<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoV - Scanner Final</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #1a1a1a; color: white; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background: #2d2d2d; width: 100%; max-width: 700px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        h1 { text-align: center; color: #e67e22; margin-top: 0; }
        
        .input-group { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
        input { padding: 12px; width: 60%; background: #444; color: white; border: 1px solid #555; border-radius: 5px; font-size: 16px; }
        button { padding: 12px 20px; background-color: #e67e22; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }
        button:hover { background-color: #d35400; }
        button:disabled { background-color: #7f8c8d; }

        .stats { display: flex; justify-content: space-around; background: #333; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .stat-box { text-align: center; }
        .stat-num { font-size: 28px; font-weight: bold; color: #3498db; }
        .stat-label { font-size: 12px; color: #aaa; text-transform: uppercase; }

        .log { background: #000; color: #0f0; padding: 10px; font-family: monospace; font-size: 12px; margin-bottom: 20px; border-radius: 5px; min-height: 20px; }
        
        .asset-list { max-height: 500px; overflow-y: auto; border-top: 1px solid #444; }
        .item { padding: 12px; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center; }
        .item:hover { background-color: #3a3a3a; }
        .item a { text-decoration: none; color: #e67e22; font-weight: bold; border: 1px solid #e67e22; padding: 5px 10px; border-radius: 4px; }
        .item a:hover { background: #e67e22; color: white; }
        .role-tag { background: #555; font-size: 11px; padding: 2px 6px; border-radius: 3px; margin-right: 8px; color: #ddd; }
    </style>
</head>
<body>

<div class="container">
    <h1>Scanner DoV</h1>
    
    <div class="input-group">
        <input type="text" id="userInput" placeholder="Compte WAX (ex: u2d2k.c.wam)">
        <button id="btn" onclick="lancerScan()">SCANNER</button>
    </div>

    <div class="log" id="logBox">Prêt. Entrez un nom de compte.</div>

    <div class="stats">
        <div class="stat-box">
            <div class="stat-num" id="divCount">0</div>
            <div class="stat-label">Divisions</div>
        </div>
        <div class="stat-box">
            <div class="stat-num" id="assetCount">0</div>
            <div class="stat-label">Cartes Trouvées</div>
        </div>
    </div>

    <div class="asset-list" id="resultList"></div>
</div>

<script>
    const RPC = "https://api.waxsweden.org/v1/chain/get_table_rows";

    async function lancerScan() {
        const account = document.getElementById('userInput').value.trim().toLowerCase();
        const logBox = document.getElementById('logBox');
        const list = document.getElementById('resultList');
        const btn = document.getElementById('btn');

        if(!account) return alert("Nom manquant");

        // Reset
        btn.disabled = true;
        list.innerHTML = "";
        document.getElementById('divCount').innerText = "0";
        document.getElementById('assetCount').innerText = "0";
        
        logBox.innerText = `Recherche en cours pour ${account}...`;

        let allDivisions = [];
        let more = true;
        let nextKey = "";

        try {
            while(more) {
                const response = await fetch(RPC, {
                    method: 'POST',
                    body: JSON.stringify({
                        json: true,
                        code: "dovpvecontrl",
                        scope: "dovpvecontrl",
                        table: "sdivisions",
                        index_position: 2,     // Index Utilisateur
                        key_type: "name",      // Recherche par nom
                        lower_bound: nextKey || account,
                        upper_bound: account,
                        limit: 200
                    })
                });

                if(!response.ok) throw new Error("Erreur réseau WAX");

                const data = await response.json();
                
                // Filtrage strict
                const rows = data.rows.filter(r => r.user === account);
                allDivisions = [...allDivisions, ...rows];

                logBox.innerText = `Analyse... ${allDivisions.length} divisions trouvées.`;

                more = data.more;
                if(more && data.next_key) {
                    nextKey = data.next_key;
                } else {
                    more = false;
                }
            }

            // --- C'EST ICI QUE LA MAGIE OPÈRE ---
            if(allDivisions.length === 0) {
                logBox.innerText = "Aucune division trouvée.";
                logBox.style.color = "orange";
            } else {
                logBox.innerText = "Chargement terminé !";
                logBox.style.color = "#0f0";
                afficherResultats(allDivisions);
            }

        } catch (e) {
            logBox.innerText = "Erreur: " + e.message;
            logBox.style.color = "red";
        }
        
        btn.disabled = false;
    }

    function afficherResultats(divisions) {
        const list = document.getElementById('resultList');
        let totalAssets = 0;
        let html = "";

        divisions.forEach(div => {
            // CORRECTION MAJEURE : On utilise 'units' au lieu de 'asset_ids'
            if(div.units && div.units.length > 0) {
                totalAssets += div.units.length;
                
                div.units.forEach(unit => {
                    // unit est un objet {key: "combat%10", value: "1099..."}
                    // On récupère l'ID dans unit.value
                    const assetId = unit.value; 
                    const role = unit.key; // ex: combat%4, officer, etc.

                    html += `
                        <div class="item">
                            <div>
                                <span class="role-tag">${role}</span>
                                <strong>${assetId}</strong> 
                                <span style="font-size:12px; color:#888;">(Div #${div.division_id})</span>
                            </div>
                            <a href="https://wax.atomichub.io/explorer/asset/${assetId}" target="_blank">Voir</a>
                        </div>
                    `;
                });
            }
        });

        document.getElementById('divCount').innerText = divisions.length;
        document.getElementById('assetCount').innerText = totalAssets;
        
        if (totalAssets === 0) {
            list.innerHTML = "<div style='padding:20px; text-align:center'>Divisions trouvées, mais elles semblent vides (pas d'unités).</div>";
        } else {
            list.innerHTML = html;
        }
    }
</script>

</body>
</html>
