<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoV - Lecteur Direct</title>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: #fff; padding: 20px; text-align: center; }
        .container { max-width: 700px; margin: 0 auto; background: #2c2c2c; padding: 20px; border-radius: 10px; }
        
        input { padding: 10px; width: 60%; border-radius: 5px; border: none; }
        button { padding: 10px 20px; background: #e67e22; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #d35400; }
        
        #log { margin-top: 20px; text-align: left; background: #000; padding: 10px; font-family: monospace; border: 1px solid #444; min-height: 100px; white-space: pre-wrap; color: #0f0; }
        
        .item { background: #333; margin: 5px 0; padding: 10px; display: flex; justify-content: space-between; align-items: center; border-radius: 4px; }
        .item a { color: #3498db; text-decoration: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>Lecteur Divisions DoV</h2>
    <p>Basé sur la table sdivisions / dovpvecontrl</p>
    
    <div>
        <input type="text" id="userInput" placeholder="Ton compte WAX (ex: abcde.wam)">
        <button onclick="lancerRecherche()">VOIR MES ASSETS</button>
    </div>

    <div id="resultats"></div>
    <div id="log">En attente...</div>
</div>

<script>
    // Configuration EXACTE du lien Bloks.io
    const RPC = "https://wax.greymass.com/v1/chain/get_table_rows";
    const CONTRACT = "dovpvecontrl";
    const SCOPE = "dovpvecontrl";
    const TABLE = "sdivisions";

    function log(msg) {
        const div = document.getElementById('log');
        div.innerText = msg + "\n" + div.innerText;
    }

    async function lancerRecherche() {
        const account = document.getElementById('userInput').value.trim().toLowerCase();
        const resDiv = document.getElementById('resultats');
        
        if(!account) return alert("Mets un compte !");
        
        resDiv.innerHTML = "";
        log("--- Nouvelle recherche ---");
        log(`Cible : ${account}`);

        try {
            // C'est ICI que la correction est faite (key_type: 'name')
            const params = {
                json: true,
                code: CONTRACT,
                scope: SCOPE,
                table: TABLE,
                index_position: 2,     // On cherche par User (Index Secondaire)
                key_type: "name",      // CORRECTION: C'est un 'name', pas un 'i64'
                lower_bound: account,  // On commence à ce nom
                upper_bound: account,  // On s'arrête après ce nom
                limit: 1000
            };

            log("Envoi demande à la Blockchain...");

            const response = await fetch(RPC, {
                method: 'POST',
                body: JSON.stringify(params)
            });

            if (!response.ok) throw new Error("Erreur serveur: " + response.status);

            const data = await response.json();
            
            if (!data.rows) {
                log("Réponse reçue mais vide.");
                return;
            }

            // Filtrage final pour être sûr à 100%
            const mesDivisions = data.rows.filter(r => r.user === account);
            
            log(`Trouvé ${mesDivisions.length} divisions.`);

            if (mesDivisions.length === 0) {
                log("Aucune division trouvée. Vérifie l'orthographe ou si elles sont bien stakées.");
            }

            // Affichage
            let html = "";
            let assetCount = 0;

            mesDivisions.forEach(div => {
                if (div.asset_ids && div.asset_ids.length > 0) {
                    div.asset_ids.forEach(id => {
                        assetCount++;
                        html += `
                            <div class="item">
                                <span>Division #${div.division_id} - Asset <strong>${id}</strong></span>
                                <a href="https://wax.atomichub.io/explorer/asset/${id}" target="_blank">Voir Carte →</a>
                            </div>
                        `;
                    });
                }
            });

            resDiv.innerHTML = `<h3 style='color:#e67e22'>Total Cartes: ${assetCount}</h3>` + html;
            log("Affichage terminé.");

        } catch (e) {
            log("ERREUR CRITIQUE : " + e.message);
        }
    }
</script>

</body>
</html>
