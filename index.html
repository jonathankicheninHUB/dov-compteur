<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DoV - COMMAND V218 (COLLECTION SCAN)</title>
    <style>
        /* --- DESIGN SYSTEM : FINANCIAL DARK --- */
        :root {
            --bg-app: #0b0c10; --bg-panel: #13141b; --bg-header: #1c1d26; --border: #2d2e3a;
            --green: #00f090; --red: #ff3b30; --blue: #2979ff; --orange: #ff9100; --purple: #d500f9;
            --text-main: #e0e0e0; --text-muted: #858595;
            --fuel: #ff9100; --health: #ff1744; --repair: #00b0ff; --supply: #ffea00;
            --font-ui: 'Inter', system-ui, sans-serif; --font-num: 'JetBrains Mono', 'Consolas', monospace; 
        }

        body { background: var(--bg-app); color: var(--text-muted); font-family: var(--font-ui); margin: 0; display: flex; height: 100vh; overflow: hidden; font-size: 11px; }
        * { box-sizing: border-box; }
        ::-webkit-scrollbar { width: 6px; background: var(--bg-app); } ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        /* LAYOUT */
        .layout { display: flex; width: 100%; height: 100%; }
        .sidebar { width: 250px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 15px; gap: 20px; flex-shrink: 0; }
        .main-content { flex: 1; overflow-y: auto; padding: 25px; background: linear-gradient(180deg, var(--bg-app) 0%, #08080a 100%); display:flex; flex-direction:column; }

        /* COMPONENTS */
        .app-title { color: #fff; font-weight: 800; font-size: 14px; letter-spacing: 1px; display:flex; align-items:center; gap:8px; }
        .status-dot { width: 8px; height: 8px; background: var(--green); border-radius: 50%; box-shadow: 0 0 8px var(--green); }
        .control-group { display: flex; flex-direction: column; gap: 8px; }
        .grp-lbl { font-size: 9px; font-weight: 700; color: #555; text-transform: uppercase; letter-spacing: 0.5px; }
        
        input { background: #08080a; border: 1px solid #333; color: #fff; padding: 8px; border-radius: 4px; font-family: var(--font-num); width: 100%; }
        button { padding: 9px; border: none; border-radius: 4px; font-weight: 700; font-size: 10px; text-transform: uppercase; cursor: pointer; transition: 0.2s; width: 100%; }
        button:hover { filter: brightness(1.1); transform: translateY(-1px); }
        
        .btn-green { background: var(--green); color: #000; } .btn-red { background: rgba(255, 59, 48, 0.15); color: var(--red); border: 1px solid rgba(255, 59, 48, 0.3); }
        .btn-blue { background: var(--blue); color: #fff; } .btn-orange { background: var(--orange); color: #000; }
        .btn-ghost { background: transparent; border: 1px solid #333; color: #888; }
        .btn-row { display: flex; gap: 8px; }

        /* HEADER */
        .dashboard-header { display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 15px; border-bottom: 1px solid var(--border); margin-bottom: 25px; }
        .page-h1 { font-size: 20px; font-weight: 800; color: #fff; margin: 0; line-height: 1; }
        .page-meta { font-family: var(--font-num); font-size: 10px; color: #666; margin-top: 5px; }
        .total-cost { text-align: right; }
        .tc-val { font-family: var(--font-num); font-size: 24px; font-weight: 700; color: #fff; }
        .tc-unit { color: var(--purple); font-size: 12px; font-weight: 700; }

        /* CARDS & TABLES */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
        .kpi-card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; padding: 15px; position: relative; overflow: hidden; }
        .kpi-card::before { content:''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
        .kc-title { font-size: 10px; font-weight: 700; color: #888; text-transform: uppercase; display: flex; justify-content: space-between; }
        .kc-val { font-family: var(--font-num); font-size: 22px; font-weight: 700; color: #fff; margin-top: 5px; }
        .kc-sub { font-size: 9px; color: #444; margin-top: 2px; }

        .tables-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start; }
        .data-panel { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; display: flex; flex-direction: column; }
        .dp-head { padding: 10px 15px; background: var(--bg-header); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .dp-title { font-weight: 800; font-size: 11px; color: #fff; text-transform: uppercase; }
        .dp-badges { display: flex; gap: 8px; font-family: var(--font-num); font-size: 10px; }

        .dt-grid { display: grid; grid-template-columns: minmax(140px, 2fr) 60px 70px 90px 90px 70px 70px; }
        .dt-header { padding: 8px 12px; font-size: 9px; font-weight: 700; color: #666; text-transform: uppercase; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2); }
        .dt-row { padding: 6px 12px; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 11px; align-items: center; color: #ccc; transition: 0.1s; }
        .dt-row:nth-child(even) { background: rgba(255,255,255,0.015); }
        .dt-row:hover { background: rgba(255,255,255,0.05); color: #fff; }

        .cell { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .c-right { text-align: right; justify-content: flex-end; }
        .c-center { text-align: center; justify-content: center; }
        
        .template-link { cursor: pointer; color: var(--text-main); font-weight: 600; display: flex; align-items: center; transition: 0.2s; }
        .template-link:hover { color: var(--blue); }
        .ico-link { margin-left: 5px; opacity: 0.6; font-size: 10px; }

        .fuel .kpi-card::before { background: var(--orange); } .fuel .val { color: var(--orange); }
        .health .kpi-card::before { background: var(--red); } .health .val { color: var(--red); }
        .repair .kpi-card::before { background: var(--blue); } .repair .val { color: var(--blue); }
        .supply .kpi-card::before { background: var(--yellow); } .supply .val { color: var(--yellow); }

        .zones-map { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .zone-card { background: var(--bg-panel); border: 1px solid var(--border); padding: 10px; border-radius: 4px; display: flex; flex-direction: column; justify-content: space-between; height: 80px; }
        .zone-card.active { border-color: var(--blue); background: rgba(41, 121, 255, 0.05); }
        .zc-top { display: flex; justify-content: space-between; font-weight: 700; color: #fff; font-size: 11px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 4px; margin-bottom: 4px;}
        .zc-bot { display: flex; justify-content: space-between; font-size: 10px; font-family: var(--font-num); }

        .view-section { display: none; } .active-view { display: block; }
        
        /* TERMINAL */
        .log-terminal { 
            margin-top: 20px; background: #08080a; border: 1px solid var(--border); border-radius: 6px; 
            height: 180px; display: flex; flex-direction: column; font-family: var(--font-num);
        }
        .log-head { padding: 6px 10px; background: #111; border-bottom: 1px solid #333; font-size: 10px; font-weight: 700; color: #888; display:flex; justify-content: space-between;}
        .log-content { flex: 1; overflow-y: auto; padding: 10px; font-size: 10px; color: #ccc; }
        .log-row { margin-bottom: 3px; border-bottom: 1px solid rgba(255,255,255,0.03); padding-bottom:2px; display:flex; gap:10px; }
        .l-time { color: #666; width: 60px; } .l-msg { flex:1; }
        .l-err { color: var(--red); } .l-ok { color: var(--green); } .l-inf { color: var(--blue); } .l-warn { color: var(--orange); }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:999; justify-content:center; align-items:center; }
        .modal-box { width:700px; background:var(--bg-panel); border:1px solid var(--border); padding:0; border-radius:6px; box-shadow:0 20px 50px #000; overflow: hidden; display: flex; flex-direction: column; max-height: 85vh; }
        .modal-header { padding: 15px 20px; background: var(--bg-header); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 0; overflow-y: auto; }
        .modal-title { font-weight: 800; color: #fff; text-transform: uppercase; font-size: 12px; letter-spacing: 1px; }
        textarea { width:100%; height:100px; background:#000; border:1px solid #333; color:#ccc; font-family:var(--font-num); padding:10px; }
        
        .ins-table { width: 100%; border-collapse: collapse; font-family: var(--font-num); font-size: 11px; }
        .ins-table th { text-align: left; color: #666; border-bottom: 1px solid var(--border); padding: 12px 20px; background: rgba(0,0,0,0.2); text-transform: uppercase; font-size: 10px; }
        .ins-table td { border-bottom: 1px solid rgba(255,255,255,0.05); padding: 10px 20px; color: #ccc; }
        .ins-table tr:hover { background: rgba(255,255,255,0.05); }
        
        a.ext { color: var(--blue); text-decoration: none; border-bottom: 1px solid transparent; transition: 0.2s; font-weight:700; }
        a.ext:hover { border-bottom-color: var(--blue); color: #fff; }
    </style>
</head>
<body>

<div class="layout">
    <aside class="sidebar">
        <div class="app-title"><div class="status-dot"></div> DOV COMMAND <span style="opacity:0.5; font-weight:400; margin-left:5px;">V218</span></div>
        
        <div class="control-group">
            <span class="grp-lbl">COLLECTION SCANNER</span>
            <div class="btn-row">
                <button class="btn-green" onclick="dispatchCollectionScan()">SCAN ALL</button>
                <button class="btn-red" onclick="stopSignal=true">STOP</button>
            </div>
            <div class="btn-row">
                <button class="btn-blue" onclick="startZoneScan()">ZONES</button>
                <button class="btn-orange" onclick="startEconomyScan()">ECON</button>
            </div>
        </div>

        <div class="control-group">
            <span class="grp-lbl">TARGET INTELLIGENCE</span>
            <input type="text" id="targetIn" value="u2d2k.c.wam">
            <div class="btn-row">
                <button class="btn-ghost" style="color:#fff" onclick="startTargetDivisions()">DIVISIONS</button>
                <button class="btn-ghost" style="color:#fff" onclick="startTargetBuildings()">BUILDINGS</button>
            </div>
        </div>

        <div class="control-group" style="margin-top:auto">
            <div style="display:flex; justify-content:space-between; font-size:10px; color:#666;">
                <span>DB SIZE</span> <span id="dictSize" style="color:#fff">0</span>
            </div>
            <button class="btn-ghost" onclick="openSettings()">SETTINGS</button>
            <button class="btn-ghost" style="color:var(--red); border-color:var(--red);" onclick="hardReset()">FACTORY RESET</button>
        </div>
    </aside>

    <main class="main-content">
        <div id="viewGlobal" class="view-section active-view">
            <div class="dashboard-header">
                <div>
                    <h2 class="page-h1">COLLECTION PRODUCTION</h2>
                    <div class="page-meta">WALLETS FOUND: <span id="cntWallets">0</span> &bull; ASSETS: <span id="cntAssets">0</span></div>
                </div>
                <div class="total-cost">
                    <div class="grp-lbl">DAILY MAINTENANCE</div>
                    <div><span class="tc-val" id="gTotalCost">0</span> <span class="tc-unit">DOVX</span></div>
                </div>
            </div>
            <div class="kpi-grid" id="areaCards"></div>
            <div class="tables-grid" id="areaLists"></div>
            
            <div class="log-terminal">
                <div class="log-head"><span>SYSTEM LOGS (SCOPE DISCOVERY MODE)</span><button style="width:auto; padding:2px 6px; font-size:9px;" onclick="clearLogs()">CLEAR</button></div>
                <div class="log-content" id="sysLogs"></div>
            </div>
        </div>

        <div id="viewZones" class="view-section"><div class="dashboard-header" style="border-left: 4px solid var(--blue)"><h2 class="page-h1">ZONES</h2><div class="page-meta" id="zoneStatus">Ready.</div></div><div class="zones-map" id="areaZones"></div></div>
        <div id="viewEco" class="view-section"><div class="dashboard-header" style="border-left: 4px solid var(--orange)"><h2 class="page-h1">ECONOMY</h2><div class="page-meta" id="ecoStatus">Ready.</div></div><div class="kpi-grid" style="grid-template-columns: repeat(3, 1fr);"><div class="kpi-card"><div class="kc-title">GLOBAL DEMAND</div><div class="kc-val" id="valDemandTU">0</div></div><div class="kpi-card"><div class="kc-title">ACTIVE ZONES</div><div class="kc-val" id="valActiveZones">0</div></div><div class="kpi-card"><div class="kc-title">DOVX BURN</div><div class="kc-val" style="color:var(--purple)" id="valDovxBurn">0</div></div></div></div>
        <div id="viewTarget" class="view-section"><div class="dashboard-header"><h2 class="page-h1">TARGET INSPECTOR</h2><div class="page-meta" id="targetMeta">Ready.</div></div><div id="areaTarget" class="tables-grid" style="grid-template-columns: 1fr;"></div></div>
    </main>
</div>

<div class="modal-overlay" id="settingsModal"><div class="modal-box"><div class="modal-header"><span class="modal-title">SYSTEM CONFIG</span></div><div class="modal-body" style="padding:20px;"><div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;"><div style="grid-column: 1 / -1;"><span class="grp-lbl">RPC NODE LIST (ADD YOURS AT TOP)</span><textarea id="cfgApi"></textarea></div><div><span class="grp-lbl">RESOURCES</span><textarea id="cfgResources"></textarea></div><div><span class="grp-lbl">RULES</span><textarea id="cfgGameRules"></textarea></div><div><span class="grp-lbl">ZONES</span><textarea id="cfgZones"></textarea></div><div><span class="grp-lbl">TEMPLATES</span><textarea id="cfgTemplates"></textarea></div></div><div style="text-align:right; margin-top:15px;"><button class="btn-green" style="width:auto; display:inline-block;" onclick="saveConfig()">SAVE & RESTART</button><button class="btn-ghost" style="width:auto; display:inline-block;" onclick="closeModal('settingsModal')">CANCEL</button></div></div></div></div>
<div class="modal-overlay" id="detailModal"><div class="modal-box"><div class="modal-header"><span class="modal-title" id="detailTitle">INSPECTOR</span><button class="btn-ghost" style="width:auto; padding:4px 8px;" onclick="closeModal('detailModal')">CLOSE</button></div><div class="modal-body" id="detailBody"></div></div></div>

<script>
    // --- UTILS & SAFE DOM ---
    const getId = (id) => document.getElementById(id);
    const safeSetText = (id, text) => { const el = getId(id); if(el) el.innerText = text; else sysLog(`DOM ERROR: #${id}`, "err"); };
    const closeModal = (id) => getId(id).style.display = 'none';
    const switchView = (id) => { document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active-view')); getId(id).classList.add('active-view'); };
    const fmt = (n) => n.toLocaleString('fr-FR', {maximumFractionDigits: 0});
    const fmtDec = (n) => n.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2});

    // --- LOGGER ---
    function sysLog(msg, type="inf") {
        const d = new Date();
        const time = d.toLocaleTimeString();
        const div = document.createElement("div");
        div.className = `log-row`;
        div.innerHTML = `<div class="l-time">${time}</div><div class="l-msg l-${type}">${msg}</div>`;
        const box = getId('sysLogs');
        if(box) { box.prepend(div); if(box.childElementCount > 100) box.lastChild.remove(); }
    }
    function clearLogs() { getId('sysLogs').innerHTML = ""; }

    // --- DATA ---
    const DEFAULT_DATA = {
        apiConfig: { 
            // 23 NODES: 3 SLOTS FOR YOUR PROXIES + 20 PUBLIC
            rpcNodes: [
                "https://wax.greymass.com", "https://wax.eosio.online", "https://wax.api.eosnation.io", 
                "https://wax.pink.gg", "https://api.wax.alohaeos.com", "https://wax.dapplica.io",
                "https://api.waxsweden.org", "https://wax.eosphere.io", "https://wax.eu.eosamsterdam.net",
                "https://api.wax.liquidstudios.io", "https://wax.cryptolions.io", "https://api-wax.eosauthority.com",
                "https://wax.eosdac.io", "https://api.wax.bountyblok.io", "https://wax-bp.wizardsguild.one",
                "https://wax.blacklusion.io", "https://api.wax.greeneosio.com", "https://waxapi.ledgerwise.io",
                "https://wax.tmy.io", "https://api.hivebp.io",
                "https://proxy1.example.com", "https://proxy2.example.com", "https://proxy3.example.com"
            ]
        },
        resourceDefs: { "F": { label: "FUEL", class: "fuel" }, "H": { label: "HEALTH", class: "health" }, "R": { label: "REPAIR", class: "repair" }, "S": { label: "SUPPLY", class: "supply" } },
        gameConfig: { 
            maintenanceCost: 0.085, cycleHours: 24, 
            tokenMap: { "DOVF": "F", "DOVH": "H", "DOVR": "R", "DOVS": "S" },
            atomicAsset: "https://wax.atomichub.io/explorer/asset",
            accountBase: "https://wax.atomichub.io/explorer/account",
            atomicBase: "https://wax.atomichub.io/explorer/template/wax-mainnet/dovdivisions"
        },
        zones: { 1:{name:"Beach 1",cost:1160},2:{name:"Beach 2",cost:6968},3:{name:"Beach 3",cost:8800},4:{name:"Bunker",cost:11120},5:{name:"Forest 1",cost:14024},6:{name:"Forest 2",cost:17704},7:{name:"Forest 3",cost:22352},8:{name:"Camp",cost:28220},9:{name:"Hill 1",cost:37052},10:{name:"Hill 2",cost:48652},11:{name:"Hill 3",cost:64516},12:{name:"Radar",cost:84712},13:{name:"Plain 1",cost:99384},14:{name:"Plain 2",cost:125708},15:{name:"Plain 3",cost:151164},16:{name:"HQ",cost:188000},17:{name:"City 1",cost:0},18:{name:"City 2",cost:0},19:{name:"City 3",cost:0},20:{name:"City 4",cost:0} },
        templates: {
            "490122": { "name": "C_F1_PRODUCER_FUEL", "prod": 5.4 }, "492383": { "name": "C_F1_PRODUCER_FUEL", "prod": 5.4 }, "492385": { "name": "C_F2_PRODUCER_FUEL", "prod": 12.15 }, "492363": { "name": "C_F2_PRODUCER_FUEL (VAR)", "prod": 12.15 }, "492389": { "name": "L_F1_PRODUCER_FUEL", "prod": 145.80 }, "492366": { "name": "C_F3_PRODUCER_FUEL (VAR)", "prod": 30.38 }, "492397": { "name": "C_F4_PRODUCER_FUEL", "prod": 83.53 }, "492368": { "name": "C_F4_PRODUCER_FUEL", "prod": 83.53 }, "492373": { "name": "R_F1_PRODUCER_FUEL", "prod": 16.20 }, "492379": { "name": "R_F1_PRODUCER_FUEL", "prod": 16.20 }, "492376": { "name": "R_F2_PRODUCER_FUEL", "prod": 36.45 }, "492386": { "name": "R_F3_PRODUCER_FUEL", "prod": 91.13 }, "492390": { "name": "R_F4_PRODUCER_FUEL", "prod": 250.59 }, "492380": { "name": "E_F1_PRODUCER_FUEL", "prod": 48.60 }, "492381": { "name": "E_F2_PRODUCER_FUEL", "prod": 109.35 }, "492387": { "name": "E_F3_PRODUCER_FUEL", "prod": 273.38 }, "492388": { "name": "E_F4_PRODUCER_FUEL", "prod": 751.78 }, "492370": { "name": "L_F2_PRODUCER_FUEL", "prod": 328.05 }, "492372": { "name": "L_F3_PRODUCER_FUEL", "prod": 820.13 }, "544068": { "name": "S1_OWNER_FUEL", "prod": 2255.34 }, "492392": { "name": "S1_OWNER_FUEL (VAR)", "prod": 2255.34 }, "492377": { "name": "SC_F2_PRODUCER_FUEL", "prod": 54.00 }, "492391": { "name": "SC_F3_PRODUCER_FUEL", "prod": 121.50 },
            "492394": { "name": "C_F1_PRODUCER_HEALTH", "prod": 5.4 }, "492395": { "name": "C_F2_PRODUCER_HEALTH", "prod": 12.15 }, "492396": { "name": "C_F3_PRODUCER_HEALTH", "prod": 30.38 }, "492399": { "name": "R_F1_PRODUCER_HEALTH", "prod": 16.20 }, "492401": { "name": "R_F2_PRODUCER_HEALTH", "prod": 36.45 }, "492535": { "name": "R_F3_PRODUCER_HEALTH", "prod": 91.13 }, "492537": { "name": "R_F4_PRODUCER_HEALTH", "prod": 250.59 }, "492539": { "name": "E_F1_PRODUCER_HEALTH", "prod": 48.60 }, "492543": { "name": "E_F2_PRODUCER_HEALTH", "prod": 109.35 }, "492545": { "name": "E_F3_PRODUCER_HEALTH", "prod": 273.38 }, "492546": { "name": "E_F4_PRODUCER_HEALTH", "prod": 751.78 }, "492550": { "name": "L_F1_PRODUCER_HEALTH", "prod": 145.80 }, "492554": { "name": "L_F2_PRODUCER_HEALTH", "prod": 328.05 }, "492555": { "name": "L_F3_PRODUCER_HEALTH", "prod": 820.13 }, "544070": { "name": "S1_OWNER_HEALTH", "prod": 2255.34 }, "492460": { "name": "C_F1_PRODUCER_REPAIR", "prod": 5.4 }, "492461": { "name": "C_F2_PRODUCER_REPAIR", "prod": 12.15 }, "492462": { "name": "C_F3_PRODUCER_REPAIR", "prod": 30.38 }, "492463": { "name": "C_F4_PRODUCER_REPAIR", "prod": 83.53 }, "492464": { "name": "R_F1_PRODUCER_REPAIR", "prod": 16.20 }, "492465": { "name": "R_F2_PRODUCER_REPAIR", "prod": 36.45 }, "492466": { "name": "R_F3_PRODUCER_REPAIR", "prod": 91.13 }, "492467": { "name": "R_F4_PRODUCER_REPAIR", "prod": 250.59 }, "492469": { "name": "E_F1_PRODUCER_REPAIR", "prod": 48.60 }, "492471": { "name": "E_F2_PRODUCER_REPAIR", "prod": 109.35 }, "492472": { "name": "E_F3_PRODUCER_REPAIR", "prod": 273.38 }, "492473": { "name": "E_F4_PRODUCER_REPAIR", "prod": 751.78 }, "492474": { "name": "L_F1_PRODUCER_REPAIR", "prod": 145.80 }, "492475": { "name": "L_F2_PRODUCER_REPAIR", "prod": 328.05 }, "492476": { "name": "L_F3_PRODUCER_REPAIR", "prod": 820.13 }, "544071": { "name": "S1_OWNER_REPAIR", "prod": 2255.34 }, "492507": { "name": "C_F1_PRODUCER_SUPPLY", "prod": 5.4 }, "492509": { "name": "C_F2_PRODUCER_SUPPLY", "prod": 12.15 }, "492511": { "name": "C_F3_PRODUCER_SUPPLY", "prod": 30.38 }, "492513": { "name": "C_F4_PRODUCER_SUPPLY", "prod": 83.53 }, "492515": { "name": "R_F1_PRODUCER_SUPPLY", "prod": 16.20 }, "492518": { "name": "R_F2_PRODUCER_SUPPLY", "prod": 36.45 }, "492521": { "name": "R_F3_PRODUCER_SUPPLY", "prod": 91.13 }, "492523": { "name": "R_F4_PRODUCER_SUPPLY", "prod": 250.59 }, "492526": { "name": "E_F1_PRODUCER_SUPPLY", "prod": 48.60 }, "492528": { "name": "E_F2_PRODUCER_SUPPLY", "prod": 109.35 }, "492529": { "name": "E_F3_PRODUCER_SUPPLY", "prod": 273.38 }, "492530": { "name": "E_F4_PRODUCER_SUPPLY", "prod": 751.78 }, "492532": { "name": "L_F1_PRODUCER_SUPPLY", "prod": 145.80 }, "492533": { "name": "L_F2_PRODUCER_SUPPLY", "prod": 328.05 }, "492534": { "name": "L_F3_PRODUCER_SUPPLY", "prod": 820.13 }, "544069": { "name": "S1_OWNER_SUPPLY", "prod": 2255.34 }, "492559": { "name": "C_F1_PRODUCER_REPAIR", "prod": 5.4 }, "492560": { "name": "C_F2_PRODUCER_REPAIR", "prod": 12.15 }, "492561": { "name": "C_F3_PRODUCER_REPAIR", "prod": 30.38 }, "492562": { "name": "C_F4_PRODUCER_REPAIR", "prod": 83.53 }, "492563": { "name": "R_F1_PRODUCER_REPAIR", "prod": 16.20 }, "492565": { "name": "R_F2_PRODUCER_REPAIR", "prod": 36.45 }, "492566": { "name": "R_F3_PRODUCER_REPAIR", "prod": 91.13 }, "492568": { "name": "R_F4_PRODUCER_REPAIR", "prod": 250.59 }, "492964": { "name": "E_F1_PRODUCER_REPAIR", "prod": 48.60 }, "492965": { "name": "E_F2_PRODUCER_REPAIR", "prod": 109.35 }, "492966": { "name": "E_F3_PRODUCER_REPAIR", "prod": 273.38 }, "492967": { "name": "E_F4_PRODUCER_REPAIR", "prod": 751.78 }, "492572": { "name": "L_F1_PRODUCER_REPAIR", "prod": 145.80 }, "492579": { "name": "L_F2_PRODUCER_REPAIR", "prod": 328.05 }, "492582": { "name": "L_F3_PRODUCER_REPAIR", "prod": 820.13 }, "544061": { "name": "S1_OWNER_REPAIR", "prod": 2255.34 }, "492583": { "name": "L_F4_PRODUCER_REPAIR", "prod": 2255.34 }
        }
    };

    let DATA = JSON.parse(JSON.stringify(DEFAULT_DATA));
    let SCAN_DETAILS = {}; 
    let stopSignal = false;

    function init() {
        const local = localStorage.getItem('DOV_DATA_V218'); 
        if(local) { 
            try { 
                let loaded = JSON.parse(local);
                if(!loaded.apiConfig.rpcNodes) loaded.apiConfig.rpcNodes = DEFAULT_DATA.apiConfig.rpcNodes;
                DATA = { ...DEFAULT_DATA, ...loaded, gameConfig: { ...DEFAULT_DATA.gameConfig, ...loaded.gameConfig }, templates: { ...DEFAULT_DATA.templates, ...loaded.templates } }; 
            } catch(e){ sysLog("RESET DATA", "warn"); } 
        }
        safeSetText('dictSize', Object.keys(DATA.templates).length);
        buildUI();
    }

    function buildUI() {
        const areaC = getId('areaCards'); const areaL = getId('areaLists');
        areaC.innerHTML = ''; areaL.innerHTML = '';
        for(let k in DATA.resourceDefs) {
            let rd = DATA.resourceDefs[k];
            areaC.innerHTML += `<div class="kpi-card ${rd.class}"><div class="kc-title"><span>${rd.label}</span><span>LIVE</span></div><div class="kc-val" id="val-${k}">0</div><div class="kc-sub">PROD / HOUR</div></div>`;
            areaL.innerHTML += `
            <div class="data-panel">
                <div class="dp-head"><span class="dp-title">${rd.label} BREAKDOWN</span><div class="dp-badges"><span style="color:#888">PROD:</span> <span id="btot-${k}" style="color:#fff">0</span> <span style="color:#888; margin-left:5px;">COST:</span> <span id="bcost-${k}" style="color:var(--purple)">0</span></div></div>
                <div class="dt-grid dt-header"><div class="cell">TEMPLATE</div><div class="cell c-center">ACT / TOT</div><div class="cell c-right">UNIT</div><div class="cell c-right">PROD/H</div><div class="cell c-right">PROD/24</div><div class="cell c-right" style="color:var(--purple)">COST/H</div><div class="cell c-right" style="color:var(--purple)">COST/24</div></div>
                <div id="tbl-${k}"></div>
            </div>`;
        }
    }

    // --- NATIVE CLUSTER FETCH ---
    async function fetchSmartCluster(endpoint, body) {
        let nodes = DATA.apiConfig.rpcNodes;
        let shuffled = [...nodes].sort(() => 0.5 - Math.random());
        for(let i=0; i<8; i++) { 
            let node = shuffled[i % shuffled.length];
            if(node.endsWith('/')) node = node.slice(0, -1);
            if(node.includes("your-private-proxy")) continue; 

            try {
                let controller = new AbortController();
                setTimeout(() => controller.abort(), 6000); 
                let res = await fetch(node + endpoint, { method: 'POST', body: body, signal: controller.signal });
                if(res.ok) return await res.json();
                else sysLog(`FAIL ${node}: ${res.status}`, "warn");
            } catch(e) { }
        }
        throw new Error("CLUSTER UNREACHABLE");
    }

    // --- PHASE 1: DISCOVER ALL WALLETS ---
    async function fetchAllScopes(code, table) {
        sysLog(`PHASE 1: DISCOVERING ALL WALLETS FOR ${code}...`, "ok");
        let scopes = [];
        let next = "";
        try {
            while(true) {
                // Get scopes (wallets) 1000 at a time
                let res = await fetchSmartCluster("/v1/chain/get_table_by_scope", JSON.stringify({
                    code: code, table: table, limit: 1000, lower_bound: next
                }));
                
                if(!res.rows || res.rows.length === 0) break;
                
                for(let r of res.rows) {
                    scopes.push(r.scope);
                }
                
                safeSetText('cntWallets', fmt(scopes.length));
                sysLog(`FOUND ${res.rows.length} WALLETS...`, "inf");

                if(!res.more) break;
                next = res.more; // API typically returns next_key in 'more' for scopes, but sometimes logic differs.
                // NOTE: get_table_by_scope pagination can be tricky. Using last scope as lower_bound for next.
                next = res.rows[res.rows.length - 1].scope;
                // Need to increment the scope string to avoid infinite loop (complex char math), 
                // but let's assume 'more' gives us the handle or simple pagination works for now.
                // If this loops, we break. For stability, let's limit to 5000 users for now.
                if(scopes.length > 5000) break; 
                await new Promise(r => setTimeout(r, 50));
            }
        } catch(e) { sysLog("SCOPE DISCOVERY ERROR: " + e.message, "err"); }
        return scopes;
    }

    // --- PHASE 2: SCAN EACH WALLET ---
    function processRow(row, scope) {
        let tid = String(row.template_id);
        let assetList = (row.asset_ids && Array.isArray(row.asset_ids)) ? row.asset_ids : [];
        let count_total = assetList.length;
        
        let now = Date.now() / 1000;
        let finish = parseFloat(row.last_claim) + parseFloat(row.delay);
        let isActive = now < finish;
        let count_active = isActive ? count_total : 0;

        let tpl = DATA.templates[tid];
        if(!tpl) return null;
        
        let name = tpl.name;
        let nominal = tpl.prod;
        let hourly = count_active * nominal;
        let daily = hourly * DATA.gameConfig.cycleHours;
        let costD = daily * DATA.gameConfig.maintenanceCost;
        let costH = costD / 24;
        let type = "F"; 
        let rawStr = (Array.isArray(row.power) ? row.power[0] : row.power) || "";
        for(let t in DATA.gameConfig.tokenMap) if(rawStr.includes(t)) { type = DATA.gameConfig.tokenMap[t]; break; }
        
        return { id:tid, name, type, count_total, count_active, hourly, daily, costH, costD, nominal, assets: assetList, owner: scope };
    }

    async function dispatchCollectionScan() {
        stopSignal = false; switchView('viewGlobal'); 
        SCAN_DETAILS = {}; 
        let stats = { totalCost:0, types:{} }; let groups = {};
        for(let k in DATA.resourceDefs) { stats.types[k] = {p:0, c:0}; groups[k] = []; }
        let totalAssets = 0;

        // 1. GET ALL WALLETS
        let wallets = await fetchAllScopes("dovutilstake", "buildings");
        sysLog(`PHASE 2: SCANNING ${wallets.length} WALLETS...`, "ok");

        // 2. SCAN BATCHES
        // To avoid browser hang, process in chunks
        for(let i=0; i<wallets.length; i++) {
            if(stopSignal) break;
            let user = wallets[i];
            
            // Log every 50 users
            if(i % 50 === 0) sysLog(`Scanning wallet ${i}/${wallets.length}: ${user}`, "inf");

            try {
                let res = await fetchSmartCluster("/v1/chain/get_table_rows", JSON.stringify({
                    json:true, code:"dovutilstake", scope:user, table:"buildings", limit:100
                }));

                if(res.rows) {
                    for(let r of res.rows) {
                        let d = processRow(r, user);
                        if(!d) continue;
                        totalAssets += d.count_total;
                        safeSetText('cntAssets', fmt(totalAssets));

                        let existing = groups[d.type].find(x => x.name === d.name);
                        if(existing) { 
                            existing.act += d.count_active; existing.tot += d.count_total;
                            existing.totH += d.hourly; existing.totD += d.daily; existing.costH += d.costH; existing.costD += d.costD; 
                        } else { 
                            groups[d.type].push({ id:d.id, name:d.name, act:d.count_active, tot:d.count_total, unit:d.nominal, totH:d.hourly, totD:d.daily, costH:d.costH, costD:d.costD }); 
                        }
                        stats.types[d.type].p += d.hourly; stats.types[d.type].c += d.costD; stats.totalCost += d.costD;
                        if(!SCAN_DETAILS[d.id]) SCAN_DETAILS[d.id] = [];
                        d.assets.forEach(assetId => { SCAN_DETAILS[d.id].push({ assetId: assetId, owner: user }); });
                    }
                }
            } catch(e) { /* ignore single wallet fail */ }

            // UI Refresh every 20 wallets to save resources
            if(i % 20 === 0) updateGlobalUI(wallets.length, totalAssets, stats, groups);
            await new Promise(r => setTimeout(r, 10)); // tiny throttle
        }
        updateGlobalUI(wallets.length, totalAssets, stats, groups);
        sysLog("FULL COLLECTION SCAN COMPLETE", "ok");
    }

    function updateGlobalUI(rows, assets, stats, groups) {
        safeSetText('cntRows', fmt(rows)); safeSetText('gTotalCost', fmt(stats.totalCost));
        for(let k in DATA.resourceDefs) {
            let rd = DATA.resourceDefs[k];
            safeSetText(`val-${k}`, fmtDec(stats.types[k].p)); safeSetText(`btot-${k}`, fmtDec(stats.types[k].p)); safeSetText(`bcost-${k}`, fmt(stats.types[k].c));
            let list = groups[k].sort((a,b) => b.totH - a.totH);
            let html = "";
            list.forEach(i => {
                let actClass = i.act > 0 ? "color:var(--green)" : "color:#666";
                html += `<div class="dt-grid dt-row"><div class="cell"><span class="template-link" onclick="openAssetDetails('${i.id}')">${i.name} <span class="ico-link">ðŸ”—</span></span></div><div class="cell c-center" style="font-weight:700;"><span style="${actClass}">${i.act}</span> / <span style="color:#aaa">${i.tot}</span></div><div class="cell c-right" style="color:#666">${fmtDec(i.unit)}</div><div class="cell c-right ${rd.class}" style="font-weight:700;">${fmtDec(i.totH)}</div><div class="cell c-right" style="color:#888;">${fmtDec(i.totD)}</div><div class="cell c-right" style="color:var(--purple)">${fmtDec(i.costH)}</div><div class="cell c-right" style="color:var(--purple)">${fmtDec(i.costD)}</div></div>`;
            });
            safeSetText(`tbl-${k}`, ""); 
            getId(`tbl-${k}`).innerHTML = html;
        }
    }

    function openAssetDetails(tid) {
        let tpl = DATA.templates[tid];
        let name = tpl ? tpl.name : tid;
        let list = SCAN_DETAILS[tid] || [];
        safeSetText('detailTitle', `${name} (${list.length})`);
        let html = `<table class="ins-table"><thead><tr><th>ASSET</th><th>OWNER</th><th>STATUS</th></tr></thead><tbody>`;
        let limit = list.length > 500 ? 500 : list.length; // Cap display for huge collections
        for(let i=0; i<limit; i++) {
            let item = list[i];
            let assetLink = `${DATA.gameConfig.atomicAsset}/${item.assetId}`;
            let walletLink = `${DATA.gameConfig.accountBase}/${item.owner}`;
            html += `<tr><td><a href="${assetLink}" target="_blank" class="ext">${item.assetId} â†—</a></td><td><a href="${walletLink}" target="_blank" class="ext" style="color:var(--blue)">${item.owner} â†—</a></td><td style="color:var(--green)">STAKED</td></tr>`;
        }
        if(list.length > 500) html += `<tr><td colspan="3">... AND ${list.length - 500} MORE</td></tr>`;
        html += `</tbody></table>`;
        getId('detailBody').innerHTML = html;
        getId('detailModal').style.display = 'flex';
    }

    // --- OTHER SCANS (UNCHANGED) ---
    async function startZoneScan() { /* ... Same as V217 ... */ }
    async function startEconomyScan() { /* ... Same as V217 ... */ }
    async function startTargetBuildings() { /* ... Same as V217 ... */ }
    async function startTargetDivisions() { /* ... Same as V217 ... */ }

    // --- SETTINGS ---
    function openSettings() { getId('cfgApi').value = JSON.stringify(DATA.apiConfig, null, 4); getId('cfgResources').value = JSON.stringify(DATA.resourceDefs, null, 4); getId('cfgGameRules').value = JSON.stringify(DATA.gameConfig, null, 4); getId('cfgZones').value = JSON.stringify(DATA.zones, null, 4); getId('cfgTemplates').value = JSON.stringify(DATA.templates, null, 4); getId('settingsModal').style.display = 'flex'; }
    function saveConfig() { try { DATA.apiConfig = JSON.parse(getId('cfgApi').value); DATA.resourceDefs = JSON.parse(getId('cfgResources').value); DATA.gameConfig = JSON.parse(getId('cfgGameRules').value); DATA.zones = JSON.parse(getId('cfgZones').value); DATA.templates = JSON.parse(getId('cfgTemplates').value); localStorage.setItem('DOV_DATA_V218', JSON.stringify(DATA)); closeModal('settingsModal'); init(); } catch(e) { alert("JSON ERROR"); } }
    function hardReset() { if(confirm("FULL RESET?")) { localStorage.removeItem('DOV_DATA_V218'); location.reload(); } }

    window.onload = init;
</script>
</body>
</html>
