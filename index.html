<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DoV - Scanner Audit</title>
    <style>
        body { background: #111; color: #eee; font-family: sans-serif; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .box { background: #222; padding: 20px; border-radius: 8px; width: 100%; max-width: 800px; border: 1px solid #444; }
        input { padding: 10px; width: 60%; background: #000; color: #fff; border: 1px solid #555; }
        button { padding: 10px; background: #e67e22; color: white; border: none; cursor: pointer; font-weight: bold; }
        
        .debug-log { 
            background: #000; 
            border: 1px solid #333; 
            padding: 10px; 
            margin-top: 10px; 
            font-family: monospace; 
            font-size: 12px; 
            height: 150px; 
            overflow-y: auto; 
            color: #ccc;
        }

        .result-item { 
            display: flex; justify-content: space-between; 
            padding: 8px; border-bottom: 1px solid #333; 
        }
        .result-item a { color: #3498db; text-decoration: none; }
        
        .role { color: #f1c40f; font-size: 0.8em; margin-right: 10px; text-transform: uppercase; }
    </style>
</head>
<body>

<div class="box">
    <h2 style="text-align:center; margin-top:0;">SCANNER CORRIGÉ</h2>
    
    <div style="text-align:center; margin-bottom:15px;">
        <input type="text" id="userInput" placeholder="toncompte.wam">
        <button onclick="runScan()">LANCER</button>
    </div>

    <div style="display:flex; justify-content:space-around; margin-bottom:10px;">
        <div>Divisions: <b id="divTotal">0</b></div>
        <div>Cartes: <b id="cardTotal">0</b></div>
    </div>

    <div class="debug-log" id="debug">En attente...</div>

    <div id="results" style="margin-top:20px;"></div>
</div>

<script>
    const RPC = "https://api.waxsweden.org/v1/chain/get_table_rows";

    function log(msg) {
        const d = document.getElementById('debug');
        d.innerHTML = `> ${msg}<br>` + d.innerHTML;
    }

    async function runScan() {
        const user = document.getElementById('userInput').value.trim().toLowerCase();
        const list = document.getElementById('results');
        
        if(!user) return alert("Mets un nom !");

        // Reset
        list.innerHTML = "";
        document.getElementById('divTotal').innerText = "0";
        document.getElementById('cardTotal').innerText = "0";
        document.getElementById('debug').innerHTML = "";
        
        log(`Démarrage pour : ${user}`);

        let nextKey = user; 
        let hasMore = true;
        let myDivisions = [];

        try {
            while(hasMore) {
                log(`Recherche à partir de : ${nextKey}`);

                const response = await fetch(RPC, {
                    method: 'POST',
                    body: JSON.stringify({
                        json: true,
                        code: "dovpvecontrl",
                        scope: "dovpvecontrl",
                        table: "sdivisions",
                        index_position: 2,     // Index Owner
                        key_type: "name",
                        lower_bound: nextKey,  // On commence ici
                        limit: 100             // On prend par paquets de 100
                        // J'AI ENLEVÉ UPPER_BOUND : C'est ça qui bloquait !
                    })
                });

                const data = await response.json();

                if(!data.rows || data.rows.length === 0) {
                    log("Plus de résultats reçus.");
                    hasMore = false;
                    break;
                }

                // Inspection technique (pour être sûr des colonnes)
                const first = data.rows[0];
                if(myDivisions.length === 0) {
                    log(`INFO TECHNIQUE - Colonnes trouvées : ${Object.keys(first).join(", ")}`);
                }

                // Filtrage manuel (Le "Scanner Souple")
                let foundInThisBatch = 0;
                
                for(let row of data.rows) {
                    // On vérifie si c'est 'owner' ou 'user' (ceinture et bretelles)
                    const rowOwner = row.owner || row.user;

                    if (rowOwner === user) {
                        myDivisions.push(row);
                        foundInThisBatch++;
                    } else {
                        // Si on tombe sur un nom qui est alphabétiquement APRÈS le tien
                        // et qui n'est pas le tien, on peut arrêter.
                        // Exemple : on cherche "toto", on tombe sur "tutu". C'est fini.
                        // (Petite sécurité : on vérifie juste que ce n'est pas le même nom)
                        if (rowOwner.localeCompare(user) > 0) {
                            log(`Arrivé au compte ${rowOwner}, arrêt du scan.`);
                            hasMore = false;
                            break;
                        }
                    }
                }

                log(`Batch reçu : ${data.rows.length} lignes. ${foundInThisBatch} sont à toi.`);

                if (hasMore && data.more && data.next_key) {
                    nextKey = data.next_key;
                } else {
                    hasMore = false;
                }
            }

            // Affichage Final
            log(`FINI. Total divisions trouvées : ${myDivisions.length}`);
            afficherCartes(myDivisions);

        } catch (e) {
            log(`ERREUR CRITIQUE : ${e.message}`);
        }
    }

    function afficherCartes(divisions) {
        const container = document.getElementById('results');
        let totalCards = 0;
        let html = "";

        divisions.forEach(div => {
            // On gère le cas où la colonne s'appelle 'units' OU 'asset_ids'
            const units = div.units || div.asset_ids || [];

            if (units.length > 0) {
                totalCards += units.length;
                units.forEach(u => {
                    // On gère si c'est un objet {key, value} ou juste un ID
                    let assetId = u;
                    let role = "Unité";

                    if (typeof u === 'object') {
                        assetId = u.value;
                        role = u.key;
                    }

                    html += `
                        <div class="result-item">
                            <div>
                                <span class="role">${role}</span>
                                <strong>${assetId}</strong>
                                <span style="color:#666; font-size:12px"> (Div #${div.division_id})</span>
                            </div>
                            <a href="https://wax.atomichub.io/explorer/asset/${assetId}" target="_blank">Voir</a>
                        </div>
                    `;
                });
            }
        });

        document.getElementById('divTotal').innerText = divisions.length;
        document.getElementById('cardTotal').innerText = totalCards;
        container.innerHTML = html || "<div style='text-align:center'>Aucune carte trouvée.</div>";
    }
</script>

</body>
</html>
