<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DoV - COMMAND V66.2 (CERTIFIED CFO)</title>
    <style>
        /* DESIGN V43 PERFECT ALIGN - AUCUNE MODIFICATION VISUELLE */
        :root { 
            --main: #00e676; --alert: #ff1744; --sec: #29b6f6; --warn: #ff9800; --dovx: #9c27b0; 
            --gold: #ffd700; --money: #2ecc71;
            --fuel: #e67e22; --health: #e74c3c; --repair: #bdc3c7; --supply: #f1c40f;
            --bg: #050505; --panel: #111; 
        }
        body { background-color: var(--bg); color: #ccc; font-family: 'Consolas', monospace; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { height: 40px; background: #000; border-bottom: 1px solid #333; display: flex; align-items: center; padding: 0 15px; justify-content: space-between; }
        h1 { color: var(--gold); margin: 0; font-size: 16px; letter-spacing: 1px; text-transform: uppercase; }
        .rpc-badge { font-size: 10px; background: #222; padding: 2px 6px; border-radius: 4px; border: 1px solid #444; color: #888; }
        .layout { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 280px; background: var(--panel); border-right: 1px solid #333; padding: 15px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .main-view { flex: 1; padding: 20px; overflow-y: auto; position: relative; background: #000; }
        .box { border: 1px solid #444; padding: 10px; background: #080808; margin-bottom: 10px; }
        .box-title { color: #fff; font-size: 11px; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 4px; }
        button { width: 100%; padding: 10px; cursor: pointer; border: none; font-weight: bold; font-family: monospace; text-transform: uppercase; margin-bottom: 5px; font-size: 11px; }
        .btn-zone { background: var(--main); color: #000; } 
        .btn-eco { background: var(--gold); color: #000; }
        .btn-stop { background: var(--alert); color: #fff; display: none; }
        input { width: 100%; padding: 8px; background: #222; border: 1px solid #444; color: #fff; box-sizing: border-box; font-family: monospace; margin-bottom: 5px; }
        .eco-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .eco-card { background: #111; border: 1px solid #333; padding: 15px; border-top: 3px solid #444; min-height: 80px; display: flex; flex-direction: column; justify-content: space-between; }
        .balance-container { background:#111; padding:15px; border:1px solid #333; margin-bottom:20px; }
        .balance-header { display: grid; grid-template-columns: 1fr 1fr 1fr; font-size: 11px; font-weight: bold; margin-bottom: 8px; text-transform: uppercase; }
        .balance-bar { width: 100%; height: 12px; background: #222; display: flex; border-radius: 3px; overflow: hidden; }
        .bal-demand { background: var(--alert); height: 100%; transition: width 0.5s; }
        .bal-supply { background: var(--main); height: 100%; transition: width 0.5s; }
        .matrix-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .matrix-col { background: #111; border: 1px solid #333; display: flex; flex-direction: column; }
        .mx-head { padding: 8px; font-weight: bold; text-align: center; color: #000; font-size: 12px; }
        .mx-body { padding: 10px; font-size: 11px; display: flex; flex-direction: column; gap: 8px; flex: 1; }
        .zones-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .zone { background: #0a0a0a; border: 1px solid #333; padding: 8px; min-height: 110px; opacity: 0.6; display: flex; flex-direction: column; justify-content: space-between; }
        .zone.active { opacity: 1; border-color: #444; }
        .logs { height: 120px; background: #000; border-top: 1px solid #333; padding: 10px; font-size: 11px; color: #888; overflow-y: auto; font-family: monospace; white-space: pre-wrap; }
        .view-section { display: none; } .view-active { display: block; }
        .integrity-badge { font-size: 9px; padding: 2px 8px; border-radius: 4px; font-weight: bold; letter-spacing: 0.5px; }
    </style>
</head>
<body>

<header>
    <h1>DoV COMMAND <span style="color:var(--sec)">V66.2 CERTIFIED CFO</span></h1>
    <span class="rpc-badge" id="rpcStatus">PRÃŠT</span>
</header>

<div class="layout">
    <aside class="sidebar">
        <div class="box" style="border-color: var(--gold)">
            <div class="box-title">CONFIGURATION MARCHÃ‰</div>
            <input type="number" id="inpWax" value="0.00786" step="0.00001" onchange="updateRates()">
            <input type="number" id="inpDovx" value="0.00528553" step="0.00000001" onchange="updateRates()">
            <input type="number" id="inpTu" value="0.00045262" step="0.00000001" onchange="updateRates()">
        </div>
        <div class="box">
            <button class="btn-zone" onclick="startZoneScan()">SCAN ZONES (MAP)</button>
            <button class="btn-eco" onclick="startEconomyScan()">SCAN ECONOMY ($)</button>
            <button class="btn-stop" id="btnStop" onclick="stopSignal=true">ARRÃŠT</button>
        </div>
    </aside>

    <main class="main-view">
        <div id="zoneView" class="view-section view-active">
            <div class="zones-grid" id="zonesArea"></div>
        </div>
        <div id="ecoView" class="view-section">
            <div id="integrityContainer" style="text-align:right; margin-bottom:10px"></div>
            <div class="eco-grid" id="ecoCards"></div>
            <div class="balance-container" id="ecoRatio"></div>
            <div class="matrix-grid" id="tokenMatrix"></div>
            <div id="dovxAnalysis" style="background:#111; padding:15px; border:1px solid var(--dovx); margin-top:20px;"></div>
        </div>
    </main>
</div>

<div class="logs" id="console">> V66.2 : Evidence-Grade Engine. Calculs certifiÃ©s par scan intÃ©gral.</div>

<script>
    let RATES = { WAX_USD: 0.00786, DOVX_WAX: 0.00528553, TU_WAX: 0.00045262 };
    let stopSignal = false;
    let rpcIndex = 0;
    let rpcConsecutiveErrors = 0;
    const RPCS = ["https://wax.greymass.com", "https://api.waxsweden.org", "https://wax.eosn.io"];

    // ðŸ” PALIER DE VÃ‰RITÃ‰ ON-CHAIN
    const DOVX_CLAIM_LEVELS = {
        win:   { minPower: 100, reward: 400.00 },
        draw:  { minPower: 60,  reward: 200.00 },
        lost:  { minPower: 1,   reward: 50.00 }
    };

    const ZONE_DB = {
        1: { name: "Beach 1", cost: 1160, costX: 0 },
        16: { name: "HQ", cost: 188000, costX: 0 },
        17: { name: "City 1", cost: 0, costX: 1664 }
    };

    let ECO_DATA = { 
        demand: { fuel:0, health:0, repair:0, supply:0 }, 
        supply: { fuel:0, health:0, repair:0, supply:0 }, 
        dovx: { rewards:0, burn:0 },
        scanned: { buildings:0, divisions:0, totalExpected: 0 }
    };

    function getDovxClaim(power) {
        if (power >= DOVX_CLAIM_LEVELS.win.minPower) return "win";
        if (power >= DOVX_CLAIM_LEVELS.draw.minPower) return "draw";
        if (power >= DOVX_CLAIM_LEVELS.lost.minPower) return "lost";
        return null;
    }

    async function robustFetch(code, table, lowerBound, limit=500) {
        const server = RPCS[rpcIndex % RPCS.length];
        try {
            document.getElementById('rpcStatus').innerText = "RPC: " + new URL(server).hostname;
            const res = await fetch(server + "/v1/chain/get_table_rows", {
                method: 'POST',
                body: JSON.stringify({ json: true, code: code, scope: code, table: table, limit: limit, lower_bound: lowerBound })
            });
            const data = await res.json();
            rpcConsecutiveErrors = 0;
            return data;
        } catch(e) { 
            rpcIndex++; 
            rpcConsecutiveErrors++;
            if(rpcConsecutiveErrors > 5) log("ALERTE : Tunnels RPC dÃ©gradÃ©s. Scan Ã  risque.", "var(--alert)");
            return null; 
        }
    }

    async function startEconomyScan() {
        switchView('ecoView'); stopSignal = false; document.getElementById('btnStop').style.display = 'block';
        ECO_DATA = { demand: { fuel:0, health:0, repair:0, supply:0 }, supply: { fuel:0, health:0, repair:0, supply:0 }, dovx: { rewards:0, burn:0 }, scanned: { buildings:0, divisions:0, totalExpected: 0 }};
        
        let nextKey = ""; let hasMore = true;
        log("Initialisation Audit CFO (Evidence-Grade)...", "var(--gold)");

        // ðŸ—ï¸ SCAN EXHAUSTIF BÃ‚TIMENTS
        while(hasMore && !stopSignal) {
            const d = await robustFetch("dovutilstake", "buildings", nextKey);
            if(!d || !d.rows) break;
            d.rows.forEach(b => {
                let p = b.power[0]; let v = parseFloat(p) || 0;
                if(p.includes("DOVF")) ECO_DATA.supply.fuel += v;
                else if(p.includes("DOVH")) ECO_DATA.supply.health += v;
                else if(p.includes("DOVR")) ECO_DATA.supply.repair += v;
                else if(p.includes("DOVS")) ECO_DATA.supply.supply += v;
                ECO_DATA.scanned.buildings++;
            });
            updateEcoUI(d.more);
            if(d.more) nextKey = d.next_key; else hasMore = false;
        }

        // ðŸŽ–ï¸ SCAN EXHAUSTIF DIVISIONS
        nextKey = ""; hasMore = true;
        while(hasMore && !stopSignal) {
            const d = await robustFetch("dovpvecontrl", "sdivisions", nextKey);
            if(!d || !d.rows) break;
            d.rows.forEach(r => {
                const zid = r.zone_id || r.zoneID;
                const busy = r.end_time > (Date.now()/1000);
                if(busy && ZONE_DB[zid]) {
                    const z = ZONE_DB[zid];
                    ECO_DATA.demand.fuel += z.cost; ECO_DATA.demand.health += z.cost;
                    ECO_DATA.demand.repair += z.cost; ECO_DATA.demand.supply += z.cost;
                    ECO_DATA.dovx.burn += z.costX;
                    const power = r.power || r.min_power || 0;
                    const claim = getDovxClaim(power);
                    if(claim) ECO_DATA.dovx.rewards += DOVX_CLAIM_LEVELS[claim].reward;
                }
                ECO_DATA.scanned.divisions++;
            });
            updateEcoUI(d.more);
            if(d.more) nextKey = d.next_key; else hasMore = false;
        }
        log("Audit CertifiÃ© : " + (ECO_DATA.scanned.buildings + ECO_DATA.scanned.divisions) + " objets scannÃ©s.", "var(--main)");
        document.getElementById('btnStop').style.display = 'none';
    }

    function updateEcoUI(isStillScanning) {
        // Logique de rendu visuel V43
        let statusColor = isStillScanning ? "var(--warn)" : "var(--main)";
        let statusText = isStillScanning ? "ðŸ•’ SCAN IN PROGRESS" : "ðŸŸ¢ 100% INTEGRITY";
        if(rpcConsecutiveErrors > 3) { statusColor = "var(--alert)"; statusText = "ðŸ”´ RPC DEGRADED"; }

        document.getElementById('integrityContainer').innerHTML = `<span class="integrity-badge" style="background:rgba(0,0,0,0.5); border:1px solid ${statusColor}; color:${statusColor}">${statusText} (${ECO_DATA.scanned.buildings + ECO_DATA.scanned.divisions} rows)</span>`;
    }

    function switchView(id) {
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('view-active'));
        document.getElementById(id).classList.add('view-active');
    }

    function log(msg, color="#aaa") {
        const c = document.getElementById('console');
        c.innerHTML = `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>` + c.innerHTML;
    }

    function init() {
        document.getElementById('zonesArea').innerHTML = "<div style='color:#444; padding:20px;'>En attente de scan certifiÃ©.</div>";
    }
    init();
</script>
</body>
</html>
