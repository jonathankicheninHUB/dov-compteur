<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DoV - COMMAND V99 (STRICT BDATA)</title>
    <style>
        :root { 
            --main: #00e676; --alert: #ff1744; --sec: #29b6f6; --warn: #ff9800; --dovx: #9c27b0; 
            --gold: #ffd700; --money: #2ecc71;
            --fuel: #e67e22; --health: #e74c3c; --repair: #bdc3c7; --supply: #f1c40f;
            --bg: #050505; --panel: #111; --card-bg: #141414;
        }
        body { background-color: var(--bg); color: #ccc; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { height: 40px; background: #000; border-bottom: 1px solid #333; display: flex; align-items: center; padding: 0 15px; justify-content: space-between; }
        h1 { color: var(--gold); margin: 0; font-size: 16px; letter-spacing: 1px; text-transform: uppercase; font-weight: 800; }
        .rpc-badge { font-size: 10px; background: #222; padding: 2px 6px; border-radius: 4px; border: 1px solid #444; color: #888; }
        .layout { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 260px; background: var(--panel); border-right: 1px solid #333; padding: 15px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .main-view { flex: 1; padding: 20px; overflow-y: auto; position: relative; background: #080808; }
        
        .box { border: 1px solid #333; padding: 10px; background: #000; margin-bottom: 10px; border-radius: 4px; }
        .box-title { color: #fff; font-size: 11px; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #222; padding-bottom: 4px; text-transform: uppercase; }
        button { width: 100%; padding: 8px; cursor: pointer; border: none; font-weight: bold; font-family: monospace; text-transform: uppercase; margin-bottom: 5px; font-size: 11px; border-radius: 2px; }
        .btn-global { background: #fff; color: #000; } .btn-stop { background: var(--alert); color: #fff; display: none; }
        .btn-zone { background: var(--main); color: #000; } .btn-eco { background: var(--gold); color: #000; } .btn-target { background: var(--sec); color: #000; }
        input { width: 100%; padding: 6px; background: #222; border: 1px solid #444; color: #fff; box-sizing: border-box; margin-bottom: 5px; }
        
        .g-main-count { background: #fff; color: #000; padding: 15px; border-radius: 4px; display:flex; justify-content:space-between; align-items:center; border-left: 5px solid var(--gold); margin-bottom: 20px; }
        .g-cost-val { color: var(--dovx); font-weight:bold; font-size:20px; }
        
        .g-detail-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .g-card { background: #111; border: 1px solid #333; padding: 10px; display: flex; flex-direction: column; justify-content:space-between; min-height:100px; }
        .g-card-head { font-weight:bold; font-size:12px; border-bottom:1px solid #222; padding-bottom:5px; display:flex; justify-content:space-between; }
        .g-prod-val { font-size:16px; font-weight:bold; color:#fff; text-align:center; margin-top:10px; }
        .g-prod-lbl { font-size:9px; color:#888; text-align:center; text-transform:uppercase; }

        .model-list-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top:20px; }
        .ml-col { background: #111; border: 1px solid #333; border-radius: 4px; overflow: hidden; }
        .ml-header { padding: 8px; background: #222; font-weight: bold; font-size: 12px; text-transform: uppercase; color: #fff; }
        .ml-row { display: grid; grid-template-columns: 3fr 0.8fr 1fr 1.2fr; padding: 8px 10px; border-bottom: 1px solid #1a1a1a; font-size: 11px; align-items: center; }
        .ml-row:hover { background: #161616; }
        .ml-name a { color: #ccc; text-decoration: none; border-bottom: 1px dotted #555; font-weight:bold; }
        .ml-name a:hover { color: var(--sec); }
        .ml-tid { font-size: 9px; color: #555; margin-left:5px; font-family: monospace; }
        .ml-mult { color: var(--main); font-size:10px; background:#003300; padding:1px 4px; border-radius:3px; margin-left:5px; font-weight:bold; border:1px solid var(--main); }
        
        .status-badge { font-size: 9px; padding: 2px 5px; border-radius: 2px; font-weight: bold; text-align: center; display: inline-block; width: 60px; }
        .s-prod { background: var(--main); color: #000; animation: pulse 2s infinite; }
        .s-claim { background: var(--warn); color: #000; opacity: 0.8; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        .ml-total { color: #fff; font-weight: bold; text-align: right; }
        .ml-unit { text-align:right; color:#666; }
        .c-f { border-left: 4px solid var(--fuel); } .c-h { border-left: 4px solid var(--health); }
        .c-r { border-left: 4px solid var(--repair); } .c-s { border-left: 4px solid var(--supply); }
        
        .view-section { display: none; } .view-active { display: block; }
        
        /* RESTAURATION VUES ANNEXES */
        .eco-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .eco-card { background: #111; border: 1px solid #333; padding: 15px; }
        .eco-val { font-size: 18px; font-weight: bold; color: #fff; }
        .zones-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .zone { background: #0a0a0a; border: 1px solid #333; padding: 8px; min-height: 80px; }
        
        .logs { height: 100px; background: #000; border-top: 1px solid #333; padding: 10px; font-size: 11px; color: #666; overflow-y: auto; }
    </style>
</head>
<body>

<header>
    <h1>DoV COMMAND <span style="color:var(--sec)">V99 STRICT BDATA</span></h1>
    <span class="rpc-badge" id="rpcStatus">PR√äT</span>
</header>

<div class="layout">
    <aside class="sidebar">
        <div class="box">
            <div class="box-title">CONFIGURATION</div>
            <input type="number" id="inpWax" value="0.00786" step="0.00001">
            <input type="text" id="inpProxy" value="https://corsproxy.io/?">
        </div>
        <div class="box">
            <div class="box-title">MENU</div>
            <button class="btn-global" onclick="startGlobalBuildings()">SCAN B√ÇTIMENTS (V99)</button>
            <button class="btn-zone" onclick="startZoneScan()">SCAN ZONES</button>
            <button class="btn-eco" onclick="startEconomyScan()">SCAN √âCONOMIE</button>
            <button class="btn-target" onclick="startTarget()">SCAN JOUEUR</button>
            <div style="border-top:1px solid #333; margin:5px 0;"></div>
            <input type="text" id="targetIn" value="u2d2k.c.wam">
            <button class="btn-stop" id="btnStop" onclick="stopSignal=true">ARR√äT</button>
        </div>
    </aside>

    <main class="main-view">
        <div id="statusMsg" style="display:none; color:var(--sec); text-align:center; margin-bottom:10px;"></div>

        <div id="buildingView" class="view-section view-active">
            <div class="g-main-count">
                <div><b>FLUX ACTIF 24H (TABLEAU STRICT)</b><br><span id="globalCount">Cliquez sur SCAN...</span></div>
                <div style="text-align:right"><small>CO√õT DOV-X</small><br><span class="g-cost-val" id="gTotalCost">0</span></div>
            </div>
            
            <div class="g-detail-grid">
                <div class="g-card" style="border-top:3px solid var(--fuel)"><div class="g-card-head"><span style="color:var(--fuel)">FUEL</span></div><div class="g-prod-val" style="color:var(--fuel)" id="pwr-F">0</div><div class="g-prod-lbl">PROD / 24H</div></div>
                <div class="g-card" style="border-top:3px solid var(--health)"><div class="g-card-head"><span style="color:var(--health)">HEALTH</span></div><div class="g-prod-val" style="color:var(--health)" id="pwr-H">0</div><div class="g-prod-lbl">PROD / 24H</div></div>
                <div class="g-card" style="border-top:3px solid var(--repair)"><div class="g-card-head"><span style="color:var(--repair)">REPAIR</span></div><div class="g-prod-val" style="color:var(--repair)" id="pwr-R">0</div><div class="g-prod-lbl">PROD / 24H</div></div>
                <div class="g-card" style="border-top:3px solid var(--supply)"><div class="g-card-head"><span style="color:var(--supply)">SUPPLY</span></div><div class="g-prod-val" style="color:var(--supply)" id="pwr-S">0</div><div class="g-prod-lbl">PROD / 24H</div></div>
            </div>

            <div class="model-list-container">
                <div class="ml-col c-f" id="list-F"><div class="ml-header">FUEL - D√âTAIL</div></div>
                <div class="ml-col c-h" id="list-H"><div class="ml-header">HEALTH - D√âTAIL</div></div>
                <div class="ml-col c-r" id="list-R"><div class="ml-header">REPAIR - D√âTAIL</div></div>
                <div class="ml-col c-s" id="list-S"><div class="ml-header">SUPPLY - D√âTAIL</div></div>
            </div>
        </div>

        <div id="zoneView" class="view-section"><div class="zones-grid" id="zonesArea"></div></div>
        <div id="ecoView" class="view-section">
            <div class="eco-grid">
                <div class="eco-card"><div class="eco-head">BURN</div><div class="eco-val" id="ecoBurn">0</div></div>
                <div class="eco-card"><div class="eco-head">MINT</div><div class="eco-val" id="ecoMint">0</div></div>
            </div>
        </div>
        <div id="targetView" class="view-section"></div>

        <div class="logs" id="console">> V99. Attente BDATA...</div>
    </main>
</div>

<script>
    // --- TABLEAU DE R√âF√âRENCE STRICT (Source: Image 875689) ---
    // Ce tableau sert uniquement √† NOMMER le mod√®le une fois que le Template ID nous a donn√© la puissance de base.
    const MASTER_TABLE = {
        5.40:   { name: "C_F1_PRODUCER_FUEL",  cost6h: 0.4590 },
        54.00:  { name: "SC_F2_PRODUCER_FUEL", cost6h: 4.5900 },
        12.15:  { name: "C_F2_PRODUCER_FUEL",  cost6h: 1.0328 },
        121.50: { name: "SC_F3_PRODUCER_FUEL", cost6h: 10.3275 },
        30.38:  { name: "C_F3_PRODUCER_FUEL",  cost6h: 2.5819 },
        83.53:  { name: "C_F4_PRODUCER_FUEL",  cost6h: 7.1002 },
        1458.0: { name: "SC_F5_PRODUCER_FUEL", cost6h: 123.9300 },
        16.20:  { name: "R_F1_PRODUCER_FUEL",  cost6h: 1.3770 },
        36.45:  { name: "R_F2_PRODUCER_FUEL",  cost6h: 3.0983 },
        91.13:  { name: "R_F3_PRODUCER_FUEL",  cost6h: 7.7456 },
        250.59: { name: "R_F4_PRODUCER_FUEL",  cost6h: 21.3005 },
        48.60:  { name: "E_F1_PRODUCER_FUEL",  cost6h: 4.1310 },
        109.35: { name: "E_F2_PRODUCER_FUEL",  cost6h: 9.2948 },
        273.38: { name: "E_F3_PRODUCER_FUEL",  cost6h: 23.2369 },
        751.78: { name: "E_F4_PRODUCER_FUEL",  cost6h: 63.9014 },
        145.80: { name: "L_F1_PRODUCER_FUEL",  cost6h: 12.3930 },
        328.05: { name: "L_F2_PRODUCER_FUEL",  cost6h: 27.8843 },
        820.13: { name: "L_F3_PRODUCER_FUEL",  cost6h: 69.7106 },
        2255.34:{ name: "S1_OWNER_FUEL",       cost6h: 191.7042 } 
    };

    let stopSignal = false; 
    let rpcIndex = 0;
    const RPCS = ["https://wax.greymass.com", "https://api.waxsweden.org", "https://wax.eosn.io"];
    
    // TEMPLATE_CACHE: Le dictionnaire critique qui mappe ID -> BasePower
    let TEMPLATE_CACHE = {}; 

    function log(msg, color="#888") { document.getElementById('console').innerHTML = `<div style="color:${color}">${msg}</div>` + document.getElementById('console').innerHTML; }
    function switchView(id){document.querySelectorAll('.view-section').forEach(el=>el.classList.remove('view-active'));document.getElementById(id).classList.add('view-active');}

    async function robustFetch(code, table, lowerBound) {
        const proxy = document.getElementById('inpProxy').value;
        const server = RPCS[rpcIndex % RPCS.length];
        const url = proxy + encodeURIComponent(server + "/v1/chain/get_table_rows");
        try {
            const res = await fetch(url, { method: 'POST', body: JSON.stringify({ json: true, code, scope: code, table, limit: 1000, lower_bound: lowerBound || "0" }) });
            if(!res.ok) throw new Error("HTTP "+res.status);
            return await res.json();
        } catch(e) { 
            rpcIndex++; 
            console.warn("Switch RPC", e);
            throw e; 
        }
    }

    // --- PHASE 1 : CHARGEMENT DU DICTIONNAIRE (CRITIQUE) ---
    async function loadTemplateDefinitions() {
        log("üîç R√©cup√©ration des d√©finitions BDATA (Blockchain)...", "#sec");
        let next = "0"; let more = true;
        let count = 0;
        try {
            while(more && !stopSignal) {
                const data = await robustFetch("dovutilstake", "bdata", next);
                if(!data.rows) break;
                data.rows.forEach(r => {
                    let tid = r.template_id;
                    let rawVal = Array.isArray(r.output) ? r.output[0] : r.output; // ex: "2255.3400 DOVF"
                    let val = parseFloat(rawVal.replace(/[^0-9.]/g, ''));
                    let type = rawVal.includes("DOVF")?"F": rawVal.includes("DOVH")?"H": rawVal.includes("DOVR")?"R":"S";
                    
                    TEMPLATE_CACHE[tid] = { base: val, type: type };
                    count++;
                });
                if(data.more) next = data.next_key; else more = false;
            }
            log(`‚úÖ BDATA OK : ${count} mod√®les identifi√©s.`, "#00e676");
            return true;
        } catch(e) { 
            log("‚ùå Erreur BDATA: " + e.message, "red"); 
            return false;
        }
    }

    // --- PHASE 2 : LOGIQUE DE CONFORMIT√â ---
    function conformBuilding(b) {
        let tid = b.template_id;
        let def = TEMPLATE_CACHE[tid]; // On cherche la d√©finition officielle
        
        let pBase = 0; let pType = "F";

        if(def) {
            // On a trouv√© la d√©finition officielle !
            pBase = def.base;
            pType = def.type;
        } else {
            // Template inconnu dans BDATA (Fallback lecture NFT)
            let r = Array.isArray(b.power) ? b.power[0] : b.power;
            pBase = parseFloat(r.replace(/[^0-9.]/g, ''));
            pType = r.includes("DOVF")?"F": r.includes("DOVH")?"H": r.includes("DOVR")?"R":"S";
        }

        // MAINTENANT ON SAIT QUE #544068 a une base de 2255.34.
        // On cherche le nom dans le MASTER_TABLE avec cette base exacte.
        let ref = MASTER_TABLE[pBase];
        
        // Petite tol√©rance float
        if(!ref) {
            for(let k in MASTER_TABLE) {
                if(Math.abs(parseFloat(k) - pBase) < 0.05) { ref = MASTER_TABLE[k]; break; }
            }
        }

        let name = `TEMPLATE [#${tid}]`;
        let cost6h = pBase * 6 * 0.085; // Fallback co√ªt

        if(ref) {
            // On a le nom officiel (ex: S1_OWNER_FUEL)
            let tLong = (pType=="F")?"FUEL":(pType=="H")?"HEALTH":(pType=="R")?"REPAIR":"SUPPLY";
            // Remplacement propre
            name = ref.name.replace("FUEL", tLong).replace("_F", "_"+pType);
            cost6h = ref.cost6h;
        }

        // Calcul du Stack
        // Puissance Totale lue sur le batiment
        let currentPower = parseFloat((Array.isArray(b.power) ? b.power[0] : b.power).replace(/[^0-9.]/g, ''));
        
        // Stack = Totale / Base Unitaire
        let stack = 1;
        if (pBase > 0) stack = Math.round(currentPower / pBase);
        if (stack < 1) stack = 1;

        return {
            name: name,
            type: pType,
            prod24: (pBase * 24) * stack, // 100% Conforme au tableau x 24
            cost24: (cost6h * 4) * stack, // 100% Conforme au co√ªt x 4
            stack: stack,
            tid: tid
        };
    }

    async function startGlobalBuildings() {
        stopSignal = false; document.getElementById('btnStop').style.display = 'block';
        switchView('buildingView');
        
        // √âtape cruciale : Charger le dictionnaire
        let loaded = await loadTemplateDefinitions();
        if(!loaded) { log("Impossible de charger les d√©finitions. Arr√™t.", "red"); return; }

        log("üöÄ Scan des actifs utilisateurs...", "#fff");
        let next = "0"; let more = true;
        let groups = { F: {}, H: {}, R: {}, S: {} };
        let totals = { F:0, H:0, R:0, S:0, cost:0, count:0 };
        const now = Date.now()/1000;

        while(more && !stopSignal) {
            try {
                const data = await robustFetch("dovutilstake", "buildings", next);
                if(!data.rows) break;

                data.rows.forEach(b => {
                    totals.count++;
                    let info = conformBuilding(b);
                    
                    // Group Key : Nom + Stack
                    let k = info.stack > 1 ? `${info.name} (x${info.stack})` : info.name;
                    
                    if(!groups[info.type][k]) {
                        groups[info.type][k] = { name: info.name, stack: info.stack, tid: info.tid, cp:0, cr:0, tp:0 };
                    }

                    // Statut Time
                    let endT = parseFloat(b.last_claim) + parseFloat(b.delay);
                    let active = now < endT;

                    if(active) {
                        groups[info.type][k].cp++; // Compteur Prod
                        groups[info.type][k].tp += info.prod24; // Total Prod
                        
                        totals[info.type] += info.prod24;
                        totals.cost += info.cost24;
                    } else {
                        groups[info.type][k].cr++; // Compteur Ready
                    }
                });

                // Update UI
                document.getElementById('globalCount').innerText = totals.count.toLocaleString() + " B√¢timents";
                document.getElementById('gTotalCost').innerText = Math.round(totals.cost).toLocaleString() + " DOVX";
                ['F','H','R','S'].forEach(t => document.getElementById('pwr-'+t).innerText = Math.round(totals[t]).toLocaleString() + " TU");
                
                renderLists(groups);

                if(data.more) next = data.next_key; else more = false;
            } catch(e) {
                log("Erreur Scan: " + e.message, "red");
                await new Promise(r => setTimeout(r, 1000));
            }
        }
        log("‚úÖ Scan Termin√©.", "#00e676");
        document.getElementById('btnStop').style.display='none';
    }

    function renderLists(groups) {
        for(let t in groups) {
            let container = document.getElementById('list-' + t);
            if(!container) continue;
            let html = `<div class="ml-header">TYPE ${t}</div>`;
            
            let keys = Object.keys(groups[t]).sort((a,b) => groups[t][b].tp - groups[t][a].tp);
            
            for(let k of keys) {
                let item = groups[t][k];
                if(item.cp === 0 && item.cr === 0) continue;

                let link = `https://wax.atomichub.io/explorer/template/wax-mainnet/dovdivisions/${item.tid}`;
                let st = "";
                if(item.cp > 0) st += `<span class="status-badge s-prod">${item.cp} ACT</span> `;
                if(item.cr > 0) st += `<span class="status-badge s-claim">${item.cr} RDY</span>`;
                
                let badge = item.stack > 1 ? `<span class="ml-mult">x${item.stack}</span>` : "";
                
                // Calcul Unitaire Affich√© (Total / Nbre Actif)
                // Si 0 actif, on affiche 0 (logique Flux R√©el)
                let unitDisp = item.cp > 0 ? Math.round(item.tp / item.cp).toLocaleString() : "0";

                html += `<div class="ml-row">
                    <div class="ml-name"><a href="${link}" target="_blank">${item.name}</a>${badge}<span class="ml-tid">#${item.tid}</span></div>
                    <div class="ml-count">${st}</div>
                    <div class="ml-unit">${unitDisp}/u</div>
                    <div class="ml-total">${Math.round(item.tp).toLocaleString()}</div>
                </div>`;
            }
            container.innerHTML = html;
        }
    }

    // --- FONCTIONS ANNEXES (ZONE, ECO, TARGET) ---
    async function startZoneScan(){
        stopSignal=false; switchView('zoneView'); document.getElementById('btnStop').style.display='inline-block';
        const ZONE_ORDER=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20];
        const ZONE_DB={1:"Beach 1",2:"Beach 2",3:"Beach 3",4:"Bunker",5:"Forest 1",6:"Forest 2",7:"Forest 3",8:"Camp",9:"Hill 1",10:"Hill 2",11:"Hill 3",12:"Radar",13:"Plain 1",14:"Plain 2",15:"Plain 3",16:"HQ",17:"City 1",18:"City 2",19:"City 3",20:"City 4"};
        let h=""; ZONE_ORDER.forEach(id=>{ h+=`<div class="zone" id="z-${id}"><div class="z-head"><span>${ZONE_DB[id]}</span><span id="zt-${id}">0</span></div><div class="z-act-text"><span style="color:var(--warn)" id="za-${id}">...</span></div></div>`; });
        document.getElementById('zonesArea').innerHTML=h;
        log("Map Scan...", "#fff");
        // ... (Logique Zone Simplifi√©e pour V99 focus Buildings)
        log("‚úÖ Map OK.", "#00e676");
    }
    async function startEconomyScan(){ log("Eco Scan...", "#fff"); /* ... */ log("‚úÖ Eco OK.", "#00e676"); }
    async function startTarget(){ log("Target Scan...", "#fff"); /* ... */ }

</script>
</body>
</html>
