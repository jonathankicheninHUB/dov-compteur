<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoV - Debug Mode</title>
    <style>
        body { font-family: monospace; background-color: #222; color: #ddd; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: #333; padding: 20px; border: 1px solid #555; }
        h1 { color: #fff; margin-top: 0; }
        
        input { padding: 10px; width: 60%; background: #000; color: #0f0; border: 1px solid #555; font-family: monospace; }
        button { padding: 10px 20px; cursor: pointer; background: #007bff; color: white; border: none; font-weight: bold; }
        button:hover { background: #0056b3; }
        button:disabled { background: #555; cursor: wait; }

        .console-log {
            background: black;
            color: #0f0;
            padding: 15px;
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #0f0;
            margin-top: 20px;
            font-size: 13px;
            white-space: pre-wrap; /* Garde les sauts de ligne */
        }

        .error-msg { color: #ff3333; font-weight: bold; }
        .success-msg { color: #33ff33; font-weight: bold; }
        .info-msg { color: #ffff33; }

        .asset-link { color: #00bfff; text-decoration: none; display: block; margin: 2px 0; }
        .asset-link:hover { text-decoration: underline; }
    </style>
</head>
<body>

<div class="container">
    <h1>CONSOLE DE DÉBUG DOV</h1>
    <p>Si ça ne marche pas, regarde la boîte noire ci-dessous.</p>
    
    <div>
        <input type="text" id="acc" placeholder="Nom du compte (ex: tonnom.wam)">
        <button id="btn" onclick="runDebug()">LANCER LE TEST</button>
    </div>

    <div class="console-log" id="logs"> > En attente de l'utilisateur...</div>
</div>

<script>
    // On utilise un seul nœud très permissif pour commencer
    const RPC = "https://wax.greymass.com/v1/chain/get_table_rows";

    function log(msg, type = "") {
        const consoleBox = document.getElementById('logs');
        const time = new Date().toLocaleTimeString();
        let colorClass = "";
        if(type === "error") colorClass = "error-msg";
        if(type === "success") colorClass = "success-msg";
        if(type === "info") colorClass = "info-msg";

        consoleBox.innerHTML += `<div class="${colorClass}">[${time}] ${msg}</div>`;
        consoleBox.scrollTop = consoleBox.scrollHeight; // Scroll automatique vers le bas
    }

    async function runDebug() {
        const account = document.getElementById('acc').value.trim().toLowerCase();
        const btn = document.getElementById('btn');
        
        if (!account) { log("ERREUR: Tu n'as pas mis de nom de compte !", "error"); return; }

        btn.disabled = true;
        document.getElementById('logs').innerHTML = " > Démarrage du script...\n"; // Reset
        
        log(`Compte ciblé : ${account}`);
        log(`Tentative de connexion à : ${RPC}`);

        try {
            // Étape 1 : Création de la requête
            const payload = {
                json: true,
                code: "dovpvecontrl",
                scope: "dovpvecontrl",
                table: "sdivisions",
                index_position: 2,
                key_type: "i64",
                lower_bound: account,
                upper_bound: account,
                limit: 100
            };

            log("Envoi de la requête réseau...", "info");

            // Étape 2 : L'appel réseau (Fetch)
            const response = await fetch(RPC, {
                method: "POST",
                headers: {
                    "Content-Type": "text/plain" // Astuce pour éviter le blocage CORS OPTIONS
                },
                body: JSON.stringify(payload)
            });

            log(`Réponse serveur reçue. Code: ${response.status}`);

            if (!response.ok) {
                throw new Error(`Erreur HTTP : ${response.status} ${response.statusText}`);
            }

            // Étape 3 : Lecture des données
            const data = await response.json();
            log("Données JSON décodées.", "success");

            if (!data.rows) {
                log("ERREUR: Le serveur n'a pas renvoyé de lignes (rows).", "error");
                console.log(data); // Pour le vrai débugger navigateur
                btn.disabled = false;
                return;
            }

            // Étape 4 : Filtrage
            const myDivisions = data.rows.filter(r => r.user === account);
            log(`Trouvé ${data.rows.length} résultats bruts.`);
            log(`Après filtre "${account}": ${myDivisions.length} divisions trouvées.`, "success");

            if (myDivisions.length === 0) {
                log("ATTENTION: 0 division trouvée. Es-tu sûr que ce compte a des unités STAKÉES ?", "info");
                log("Si elles sont dans ton inventaire AtomicHub, elles n'apparaissent pas ici.");
            }

            // Étape 5 : Affichage des assets
            let assetCount = 0;
            myDivisions.forEach(div => {
                if(div.asset_ids && div.asset_ids.length > 0) {
                    div.asset_ids.forEach(id => {
                        assetCount++;
                        log(`Asset trouvé: ${id} (Div #${div.division_id})`);
                        // Ajout lien cliquable
                        document.getElementById('logs').innerHTML += 
                            `<a href="https://wax.atomichub.io/explorer/asset/${id}" target="_blank" class="asset-link">   -> Voir l'asset ${id}</a>`;
                    });
                }
            });

            log(`FINI. Total assets affichés : ${assetCount}`, "success");

        } catch (error) {
            log("--- CRASH DU SCRIPT ---", "error");
            log(error.message, "error");
            log("Si l'erreur est 'Failed to fetch', c'est que ton réseau ou le navigateur bloque l'accès à WAX.", "info");
        }

        btn.disabled = false;
    }
</script>

</body>
</html>
