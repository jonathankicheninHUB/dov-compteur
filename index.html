<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DoV - COMMAND V318 (FULL MAP)</title>
    <style>
        :root {
            --bg-app: #0b0c10; --bg-panel: #13141b; --bg-header: #1c1d26; --border: #2d2e3a;
            --green: #00f090; --red: #ff3b30; --blue: #2979ff; --orange: #ff9100; --purple: #d500f9; --yellow: #ffea00;
            --text-main: #e0e0e0; --text-muted: #858595;
            --font-ui: 'Inter', system-ui, sans-serif; --font-num: 'JetBrains Mono', 'Consolas', monospace; 
        }
        body { background: var(--bg-app); color: var(--text-muted); font-family: var(--font-ui); margin: 0; display: flex; height: 100vh; overflow: hidden; font-size: 11px; }
        * { box-sizing: border-box; }
        ::-webkit-scrollbar { width: 6px; background: var(--bg-app); } ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .layout { display: flex; width: 100%; height: 100%; }
        .sidebar { width: 280px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 15px; gap: 15px; flex-shrink: 0; z-index: 10; }
        .main-content { flex: 1; overflow-y: auto; padding: 25px; background: linear-gradient(180deg, var(--bg-app) 0%, #08080a 100%); display:flex; flex-direction:column; }
        .app-title { color: #fff; font-weight: 800; font-size: 14px; letter-spacing: 1px; display:flex; align-items:center; gap:8px; margin-bottom: 10px; }
        .status-dot { width: 8px; height: 8px; background: var(--green); border-radius: 50%; box-shadow: 0 0 8px var(--green); }
        .control-group { display: flex; flex-direction: column; gap: 8px; }
        .grp-lbl { font-size: 9px; font-weight: 700; color: #555; text-transform: uppercase; letter-spacing: 0.5px; }
        input { background: #08080a; border: 1px solid #333; color: #fff; padding: 8px; border-radius: 4px; font-family: var(--font-num); width: 100%; }
        button { padding: 9px; border: none; border-radius: 4px; font-weight: 700; font-size: 10px; text-transform: uppercase; cursor: pointer; transition: 0.2s; width: 100%; }
        button:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-green { background: var(--green); color: #000; } .btn-red { background: rgba(255, 59, 48, 0.15); color: var(--red); border: 1px solid rgba(255, 59, 48, 0.3); }
        .btn-blue { background: var(--blue); color: #fff; } .btn-orange { background: var(--orange); color: #000; }
        .btn-purple { background: var(--purple); color: #fff; } .btn-yellow { background: var(--yellow); color: #000; }
        .btn-ghost { background: transparent; border: 1px solid #333; color: #888; }
        .btn-row { display: flex; gap: 8px; }
        .console-log { flex: 1; background: #000; border: 1px solid #333; border-radius: 4px; padding: 10px; font-family: var(--font-num); font-size: 9px; color: #0f0; overflow-y: auto; white-space: pre-wrap; display: flex; flex-direction: column-reverse; max-height: 300px; margin-top: auto; }
        .log-entry { margin-bottom: 2px; border-bottom: 1px solid #111; padding-bottom: 2px; }
        .log-time { color: #555; margin-right: 5px; }
        .dashboard-header { display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 15px; border-bottom: 1px solid var(--border); margin-bottom: 25px; }
        .page-h1 { font-size: 20px; font-weight: 800; color: #fff; margin: 0; }
        .total-cost { text-align: right; }
        .tc-val { font-family: var(--font-num); font-size: 28px; font-weight: 800; color: var(--purple); text-shadow: 0 0 10px rgba(213, 0, 249, 0.3); } 
        .tc-unit { color: #888; font-size: 12px; font-weight: 700; }
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
        .kpi-card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; padding: 15px; position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between; min-height: 140px; }
        .kpi-card::before { content:''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
        .kc-title { font-size: 10px; font-weight: 700; color: #888; text-transform: uppercase; }
        .kc-val { font-family: var(--font-num); font-size: 20px; font-weight: 700; color: #fff; margin-top: 2px; }
        .kc-val-huge { font-family: var(--font-num); font-size: 26px; font-weight: 800; color: #fff; margin-top: 2px; letter-spacing: -1px; }
        .kc-sub { font-size: 10px; color: #666; font-family: var(--font-num); margin-top: auto; }
        .kc-sep { height:1px; background:rgba(255,255,255,0.1); margin:8px 0; }
        .fuel .kpi-card::before { background: var(--orange); } .fuel .kc-val, .fuel .kc-val-huge { color: var(--orange); } 
        .health .kpi-card::before { background: var(--red); } .health .kc-val, .health .kc-val-huge { color: var(--red); } 
        .repair .kpi-card::before { background: var(--blue); } .repair .kc-val, .repair .kc-val-huge { color: var(--blue); } 
        .supply .kpi-card::before { background: var(--yellow); } .supply .kc-val, .supply .kc-val-huge { color: var(--yellow); } 
        .eco .kpi-card::before { background: #fff; }
        .pie-container { display: flex; align-items: center; justify-content: center; height: 100%; }
        .pie-chart { width: 80px; height: 80px; border-radius: 50%; background: conic-gradient(var(--green) 0% 0%, #333 0% 100%); display: flex; align-items: center; justify-content: center; position: relative; }
        .pie-chart::after { content: ''; position: absolute; width: 60px; height: 60px; background: var(--bg-panel); border-radius: 50%; }
        .pie-val { position: absolute; z-index: 2; font-family: var(--font-num); font-weight: 700; color: #fff; font-size: 14px; }
        .tables-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start; }
        .data-panel { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; display: flex; flex-direction: column; }
        .dp-head { padding: 10px 15px; background: var(--bg-header); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .dp-title { font-weight: 800; font-size: 11px; color: #fff; text-transform: uppercase; }
        .dp-badges { display: flex; gap: 8px; font-family: var(--font-num); font-size: 10px; }
        .dt-grid { display: grid; grid-template-columns: minmax(140px, 2fr) 50px 70px 90px 90px 90px 70px 70px; }
        .dt-header { padding: 8px 12px; font-size: 9px; font-weight: 700; color: #666; text-transform: uppercase; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2); }
        .dt-row { padding: 6px 12px; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 11px; align-items: center; color: #ccc; transition: 0.1s; }
        .dt-row:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .cell { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .c-right { text-align: right; justify-content: flex-end; }
        .c-center { text-align: center; justify-content: center; }
        .zones-map { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .zone-card { background: var(--bg-panel); border: 1px solid var(--border); padding: 10px; border-radius: 4px; display: flex; flex-direction: column; justify-content: space-between; height: 160px; cursor: pointer; transition: 0.2s; }
        .zone-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); border-color: var(--blue); }
        .zone-card.active { border-color: var(--blue); background: rgba(41, 121, 255, 0.05); }
        .zc-top { display: flex; justify-content: space-between; font-weight: 700; color: #fff; font-size: 11px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 4px; margin-bottom: 6px;}
        .zc-mid { display: flex; flex-direction: column; gap: 4px; flex: 1; }
        .zs-item { display: flex; justify-content: space-between; font-family: var(--font-num); font-size: 9px; color: #888; }
        .zc-bot { display: flex; justify-content: space-between; font-size: 10px; font-family: var(--font-num); border-top: 1px solid rgba(255,255,255,0.05); padding-top:4px; margin-top: auto; }
        .tc-f { color: var(--orange); } .tc-h { color: var(--red); } .tc-r { color: var(--blue); } .tc-s { color: var(--yellow); }
        .view-section { display: none; } .active-view { display: block; }
        a.atomic { color: inherit; text-decoration: none; border-bottom: 1px dotted #444; }
        a.atomic:hover { color: var(--blue); border-bottom-color: var(--blue); }
        .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:999; justify-content:center; align-items:center; }
        .modal-box { width:650px; background:var(--bg-panel); border:1px solid var(--border); padding:20px; border-radius:6px; box-shadow:0 20px 50px #000; max-height:90vh; overflow-y:auto; }
        .market-ticker { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-bottom: 20px; }
        .ticker-item { background: #191a21; border: 1px solid #333; padding: 10px; border-radius: 4px; text-align: center; }
        .t-sym { font-weight: 800; color: #fff; font-size: 12px; }
        .t-price { font-family: var(--font-num); color: var(--blue); font-size: 11px; margin-top: 4px; }
        .t-usd { font-family: var(--font-num); color: #666; font-size: 10px; }
        .acc-btn { cursor:pointer; font-weight:bold; color:var(--blue); }
        .acc-content { display:none; background:#08080a; padding:10px; border-left:2px solid var(--blue); margin-top:5px; grid-column: 1 / -1; }
        .val-row { display: flex; justify-content: space-between; font-size: 10px; color: #888; border-bottom: 1px dotted #333; padding: 2px 0; }
        .val-row span:last-child { color: #fff; font-family: var(--font-num); }
        #error-banner { display:none; background:var(--red); color:#fff; padding:10px; text-align:center; position:fixed; top:0; left:0; width:100%; z-index:9999; font-weight:bold; }
        .dr-section { margin-bottom: 20px; border-bottom: 1px solid #222; padding-bottom: 20px; }
        .dr-title { color: var(--blue); font-size: 12px; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; }
        .dr-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .dr-item { background: #000; padding: 10px; border: 1px solid #333; border-radius: 4px; font-size: 11px; display: flex; justify-content: space-between; align-items: center; }
        .dr-item a { color: #fff; text-decoration: none; } .dr-item a:hover { color: var(--blue); }
        .dr-logo { width: 100px; height: 100px; border-radius: 50%; border: 2px solid #333; margin: 0 auto 20px auto; display: block; object-fit: cover; }
        .sys-clock { font-family:var(--font-num); color:var(--orange); font-size:11px; margin-left:auto; display:flex; gap:10px; align-items:center; border:1px solid #333; padding:5px 10px; border-radius:4px; background:#000; }
        .clock-copy { opacity:0.7; }
        #chartContainer { width:100%; height:280px; background:#08080a; border:1px solid #333; border-radius:4px; margin-bottom:15px; position:relative; }
        canvas { display:block; width:100%; height:100%; }
        .stats-table-wrapper { max-height:300px; overflow-y:auto; }
        .chart-controls { display:flex; gap:10px; margin-bottom:10px; }
        .chart-btn { padding:5px 10px; border:1px solid #444; background:#111; color:#888; font-size:10px; cursor:pointer; border-radius:4px; }
        .chart-btn.active { background:var(--blue); color:#fff; border-color:var(--blue); }
        .analysis-box { background:rgba(41,121,255,0.1); border-left:3px solid var(--blue); padding:10px; color:#ccc; font-size:11px; margin-bottom:15px; font-family:var(--font-ui); }
        .sim-grid { display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
        .sim-result { background:var(--bg-panel); border:1px solid var(--border); padding:15px; border-radius:6px; margin-top:20px; text-align:center; }
        .rec-box { margin-top:10px; font-size:14px; font-weight:bold; color:var(--yellow); padding:10px; border:1px dashed var(--yellow); border-radius:4px; }
        .gap-row { display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid #333; color:#ccc; }
        .gap-val { font-family:var(--font-num); font-weight:bold; }
        .val-red { color:var(--red); } .val-green { color:var(--green); }
    </style>
</head>
<body>
<div id="error-banner"></div>
<div class="layout">
    <aside class="sidebar">
        <div class="app-title"><div class="status-dot"></div> DOV COMMAND <span style="opacity:0.5; font-weight:400;">V318</span></div>
        <div class="control-group">
            <span class="grp-lbl">OPERATIONS</span>
            <div class="btn-row"><button class="btn-green" onclick="dispatchGlobalScan()">BÂTIMENTS</button></div>
            <div class="btn-row"><button class="btn-blue" onclick="startZoneScan()">DIVISIONS</button><button class="btn-orange" onclick="startEconomyScan()">ECONOMY</button></div>
            <div class="btn-row"><button class="btn-purple" onclick="showStatsView()">STATISTICS</button></div>
            <div class="btn-row"><button class="btn-yellow" onclick="showSimView()">WAR ROOM</button></div>
        </div>
        
        <div class="control-group">
            <span class="grp-lbl">PROJECT INTELLIGENCE</span>
            <button class="btn-ghost" style="color:#fff; border-color:#555;" onclick="openDataRoom()">DATA ROOM</button>
        </div>

        <div class="control-group">
            <span class="grp-lbl">BLACK BOX LOGGING</span>
            <div class="btn-row">
                <button class="btn-purple" onclick="takeLogSnapshot(true)">FORCE SNAPSHOT</button>
                <button class="btn-ghost" style="color:#fff" onclick="exportLogs()">EXPORT CSV</button>
            </div>
        </div>

        <div class="control-group"><span class="grp-lbl">TARGET INTELLIGENCE</span><input type="text" id="targetIn" value="u2d2k.c.wam"><div class="btn-row"><button class="btn-ghost" style="color:#fff">DIVISIONS</button><button class="btn-ghost" style="color:#fff">BUILDINGS</button></div></div>
        <div class="control-group" style="margin-top:auto">
            <div style="display:flex; justify-content:space-between; font-size:10px; color:#666;"><span>DB</span> <span id="dictSize" style="color:#fff">0</span></div>
            <button class="btn-ghost" style="color:var(--red); border-color:var(--red);" onclick="hardReset()">FACTORY RESET</button>
        </div>
        <div class="console-log" id="sysLog"><div class="log-entry"><span class="log-time">SYS:</span>V318. Full Map Restored.</div></div>
    </aside>

    <main class="main-content">
        <div id="viewGlobal" class="view-section active-view">
            <div class="dashboard-header">
                <div><h2 class="page-h1">PRODUCTION BÂTIMENTS</h2><div class="page-meta">ROWS: <span id="cntRows">0</span></div></div>
                <div class="sys-clock"><span id="liveTime">00:00:00</span> <span style="color:#666">|</span> <span id="liveDate">YYYY-MM-DD</span></div>
                <div class="total-cost"><div class="grp-lbl">MAINTENANCE DOVX / 24H</div><div><span class="tc-val" id="gTotalCost">0</span></div></div>
            </div>
            <div class="kpi-grid" id="areaCards"></div><div class="tables-grid" id="areaLists"></div>
        </div>

        <div id="viewZones" class="view-section">
            <div class="dashboard-header" style="border-left: 4px solid var(--blue)">
                <div><h2 class="page-h1">CARTE DIVISIONS</h2><div class="page-meta">UNITS: <span id="zTotalDivsHeader">0</span></div></div>
                <div class="sys-clock"><span class="clock-copy"></span></div>
                <div class="total-cost">
                    <div class="grp-lbl">CONSOMMATION DU DOVX 24H00</div>
                    <div style="font-family:var(--font-num); font-size:14px; font-weight:800; margin-top:4px;">
                        <span class="tc-f">FUEL <span id="gBurnF">0</span></span> | <span class="tc-h">HEALTH <span id="gBurnH">0</span></span> | <span class="tc-r">REPAIR <span id="gBurnR">0</span></span> | <span class="tc-s">SUPPLY <span id="gBurnS">0</span></span>
                    </div>
                    <div style="text-align:right; margin-top:5px; font-size:11px; color:var(--purple); font-weight:bold;">CITY DOVX BURN: <span id="gCityBurn">0</span></div>
                </div>
            </div>
            <div class="kpi-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom:20px;">
                <div class="kpi-card"><div class="kc-title">TOTAL DIVISIONS</div><div class="kc-val" id="zTotalDivs">0</div></div>
                <div class="kpi-card"><div class="kc-title">IN FIGHT</div><div class="kc-val" id="zActiveDivs" style="color:var(--green)">0</div></div>
                <div class="kpi-card" style="align-items:center; justify-content:center;"><div class="pie-container"><div class="pie-chart" id="zPieChart"><span class="pie-val" id="zPieVal">0%</span></div></div></div>
                <div class="kpi-card"><div class="kc-title">TOTAL DOVX MINT</div><div class="kc-val" id="zTotalProd" style="color:var(--purple)">0</div></div>
            </div>
            <div class="zones-map" id="areaZones"></div>
        </div>

        <div id="viewEco" class="view-section">
            <div class="dashboard-header" style="border-left: 4px solid var(--orange)">
                <div><h2 class="page-h1">INVESTOR DASHBOARD</h2><div class="page-meta" id="ecoStatus">BUSINESS INTELLIGENCE</div></div>
                <div class="sys-clock"><span class="clock-copy"></span></div>
            </div>
            <div class="market-ticker" id="marketTicker"></div>
            <div class="kpi-grid eco" style="grid-template-columns: repeat(3, 1fr); gap:15px; margin-bottom:25px;">
                <div class="kpi-card"><div class="kc-title">UNIQUE WALLETS (USERS)</div><div class="kc-val-huge" style="color:var(--blue)" id="ecoWallets">0</div><div class="kc-sub">NFTHIVE SNAPSHOT</div></div>
                <div class="kpi-card"><div class="kc-title">NFT MARKET CAP</div><div class="kc-val" style="color:#fff" id="ecoNftCap">0</div><div class="kc-sub" id="ecoNftCapUsd">$0.00</div></div>
                <div class="kpi-card"><div class="kc-title">TOTAL ASSETS</div><div class="kc-val" id="ecoTVL">0</div><div class="kc-sub">CIRCULATING SUPPLY</div></div>
                <div class="kpi-card"><div class="kc-title">TOTAL SALES VOLUME</div><div class="kc-val" style="color:var(--yellow)" id="ecoSales">$0.00</div></div>
                <div class="kpi-card"><div class="kc-title">MARKET FEE</div><div class="kc-val" id="ecoFee">0%</div></div>
                <div class="kpi-card"><div class="kc-title">DAILY GDP (VALUE)</div><div class="kc-val" style="color:var(--green)" id="ecoGdpUsd">$0.00</div><div class="kc-sub" id="ecoGdpWax">0 WAX</div></div>
            </div>
            <div style="text-align:right; margin-bottom:15px; font-size:10px;"><a href="https://nfthive.io/collection/dovdivisions" target="_blank" style="color:#666; text-decoration:none;">SOURCE: NFTHIVE.IO ↗</a></div>
            <div class="data-panel" style="margin-bottom:25px;">
                <div class="dp-head"><span class="dp-title">FINANCIAL PROJECTIONS (REVENUE)</span></div>
                <div class="dt-grid dt-header" style="grid-template-columns: 200px 1fr 1fr;"><div class="cell">PERIOD</div><div class="cell c-right">REVENUE (WAX)</div><div class="cell c-right">REVENUE (USD)</div></div>
                <div id="projTable"></div>
            </div>
        </div>

        <div id="viewStats" class="view-section">
            <div class="dashboard-header" style="border-left: 4px solid var(--purple)">
                <div><h2 class="page-h1">FINANCIAL SUITE</h2><div class="page-meta">ADVANCED ANALYTICS</div></div>
                <div class="sys-clock"><span class="clock-copy"></span></div>
            </div>
            <div class="chart-controls">
                <button class="chart-btn active" onclick="switchChart('pnl')">PNL (NET PROFIT)</button>
                <button class="chart-btn" onclick="switchChart('scissors')">SCISSORS (REV vs COST)</button>
                <button class="chart-btn" onclick="switchChart('tvl')">TVL GROWTH</button>
            </div>
            <div id="chartContainer"><canvas id="analyticsChart"></canvas></div>
            <div id="financialInsight" class="analysis-box">Waiting for data...</div>
            <div class="data-panel">
                <div class="dp-head"><span class="dp-title">LOG HISTORY (EXTENDED)</span></div>
                <div class="dt-grid dt-header" style="grid-template-columns: 140px 60px 100px 100px 100px 100px;"><div class="cell">TIMESTAMP</div><div class="cell">TYPE</div><div class="cell c-right">REV (USD)</div><div class="cell c-right">COST (USD)</div><div class="cell c-right">NET (USD)</div><div class="cell c-right">ASSETS</div></div>
                <div id="logTable" class="stats-table-wrapper"></div>
            </div>
        </div>

        <div id="viewSim" class="view-section">
            <div class="dashboard-header" style="border-left: 4px solid var(--yellow)">
                <div><h2 class="page-h1" style="color:var(--yellow)">WAR ROOM</h2><div class="page-meta">GAP & CAPACITY PLANNING</div></div>
                <div class="sys-clock"><span class="clock-copy"></span></div>
            </div>
            <div style="margin-bottom:20px;">
                <button class="btn-yellow" style="width:250px; font-weight:bold;" onclick="runSimulation()">CALCULATE GAP & NEEDS</button>
                <span style="font-size:10px; color:#666; margin-left:10px;">BASED ON LIVE SCANNED DATA</span>
            </div>
            <div class="sim-grid">
                <div class="data-panel">
                    <div class="dp-head"><span class="dp-title" style="color:var(--blue)">CURRENT SUPPLY / DEMAND</span></div>
                    <div id="simGapList" style="padding:15px; font-family:var(--font-num);">Scan to Analyze...</div>
                </div>
                <div class="data-panel">
                    <div class="dp-head"><span class="dp-title" style="color:var(--green)">CONSTRUCTION ORDERS</span></div>
                    <div id="simBuildList" style="padding:15px; font-family:var(--font-num);">Scan to Analyze...</div>
                </div>
            </div>
            <div class="sim-result">
                <h3 style="margin:0 0 10px 0; color:#fff;">DOVX BURN PROJECTION (24H)</h3>
                <div class="dt-grid dt-header"><div class="cell">METRIC</div><div class="cell c-right">CURRENT BURN</div><div class="cell c-right">NEW BURN (ADDED)</div><div class="cell c-right">TOTAL PROJECTED</div></div>
                <div id="simBalanceTable"></div>
                <div id="simRec" class="rec-box">AWAITING CALCULATION...</div>
            </div>
        </div>
    </main>
</div>

<div class="modal-overlay" id="dataRoomModal"><div class="modal-box" style="width:700px;">
    <img src="https://ipfs.io/ipfs/QmcR7QTbt2tYHxMZ8rsH45FxYU8fuHPCy7UeAguZW3QupE" class="dr-logo" alt="DOV Logo">
    <h3 style="text-align:center; color:#fff; margin-top:0;">DAWN OF VICTORY - INVESTOR DATA ROOM</h3>
    <div id="drContent"></div>
    <div style="text-align:right; margin-top:15px;"><button class="btn-ghost" onclick="closeModal('dataRoomModal')">CLOSE</button></div>
</div></div>

<div class="modal-overlay" id="zoneDetailModal"><div class="modal-box" style="width:800px;">
    <h3 id="zdTitle" style="margin-top:0; color:#fff; border-bottom:1px solid #333; padding-bottom:10px;">ZONE DETAIL</h3>
    <div style="height:400px; overflow-y:auto; margin-top:15px;"><div id="zdList"></div></div>
    <div style="text-align:right; margin-top:15px;"><button class="btn-ghost" onclick="closeModal('zoneDetailModal')">CLOSE</button></div>
</div></div>

<script>
    // --- CONFIG ---
    const CONFIG_PRIX = { WAX_USD: 0.00751, DOVX_WAX: 0.00528553, DOVR_WAX: 0.00052051, DOVF_WAX: 0.00052051, DOVH_WAX: 0.00052051, DOVS_WAX: 0.00052051, PRIX_MOYEN_NFT_USD: 5 };
    const NFTHIVE_SNAPSHOT = { sales: "$954.1K", assets: "140 466", marketCap: "$883.3K", users: "8 334", fee: "6%" };
    const PROJECT_DATA = { links: [ { name: "Official Website", url: "https://dawnofvictory.io/" }, { name: "Whitepaper", url: "https://dawn-of-victory.gitbook.io/dov/" } ], markets: [ { name: "DOVX / WAX", url: "https://alcor.exchange/trade/dovx-dovvaultfort_wax-eosio.token" } ], contracts: [ "dovutilstake", "dovpvecontrl", "dawnfvictory" ] };

    const STORAGE_KEY = 'DOV_DATA_V318';
    const LOG_STORAGE_KEY = 'DOV_LOGS_V318';
    const getId = (id) => document.getElementById(id);
    const closeModal = (id) => getId(id).style.display = 'none';
    const switchView = (id) => { document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active-view')); getId(id).classList.add('active-view'); };
    const fmt = (n) => n.toLocaleString('fr-FR', {maximumFractionDigits: 0});
    const fmtDec = (n) => n.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    const fmtUsd = (n) => n.toLocaleString('en-US', {style:'currency', currency:'USD', minimumFractionDigits: 4});
    
    window.onerror = function(msg, url, line) { let errBanner = getId('error-banner'); errBanner.style.display = 'block'; errBanner.innerText = `CRITICAL ERROR: ${msg} (Line ${line}). Please Reset.`; return false; };
    function log(msg) { let c = getId('sysLog'); if(c) { let d = document.createElement("div"); d.className="log-entry"; d.innerHTML=`<span class="log-time">${new Date().toLocaleTimeString()}</span>${msg}`; c.prepend(d); } }

    const DEFAULT_DATA = {
        apiConfig: { 
            rpcNodes: [
                "https://wax.greymass.com", "https://wax.eosio.online", "https://wax.api.eosnation.io",
                "https://wax.dapplica.io", "https://wax.eosphere.io", "https://wax.eosusa.io",
                "https://wax-public1.neftyblocks.com", "https://wax-public2.neftyblocks.com",
                "https://wax.eosrio.io", "https://api.wax.detroitledger.tech", "https://wax.oiac.io",
                "https://api.hivebp.io", "https://api2.hivebp.io", "https://api-wax.eosauthority.com",
                "https://wax.eosdac.io", "https://wax.blacklusion.io", "https://api.waxsweden.org",
                "https://wax-bp.wizardsguild.one", "https://api.wax.alohaeos.com", "https://wax.eu.eosamsterdam.net"
            ] 
        },
        resourceDefs: { "F": { label: "FUEL", class: "fuel" }, "H": { label: "HEALTH", class: "health" }, "R": { label: "REPAIR", class: "repair" }, "S": { label: "SUPPLY", class: "supply" } },
        templates: {
            "FUEL": { "490122": { "name": "C_F1_PRODUCER_FUEL", "prod": 5.4 }, "492363": { "name": "C_F2_PRODUCER_FUEL", "prod": 12.15 }, "492366": { "name": "C_F3_PRODUCER_FUEL", "prod": 30.38 }, "492368": { "name": "C_F4_PRODUCER_FUEL", "prod": 83.53 }, "492373": { "name": "R_F1_PRODUCER_FUEL", "prod": 16.20 }, "492376": { "name": "R_F2_PRODUCER_FUEL", "prod": 36.45 }, "492379": { "name": "R_F3_PRODUCER_FUEL", "prod": 91.13 }, "492381": { "name": "R_F4_PRODUCER_FUEL", "prod": 250.59 }, "492383": { "name": "E_F1_PRODUCER_FUEL", "prod": 48.60 }, "492385": { "name": "E_F2_PRODUCER_FUEL", "prod": 109.35 }, "492386": { "name": "E_F3_PRODUCER_FUEL", "prod": 273.38 }, "492387": { "name": "E_F4_PRODUCER_FUEL", "prod": 751.78 }, "492389": { "name": "L_F1_PRODUCER_FUEL", "prod": 145.80 }, "492390": { "name": "L_F2_PRODUCER_FUEL", "prod": 328.05 }, "492391": { "name": "L_F3_PRODUCER_FUEL", "prod": 820.13 }, "492392": { "name": "L_F4_PRODUCER_FUEL", "prod": 2255.34 }, "544068": { "name": "S1_OWNER_FUEL", "prod": 2255.34 } },
            "HEALTH": { "492394": { "name": "C_F1_PRODUCER_HEALTH", "prod": 5.4 }, "492395": { "name": "C_F2_PRODUCER_HEALTH", "prod": 12.15 }, "492396": { "name": "C_F3_PRODUCER_HEALTH", "prod": 30.38 }, "492397": { "name": "C_F4_PRODUCER_HEALTH", "prod": 83.53 }, "492399": { "name": "R_F1_PRODUCER_HEALTH", "prod": 16.20 }, "492401": { "name": "R_F2_PRODUCER_HEALTH", "prod": 36.45 }, "492535": { "name": "R_F3_PRODUCER_HEALTH", "prod": 91.13 }, "492537": { "name": "R_F4_PRODUCER_HEALTH", "prod": 250.59 }, "492539": { "name": "E_F1_PRODUCER_HEALTH", "prod": 48.60 }, "492543": { "name": "E_F2_PRODUCER_HEALTH", "prod": 109.35 }, "492545": { "name": "E_F3_PRODUCER_HEALTH", "prod": 273.38 }, "492546": { "name": "E_F4_PRODUCER_HEALTH", "prod": 751.78 }, "492550": { "name": "L_F1_PRODUCER_HEALTH", "prod": 145.80 }, "492554": { "name": "L_F2_PRODUCER_HEALTH", "prod": 328.05 }, "492555": { "name": "L_F3_PRODUCER_HEALTH", "prod": 820.13 }, "492557": { "name": "L_F4_PRODUCER_HEALTH", "prod": 2255.34 }, "544070": { "name": "S1_OWNER_HEALTH", "prod": 2255.34 } },
            "REPAIR": { "492559": { "name": "C_F1_PRODUCER_REPAIR", "prod": 5.4 }, "492560": { "name": "C_F2_PRODUCER_REPAIR", "prod": 12.15 }, "492561": { "name": "C_F3_PRODUCER_REPAIR", "prod": 30.38 }, "492562": { "name": "C_F4_PRODUCER_REPAIR", "prod": 83.53 }, "492563": { "name": "R_F1_PRODUCER_REPAIR", "prod": 16.20 }, "492465": { "name": "R_F2_PRODUCER_REPAIR", "prod": 36.45 }, "492566": { "name": "R_F3_PRODUCER_REPAIR", "prod": 91.13 }, "492568": { "name": "R_F4_PRODUCER_REPAIR", "prod": 250.59 }, "492964": { "name": "E_F1_PRODUCER_REPAIR", "prod": 48.60 }, "492965": { "name": "E_F2_PRODUCER_REPAIR", "prod": 109.35 }, "492966": { "name": "E_F3_PRODUCER_REPAIR", "prod": 273.38 }, "492967": { "name": "E_F4_PRODUCER_REPAIR", "prod": 751.78 }, "492572": { "name": "L_F1_PRODUCER_REPAIR", "prod": 145.80 }, "492579": { "name": "L_F2_PRODUCER_REPAIR", "prod": 328.05 }, "492582": { "name": "L_F3_PRODUCER_REPAIR", "prod": 820.13 }, "492583": { "name": "L_F4_PRODUCER_REPAIR", "prod": 2255.34 }, "544061": { "name": "S1_OWNER_REPAIR", "prod": 2255.34 } },
            "SUPPLY": { "492585": { "name": "C_F1_PRODUCER_SUPPLY", "prod": 5.4 }, "492587": { "name": "C_F2_PRODUCER_SUPPLY", "prod": 12.15 }, "492589": { "name": "C_F3_PRODUCER_SUPPLY", "prod": 30.38 }, "492702": { "name": "C_F4_PRODUCER_SUPPLY", "prod": 83.53 }, "492703": { "name": "R_F1_PRODUCER_SUPPLY", "prod": 16.20 }, "492704": { "name": "R_F2_PRODUCER_SUPPLY", "prod": 36.45 }, "492706": { "name": "R_F3_PRODUCER_SUPPLY", "prod": 91.13 }, "492707": { "name": "R_F4_PRODUCER_SUPPLY", "prod": 250.59 }, "492708": { "name": "E_F1_PRODUCER_SUPPLY", "prod": 48.60 }, "492709": { "name": "E_F2_PRODUCER_SUPPLY", "prod": 109.35 }, "492710": { "name": "E_F3_PRODUCER_SUPPLY", "prod": 273.38 }, "492711": { "name": "E_F4_PRODUCER_SUPPLY", "prod": 751.78 }, "492712": { "name": "L_F1_PRODUCER_SUPPLY", "prod": 145.80 }, "492713": { "name": "L_F2_PRODUCER_SUPPLY", "prod": 328.05 }, "492714": { "name": "L_F3_PRODUCER_SUPPLY", "prod": 820.13 }, "492715": { "name": "L_F4_PRODUCER_SUPPLY", "prod": 2255.34 }, "544064": { "name": "S1_OWNER_SUPPLY", "prod": 2255.34 } }
        }
    };

    // FIXED V318: RESTORED FULL ZONE LIST (20 ZONES)
    const SMART_ZONES_BIBLE = {
        1: { name:"Beach 1", cost:1160, win:400 }, 2: { name:"Beach 2", cost:6968, win:2405 }, 3: { name:"Beach 3", cost:8800, win:3037 }, 4: { name:"Bunker", cost:11120, win:3838 }, 
        5: { name:"Forest 1", cost:14024, win:4840 }, 6: { name:"Forest 2", cost:17704, win:6110 }, 7: { name:"Forest 3", cost:22352, win:7714 }, 8: { name:"Camp", cost:28220, win:9739 }, 
        9: { name:"Hill 1", cost:37052, win:12788 }, 10: { name:"Hill 2", cost:48652, win:16791 }, 11: { name:"Hill 3", cost:64516, win:22266 }, 12: { name:"Radar", cost:84712, win:29236 }, 
        13: { name:"Plain 1", cost:99384, win:34300 }, 14: { name:"Plain 2", cost:125708, win:43385 }, 15: { name:"Plain 3", cost:151164, win:52171 }, 16: { name:"HQ", cost:188000, win:64884 }, 
        17: { name:"City 1", cost:1664, win:0 }, 18: { name:"City 2", cost:4448, win:0 }, 19: { name:"City 3", cost:13440, win:0 }, 20: { name:"Bridge", cost:29856, win:0 }
    };

    let DATA = JSON.parse(JSON.stringify(DEFAULT_DATA));
    let stopSignal = false;
    let zoneDetailsCache = {}; 
    let ecoStats = { buildings: { active:0, prodF:0, prodH:0, prodR:0, prodS:0, totalCost:0 }, divisions: { active:0, mint:0, cost:0 }, cityBurn: 0, burns: {F:0,H:0,R:0,S:0}, uniqueWalletCount: 0, totalAssetsAtomic: 0 };
    let runtimeWalletSet = new Set(); 
    let currentChartMode = 'pnl';

    function saveData() { DATA.ecoStats = ecoStats; localStorage.setItem(STORAGE_KEY, JSON.stringify(DATA)); log("Data Saved."); }
    function hardReset() { if(confirm("FULL RESET?")) { localStorage.removeItem(STORAGE_KEY); localStorage.removeItem(LOG_STORAGE_KEY); location.reload(); } }

    function init() {
        const local = localStorage.getItem(STORAGE_KEY);
        if(local) { 
            try { 
                let loaded = JSON.parse(local); 
                DATA = { ...DEFAULT_DATA, ...loaded, templates: { ...DEFAULT_DATA.templates, ...loaded.templates } }; 
                if(loaded.ecoStats) {
                    ecoStats = loaded.ecoStats;
                    if(!ecoStats.burns) ecoStats.burns = {F:0, H:0, R:0, S:0};
                }
            } catch(e){} 
        }
        let count = 0; Object.values(DATA.templates).forEach(t => count += Object.keys(t).length);
        if(getId('dictSize')) getId('dictSize').innerText = count;
        
        startClock(); startMonitoringRoutine();
        buildUI(); renderTicker(); updateEcoUI(); 
        
        if(ecoStats.buildings.active > 0 && getId('gTotalCost')) { 
            getId('gTotalCost').innerText = fmt(ecoStats.buildings.totalCost); 
            getId('cntRows').innerText = fmt(ecoStats.buildings.active); 
        }
        if(ecoStats.divisions.active > 0 && getId('zTotalDivsHeader')) { 
            getId('zTotalDivsHeader').innerText = fmt(ecoStats.divisions.active); 
        }
        log("Ready. Mode: V318 Full Map.");
    }

    function buildUI() {
        const areaC = getId('areaCards'); const areaL = getId('areaLists');
        areaC.innerHTML = ''; areaL.innerHTML = '';
        const order = ["F", "H", "R", "S"];
        for(let k of order) {
            let rd = DATA.resourceDefs[k];
            areaC.innerHTML += `<div class="kpi-card ${rd.class}"><div><div class="kc-title">${rd.label} / HOUR</div><div class="kc-val" id="val-${k}">0</div></div><div class="kc-sep"></div><div><div class="kc-title" style="color:#fff; opacity:0.8;">DAILY PRODUCTION</div><div class="kc-val-huge" id="val24-${k}">0</div></div><div class="kc-sub" id="act-${k}">0 ACTIVE</div></div>`;
            areaL.innerHTML += `<div class="data-panel"><div class="dp-head"><span class="dp-title">${rd.label} BREAKDOWN</span><div class="dp-badges"><span style="color:#888">PROD:</span> <span id="btot-${k}" style="color:#fff">0</span></div></div><div class="dt-grid dt-header"><div class="cell">TEMPLATE</div><div class="cell c-center">ACT / TOT</div><div class="cell c-right">UNIT</div><div class="cell c-right">PROD/H</div><div class="cell c-right">PROD/24</div><div class="cell c-right" style="color:#aaa">YIELD (TU/DOVX)</div><div class="cell c-right" style="color:var(--purple)">COST/24</div></div><div id="tbl-${k}"></div></div>`;
        }
    }

    function renderTicker() {
        let html = `<div class="ticker-item"><div class="t-sym" style="color:var(--orange)">WAX</div><div class="t-price">$${CONFIG_PRIX.WAX_USD}</div></div>`;
        const tokens = [ { s:"DOVX", p: CONFIG_PRIX.DOVX_WAX }, { s:"DOVF", p: CONFIG_PRIX.DOVF_WAX }, { s:"DOVH", p: CONFIG_PRIX.DOVH_WAX }, { s:"DOVR", p: CONFIG_PRIX.DOVR_WAX }, { s:"DOVS", p: CONFIG_PRIX.DOVS_WAX } ];
        tokens.forEach(t => { let usd = t.p * CONFIG_PRIX.WAX_USD; html += `<div class="ticker-item"><div class="t-sym">${t.s}</div><div class="t-price">${t.p} WAX</div><div class="t-usd">$${usd.toFixed(6)}</div></div>`; });
        getId('marketTicker').innerHTML = html;
    }

    function startClock() {
        setInterval(() => {
            const now = new Date(); const time = now.toLocaleTimeString('fr-FR'); const date = now.toLocaleDateString('fr-FR', { year:'numeric', month:'2-digit', day:'2-digit' });
            if(getId('liveTime')) { getId('liveTime').innerText = time; getId('liveDate').innerText = date; }
            let copies = document.querySelectorAll('.clock-copy'); copies.forEach(c => c.innerText = `${time} | ${date}`);
        }, 1000);
    }

    async function takeLogSnapshot(isManual) {
        if(isManual) { log("Manual Snapshot Initiated..."); await dispatchGlobalScan(true); await startZoneScan(true); }
        let logs = JSON.parse(localStorage.getItem(LOG_STORAGE_KEY) || "[]");
        let dailyIndustryWax = (ecoStats.buildings.prodF * 24 * CONFIG_PRIX.DOVF_WAX) + (ecoStats.buildings.prodH * 24 * CONFIG_PRIX.DOVH_WAX) + (ecoStats.buildings.prodR * 24 * CONFIG_PRIX.DOVR_WAX) + (ecoStats.buildings.prodS * 24 * CONFIG_PRIX.DOVS_WAX);
        let dailyMilitaryWax = ecoStats.divisions.mint * CONFIG_PRIX.DOVX_WAX;
        let totalRevWax = dailyIndustryWax + dailyMilitaryWax;
        let costWax = ecoStats.buildings.totalCost * CONFIG_PRIX.DOVX_WAX;
        let entry = {
            timestamp: new Date().toISOString(), type: isManual ? "MANUAL" : "AUTO",
            revenue_usd: totalRevWax * CONFIG_PRIX.WAX_USD, cost_usd: costWax * CONFIG_PRIX.WAX_USD,
            profit_usd: (totalRevWax - costWax) * CONFIG_PRIX.WAX_USD, assets_count: ecoStats.buildings.active + ecoStats.divisions.active
        };
        logs.push(entry); if(logs.length > 1000) logs.shift();
        localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(logs));
        if(isManual) { alert("Snapshot Saved."); renderStatsUI(); } else { log("Auto-Log Saved."); }
    }

    function startMonitoringRoutine() { setInterval(() => { takeLogSnapshot(false); }, 3600000); }
    function switchChart(mode) { currentChartMode = mode; document.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); renderStatsUI(); }
    function showStatsView() { switchView('viewStats'); renderStatsUI(); }

    function renderStatsUI() {
        let logs = JSON.parse(localStorage.getItem(LOG_STORAGE_KEY) || "[]").reverse();
        let html = "";
        logs.forEach(l => {
            let date = new Date(l.timestamp).toLocaleString('fr-FR'); let color = l.type === "MANUAL" ? "var(--purple)" : "#666";
            let rev = l.revenue_usd || 0; let cost = l.cost_usd || 0; let net = l.profit_usd || 0; let ast = l.assets_count || 0;
            html += `<div class="dt-grid dt-row" style="grid-template-columns: 140px 60px 100px 100px 100px 100px;"><div class="cell" style="color:#fff">${date}</div><div class="cell" style="color:${color}; font-weight:bold;">${l.type}</div><div class="cell c-right" style="color:var(--green)">$${rev.toFixed(2)}</div><div class="cell c-right" style="color:var(--orange)">$${cost.toFixed(2)}</div><div class="cell c-right" style="color:${net>=0?'var(--blue)':'var(--red)'}">$${net.toFixed(2)}</div><div class="cell c-right">${ast}</div></div>`;
        });
        getId('logTable').innerHTML = html;
        if(logs.length > 0) {
            let last = logs[0]; let prev = logs.length > 1 ? logs[1] : last; let diff = last.profit_usd - prev.profit_usd;
            let trend = diff >= 0 ? "UP" : "DOWN";
            getId('financialInsight').innerText = `LATEST: Profit $${last.profit_usd?.toFixed(2)} (${trend} $${Math.abs(diff).toFixed(2)}). Margin: ${((last.profit_usd/last.revenue_usd)*100).toFixed(1)}%.`;
        }
        if(logs.length < 2) return;
        let cvs = getId('analyticsChart'); let ctx = cvs.getContext('2d'); let w = cvs.width = cvs.parentElement.offsetWidth; let h = cvs.height = cvs.parentElement.offsetHeight;
        ctx.fillStyle = "#08080a"; ctx.fillRect(0,0,w,h);
        let data = logs.slice(0, 30).reverse(); if(data.length < 2) return;
        let maxVal = 0; data.forEach(d => { if(currentChartMode === 'pnl') maxVal = Math.max(maxVal, d.profit_usd || 0); if(currentChartMode === 'scissors') maxVal = Math.max(maxVal, d.revenue_usd || 0); if(currentChartMode === 'tvl') maxVal = Math.max(maxVal, d.assets_count || 0); }); maxVal = maxVal * 1.1;
        ctx.strokeStyle = "#222"; ctx.beginPath(); for(let i=0; i<5; i++) { let y = i*(h/4); ctx.moveTo(0,y); ctx.lineTo(w,y); } ctx.stroke();
        let step = w / (data.length - 1);
        if(currentChartMode === 'pnl') {
            ctx.fillStyle = "rgba(41, 121, 255, 0.2)"; ctx.strokeStyle = "#2979ff"; ctx.lineWidth = 2; ctx.beginPath();
            data.forEach((d, i) => { let val = d.profit_usd || 0; let x = i * step; let y = h - ((val / maxVal) * h); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
            ctx.stroke(); ctx.lineTo(w, h); ctx.lineTo(0, h); ctx.fill();
        } else if (currentChartMode === 'scissors') {
            ctx.strokeStyle = "#00f090"; ctx.lineWidth = 2; ctx.beginPath(); data.forEach((d, i) => { let y = h - (((d.revenue_usd||0) / maxVal) * h); if(i===0) ctx.moveTo(i*step,y); else ctx.lineTo(i*step,y); }); ctx.stroke();
            ctx.strokeStyle = "#ff3b30"; ctx.beginPath(); data.forEach((d, i) => { let y = h - (((d.cost_usd||0) / maxVal) * h); if(i===0) ctx.moveTo(i*step,y); else ctx.lineTo(i*step,y); }); ctx.stroke();
        } else if (currentChartMode === 'tvl') {
            ctx.fillStyle = "#ff9100"; let barW = (w / data.length) - 2;
            data.forEach((d, i) => { let hBar = ((d.assets_count||0) / maxVal) * h; ctx.fillRect(i*step, h - hBar, barW, hBar); });
        }
    }

    function exportLogs() {
        let logs = JSON.parse(localStorage.getItem(LOG_STORAGE_KEY) || "[]"); if(logs.length === 0) { alert("No logs."); return; }
        let csv = "TIMESTAMP,TYPE,REV_USD,COST_USD,NET_USD,ASSETS\n";
        logs.forEach(r => { csv += `${r.timestamp},${r.type},${r.revenue_usd},${r.cost_usd},${r.profit_usd},${r.assets_count}\n`; });
        let blob = new Blob([csv], {type:'text/csv'}); let url = window.URL.createObjectURL(blob);
        let a = document.createElement('a'); a.href=url; a.download='dov_financials.csv'; a.click();
    }

    function findTemplate(tid) {
        if(DATA.templates.FUEL[tid]) return { ...DATA.templates.FUEL[tid], type:'F' };
        if(DATA.templates.HEALTH[tid]) return { ...DATA.templates.HEALTH[tid], type:'H' };
        if(DATA.templates.REPAIR[tid]) return { ...DATA.templates.REPAIR[tid], type:'R' };
        if(DATA.templates.SUPPLY[tid]) return { ...DATA.templates.SUPPLY[tid], type:'S' };
        return null;
    }

    async function fetchSmartCluster(endpoint, body) {
        let nodes = DATA.apiConfig.rpcNodes; let shuffled = [...nodes].sort(() => 0.5 - Math.random());
        for(let i=0; i<shuffled.length; i++) { try { let controller = new AbortController(); setTimeout(() => controller.abort(), 2500); let res = await fetch(shuffled[i] + endpoint, { method: 'POST', body: body, signal: controller.signal }); if(res.ok) return await res.json(); } catch(e) { } }
        throw new Error("CLUSTER UNREACHABLE");
    }

    async function dispatchGlobalScan(silent = false) {
        stopSignal = false; if(!silent) switchView('viewGlobal'); if(getId('cntRows')) getId('cntRows').innerText = "...";
        log("Scanning Buildings..."); let next = ""; let stats = { totalCost:0, types:{F:{p:0,a:0,t:0}, H:{p:0,a:0,t:0}, R:{p:0,a:0,t:0}, S:{p:0,a:0,t:0}} }; let groups = {F:[], H:[], R:[], S:[]}; let rowCount = 0; let assetCount = 0;
        try { while(!stopSignal) {
            let res = await fetchSmartCluster("/v1/chain/get_table_rows", JSON.stringify({json:true, code:"dovutilstake", scope:"dovutilstake", table:"buildings", limit:1000, lower_bound:next}));
            if(!res.rows) break;
            const now = Date.now()/1000;
            for(let r of res.rows) {
                let tid = r.template_id.toString(); let tpl = findTemplate(tid); if(!tpl) continue;
                rowCount++; let count = r.asset_ids ? r.asset_ids.length : 1; assetCount += count;
                stats.types[tpl.type].t += count; runtimeWalletSet.add(r.owner); 
                if(now < (parseFloat(r.last_claim) + parseFloat(r.delay))) {
                    stats.types[tpl.type].a += count; 
                    let h = count * tpl.prod; let d = h * 24; let c = d * 0.085; 
                    let existing = groups[tpl.type].find(x => x.name === tpl.name);
                    if(!existing) { existing = { id:tid, name:tpl.name, act:0, tot:0, unit:tpl.prod, totH:0, totD:0, costD:0 }; groups[tpl.type].push(existing); }
                    existing.tot += count; existing.act += count; existing.totH += h; existing.totD += d; existing.costD += c;
                    stats.types[tpl.type].p += h; stats.totalCost += c;
                }
            }
            ecoStats.buildings.active = assetCount; ecoStats.buildings.prodF = stats.types.F.p; ecoStats.buildings.prodH = stats.types.H.p; ecoStats.buildings.prodR = stats.types.R.p; ecoStats.buildings.prodS = stats.types.S.p; ecoStats.buildings.totalCost = stats.totalCost;
            updateGlobalUI(rowCount, stats, groups);
            if(res.more) next = res.next_key; else break; await new Promise(r => setTimeout(r, 50));
        } saveData(); log(`Buildings Scan Done. ${assetCount} Assets.`); } catch(e) { log("Error Buildings: " + e.message); }
    }

    function updateGlobalUI(rows, stats, groups) {
        if(!getId('cntRows')) return; getId('cntRows').innerText = fmt(rows); if(getId('gTotalCost')) getId('gTotalCost').innerText = fmt(stats.totalCost); 
        for(let k in DATA.resourceDefs) {
            let rd = DATA.resourceDefs[k]; getId(`val-${k}`).innerText = fmtDec(stats.types[k].p); getId(`val24-${k}`).innerText = fmtDec(stats.types[k].p * 24); getId(`act-${k}`).innerText = fmt(stats.types[k].a) + " ACTIVE"; getId(`btot-${k}`).innerText = fmtDec(stats.types[k].p); 
            let list = groups[k].sort((a,b) => b.totH - a.totH); let html = "";
            list.forEach(i => {
                let link = `https://wax.atomichub.io/explorer/template/wax-mainnet/dovdivisions/${i.id}`;
                let ratio = (i.costD > 0 && i.totD > 0) ? (i.totD / i.costD) : 0;
                html += `<div class="dt-grid dt-row"><div class="cell"><a href="${link}" target="_blank" class="atomic">${i.name}</a></div><div class="cell c-center" style="font-weight:700;"><span style="color:var(--green)">${i.act}</span> / <span style="color:#666">${i.tot}</span></div><div class="cell c-right" style="color:#666">${fmtDec(i.unit)}</div><div class="cell c-right ${rd.class}" style="font-weight:700;">${fmtDec(i.totH)}</div><div class="cell c-right" style="color:#888;">${fmtDec(i.totD)}</div><div class="cell c-right" style="color:#aaa;">${ratio.toFixed(2)}</div><div class="cell c-right" style="color:var(--purple);">${fmtDec(i.costD)}</div></div>`;
            });
            getId(`tbl-${k}`).innerHTML = html;
        }
    }

    async function startZoneScan(silent = false) {
        stopSignal = false; if(!silent) switchView('viewZones'); if(getId('zTotalDivsHeader')) getId('zTotalDivsHeader').innerText = "SCANNING...";
        log("Scanning Divisions (Detailed)..."); 
        
        let stats = { totalDivs: 0, activeDivs: 0, totalProd: 0, cityBurn:0, bf:0, bh:0, br:0, bs:0 }; 
        let next = "";
        // FIXED V318: FULL 20 ZONES LIST FROM V299
        let zonesData = {}; Object.keys(SMART_ZONES_BIBLE).forEach(id => { zonesData[id] = { count: 0, active: 0, prod: 0, cityBurn:0, bf:0, bh:0, br:0, bs:0 }; });
        zoneDetailsCache = {}; Object.keys(SMART_ZONES_BIBLE).forEach(id => { zoneDetailsCache[id] = []; });

        try { while(!stopSignal) {
            let json = await fetchSmartCluster("/v1/chain/get_table_rows", JSON.stringify({json:true, code:"dovpvecontrl", scope:"dovpvecontrl", table:"sdivisions", limit:1000, lower_bound:next}));
            if(!json.rows) break;
            for(let r of json.rows) {
                let zid = r.zone_id || r.zoneID;
                if(zonesData[zid]) {
                    zonesData[zid].count++; stats.totalDivs++; runtimeWalletSet.add(r.owner); 
                    let end = parseFloat(r.unlock_time || r.end_time || 0);
                    let isFighting = end > (Date.now()/1000); 
                    if(isFighting) {
                        zonesData[zid].active++; stats.activeDivs++;
                        let zConf = SMART_ZONES_BIBLE[zid];
                        let isCity = [17, 18, 19, 20].includes(parseInt(zid));
                        if(isCity) { zonesData[zid].cityBurn += zConf.cost; stats.cityBurn += zConf.cost; } 
                        else { 
                            zonesData[zid].bf += zConf.cost; stats.bf += zConf.cost; 
                            zonesData[zid].bh += zConf.cost; stats.bh += zConf.cost; 
                            zonesData[zid].br += zConf.cost; stats.br += zConf.cost; 
                            zonesData[zid].bs += zConf.cost; stats.bs += zConf.cost; 
                        }
                        zonesData[zid].prod += zConf.win; stats.totalProd += zConf.win;
                        zoneDetailsCache[zid].push({ owner: r.owner, reward: zConf.win });
                    }
                }
            }
            // V317 PATCH: SAVE BURNS SAFELY
            ecoStats.divisions.active = stats.activeDivs; 
            ecoStats.divisions.mint = stats.totalProd; 
            ecoStats.cityBurn = stats.cityBurn;
            if(ecoStats.burns) {
                ecoStats.burns.F = stats.bf; ecoStats.burns.H = stats.bh; ecoStats.burns.R = stats.br; ecoStats.burns.S = stats.bs;
            }

            updateZoneUI(zonesData, stats); if(!json.more) break; next = json.next_key; await new Promise(r => setTimeout(r, 50));
        } saveData(); log(`Divisions Scan Done. ${stats.activeDivs} Fighting.`); } catch(e) { log("Error Divisions: " + e.message); }
        if(getId('zoneStatus')) getId('zoneStatus').innerText = "Complete.";
    }

    function updateZoneUI(zonesData, stats) {
        if(!getId('zTotalDivsHeader')) return;
        getId('zTotalDivsHeader').innerText = fmt(stats.totalDivs); getId('zTotalDivs').innerText = fmt(stats.totalDivs); getId('zActiveDivs').innerText = fmt(stats.activeDivs);
        let activePct = stats.totalDivs > 0 ? (stats.activeDivs / stats.totalDivs) * 100 : 0;
        getId('zPieVal').innerText = activePct.toFixed(0) + "%"; getId('zPieChart').style.background = `conic-gradient(var(--green) 0% ${activePct}%, #333 ${activePct}% 100%)`;
        getId('zTotalProd').innerText = fmt(stats.totalProd); 
        getId('gBurnF').innerText = fmt(stats.bf); getId('gBurnH').innerText = fmt(stats.bh); getId('gBurnR').innerText = fmt(stats.br); getId('gBurnS').innerText = fmt(stats.bs);
        getId('gCityBurn').innerText = fmt(stats.cityBurn);
        
        let html = "";
        Object.keys(zonesData).forEach(id => {
            let z = SMART_ZONES_BIBLE[id]; let d = zonesData[id]; let activeClass = d.count > 0 ? "active" : "";
            let isCity = [17,18,19,20].includes(parseInt(id));
            let burnHtml = isCity ? `<div class="zs-item" style="font-size:10px; color:var(--purple); font-weight:bold; margin-top:2px;">ENTRY COST: ${z.cost} DOVX</div>` 
                                  : `<div class="zs-item" style="color:#888; font-size:9px;">UTILITY COST</div><div class="zs-item" style="font-size:9px;"><span class="tc-f">${fmt(d.bf)}</span> <span class="tc-h">${fmt(d.bh)}</span> <span class="tc-r">${fmt(d.br)}</span> <span class="tc-s">${fmt(d.bs)}</span></div>`;
            html += `<div class="zone-card ${activeClass}" onclick="openZoneDetail('${id}')"><div class="zc-top"><span>${z.name}</span> <span style="color:${d.active>0?'var(--green)':'#666'}">${d.active} FIGHT</span> / <span style="color:#fff">${d.count} TOT</span></div><div class="zc-mid"><div class="zs-item"><span>MINT (DOVX)</span> <span style="color:var(--purple)">${fmt(d.prod)}</span></div><div style="height:1px; background:#333; margin:2px 0;"></div>${burnHtml}</div></div>`;
        });
        getId('areaZones').innerHTML = html;
    }

    async function startEconomyScan() { switchView('viewEco'); getId('ecoStatus').innerText = "SCANNING..."; runtimeWalletSet.clear(); await dispatchGlobalScan(true); await startZoneScan(true); ecoStats.uniqueWalletCount = runtimeWalletSet.size; saveData(); getId('ecoStatus').innerText = "REPORT GENERATED."; updateEcoUI(); }

    function updateEcoUI() {
        let dailyIndustryWax = (ecoStats.buildings.prodF * 24 * CONFIG_PRIX.DOVF_WAX) + (ecoStats.buildings.prodH * 24 * CONFIG_PRIX.DOVH_WAX) + (ecoStats.buildings.prodR * 24 * CONFIG_PRIX.DOVR_WAX) + (ecoStats.buildings.prodS * 24 * CONFIG_PRIX.DOVS_WAX);
        let dailyMilitaryWax = ecoStats.divisions.mint * CONFIG_PRIX.DOVX_WAX;
        let totalDailyWax = dailyIndustryWax + dailyMilitaryWax; let totalDailyUsd = totalDailyWax * CONFIG_PRIX.WAX_USD;
        getId('ecoWallets').innerText = NFTHIVE_SNAPSHOT.users; getId('ecoNftCap').innerText = NFTHIVE_SNAPSHOT.marketCap; getId('ecoTVL').innerText = NFTHIVE_SNAPSHOT.assets;
        getId('ecoGdpUsd').innerText = fmtUsd(totalDailyUsd); getId('ecoGdpWax').innerText = fmtDec(totalDailyWax) + " WAX";
        let html = `
            <div class="dt-grid dt-row" style="grid-template-columns: 200px 1fr 1fr;"><div class="cell"><b>DAILY INDUSTRY</b></div><div class="cell c-right" style="color:var(--orange)">${fmtDec(dailyIndustryWax)} W</div><div class="cell c-right" style="color:var(--green)">${fmtUsd(dailyIndustryWax * CONFIG_PRIX.WAX_USD)}</div></div>
            <div class="dt-grid dt-row" style="grid-template-columns: 200px 1fr 1fr;"><div class="cell"><b>DAILY MILITARY</b></div><div class="cell c-right" style="color:var(--orange)">${fmtDec(dailyMilitaryWax)} W</div><div class="cell c-right" style="color:var(--green)">${fmtUsd(dailyMilitaryWax * CONFIG_PRIX.WAX_USD)}</div></div>
            <div style="height:5px;"></div><div class="dt-grid dt-row" style="grid-template-columns: 200px 1fr 1fr;"><div class="cell" style="color:var(--purple)"><b>ANNUAL TOTAL</b></div><div class="cell c-right" style="color:var(--purple)"><b>${fmtDec(totalDailyWax * 365)} W</b></div><div class="cell c-right" style="color:var(--purple)"><b>${fmtUsd(totalDailyUsd * 365)}</b></div></div>`;
        getId('projTable').innerHTML = html;
    }

    function openDataRoom() {
        let html = `<div class="dr-section"><div class="dr-title">OFFICIAL RESOURCES</div><div class="dr-grid">`;
        PROJECT_DATA.links.forEach(l => { html += `<div class="dr-item"><span>${l.name}</span><a href="${l.url}" target="_blank">OPEN ↗</a></div>`; });
        html += `</div></div><div class="dr-section"><div class="dr-title">LIQUIDITY (ALCOR)</div><div class="dr-grid">`;
        PROJECT_DATA.markets.forEach(m => { html += `<div class="dr-item"><span>${m.name}</span><a href="${m.url}" target="_blank" style="color:var(--orange)">TRADE</a></div>`; });
        html += `</div></div><div class="dr-section" style="border:none;"><div class="dr-title">AUTHORIZED CONTRACTS</div><div style="font-family:var(--font-num); color:#666; font-size:10px;">`;
        PROJECT_DATA.contracts.forEach(c => { html += `<span style="margin-right:10px; padding:2px 5px; background:#111; border-radius:3px;">${c}</span>`; });
        html += `</div></div>`;
        getId('drContent').innerHTML = html; getId('dataRoomModal').style.display = 'flex';
    }

    function openZoneDetail(zid) { 
        if(!zoneDetailsCache[zid] || zoneDetailsCache[zid].length === 0) return;
        let list = zoneDetailsCache[zid];
        let groups = {};
        list.forEach(item => { if(!groups[item.owner]) groups[item.owner] = { count:0, mint:0 }; groups[item.owner].count++; groups[item.owner].mint += item.reward; });
        let sorted = Object.keys(groups).sort((a,b) => groups[b].count - groups[a].count);
        let html = "";
        sorted.forEach(owner => {
            html += `<div class="dt-grid dt-row" style="grid-template-columns: 1fr 100px 100px 50px;"><div class="cell" style="font-weight:bold; color:#fff;">${owner}</div><div class="cell c-right" style="color:var(--blue)">${groups[owner].count} DIVS</div><div class="cell c-right" style="color:var(--purple)">${fmt(groups[owner].mint)}</div><div class="cell c-center"><a href="https://waxblock.io/account/${owner}" target="_blank" style="color:#555;">LINK</a></div></div>`;
        });
        getId('zdList').innerHTML = html; getId('zoneDetailModal').style.display = 'flex';
    }

    // V316: GAP ANALYZER LOGIC
    function showSimView() { switchView('viewSim'); }
    
    function runSimulation() {
        if(!ecoStats.burns) { alert("Data structure updating. Please run scans first."); return; }
        if(ecoStats.buildings.active === 0 && ecoStats.divisions.active === 0) {
            alert("No data available. Please perform OPERATIONS scans first.");
            return;
        }

        // 1. GATHER REAL DATA (DAILY)
        let prod = {
            F: ecoStats.buildings.prodF * 24,
            H: ecoStats.buildings.prodH * 24,
            R: ecoStats.buildings.prodR * 24,
            S: ecoStats.buildings.prodS * 24
        };
        
        let burn = {
            F: ecoStats.burns.F,
            H: ecoStats.burns.H,
            R: ecoStats.burns.R,
            S: ecoStats.burns.S
        };

        // 2. CALCULATE GAP & NEEDS
        let htmlGap = "";
        let htmlBuild = "";
        let totalNewBurnDOVX = 0;
        let commonProdDaily = 5.4 * 24; // 129.6 TU/Day
        let commonBurnDaily = commonProdDaily * 0.085; // DOVX cost

        let resourceMap = {F: {n:"FUEL", p:CONFIG_PRIX.DOVF_WAX}, H: {n:"HEALTH", p:CONFIG_PRIX.DOVH_WAX}, R: {n:"REPAIR", p:CONFIG_PRIX.DOVR_WAX}, S: {n:"SUPPLY", p:CONFIG_PRIX.DOVS_WAX}};

        Object.keys(prod).forEach(k => {
            let p = prod[k];
            let b = burn[k];
            let gap = p - b;
            let gapColor = gap >= 0 ? "val-green" : "val-red";
            
            // Render Gap Row
            htmlGap += `<div class="gap-row">
                <span>${resourceMap[k].n}</span>
                <span style="color:#888">${fmt(p)} / ${fmt(b)}</span>
                <span class="${gapColor}">${gap >= 0 ? "+" : ""}${fmt(gap)}</span>
            </div>`;

            // Calculate Needs if Deficit
            if (gap < 0) {
                let deficit = Math.abs(gap);
                let buildingsNeeded = Math.ceil(deficit / commonProdDaily);
                let addedBurnDOVX = buildingsNeeded * commonBurnDaily;
                let valueWax = deficit * resourceMap[k].p;
                let valueUsd = valueWax * CONFIG_PRIX.WAX_USD;
                
                totalNewBurnDOVX += addedBurnDOVX;

                htmlBuild += `<div class="gap-row" style="border-color:var(--red)">
                    <span style="color:var(--orange)">${resourceMap[k].n} DEFICIT</span>
                    <span>BUILD <b>${buildingsNeeded}</b> COMMON</span>
                    <span style="font-size:9px; color:#666">~${fmtDec(valueUsd)}$</span>
                </div>`;
            } else {
                htmlBuild += `<div class="gap-row" style="border-color:var(--green); opacity:0.5">
                    <span style="color:var(--green)">${resourceMap[k].n} SECURE</span>
                    <span>OK</span>
                    <span>-</span>
                </div>`;
            }
        });

        getId('simGapList').innerHTML = htmlGap;
        getId('simBuildList').innerHTML = htmlBuild || "<div style='text-align:center; color:var(--green)'>ALL SYSTEMS GREEN. NO BUILDINGS REQUIRED.</div>";

        // 3. DOVX BALANCE
        let currentMint = ecoStats.divisions.mint;
        let currentCost = ecoStats.buildings.totalCost; // Existing Burn
        let projectedCost = currentCost + totalNewBurnDOVX;
        let netDOVX = currentMint - projectedCost;

        let htmlBal = `
            <div class="dt-grid dt-row"><div class="cell"><b>DOVX ECONOMY</b></div><div class="cell c-right" style="color:var(--purple)">-${fmt(currentCost)}</div><div class="cell c-right" style="color:var(--red)">-${fmt(totalNewBurnDOVX)}</div><div class="cell c-right" style="color:${netDOVX>=0?'var(--green)':'var(--red)'}; font-weight:bold;">${fmt(netDOVX)}</div></div>
        `;
        getId('simBalanceTable').innerHTML = htmlBal;

        // 4. RECOMMENDATION
        let recBox = getId('simRec');
        if (totalNewBurnDOVX > 0) {
            recBox.className = "rec-box";
            recBox.style.color = "var(--red)";
            recBox.style.borderColor = "var(--red)";
            recBox.innerHTML = `ACTION REQUIRED: INCREASE PRODUCTION CAPACITY.<br>ADDED DOVX BURN: ${fmt(totalNewBurnDOVX)} / DAY.`;
        } else {
            recBox.className = "rec-box";
            recBox.style.color = "var(--green)";
            recBox.style.borderColor = "var(--green)";
            recBox.innerHTML = `LOGISTICS STABLE. NO IMMEDIATE ACTION REQUIRED.`;
        }
    }

    window.onload = init;
</script>
</body>
</html>
