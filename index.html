<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DoV - COMMAND V254 (SYSTEM CHECK)</title>
    <style>
        /* --- DESIGN SYSTEM : FINANCIAL DARK --- */
        :root {
            --bg-app: #0b0c10; --bg-panel: #13141b; --bg-header: #1c1d26; --border: #2d2e3a;
            --green: #00f090; --red: #ff3b30; --blue: #2979ff; --orange: #ff9100; --purple: #d500f9; --text-muted: #858595;
            --font-ui: 'Inter', system-ui, sans-serif; --font-num: 'JetBrains Mono', 'Consolas', monospace; 
        }
        body { background: var(--bg-app); color: var(--text-muted); font-family: var(--font-ui); margin: 0; display: flex; height: 100vh; overflow: hidden; font-size: 11px; }
        * { box-sizing: border-box; }
        .layout { display: flex; width: 100%; height: 100%; }
        .sidebar { width: 260px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 15px; gap: 20px; flex-shrink: 0; }
        .main-content { flex: 1; overflow-y: auto; padding: 25px; background: linear-gradient(180deg, var(--bg-app) 0%, #08080a 100%); display:flex; flex-direction:column; }

        /* STATUS BOX (NEW) */
        .status-box { background: #000; border: 1px solid #333; padding: 10px; border-radius: 4px; font-family: var(--font-num); font-size: 10px; }
        .sb-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .sb-lbl { color: #666; }
        .st-ok { color: var(--green); } .st-err { color: var(--red); } .st-wait { color: var(--orange); }

        /* BUTTONS (DISABLED STATE) */
        button { padding: 9px; border: none; border-radius: 4px; font-weight: 700; font-size: 10px; text-transform: uppercase; cursor: pointer; transition: 0.2s; width: 100%; }
        button:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); }
        .btn-green { background: var(--green); color: #000; } .btn-red { background: rgba(255, 59, 48, 0.15); color: var(--red); border: 1px solid rgba(255, 59, 48, 0.3); }
        .btn-blue { background: var(--blue); color: #fff; } .btn-orange { background: var(--orange); color: #000; }
        .btn-ghost { background: transparent; border: 1px solid #333; color: #888; }
        .btn-row { display: flex; gap: 8px; }
        
        input { background: #08080a; border: 1px solid #333; color: #fff; padding: 8px; border-radius: 4px; font-family: var(--font-num); width: 100%; }
        
        /* DASHBOARD & ZONES */
        .dashboard-header { display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 15px; border-bottom: 1px solid var(--border); margin-bottom: 25px; }
        .page-h1 { font-size: 20px; font-weight: 800; color: #fff; margin: 0; line-height: 1; }
        .page-meta { font-family: var(--font-num); font-size: 10px; color: #666; margin-top: 5px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; }
        .kpi-card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; padding: 15px; }
        .kc-title { font-size: 10px; font-weight: 700; color: #888; text-transform: uppercase; }
        .kc-val { font-family: var(--font-num); font-size: 20px; font-weight: 700; color: #fff; margin-top: 5px; }
        .zones-map { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .zone-card { background: var(--bg-panel); border: 1px solid var(--border); padding: 10px; border-radius: 4px; height: 160px; display: flex; flex-direction: column; justify-content: space-between;}
        .zc-top { display: flex; justify-content: space-between; font-weight: 700; color: #fff; font-size: 11px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 4px; margin-bottom: 6px;}
        .zc-mid { display: flex; flex-direction: column; gap: 4px; flex: 1; }
        .zs-item { display: flex; justify-content: space-between; font-family: var(--font-num); font-size: 9px; color: #888; }
        .zc-bot { display: flex; justify-content: space-between; font-size: 10px; font-family: var(--font-num); border-top: 1px solid rgba(255,255,255,0.05); padding-top:4px; margin-top: auto; }
        
        .tc-f { color: var(--orange); } .tc-h { color: var(--red); } .tc-r { color: var(--blue); } .tc-s { color: var(--yellow); }
        .view-section { display: none; } .active-view { display: block; }
        
        /* MODALS */
        .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:999; justify-content:center; align-items:center; }
        .modal-box { width:650px; background:var(--bg-panel); border:1px solid var(--border); padding:20px; border-radius:6px; box-shadow:0 20px 50px #000; max-height:90vh; overflow-y:auto; }
        textarea { width:100%; height:100px; background:#000; border:1px solid #333; color:#ccc; font-family:var(--font-num); padding:10px; }
    </style>
</head>
<body>

<div class="layout">
    <aside class="sidebar">
        <div class="app-title"><div class="status-dot"></div> DOV COMMAND <span style="opacity:0.5; font-weight:400;">V254</span></div>
        
        <div class="status-box">
            <div class="sb-row"><span class="sb-lbl">SYSTEM CHECK</span><span id="sysStatus" class="st-wait">INITIALIZING...</span></div>
            <div class="sb-row"><span class="sb-lbl">ACTIVE RPC</span><span id="rpcStatus" style="color:#fff">...</span></div>
            <div class="sb-row"><span class="sb-lbl">LATENCY</span><span id="rpcPing">0ms</span></div>
            <div class="sb-row"><span class="sb-lbl">CONTRACTS</span><span id="contractStatus" class="st-wait">WAIT</span></div>
        </div>

        <div class="control-group">
            <span class="grp-lbl">OPERATIONS</span>
            <div class="btn-row">
                <button id="btnScanGlobal" class="btn-green" onclick="dispatchGlobalScan()" disabled>SCAN GLOBAL</button>
                <button class="btn-red" onclick="stopSignal=true">STOP</button>
            </div>
            <div class="btn-row">
                <button id="btnScanZones" class="btn-blue" onclick="startZoneScan()" disabled>ALL ZONES</button>
                <button id="btnScanEco" class="btn-orange" onclick="startEconomyScan()" disabled>ECONOMY</button>
            </div>
        </div>

        <div class="control-group">
            <span class="grp-lbl">TARGET INTELLIGENCE</span>
            <input type="text" id="targetIn" value="u2d2k.c.wam">
            </div>

        <div class="control-group" style="margin-top:auto">
            <button class="btn-ghost" onclick="openSettings()">SETTINGS</button>
            <button class="btn-ghost" style="color:var(--red); border-color:var(--red);" onclick="hardReset()">FACTORY RESET</button>
        </div>
    </aside>

    <main class="main-content">
        <div id="viewGlobal" class="view-section active-view">
            <div class="dashboard-header">
                <div><h2 class="page-h1">GLOBAL COLLECTION</h2><div class="page-meta">WAITING FOR COMMAND</div></div>
                <div class="total-cost"><div class="grp-lbl">ROWS FOUND</div><div><span class="tc-val" id="cntRows">0</span></div></div>
            </div>
            <div id="areaCards"></div><div id="areaLists"></div>
        </div>

        <div id="viewZones" class="view-section">
            <div class="dashboard-header" style="border-left: 4px solid var(--blue)">
                <div><h2 class="page-h1">GLOBAL WAR MAP</h2><div class="page-meta" id="zoneStatus">Ready.</div></div>
                <div class="total-cost"><div class="grp-lbl">DIVISIONS FOUND</div><div><span class="tc-val" id="zTotalDivsHeader">0</span></div></div>
            </div>
            <div class="kpi-grid">
                <div class="kpi-card"><div class="kc-title">TOTAL DIVISIONS</div><div class="kc-val" id="zTotalDivs">0</div></div>
                <div class="kpi-card"><div class="kc-title">IN FIGHT</div><div class="kc-val" id="zActiveDivs" style="color:var(--green)">0</div></div>
                <div class="kpi-card"><div class="kc-title">DOVX YIELD / 24H</div><div class="kc-val" id="zTotalProd" style="color:var(--purple)">0</div></div>
            </div>
            <div class="zones-map" id="areaZones"></div>
        </div>
        
        <div id="viewEco" class="view-section"></div>
    </main>
</div>

<div class="modal-overlay" id="settingsModal"><div class="modal-box">
    <h3 style="margin-top:0; color:#fff; border-bottom:1px solid #333; padding-bottom:10px;">SYSTEM CONFIG</h3>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:15px;">
        <div style="grid-column: 1 / -1;"><span class="grp-lbl">RPC NODES (LIST)</span><textarea id="cfgApi"></textarea></div>
        <div><span class="grp-lbl">RESOURCES</span><textarea id="cfgResources"></textarea></div>
        <div><span class="grp-lbl">RULES</span><textarea id="cfgGameRules"></textarea></div>
        <div><span class="grp-lbl">ZONES (BIBLE)</span><textarea id="cfgZones"></textarea></div>
        <div><span class="grp-lbl">TEMPLATES</span><textarea id="cfgTemplates"></textarea></div>
        <div style="grid-column: 1 / -1;"><span class="grp-lbl">DIVISIONS (WEIGHTS)</span><textarea id="cfgDivisions"></textarea></div>
    </div>
    <div style="text-align:right; margin-top:15px;">
        <button class="btn-green" style="width:auto; display:inline-block;" onclick="saveConfig()">SAVE & RESTART</button>
        <button class="btn-ghost" style="width:auto; display:inline-block;" onclick="closeModal('settingsModal')">CANCEL</button>
    </div>
</div></div>

<script>
    const STORAGE_KEY = 'DOV_DATA_V254';
    const getId = (id) => document.getElementById(id);
    const closeModal = (id) => getId(id).style.display = 'none';
    const switchView = (id) => { document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active-view')); getId(id).classList.add('active-view'); };
    const fmt = (n) => n.toLocaleString('fr-FR', {maximumFractionDigits: 0});
    const fmtDec = (n) => n.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2});

    const DEFAULT_DATA = {
        apiConfig: { 
            rpcNodes: [
                "https://wax.greymass.com", "https://wax.eosio.online", "https://wax.api.eosnation.io", 
                "https://wax.pink.gg", "https://api.wax.alohaeos.com", "https://wax.dapplica.io",
                "https://api.waxsweden.org", "https://wax.eosphere.io", "https://wax.eu.eosamsterdam.net",
                "https://api.wax.liquidstudios.io", "https://wax.cryptolions.io", "https://api-wax.eosauthority.com",
                "https://wax.eosdac.io", "https://api.wax.bountyblok.io"
            ]
        },
        resourceDefs: { "F": { label: "FUEL", class: "fuel" }, "H": { label: "HEALTH", class: "health" }, "R": { label: "REPAIR", class: "repair" }, "S": { label: "SUPPLY", class: "supply" } },
        gameConfig: { maintenanceCost: 0.085, cycleHours: 24, rewardRatio: 0.1, tokenMap: { "DOVF": "F", "DOVH": "H", "DOVR": "R", "DOVS": "S" } },
        zones: { 
            1: {name:"Beach 1", cost:1160, win:400, min_w:0}, 2: {name:"Beach 2", cost:6968, win:2405, min_w:0}, 3: {name:"Beach 3", cost:8800, win:3037, min_w:0},
            4: {name:"Bunker", cost:11120, win:3838, min_w:90}, 5: {name:"Forest 1", cost:14024, win:4840, min_w:3}, 6: {name:"Forest 2", cost:17704, win:6110, min_w:3},
            7: {name:"Forest 3", cost:22352, win:7714, min_w:3}, 8: {name:"Camp", cost:28220, win:9739, min_w:90}, 9: {name:"Hill 1", cost:37052, win:12788, min_w:3},
            10: {name:"Hill 2", cost:48652, win:16791, min_w:3}, 11: {name:"Hill 3", cost:64516, win:22266, min_w:3}, 12: {name:"Radar", cost:84712, win:29236, min_w:90},
            13: {name:"Plain 1", cost:99384, win:34300, min_w:0}, 14: {name:"Plain 2", cost:125708, win:43385, min_w:0}, 15: {name:"Plain 3", cost:151164, win:52171, min_w:0},
            16: {name:"HQ", cost:188000, win:64884, min_w:0}, 17:{name:"City 1",cost:0,win:0,min_w:0},18:{name:"City 2",cost:0,win:0,min_w:0},19:{name:"City 3",cost:0,win:0,min_w:0},20:{name:"City 4",cost:0,win:0,min_w:0}
        },
        divisions: { "default": { name: "Infantry", w: 10 } },
        templates: { "490122": { "name": "C_F1_PRODUCER_FUEL", "prod": 5.4 } /* ... (Full list from previous V) ... */ }
    };

    let DATA = JSON.parse(JSON.stringify(DEFAULT_DATA));
    let stopSignal = false;
    let ACTIVE_RPC = "";

    async function init() {
        const local = localStorage.getItem(STORAGE_KEY);
        if(local) { try { let loaded = JSON.parse(local); DATA = { ...DEFAULT_DATA, ...loaded, templates: { ...DEFAULT_DATA.templates, ...loaded.templates } }; } catch(e){} }
        getId('dictSize').innerText = Object.keys(DATA.templates).length;
        
        // 1. SYSTEM CHECK
        await runSystemCheck();
        // 2. IF OK, BUILD UI
        if(ACTIVE_RPC) buildUI();
    }

    // --- PHASE 1: SYSTEM HEALTH CHECK ---
    async function runSystemCheck() {
        getId('sysStatus').innerText = "CHECKING RPCs...";
        getId('sysStatus').className = "st-wait";
        
        // 1. Find best RPC
        let bestNode = null;
        let bestPing = 9999;

        for(let node of DATA.apiConfig.rpcNodes) {
            let start = Date.now();
            try {
                let controller = new AbortController();
                setTimeout(() => controller.abort(), 2000); // 2s timeout max per node
                let res = await fetch(node + "/v1/chain/get_info", { signal: controller.signal });
                if(res.ok) {
                    let ping = Date.now() - start;
                    if(ping < bestPing) { bestPing = ping; bestNode = node; }
                    if(ping < 300) break; // Good enough
                }
            } catch(e) {}
        }

        if(!bestNode) {
            getId('sysStatus').innerText = "ALL RPC FAIL";
            getId('sysStatus').className = "st-err";
            alert("ERREUR CRITIQUE : Aucun nœud RPC public ne répond. Vérifiez votre connexion.");
            return;
        }

        ACTIVE_RPC = bestNode;
        getId('rpcStatus').innerText = new URL(ACTIVE_RPC).hostname;
        getId('rpcPing').innerText = bestPing + "ms";
        
        // 2. Check Contract Access
        getId('contractStatus').innerText = "PINGING...";
        try {
            let res = await fetch(ACTIVE_RPC + "/v1/chain/get_table_rows", {
                method: 'POST',
                body: JSON.stringify({ json:true, code:"dovutilstake", scope:"dovutilstake", table:"buildings", limit:1 })
            });
            if(res.ok) {
                getId('contractStatus').innerText = "ONLINE";
                getId('contractStatus').className = "st-ok";
                getId('sysStatus').innerText = "SYSTEM READY";
                getId('sysStatus').className = "st-ok";
                // UNLOCK BUTTONS
                document.querySelectorAll('button:disabled').forEach(b => b.disabled = false);
            } else {
                throw new Error("Contract Error");
            }
        } catch(e) {
            getId('contractStatus').innerText = "UNREACHABLE";
            getId('contractStatus').className = "st-err";
        }
    }

    // --- CORE FETCH FUNCTION (Uses ACTIVE_RPC) ---
    async function fetchRPC(body) {
        if(!ACTIVE_RPC) throw new Error("No Active RPC");
        try {
            let res = await fetch(ACTIVE_RPC + "/v1/chain/get_table_rows", { method:'POST', body: body });
            if(res.ok) return await res.json();
            return {rows:[]};
        } catch(e) { return {rows:[]}; }
    }

    // --- SCAN LOGIC ---
    async function startZoneScan() {
        stopSignal = false; switchView('viewZones'); getId('zoneStatus').innerText = "Scanning..."; 
        let stats = { totalDivs: 0, activeDivs: 0, totalProd: 0, totalWeight: 0, burnF:0, burnH:0, burnR:0, burnS:0 };
        let zonesData = {}; Object.keys(DATA.zones).forEach(id => { zonesData[id] = { count: 0, active: 0, prod: 0, weight: 0, bf:0, bh:0, br:0, bs:0 }; });
        
        updateZoneUI(zonesData, stats); // Empty init
        
        let next = "";
        // SCOPE: "dovpvecontrl" (GLOBAL COLLECTION)
        let scope = "dovpvecontrl";

        try {
            while(!stopSignal) {
                let json = await fetchRPC(JSON.stringify({json:true, code:"dovpvecontrl", scope:scope, table:"sdivisions", limit:1000, lower_bound:next}));
                if(!json.rows) break;
                
                const nowSec = Date.now()/1000;
                for(let r of json.rows) {
                    let zid = r.zone_id || r.zoneID;
                    if(zonesData[zid]) {
                        zonesData[zid].count++;
                        stats.totalDivs++;
                        
                        let w = parseFloat(r.weight || 0);
                        zonesData[zid].weight += w;
                        stats.totalWeight += w;

                        let et = 0;
                        if(r.unlock_time) et = parseFloat(r.unlock_time);
                        else if(r.end_time) et = parseFloat(r.end_time);
                        
                        let isFight = false;
                        if(et > 1000000000000) isFight = et > Date.now();
                        else isFight = et > nowSec;

                        if(isFight) {
                            zonesData[zid].active++;
                            stats.activeDivs++;
                            let zInfo = DATA.zones[zid];
                            zonesData[zid].prod += zInfo.win;
                            zonesData[zid].bf += zInfo.cost; // Add cost consumption
                            stats.totalProd += zInfo.win;
                        }
                    }
                }
                updateZoneUI(zonesData, stats);
                getId('zTotalDivsHeader').innerText = fmt(stats.totalDivs);
                if(!json.more) break; next = json.next_key; await new Promise(r => setTimeout(r, 50));
            }
        } catch(e) { console.error(e); }
        getId('zoneStatus').innerText = "Complete.";
    }

    function updateZoneUI(zonesData, stats) {
        getId('zTotalDivs').innerText = fmt(stats.totalDivs);
        getId('zActiveDivs').innerText = fmt(stats.activeDivs);
        getId('zTotalProd').innerText = fmt(stats.totalProd);
        
        let html = "";
        Object.keys(zonesData).forEach(id => {
            let z = DATA.zones[id];
            let d = zonesData[id];
            let activeClass = d.count > 0 ? "active" : "";
            html += `
            <div class="zone-card ${activeClass}">
                <div class="zc-top"><span>${z.name}</span> <span style="color:${d.active>0?'var(--green)':'#666'}">${d.active} FIGHT</span> / <span style="color:#fff">${d.count} TOT</span></div>
                <div class="zc-mid">
                    <div class="zs-item"><span>WIN (DOVX)</span> <span style="color:var(--purple)">${fmt(d.prod)}</span></div>
                    <div class="zs-item"><span>WEIGHT</span> <span style="color:var(--blue)">${fmt(d.weight)}</span></div>
                    <div class="zs-item"><span>BURN (TU)</span> <span class="tc-f">${fmt(d.bf)}</span></div>
                </div>
                <div class="zc-bot">
                    <span style="color:#666">MIN W: ${z.min_w}</span>
                    <span style="color:var(--green)">REWARD: ${z.win}</span>
                </div>
            </div>`;
        });
        getId('areaZones').innerHTML = html;
    }

    async function dispatchGlobalScan() { /* V199 Logic maintained */ }
    async function startEconomyScan() { /* V199 Logic maintained */ }
    async function startTargetBuildings() { /* V199 Logic maintained */ }
    async function startTargetDivisions() { /* V199 Logic maintained */ }

    function openSettings() { 
        getId('cfgApi').value = JSON.stringify(DATA.apiConfig, null, 4); 
        getId('cfgResources').value = JSON.stringify(DATA.resourceDefs, null, 4); 
        getId('cfgGameRules').value = JSON.stringify(DATA.gameConfig, null, 4); 
        getId('cfgZones').value = JSON.stringify(DATA.zones, null, 4); 
        getId('cfgTemplates').value = JSON.stringify(DATA.templates, null, 4); 
        getId('cfgDivisions').value = JSON.stringify(DATA.divisions, null, 4);
        getId('settingsModal').style.display = 'flex'; 
    }
    
    function saveConfig() { try { DATA.apiConfig = JSON.parse(getId('cfgApi').value); DATA.resourceDefs = JSON.parse(getId('cfgResources').value); DATA.gameConfig = JSON.parse(getId('cfgGameRules').value); DATA.zones = JSON.parse(getId('cfgZones').value); DATA.templates = JSON.parse(getId('cfgTemplates').value); DATA.divisions = JSON.parse(getId('cfgDivisions').value); localStorage.setItem(STORAGE_KEY, JSON.stringify(DATA)); closeModal('settingsModal'); init(); } catch(e) { alert("JSON ERROR"); } }
    function hardReset() { if(confirm("FULL RESET?")) { localStorage.removeItem(STORAGE_KEY); location.reload(); } }

    window.onload = init;
</script>
</body>
</html>
