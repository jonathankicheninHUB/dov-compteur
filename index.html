<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DoV - COMMAND V175 (ULTIMATE)</title>
    <style>
        /* --- WEB3 DESIGN SYSTEM (RESTORED V173) --- */
        :root { 
            --bg-dark: #050508;
            --panel-bg: rgba(20, 20, 25, 0.7);
            --panel-border: rgba(255, 255, 255, 0.08);
            --glass: blur(12px);
            
            --main: #00d2d3;   /* Cyan neon */
            --sec: #5f27cd;    /* Deep Purple */
            --alert: #ff4757;  /* Bright Red */
            --warn: #ff9f43;
            --gold: #ffd32a;
            --dovx: #c8d6e5;
            
            --fuel: #ff9f43; --health: #ff6b6b; --repair: #54a0ff; --supply: #feca57;
            --text-main: #f1f2f6; --text-muted: #a4b0be;
        }
        
        body { 
            background-color: var(--bg-dark); 
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(95, 39, 205, 0.15) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(0, 210, 211, 0.1) 0%, transparent 20%);
            color: var(--text-main); 
            font-family: 'Segoe UI', 'Roboto', 'Consolas', monospace;
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; 
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

        header { 
            height: 50px; background: rgba(0,0,0,0.5); backdrop-filter: var(--glass);
            border-bottom: 1px solid var(--panel-border); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; 
            z-index: 10;
        }
        h1 { 
            color: var(--text-main); margin: 0; font-size: 16px; letter-spacing: 2px; font-weight: 800; 
            background: -webkit-linear-gradient(0deg, #fff, #a4b0be); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .layout { display: flex; flex: 1; overflow: hidden; }

        .sidebar { 
            width: 300px; background: var(--panel-bg); border-right: 1px solid var(--panel-border); 
            padding: 20px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; backdrop-filter: var(--glass);
        }
        
        .box { 
            border: 1px solid var(--panel-border); padding: 15px; background: rgba(255,255,255,0.02); 
            border-radius: 12px; margin-bottom: 10px; transition: all 0.3s ease;
        }
        .box:hover { border-color: rgba(255,255,255,0.1); background: rgba(255,255,255,0.04); }
        .box-title { color: var(--text-muted); font-size: 10px; font-weight: 700; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--panel-border); padding-bottom: 5px; }

        input, select, textarea { 
            width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid var(--panel-border); 
            color: #fff; border-radius: 6px; font-family: 'Consolas', monospace; margin-bottom: 8px; box-sizing: border-box;
        }
        .inp-label { font-size: 9px; color: var(--text-muted); margin-bottom: 2px; display: block; }

        button { 
            width: 100%; padding: 12px; cursor: pointer; border: none; font-weight: 700; font-size: 11px; 
            text-transform: uppercase; letter-spacing: 0.5px; border-radius: 8px; margin-bottom: 8px; 
            transition: all 0.2s; position: relative; overflow: hidden;
        }
        button:active { transform: scale(0.98); }

        .btn-zone { background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); color: #000; }
        .btn-eco { background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%); color: #000; }
        .btn-target { background: linear-gradient(135deg, #0984e3 0%, #74b9ff 100%); color: #fff; }
        .btn-build { background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%); color: #fff; }
        .btn-stop { background: linear-gradient(135deg, #d63031 0%, #ff7675 100%); color: #fff; }
        .btn-global { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.1); }
        
        .btn-settings { background: transparent; color: var(--text-muted); border: 1px solid var(--panel-border); }
        .btn-settings:hover { border-color: var(--main); color: var(--main); }
        .btn-update { background: rgba(255, 159, 67, 0.1); color: #ff9f43; border: 1px solid rgba(255, 159, 67, 0.3); }
        .btn-reset { background: rgba(255, 71, 87, 0.1); color: #ff4757; border: 1px dashed rgba(255, 71, 87, 0.3); font-size: 10px; margin-top: 10px; }

        .btn-time { 
            background: rgba(255,255,255,0.05); color: #fff; border: 1px solid var(--panel-border); 
            padding: 6px 15px; border-radius: 20px; font-size: 10px; margin-left: 15px; font-weight: bold;
        }

        .main-view { flex: 1; padding: 30px; overflow-y: auto; background: radial-gradient(circle at 50% 0%, rgba(20,20,30,1) 0%, rgba(5,5,8,1) 100%); }

        .g-main-count { 
            background: linear-gradient(90deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid var(--panel-border); padding: 20px; border-radius: 16px; 
            display:flex; justify-content:space-between; align-items:center; margin-bottom: 25px; backdrop-filter: blur(5px);
            border-left: 4px solid var(--main);
        }
        .g-title { font-weight:800; color:#fff; font-size:16px; letter-spacing: 1px; }
        .g-cost-val { color: #fff; font-weight:800; font-size:24px; text-shadow: 0 0 15px rgba(255,255,255,0.3); }

        .g-detail-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 15px; }
        .g-card { 
            background: rgba(255,255,255,0.03); border: 1px solid var(--panel-border); padding: 15px; 
            border-radius: 12px; display: flex; flex-direction: column; justify-content:space-between; min-height:100px;
        }
        .g-card-head { font-weight:700; font-size:11px; padding-bottom:8px; border-bottom:1px solid rgba(255,255,255,0.05); text-align:center; color:var(--text-muted); }
        .g-prod-val { font-size:20px; font-weight:800; color:#fff; text-align:center; margin-top:15px; }
        .g-prod-lbl { font-size:9px; color:rgba(255,255,255,0.3); text-align:center; margin-top: 5px; }

        .model-list-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top:30px; }
        .ml-col { background: rgba(20,20,25,0.5); border: 1px solid var(--panel-border); border-radius: 12px; overflow: hidden; }
        
        .ml-header { 
            padding: 12px 15px; background: rgba(255,255,255,0.03); font-weight: 700; font-size: 11px; color: var(--text-muted); 
            border-bottom: 1px solid var(--panel-border); display: flex; justify-content: space-between; align-items: center;
        }
        .header-cost-badge { font-size:9px; color:var(--dovx); background:rgba(200, 214, 229, 0.1); padding:3px 8px; border-radius:10px; margin-left:8px; border: 1px solid rgba(200, 214, 229, 0.2); }

        .ml-row { 
            display: grid; grid-template-columns: 4fr 1.5fr 2fr; padding: 10px 15px; 
            border-bottom: 1px solid rgba(255,255,255,0.02); font-size: 12px; align-items: center; color: #ccc; 
            font-family: 'Consolas', monospace; transition: background 0.1s;
        }
        .ml-row:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .ml-name { color: #fff; font-weight:500; }
        .ml-mult { color: #000; font-size:10px; background:var(--main); padding:1px 5px; border-radius:4px; margin-left:6px; font-weight:800; }
        .c-active { color: var(--main); font-size: 10px; opacity: 0.8; margin-left: 5px; }

        .debug-box { margin-top:40px; border:1px solid var(--panel-border); background:rgba(0,0,0,0.3); padding:15px; border-radius: 8px; }
        .debug-grid { display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; font-size:10px; max-height:200px; overflow-y:auto; font-family: 'Consolas', monospace; }
        .d-row { background:rgba(255,255,255,0.03); padding:5px; border-radius:4px; display:flex; justify-content:space-between; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 1000; justify-content: center; align-items: center; }
        .modal-box { background: #111; border: 1px solid var(--panel-border); width: 700px; max-height: 90vh; display: flex; flex-direction: column; border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal-head { padding: 15px 20px; background: rgba(255,255,255,0.05); border-bottom: 1px solid var(--panel-border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; color: #ccc; font-size: 11px; }

        /* Helpers */
        .c-cost-mini { color: var(--text-muted); font-size: 10px; opacity: 0.6; }
        .rpc-badge { font-size: 10px; background: rgba(0,0,0,0.5); padding: 4px 8px; border-radius: 4px; border: 1px solid var(--panel-border); color: var(--text-muted); }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:10px;">
        <div style="width:10px; height:10px; background:var(--main); border-radius:50%; box-shadow:0 0 10px var(--main);"></div>
        <h1>DoV COMMAND <span style="font-weight:300; font-size:12px; color:var(--text-muted); opacity:0.7;">V175 ULTIMATE</span></h1>
    </div>
    <div style="display:flex; align-items:center;">
        <button class="btn-time" onclick="toggleTimeMode()" id="btnTimeMode">‚è±Ô∏è MODE: 1H (LIVE)</button>
        <span class="rpc-badge" id="rpcStatus">PR√äT</span>
    </div>
</header>

<div class="layout">
    <aside class="sidebar">
        <button class="btn-settings" onclick="openSettings()">‚öôÔ∏è PARAM√àTRES</button>
        <button class="btn-reset" onclick="hardReset()">‚ö†Ô∏è RESET USINE</button>
        
        <div class="box" style="margin-top:10px;">
            <div class="box-title">DICTIONNAIRE</div>
            <div style="font-size:10px; margin-bottom:5px; color:var(--text-muted);">Templates connus : <b id="dictSize" style="color:#fff">0</b></div>
            <button class="btn-update" onclick="updateDictionary()">üì• T√âL√âCHARGER</button>
        </div>

        <div class="box" style="border-color: var(--gold)">
            <div class="box-title" style="color:var(--gold)">CONFIGURATION RAPIDE</div>
            <label class="inp-label">Prix WAX ($)</label>
            <input type="number" id="inpWax" step="0.00001" onchange="updateRates()">
            <label class="inp-label">Parit√© DOVX</label>
            <input type="number" id="inpDovx" step="0.00000001" onchange="updateRates()">
            <label class="inp-label">Parit√© TU</label>
            <input type="number" id="inpTu" step="0.00000001" onchange="updateRates()">
        </div>
        <div class="box">
            <div class="box-title">CONTROLS</div>
            <button class="btn-zone" onclick="startZoneScan()">SCAN ZONES</button>
            <button class="btn-eco" onclick="startEconomyScan()">SCAN ECONOMY</button>
            <button class="btn-stop" id="btnStop" onclick="stopSignal=true">ARR√äT</button>
        </div>
        <div class="box">
            <div class="box-title">TARGET</div>
            <button class="btn-global" onclick="dispatchGlobalScan()">SCAN GLOBAL (ALL)</button>
            <div style="border-top:1px solid var(--panel-border); margin: 15px 0;"></div>
            <input type="text" id="targetIn" value="u2d2k.c.wam">
            <button class="btn-target" onclick="startTarget()">SCAN DIVISIONS</button>
            <button class="btn-build" onclick="startBuildings()">SCAN B√ÇTIMENTS</button>
        </div>
    </aside>

    <main class="main-view">
        <div id="globalStatsArea" style="display:none; margin-bottom:20px;">
            <div class="g-main-count">
                <div class="g-mc-left">
                    <div class="g-title" id="scanModeTitle">SCAN GLOBAL (LIVE)</div>
                    <div class="scan-stats-row">
                        <div class="scan-stat-item">Lignes: <b id="cntRows" style="color:var(--text-main)">0</b></div>
                        <div class="scan-stat-item">NFTs: <b id="cntAssets" style="color:var(--main)">0</b></div>
                    </div>
                </div>
                <div class="g-mc-right"><div class="g-cost-label">CO√õT TOTAL DOV-X</div><div class="g-cost-val" id="gTotalCost">0</div></div>
            </div>
            <div class="g-detail-grid" id="dynamicCardsArea"></div>
            <div class="model-list-container" id="dynamicListsArea"></div>

            <div class="debug-box">
                <div class="debug-title">RAPPORT DE SCAN (TEMPLATES TROUV√âS)</div>
                <div class="debug-grid" id="debugGrid"></div>
            </div>
        </div>

        <div id="zoneView" class="view-section" style="display:none;">
             <div class="stats-row">
                <div class="stat"><span class="stat-val" id="dDivs">0</span><span class="stat-lbl">Divisions</span></div>
                <div class="stat"><span class="stat-val val-win" id="dGain">0</span><span class="stat-lbl">GAIN (DOVX)</span></div>
                <div class="stat" style="border-top: 1px solid var(--panel-border)">
                    <div class="res-grid">
                        <div class="res-item"><span><span class="dot d-fuel"></span>DOVF</span> <span id="lFuel" style="color:var(--fuel)">0</span></div>
                        <div class="res-item"><span><span class="dot d-health"></span>DOVH</span> <span id="lHealth" style="color:var(--health)">0</span></div>
                        <div class="res-item"><span><span class="dot d-repair"></span>DOVR</span> <span id="lRepair" style="color:var(--repair)">0</span></div>
                        <div class="res-item"><span><span class="dot d-supply"></span>DOVS</span> <span id="lSupply" style="color:var(--supply)">0</span></div>
                    </div>
                    <span class="stat-lbl">CONSO ACTIVE / 24H</span>
                </div>
                <div class="stat"><span class="stat-val val-cost-x" id="dCostX">0</span><span class="stat-lbl">Conso. Villes</span></div>
            </div>
            <div class="zones-grid" id="zonesArea"></div>
        </div>
        
        <div id="ecoView" class="view-section" style="display:none;">
            <div class="eco-grid">
                <div class="eco-card c-fighter"><div class="eco-head"><span>DEMANDE</span></div><div class="eco-val" id="valDemandTU">0 TU</div><div class="eco-usd" id="valDemandUSD">$0.00 / 24h</div></div>
                <div class="eco-card c-producer"><div class="eco-head"><span>OFFRE</span></div><div class="eco-val" id="valSupplyTU">0 TU</div><div class="eco-usd" id="valSupplyUSD">$0.00 / 24h</div></div>
                <div class="eco-card c-market"><div class="eco-head"><span>PRESSION DOVX</span></div><div class="eco-val" id="valDovxBurn">0 DOVX</div><div class="eco-usd" id="valDovxUSD">$0.00 / 24h</div></div>
            </div>
        </div>
        
        <div id="targetView" class="view-section" style="display:none;"></div>
        
        <div id="buildList" class="build-grid"></div>

        <div class="logs" id="console">> V175. RESTORED.</div>
    </main>
</div>

<div class="modal-overlay" id="zoneModal" onclick="if(event.target===this) closeModal('zoneModal')">
    <div class="modal-box">
        <div class="modal-head">
            <div class="modal-title" id="zmTitle">RADAR MULTI-COMPTES</div>
            <div class="modal-close" onclick="closeModal('zoneModal')">√ó</div>
        </div>
        <div class="modal-body" id="zmBody"></div>
    </div>
</div>

<div class="modal-overlay" id="settingsModal" onclick="if(event.target===this) closeModal('settingsModal')">
    <div class="modal-box" style="width:700px;">
        <div class="modal-head">
            <div class="modal-title">‚öôÔ∏è CONFIGURATION</div>
            <div class="modal-close" onclick="closeModal('settingsModal')">√ó</div>
        </div>
        <div class="modal-body">
            <div class="set-group">
                <span class="set-title">INTERFACE & RESSOURCES (JSON)</span>
                <textarea id="cfgResources" style="height:100px;"></textarea>
            </div>
            <div class="set-group">
                <span class="set-title">R√àGLES DE JEU</span>
                <textarea id="cfgGameRules" style="height:80px;"></textarea>
            </div>
            <div class="set-group">
                <span class="set-title">ZONES</span>
                <textarea id="cfgZones" style="height:80px;"></textarea>
            </div>
            <div class="set-group">
                <span class="set-title">DICTIONNAIRE TEMPLATES</span>
                <textarea id="cfgTemplates" style="height:100px;"></textarea>
            </div>
            <div style="text-align:right;">
                <button class="btn-action" style="background:#444;" onclick="resetConfig()">R√âINITIALISER</button>
                <button class="btn-action" onclick="saveConfig()">SAUVEGARDER</button>
            </div>
        </div>
    </div>
</div>

<script>
    window.closeModal = function(id) { document.getElementById(id).style.display = 'none'; }
    function switchView(id) { 
        document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none'); 
        document.getElementById('globalStatsArea').style.display = 'none'; // Special case
        document.getElementById('buildList').style.display = 'none'; // Special case
        
        let el = document.getElementById(id);
        if(el) {
            el.style.display = 'block'; 
            el.classList.add('view-active');
        }
    }

    // --- DEFAULT DATA (RESTAUR√â COMPLET) ---
    const DEFAULT_DATA = {
        resourceDefs: {
            "F": { label: "FUEL", color: "#ff9f43", css: "c-f" },
            "H": { label: "HEALTH", color: "#ff6b6b", css: "c-h" },
            "R": { label: "REPAIR", color: "#54a0ff", css: "c-r" },
            "S": { label: "SUPPLY", color: "#feca57", css: "c-s" }
        },
        gameConfig: {
            maintenanceCost: 0.085,
            cycleHours: 24,
            tokenMap: { "DOVF": "F", "DOVH": "H", "DOVR": "R", "DOVS": "S" }
        },
        zones: { 1:{name:"Beach 1",cost:1160,costX:0,reward:400},2:{name:"Beach 2",cost:6968,costX:0,reward:2405},3:{name:"Beach 3",cost:8800,costX:0,reward:3037},4:{name:"Bunker",cost:11120,costX:0,reward:3838},5:{name:"Forest 1",cost:14024,costX:0,reward:4839},6:{name:"Forest 2",cost:17704,costX:0,reward:6092},7:{name:"Forest 3",cost:22352,costX:0,reward:7659},8:{name:"Camp",cost:28220,costX:0,reward:9617},9:{name:"Hill 1",cost:37052,costX:0,reward:12557},10:{name:"Hill 2",cost:48652,costX:0,reward:16418},11:{name:"Hill 3",cost:64516,costX:0,reward:21703},12:{name:"Radar",cost:84712,costX:0,reward:28427},13:{name:"Plain 1",cost:99384,costX:0,reward:34300},14:{name:"Plain 2",cost:125708,costX:0,reward:42083},15:{name:"Plain 3",cost:151164,costX:0,reward:50570},16:{name:"HQ",cost:188000,costX:0,reward:64884},17:{name:"City 1",cost:0,costX:1664,reward:0},18:{name:"City 2",cost:0,costX:4448,reward:0},19:{name:"City 3",cost:0,costX:13440,reward:0},20:{name:"City 4",cost:0,costX:29120,reward:0}},
        templates: {
            "490122": { "name": "C_F1_PRODUCER_FUEL", "prod": 5.4 }, "492383": { "name": "C_F1_PRODUCER_FUEL", "prod": 5.4 },
            "492385": { "name": "C_F2_PRODUCER_FUEL", "prod": 12.15 }, "492389": { "name": "C_F3_PRODUCER_FUEL", "prod": 30.38 },
            "492397": { "name": "C_F4_PRODUCER_FUEL", "prod": 83.53 }, "492373": { "name": "R_F1_PRODUCER_FUEL", "prod": 16.20 },
            "492379": { "name": "R_F1_PRODUCER_FUEL", "prod": 16.20 }, "492376": { "name": "R_F2_PRODUCER_FUEL", "prod": 36.45 },
            "492386": { "name": "R_F3_PRODUCER_FUEL", "prod": 91.13 }, "492390": { "name": "R_F4_PRODUCER_FUEL", "prod": 250.59 },
            "492380": { "name": "E_F1_PRODUCER_FUEL", "prod": 48.60 }, "492381": { "name": "E_F2_PRODUCER_FUEL", "prod": 109.35 },
            "492387": { "name": "E_F3_PRODUCER_FUEL", "prod": 273.38 }, "492388": { "name": "E_F4_PRODUCER_FUEL", "prod": 751.78 },
            "492368": { "name": "L_F1_PRODUCER_FUEL", "prod": 145.80 }, "492370": { "name": "L_F2_PRODUCER_FUEL", "prod": 328.05 },
            "492372": { "name": "L_F3_PRODUCER_FUEL", "prod": 820.13 }, "544068": { "name": "S1_OWNER_FUEL", "prod": 2255.34 },
            "492377": { "name": "SC_F2_PRODUCER_FUEL", "prod": 54.00 }, "492391": { "name": "SC_F3_PRODUCER_FUEL", "prod": 121.50 },
            "492392": { "name": "S1_OWNER_FUEL (VAR)", "prod": 2255.34 }, "492366": { "name": "C_F3_PRODUCER_FUEL (VAR)", "prod": 30.38 }, "492363": { "name": "C_F2_PRODUCER_FUEL (VAR)", "prod": 12.15 },
            "492394": { "name": "C_F1_PRODUCER_HEALTH", "prod": 5.4 }, "492395": { "name": "C_F2_PRODUCER_HEALTH", "prod": 12.15 },
            "492396": { "name": "C_F3_PRODUCER_HEALTH", "prod": 30.38 }, "492399": { "name": "R_F1_PRODUCER_HEALTH", "prod": 16.20 },
            "492401": { "name": "R_F2_PRODUCER_HEALTH", "prod": 36.45 }, "492535": { "name": "R_F3_PRODUCER_HEALTH", "prod": 91.13 },
            "492537": { "name": "R_F4_PRODUCER_HEALTH", "prod": 250.59 }, "492539": { "name": "E_F1_PRODUCER_HEALTH", "prod": 48.60 },
            "492543": { "name": "E_F2_PRODUCER_HEALTH", "prod": 109.35 }, "492545": { "name": "E_F3_PRODUCER_HEALTH", "prod": 273.38 },
            "492546": { "name": "E_F4_PRODUCER_HEALTH", "prod": 751.78 }, "492550": { "name": "L_F1_PRODUCER_HEALTH", "prod": 145.80 },
            "492554": { "name": "L_F2_PRODUCER_HEALTH", "prod": 328.05 }, "492555": { "name": "L_F3_PRODUCER_HEALTH", "prod": 820.13 },
            "544070": { "name": "S1_OWNER_HEALTH", "prod": 2255.34 },
            "492460": { "name": "C_F1_PRODUCER_REPAIR", "prod": 5.4 }, "492461": { "name": "C_F2_PRODUCER_REPAIR", "prod": 12.15 },
            "492462": { "name": "C_F3_PRODUCER_REPAIR", "prod": 30.38 }, "492463": { "name": "C_F4_PRODUCER_REPAIR", "prod": 83.53 },
            "492464": { "name": "R_F1_PRODUCER_REPAIR", "prod": 16.20 }, "492465": { "name": "R_F2_PRODUCER_REPAIR", "prod": 36.45 },
            "492466": { "name": "R_F3_PRODUCER_REPAIR", "prod": 91.13 }, "492467": { "name": "R_F4_PRODUCER_REPAIR", "prod": 250.59 },
            "492469": { "name": "E_F1_PRODUCER_REPAIR", "prod": 48.60 }, "492471": { "name": "E_F2_PRODUCER_REPAIR", "prod": 109.35 },
            "492472": { "name": "E_F3_PRODUCER_REPAIR", "prod": 273.38 }, "492473": { "name": "E_F4_PRODUCER_REPAIR", "prod": 751.78 },
            "492474": { "name": "L_F1_PRODUCER_REPAIR", "prod": 145.80 }, "492475": { "name": "L_F2_PRODUCER_REPAIR", "prod": 328.05 },
            "492476": { "name": "L_F3_PRODUCER_REPAIR", "prod": 820.13 }, "544071": { "name": "S1_OWNER_REPAIR", "prod": 2255.34 },
            "492507": { "name": "C_F1_PRODUCER_SUPPLY", "prod": 5.4 }, "492509": { "name": "C_F2_PRODUCER_SUPPLY", "prod": 12.15 },
            "492511": { "name": "C_F3_PRODUCER_SUPPLY", "prod": 30.38 }, "492513": { "name": "C_F4_PRODUCER_SUPPLY", "prod": 83.53 },
            "492515": { "name": "R_F1_PRODUCER_SUPPLY", "prod": 16.20 }, "492518": { "name": "R_F2_PRODUCER_SUPPLY", "prod": 36.45 },
            "492521": { "name": "R_F3_PRODUCER_SUPPLY", "prod": 91.13 }, "492523": { "name": "R_F4_PRODUCER_SUPPLY", "prod": 250.59 },
            "492526": { "name": "E_F1_PRODUCER_SUPPLY", "prod": 48.60 }, "492528": { "name": "E_F2_PRODUCER_SUPPLY", "prod": 109.35 },
            "492529": { "name": "E_F3_PRODUCER_SUPPLY", "prod": 273.38 }, "492530": { "name": "E_F4_PRODUCER_SUPPLY", "prod": 751.78 },
            "492532": { "name": "L_F1_PRODUCER_SUPPLY", "prod": 145.80 }, "492533": { "name": "L_F2_PRODUCER_SUPPLY", "prod": 328.05 },
            "492534": { "name": "L_F3_PRODUCER_SUPPLY", "prod": 820.13 }, "544069": { "name": "S1_OWNER_SUPPLY", "prod": 2255.34 }
        },
        claimLevels: [{ name: "WIN",  minPower: 1200, coeff: 1.0 },{ name: "DRAW", minPower: 500,  coeff: 0.5 },{ name: "LOST", minPower: 0,    coeff: 0.25 }],
        rates: { WAX_USD: 0.00786, DOVX_WAX: 0.00528553, TU_WAX: 0.00045262 }
    };
    
    let SYSTEM_CONFIG = { strategy: 'B', batchSize: 1000, delay: 200, startKey: '', sortOrder: ["C_F1","C_F2","C_F3","C_F4","R_F1","R_F2","R_F3","R_F4","E_F1","E_F2","E_F3","E_F4","L_F1","L_F2","L_F3","S1","SC_F2","SC_F3"], atomicApi: "https://wax.api.atomicassets.io/atomicassets/v1/templates?collection_name=dovdivisions&schema_name=warbuildings&limit=500", rpcs: ["https://wax.greymass.com", "https://api.waxsweden.org", "https://wax.eosn.io"], proxies: ["", "https://corsproxy.io/?"] };
    let CORE_DATA = JSON.parse(JSON.stringify(DEFAULT_DATA));
    let SYS_CONFIG = JSON.parse(JSON.stringify(SYSTEM_CONFIG));
    let ZONE_DETAILS = {}; let stopSignal = false; let rpcIndex = 0; let proxyIndex = 0;
    let ECO_DATA = { demand: { fuel:0, health:0, repair:0, supply:0 }, supply: { fuel:0, health:0, repair:0, supply:0 }, dovx: { cities:0, buildings:0, rewards:0 }, scanned: 0 };
    let USE_HOURLY = true; 

    function log(msg, color="#aaa") { const c = document.getElementById('console'); if(c) c.innerHTML = `<div style="color:${color}">[${new Date().toLocaleTimeString()}] ${msg}</div>` + c.innerHTML; }
    function setTextSafe(id, txt) { let el = document.getElementById(id); if(el) el.innerText = txt; }
    function getProp(obj, keys) { for(let k of keys) if(obj[k] !== undefined) return obj[k]; return 0; }
    function isBusy(row) { return (getProp(row, ['end_time', 'end']) > (Date.now()/1000)); }
    function getId(row) { return row.asset_id || row.id || row.division_id || 0; }
    function extractPower(row) { let val = Array.isArray(row.power) ? row.power[0] : (row.power || row.pwr); if (typeof val === 'string') val = val.replace(/[^0-9.]/g, ''); return parseFloat(val) || 0; }
    function computeDovxReward(baseReward, divisionPower) { if(!CORE_DATA.claimLevels) return 0; for (let lvl of CORE_DATA.claimLevels) { if (divisionPower >= lvl.minPower) return baseReward * lvl.coeff; } return 0; }
    function updateRates() { CORE_DATA.rates.WAX_USD = parseFloat(document.getElementById('inpWax').value) || 0; CORE_DATA.rates.DOVX_WAX = parseFloat(document.getElementById('inpDovx').value) || 0; CORE_DATA.rates.TU_WAX = parseFloat(document.getElementById('inpTu').value) || 0; if(document.getElementById('ecoView').classList.contains('view-active')) updateEcoDisplay(); }

    function initUI() {
        const cardContainer = document.getElementById('dynamicCardsArea');
        const listContainer = document.getElementById('dynamicListsArea');
        cardContainer.innerHTML = ''; listContainer.innerHTML = '';
        for(let key in CORE_DATA.resourceDefs) {
            let res = CORE_DATA.resourceDefs[key];
            let card = document.createElement('div');
            card.className = "g-card"; card.style.borderTop = `3px solid ${res.color}`;
            card.innerHTML = `<div class="g-card-head">${res.label}</div><div class="g-prod-val" style="color:${res.color}" id="pwr-${key}">0</div><div class="g-prod-lbl" id="lbl-${key}">PROD / H</div>`;
            cardContainer.appendChild(card);
            let col = document.createElement('div'); col.className = `ml-col ${res.css || ''}`;
            if(res.color) col.style.borderLeft = `4px solid ${res.color}`; col.id = `list-${key}`;
            listContainer.appendChild(col);
        }
    }

    function initApp() {
        const storedSys = localStorage.getItem('DOV_SYS');
        if(storedSys) try { SYS_CONFIG = { ...SYSTEM_CONFIG, ...JSON.parse(storedSys) }; } catch(e) {}
        const storedData = localStorage.getItem('DOV_DATA');
        if(storedData) {
            try { 
                let loaded = JSON.parse(storedData);
                CORE_DATA.zones = loaded.zones || DEFAULT_DATA.zones;
                CORE_DATA.templates = { ...DEFAULT_DATA.templates, ...(loaded.templates || {}) };
                CORE_DATA.rates = loaded.rates || DEFAULT_DATA.rates;
                CORE_DATA.claimLevels = loaded.claimLevels || DEFAULT_DATA.claimLevels; 
                CORE_DATA.gameConfig = { ...DEFAULT_DATA.gameConfig, ...(loaded.gameConfig || {}) };
                CORE_DATA.resourceDefs = { ...DEFAULT_DATA.resourceDefs, ...(loaded.resourceDefs || {}) };
            } catch(e) { CORE_DATA = JSON.parse(JSON.stringify(DEFAULT_DATA)); }
        }
        document.getElementById('inpWax').value = CORE_DATA.rates.WAX_USD;
        document.getElementById('inpDovx').value = CORE_DATA.rates.DOVX_WAX;
        document.getElementById('inpTu').value = CORE_DATA.rates.TU_WAX;
        document.getElementById('dictSize').innerText = Object.keys(CORE_DATA.templates).length;
        initUI(); initGrid();
        log("‚úÖ Syst√®me initialis√©.", "#00d2d3");
    }

    function hardReset() {
        if(confirm("‚ö†Ô∏è RESET TOTAL ?")) { localStorage.removeItem('DOV_SYS'); localStorage.removeItem('DOV_DATA'); location.reload(); }
    }

    function toggleTimeMode() {
        USE_HOURLY = !USE_HOURLY;
        let btn = document.getElementById('btnTimeMode');
        btn.innerText = USE_HOURLY ? "‚è±Ô∏è MODE: 1H (LIVE)" : "üìÖ MODE: 24H (DAILY)";
        btn.style.background = USE_HOURLY ? "rgba(255,255,255,0.05)" : "rgba(0, 210, 211, 0.2)";
        btn.style.borderColor = USE_HOURLY ? "rgba(255,255,255,0.1)" : "var(--main)";
        let suffix = USE_HOURLY ? "/ H" : "/ 24H";
        for(let key in CORE_DATA.resourceDefs) { let el = document.getElementById('lbl-'+key); if(el) el.innerText = "PROD " + suffix; }
        if(document.getElementById('globalStatsArea').style.display === 'block') { log("Mode chang√©. Relancez le scan.", "#ffd32a"); }
    }

    async function robustFetch(code, table, lowerBound, limit=1000, customScope=null, indexPos=1, keyType="") {
        let attempts = 0; const effectiveLimit = limit || SYS_CONFIG.batchSize; const effectiveScope = customScope ? customScope : code;
        while(attempts < 20 && !stopSignal) {
            const server = SYS_CONFIG.rpcs[rpcIndex % SYS_CONFIG.rpcs.length]; const proxy = SYS_CONFIG.proxies[proxyIndex % SYS_CONFIG.proxies.length]; rpcIndex++; 
            const url = server + "/v1/chain/get_table_rows"; let finalUrl = url; if(proxy && proxy.length > 5) finalUrl = proxy + encodeURIComponent(url);
            try {
                let statusText = `[RPC: ${new URL(server).hostname}]`; if(proxy && proxy.length > 5) statusText += ` + [PXY: ${new URL(proxy).hostname}]`; else statusText += ` + [DIRECT]`;
                if(document.getElementById('rpcStatus')) document.getElementById('rpcStatus').innerText = statusText;
                const controller = new AbortController(); setTimeout(() => controller.abort(), 15000); 
                const payload = { json: true, code: code, scope: effectiveScope, table: table, limit: effectiveLimit, lower_bound: lowerBound };
                if(indexPos > 1) { payload.index_position = indexPos; payload.key_type = keyType; payload.upper_bound = lowerBound; }
                const res = await fetch(finalUrl, { method: 'POST', body: JSON.stringify(payload), signal: controller.signal });
                if(!res.ok) throw new Error("HTTP " + res.status);
                const contentType = res.headers.get("content-type"); if (contentType && !contentType.includes("application/json")) throw new Error("Not JSON");
                return await res.json();
            } catch(e) { attempts++; if(SYS_CONFIG.proxies.length > 1) proxyIndex++; await new Promise(r => setTimeout(r, 200)); }
        } throw new Error("Arr√™t.");
    }

    async function updateDictionary() {
        stopSignal = false; if (!SYS_CONFIG.proxies || SYS_CONFIG.proxies.length === 0) { alert("ERREUR: Aucun proxy !"); return; }
        log("üîÑ MAJ Dictionnaire...", "#fff"); let page = 1; let totalLoaded = 0; let localProxyIdx = 0; 
        try { while(!stopSignal) {
            const urlTarget = `${SYS_CONFIG.atomicApi}&page=${page}`; const currentProxy = SYS_CONFIG.proxies[localProxyIdx % SYS_CONFIG.proxies.length];
            let finalUrl = urlTarget; if(currentProxy.length > 5) finalUrl = currentProxy + encodeURIComponent(urlTarget);
            try {
                const res = await fetch(finalUrl); if (!res.headers.get("content-type")?.includes("application/json")) throw new Error("Not JSON");
                const json = await res.json();
                if(json.success && json.data.length > 0) {
                    json.data.forEach(t => { let old = CORE_DATA.templates[t.template_id]; CORE_DATA.templates[t.template_id] = { name: t.immutable_data.name, prod: old ? old.prod : 0 }; });
                    totalLoaded += json.data.length; document.getElementById('dictSize').innerText = Object.keys(CORE_DATA.templates).length;
                    if(json.data.length < 500) break; page++; await new Promise(r => setTimeout(r, 250));
                } else break;
            } catch (e) { localProxyIdx++; if(localProxyIdx > SYS_CONFIG.proxies.length*2) break; await new Promise(r => setTimeout(r, 500)); }
        } localStorage.setItem('DOV_DATA', JSON.stringify(CORE_DATA)); log("‚úÖ Dictionnaire mis √† jour.", "#00e676"); } catch(e) { log("Erreur Dico: "+e.message, "red"); }
    }

    function getSortScore(name) { if(!name) return 999; for(let i=0; i<SYS_CONFIG.sortOrder.length; i++) { if(name.startsWith(SYS_CONFIG.sortOrder[i])) return i; } return 999; }
    
    // --- V174/175 LOGIC: PURE DATA (No Multiplier invention) ---
    function conformBuilding(b) {
        let tid = b.template_id.toString(); 
        let rawStr = (Array.isArray(b.power)?b.power[0]:b.power) || "";
        let hourlyProd = parseFloat(rawStr.replace(/[^0-9.]/g,'')) || 0;
        let dailyProd = hourlyProd * CORE_DATA.gameConfig.cycleHours;
        let pType = null; for(let token in CORE_DATA.gameConfig.tokenMap) { if(rawStr.includes(token)) { pType = CORE_DATA.gameConfig.tokenMap[token]; break; } }
        if(!pType) pType = "F"; 
        let tpl = CORE_DATA.templates[tid]; let name = tpl ? tpl.name : `INCONNU [${tid}]`; let base = tpl ? tpl.prod : 0;
        
        let dispUnit = 0; let dispTotal = 0;
        if(USE_HOURLY) { dispUnit = base > 0 ? base : hourlyProd; dispTotal = hourlyProd; } 
        else { dispUnit = base > 0 ? (base * CORE_DATA.gameConfig.cycleHours) : dailyProd; dispTotal = dailyProd; }
        
        let dispCost = dispTotal * CORE_DATA.gameConfig.maintenanceCost; 
        let sortScore = getSortScore(name);
        // V175: stack is purely informative or 1 if not calculable, we don't invent if 0
        let stack = (base > 0 && hourlyProd > 0) ? Math.round(hourlyProd/base) : 1; 
        return { name, type:pType, stack, tid, unitProd: dispUnit, tp: dispTotal, cost: dispCost, sortScore: sortScore };
    }

    async function dispatchGlobalScan() { stopSignal = false; switchView('buildingView'); document.getElementById('globalStatsArea').style.display = 'block'; document.getElementById('buildList').style.display = 'none'; document.getElementById('btnStop').style.display = 'inline-block'; let start = SYS_CONFIG.startKey || "0"; await runGlobalScan(start); }

    async function runGlobalScan(next) {
        log(`üåç START GLOBAL SCAN...`, "#fff"); let more = true; let groups = {}; let stats = { total: 0, cost: 0, p: {}, c: {} };
        for(let key in CORE_DATA.resourceDefs) { groups[key] = {}; stats.p[key] = 0; stats.c[key] = 0; }
        let scanRows = 0; let scanAssets = 0; let templateAudit = {}; 
        try { while (more && !stopSignal) {
            const data = await robustFetch("dovutilstake", "buildings", next); if(!data.rows) break;
            scanRows += data.rows.length; const now = Date.now()/1000;
            for(let b of data.rows) {
                stats.total++; let info = conformBuilding(b); scanAssets += info.stack; 
                if(!templateAudit[info.tid]) templateAudit[info.tid] = { name: info.name, count: 0 }; templateAudit[info.tid].count += info.stack;
                if(!groups[info.type]) groups[info.type] = {};
                let k = info.stack > 1 ? `${info.name} (x${info.stack})` : info.name;
                if (!groups[info.type][k]) groups[info.type][k] = { name: info.name, stack: info.stack, tid: info.tid, cp: 0, cr: 0, tp: 0, unitProd: info.unitProd, sortScore: info.sortScore };
                let active = now < (parseFloat(b.last_claim) + parseFloat(b.delay));
                if (active) { groups[info.type][k].cp++; groups[info.type][k].tp += info.tp; stats.p[info.type] += info.tp; stats.c[info.type] += info.cost; stats.cost += info.cost; } else { groups[info.type][k].cr++; }
            }
            if(document.getElementById('cntRows')) {
                document.getElementById('cntRows').innerText = scanRows.toLocaleString(); document.getElementById('cntAssets').innerText = scanAssets.toLocaleString();
                document.getElementById('gTotalCost').innerText = Math.round(stats.cost).toLocaleString() + " DOVX";
                for(let key in CORE_DATA.resourceDefs) { let pwrEl = document.getElementById('pwr-'+key); if(pwrEl) pwrEl.innerText = Math.round(stats.p[key] || 0).toLocaleString(); }
                let dbgHTML = ""; let auditKeys = Object.keys(templateAudit); auditKeys.sort((a,b) => getSortScore(templateAudit[a].name) - getSortScore(templateAudit[b].name));
                for(let tid of auditKeys) { let n = templateAudit[tid].name; let color = n.includes("INCONNU") ? "var(--warn)" : "#aaa"; dbgHTML += `<div class="d-row"><a href="#" class="d-id">[${tid}]</a> <span style="font-size:9px; color:${color}; overflow:hidden; white-space:nowrap; width:80px;">${n}</span> <span class="d-cnt">x${templateAudit[tid].count}</span></div>`; }
                document.getElementById('debugGrid').innerHTML = dbgHTML; renderLists(groups, stats.p, stats.c);
            }
            if (data.more && data.next_key) next = data.next_key; else more = false;
        } log("‚úÖ SCAN TERMIN√â.", "#00d2d3"); document.getElementById('btnStop').style.display='none'; } catch(e) { log("Erreur: " + e.message, "red"); }
    }

    function renderLists(groups, typeTotals, costTotals){
        for(let t in groups){
            let container = document.getElementById('list-'+t); if(!container) continue;
            let keys=Object.keys(groups[t]);
            keys.sort((a,b) => { let scoreA = groups[t][a].sortScore; let scoreB = groups[t][b].sortScore; if(scoreA === scoreB) return groups[t][b].unitProd - groups[t][a].unitProd; return scoreA - scoreB; });
            let totalForType = typeTotals && typeTotals[t] ? Math.round(typeTotals[t]).toLocaleString() : "0";
            let costForType = costTotals && costTotals[t] ? Math.round(costTotals[t]).toLocaleString() : "0";
            let resDef = CORE_DATA.resourceDefs[t] || { label: "UNKNOWN" };
            let h = `<div class="ml-header"><div>${resDef.label}</div><div style="text-align:right;"><span class="header-cost-badge">TOT: ${totalForType}</span><span class="header-cost-badge" style="border-color:var(--sec)">CO√õT: ${costForType} DOVX</span></div></div>`;
            let unitLabel = USE_HOURLY ? "/h" : "/24h";
            keys.forEach(k=>{
                let i=groups[t][k]; if(i.cp===0 && i.cr===0) return;
                let stackLabel = i.stack > 1 ? `<span class="ml-mult">x${i.stack}</span>` : '';
                h+=`<div class="ml-row"><div class="ml-name row-left">${i.name} ${stackLabel}<span class="c-active">${i.cp} ACTIF</span></div><div class="row-mid">${Math.round(i.unitProd).toLocaleString()}${unitLabel}</div><div class="row-right"><span>${Math.round(i.tp).toLocaleString()}</span></div></div>`;
            });
            container.innerHTML=h;
        }
    }

    async function startBuildings() { 
        const user = document.getElementById('targetIn').value.trim().toLowerCase(); switchView('buildingView'); document.getElementById('globalStatsArea').style.display = 'none'; document.getElementById('buildList').style.display = 'grid'; document.getElementById('buildDash').innerHTML = ""; document.getElementById('buildList').innerHTML = ""; log(`üîç Scan Joueur ${user}...`, "#fff"); let nextKey = ""; let hasMore = true; 
        try { while(hasMore && !stopSignal) { 
            const data = await robustFetch("dovutilstake", "buildings", nextKey, 1000, user); if(!data.rows || data.rows.length === 0) break; const now = Date.now()/1000; 
            data.rows.forEach(b => { 
                let info = conformBuilding(b); let isReady = now > (parseFloat(b.last_claim) + parseFloat(b.delay)); 
                let typeColor = CORE_DATA.resourceDefs[info.type] ? CORE_DATA.resourceDefs[info.type].color : "#fff";
                let card = `<div class="b-card"><div><div class="b-title" style="color:${typeColor}">${info.name} ${info.stack>1?'x'+info.stack:''}</div><div class="b-sub">#${b.asset_id}</div></div><div>${isReady?'<span class="b-badge-claim">PR√äT</span>':'<span class="b-badge-ok">ACTIF</span>'}</div><div class="b-stats"><div style="font-weight:bold">${Math.round(info.prod24).toLocaleString()} /24h</div></div></div>`; 
                document.getElementById('buildList').insertAdjacentHTML('beforeend', card); 
            }); if(data.more && data.next_key) nextKey = data.next_key; else hasMore = false; 
        } log(`‚úÖ Scan Joueur termin√©.`, "#00d2d3"); } catch(e){ log("Err: "+e.message, "red"); } 
    }
    
    async function startTarget() { 
        const user = document.getElementById('targetIn').value.trim().toLowerCase(); switchView('targetView'); const view = document.getElementById('targetView'); view.innerHTML="Recherche divisions..."; try { const data = await robustFetch("dovpvecontrl", "sdivisions", user, 500, null, 2, "i64"); const rows = data.rows ? data.rows : []; let htmlBuffer = `<div style="background:var(--panel-bg); padding:10px; color:var(--sec); border-radius:8px;">JOUEUR : ${user.toUpperCase()} (${rows.length} Divs)</div>`; rows.forEach(r => { const zID = getProp(r, ['zoneID', 'zone_id']); const zName = CORE_DATA.zones[zID] ? CORE_DATA.zones[zID].name : 'Zone '+zID; htmlBuffer += `<div class="t-row"><div style="color:var(--main)">#${getId(r)}</div><div style="color:var(--sec)">${zName}</div><div>${isBusy(r)?'<span class="st-mission">MISSION</span>':'<span class="st-ready">PR√äT</span>'}</div></div>`; }); view.innerHTML = htmlBuffer; } catch(e){ log("Erreur Target: "+e.message, "red"); } 
    }

    async function startZoneScan() { 
        stopSignal = false; switchView('zoneView'); initGrid(); document.getElementById('btnStop').style.display = 'inline-block'; ZONE_DETAILS = {}; let stats = { divs: 0, burn: { fuel: 0, health: 0, repair: 0, supply: 0 }, totalCostX: 0, totalGain: 0, zones: {} }; Object.keys(CORE_DATA.zones).forEach(id => { stats.zones[id] = { count: 0, active: 0, idle: 0 }; }); let nextKey = ""; let hasMore = true; log("Mapping Zones...", "#fff"); try { while(hasMore && !stopSignal) { const data = await robustFetch("dovpvecontrl", "sdivisions", nextKey); if(!data.rows) break; for(let row of data.rows) { stats.divs++; const zID = getProp(row, ['zoneID', 'zone_id']); const busy = isBusy(row); if(busy) { if(!ZONE_DETAILS[zID]) ZONE_DETAILS[zID] = []; const ownerName = row.owner || row.user || row.account || row.player; if(ownerName) ZONE_DETAILS[zID].push({ name: ownerName, time: row.end_time || 0 }); } if(stats.zones[zID]) { stats.zones[zID].count++; const zInfo = CORE_DATA.zones[zID]; if(busy) { stats.zones[zID].active++; if(zInfo) { if(zInfo.cost > 0) { stats.burn.fuel+=zInfo.cost; stats.burn.health+=zInfo.cost; stats.burn.repair+=zInfo.cost; stats.burn.supply+=zInfo.cost; } stats.totalCostX += zInfo.costX; const power = extractPower(row); if(zInfo.reward > 0) stats.totalGain += computeDovxReward(zInfo.reward, power); } } else stats.zones[zID].idle++; } } if (stats.divs % 1000 === 0) updateZoneDash(stats); if(data.more && data.next_key) nextKey = data.next_key; else hasMore = false; } updateZoneDash(stats); log("Mapping OK.", "#00d2d3"); document.getElementById('btnStop').style.display='none'; } catch(e) { log("Err: "+e.message, "red"); } 
    }
    
    function updateZoneDash(stats) { const fmt = (n) => n.toLocaleString(undefined, {maximumFractionDigits:0}); setTextSafe('dDivs', fmt(stats.divs)); setTextSafe('dGain', "+ " + fmt(stats.totalGain) + " DOVX"); setTextSafe('dCostX', "- " + fmt(stats.totalCostX) + " DOVX"); setTextSafe('lFuel', "-" + fmt(stats.burn.fuel)); setTextSafe('lHealth', "-" + fmt(stats.burn.health)); setTextSafe('lRepair', "-" + fmt(stats.burn.repair)); setTextSafe('lSupply', "-" + fmt(stats.burn.supply)); Object.keys(stats.zones).forEach(id => { const data = stats.zones[id]; const card = document.getElementById(`z-card-${id}`); if(card && data) { if(data.count > 0) card.classList.add('active'); document.getElementById(`z-count-${id}`).innerText = data.count; document.getElementById(`z-miss-${id}`).innerText = data.active + " Act."; document.getElementById(`z-rdy-${id}`).innerText = data.idle + " Rdy"; } }); }
    
    async function startEconomyScan() { stopSignal = false; switchView('ecoView'); document.getElementById('btnStop').style.display='inline-block'; ECO_DATA = { demand: { fuel:0, health:0, repair:0, supply:0 }, supply: { fuel:0, health:0, repair:0, supply:0 }, dovx: { cities:0, buildings:0, rewards:0 }, scanned: 0 }; log("Audit Eco...", "#fff"); try { let nextKey = ""; let hasMore = true; while(hasMore && !stopSignal) { const data = await robustFetch("dovpvecontrl", "sdivisions", nextKey); if(!data.rows) break; for(let row of data.rows) { ECO_DATA.scanned++; const zID = getProp(row, ['zoneID', 'zone_id']); const zInfo = CORE_DATA.zones[zID]; const busy = isBusy(row); if(zInfo && busy) { if(zInfo.cost > 0) { ECO_DATA.demand.fuel += zInfo.cost; ECO_DATA.demand.health += zInfo.cost; ECO_DATA.demand.repair += zInfo.cost; ECO_DATA.demand.supply += zInfo.cost; } if(zInfo.costX > 0) ECO_DATA.dovx.cities += zInfo.costX; const power = extractPower(row); if(zInfo.reward > 0) ECO_DATA.dovx.rewards += computeDovxReward(zInfo.reward, power); } } if (ECO_DATA.scanned % 1000 === 0) updateEcoDisplay(); if(data.more && data.next_key) nextKey = data.next_key; else hasMore = false; } updateEcoDisplay(); log("Audit OK.", "#00d2d3"); document.getElementById('btnStop').style.display='none'; } catch(e) { log(e.message, "red"); } }
    function updateEcoDisplay() { const fmt = (n) => n.toLocaleString(undefined, {maximumFractionDigits:0}); const fmtUSD = (n) => "$" + n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); let totalD = ECO_DATA.demand.fuel + ECO_DATA.demand.health + ECO_DATA.demand.repair + ECO_DATA.demand.supply; let totalS = ECO_DATA.supply.fuel + ECO_DATA.supply.health + ECO_DATA.supply.repair + ECO_DATA.supply.supply; let totalDovxIn = ECO_DATA.dovx.cities + ECO_DATA.dovx.buildings; setTextSafe('valDemandTU', fmt(totalD) + " TU"); setTextSafe('valDemandUSD', fmtUSD(totalD * CORE_DATA.rates.TU_WAX * CORE_DATA.rates.WAX_USD) + " / 24h"); setTextSafe('valSupplyTU', fmt(totalS) + " TU"); setTextSafe('valSupplyUSD', fmtUSD(totalS * CORE_DATA.rates.TU_WAX * CORE_DATA.rates.WAX_USD) + " / 24h"); setTextSafe('valDovxBurn', fmt(totalDovxIn) + " DOVX"); setTextSafe('valDovxUSD', fmtUSD(totalDovxIn * CORE_DATA.rates.DOVX_WAX * CORE_DATA.rates.WAX_USD) + " / 24h"); let mint = ECO_DATA.dovx.rewards; let burn = ECO_DATA.dovx.cities + ECO_DATA.dovx.buildings; let net = mint - burn; setTextSafe('valDovxMint', "+ " + fmt(mint)); setTextSafe('usdDovxMint', fmtUSD(mint * CORE_DATA.rates.DOVX_WAX * CORE_DATA.rates.WAX_USD)); setTextSafe('valDovxBurnTotal', "- " + fmt(burn)); setTextSafe('usdDovxBurnTotal', fmtUSD(burn * CORE_DATA.rates.DOVX_WAX * CORE_DATA.rates.WAX_USD)); setTextSafe('valDovxNet', fmt(net)); setTextSafe('usdDovxNet', fmtUSD(net * CORE_DATA.rates.DOVX_WAX * CORE_DATA.rates.WAX_USD)); }

    function openSettings() { try { document.getElementById('cfgStrategy').value = SYS_CONFIG.strategy; document.getElementById('cfgBatch').value = SYS_CONFIG.batchSize; document.getElementById('cfgDelay').value = SYS_CONFIG.delay; document.getElementById('cfgStart').value = SYS_CONFIG.startKey; document.getElementById('cfgSort').value = SYS_CONFIG.sortOrder.join(', '); document.getElementById('cfgRpc').value = SYS_CONFIG.rpcs.join('\n'); document.getElementById('cfgProxy').value = SYS_CONFIG.proxies.join('\n'); document.getElementById('cfgZones').value = JSON.stringify(CORE_DATA.zones, null, 4); document.getElementById('cfgTemplates').value = JSON.stringify(CORE_DATA.templates, null, 4); if(CORE_DATA.claimLevels) document.getElementById('cfgLevels').value = JSON.stringify(CORE_DATA.claimLevels, null, 4); document.getElementById('cfgGameRules').value = JSON.stringify(CORE_DATA.gameConfig, null, 4); document.getElementById('cfgResources').value = JSON.stringify(CORE_DATA.resourceDefs, null, 4); document.getElementById('settingsModal').style.display = 'flex'; } catch(e) { alert("Erreur ouverture settings. Donn√©es corrompues."); } }
    function saveConfig() { SYS_CONFIG.strategy = document.getElementById('cfgStrategy').value; SYS_CONFIG.batchSize = parseInt(document.getElementById('cfgBatch').value)||1000; SYS_CONFIG.delay = parseInt(document.getElementById('cfgDelay').value)||200; SYS_CONFIG.startKey = document.getElementById('cfgStart').value.trim(); let rawSort = document.getElementById('cfgSort').value.trim().split(','); let cleanSort = rawSort.map(s => s.trim()).filter(s => s.length > 0); if(cleanSort.length > 0) SYS_CONFIG.sortOrder = cleanSort; let rawRpc = document.getElementById('cfgRpc').value.trim().split('\n'); let cleanRpc = rawRpc.map(r => r.trim()).filter(r => r.startsWith('http')); if(cleanRpc.length > 0) SYS_CONFIG.rpcs = cleanRpc; let rawProxy = document.getElementById('cfgProxy').value.trim().split('\n'); let cleanProxy = rawProxy.map(r => r.trim()).filter(r => r.startsWith('http') || r === ""); if(cleanProxy.length > 0) SYS_CONFIG.proxies = cleanProxy; try { CORE_DATA.zones = JSON.parse(document.getElementById('cfgZones').value); CORE_DATA.templates = JSON.parse(document.getElementById('cfgTemplates').value); CORE_DATA.claimLevels = JSON.parse(document.getElementById('cfgLevels').value); CORE_DATA.gameConfig = JSON.parse(document.getElementById('cfgGameRules').value); CORE_DATA.resourceDefs = JSON.parse(document.getElementById('cfgResources').value); } catch(e) { alert("JSON Invalide: "+e.message); return; } localStorage.setItem('DOV_SYS', JSON.stringify(SYS_CONFIG)); localStorage.setItem('DOV_DATA', JSON.stringify(CORE_DATA)); window.closeModal('settingsModal'); log("‚öôÔ∏è Config Sauvegard√©e.", "#ffd700"); initApp(); }

    window.onload = function() { initApp(); }
</script>

</body>
</html>
