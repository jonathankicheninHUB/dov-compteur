<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoV - Scanner FINAL</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #222; color: white; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background: #333; width: 100%; max-width: 750px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        h1 { text-align: center; color: #f1c40f; margin-top: 0; }
        
        .input-group { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
        input { padding: 12px; width: 60%; background: #444; color: white; border: 1px solid #555; border-radius: 5px; font-size: 16px; }
        button { padding: 12px 20px; background-color: #f1c40f; color: #222; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }
        button:hover { background-color: #f39c12; }
        button:disabled { background-color: #7f8c8d; cursor: not-allowed; }

        .log { background: #000; color: #0f0; padding: 10px; font-family: monospace; font-size: 12px; margin-bottom: 20px; border-radius: 5px; min-height: 20px; border: 1px solid #555; }
        
        .stats-box { display: flex; justify-content: space-around; background: #444; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .stat { text-align: center; }
        .stat-val { font-size: 24px; font-weight: bold; color: #3498db; }

        .asset-list { max-height: 600px; overflow-y: auto; border-top: 1px solid #555; }
        .item { padding: 12px; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center; }
        .item:hover { background-color: #3a3a3a; }
        
        .tag-role { background: #555; color: #ddd; font-size: 11px; padding: 3px 6px; border-radius: 4px; margin-right: 8px; text-transform: uppercase; }
        .tag-div { color: #888; font-size: 12px; margin-left: 10px; }
        
        .link-btn { text-decoration: none; background: #2980b9; color: white; padding: 5px 10px; border-radius: 4px; font-size: 13px; }
        .link-btn:hover { background: #3498db; }
    </style>
</head>
<body>

<div class="container">
    <h1>Scanner DoV (Corrigé)</h1>
    
    <div class="input-group">
        <input type="text" id="userInput" placeholder="Compte WAX (ex: u2d2k.c.wam)">
        <button id="btn" onclick="lancerScan()">SCANNER</button>
    </div>

    <div class="log" id="logBox">Prêt. En attente...</div>

    <div class="stats-box">
        <div class="stat">
            <div class="stat-val" id="divCount">0</div>
            <div>Divisions</div>
        </div>
        <div class="stat">
            <div class="stat-val" id="assetCount">0</div>
            <div>Cartes</div>
        </div>
    </div>

    <div class="asset-list" id="resultList"></div>
</div>

<script>
    // Liste de secours au cas où un serveur bloque
    const RPCS = [
        "https://api.waxsweden.org/v1/chain/get_table_rows",
        "https://wax.greymass.com/v1/chain/get_table_rows",
        "https://wax.eosn.io/v1/chain/get_table_rows"
    ];

    async function lancerScan() {
        const account = document.getElementById('userInput').value.trim().toLowerCase();
        const logBox = document.getElementById('logBox');
        const list = document.getElementById('resultList');
        const btn = document.getElementById('btn');

        if(!account) return alert("Nom manquant");

        // Reset
        btn.disabled = true;
        list.innerHTML = "";
        document.getElementById('divCount').innerText = "0";
        document.getElementById('assetCount').innerText = "0";
        
        let allDivisions = [];
        let more = true;
        let nextKey = "";
        let rpcIndex = 0;

        logBox.innerText = `Connexion au serveur pour ${account}...`;

        try {
            while(more) {
                // Tentative de connexion (Failover simple)
                const currentRPC = RPCS[rpcIndex];
                
                const response = await fetch(currentRPC, {
                    method: 'POST',
                    body: JSON.stringify({
                        json: true,
                        code: "dovpvecontrl",
                        scope: "dovpvecontrl",
                        table: "sdivisions",
                        index_position: 2,     // Index 2 (Owner)
                        key_type: "name",      // Recherche par nom
                        lower_bound: nextKey || account,
                        upper_bound: account,
                        limit: 500
                    })
                });

                if(!response.ok) {
                    // Si le serveur 1 plante, on essaie le suivant au prochain tour
                    rpcIndex = (rpcIndex + 1) % RPCS.length;
                    throw new Error("Erreur serveur, nouvelle tentative...");
                }

                const data = await response.json();
                
                // --- CORRECTION CRUCIALE ICI ---
                // Le dump a montré que la colonne s'appelle "owner", pas "user"
                const rows = data.rows.filter(r => r.owner === account);
                
                allDivisions = [...allDivisions, ...rows];

                logBox.innerText = `Récupéré ${allDivisions.length} divisions... (Chargement suite...)`;

                more = data.more;
                if(more && data.next_key) {
                    nextKey = data.next_key;
                } else {
                    more = false;
                }
            }

            // Affichage
            if(allDivisions.length === 0) {
                logBox.innerText = "Aucune division trouvée pour ce compte (colonnes 'owner' vérifiée).";
                logBox.style.color = "orange";
            } else {
                logBox.innerText = "Terminé avec succès !";
                logBox.style.color = "#0f0";
                afficherResultats(allDivisions);
            }

        } catch (e) {
            logBox.innerText = "Erreur: " + e.message;
            logBox.style.color = "red";
        }
        
        btn.disabled = false;
    }

    function afficherResultats(divisions) {
        const list = document.getElementById('resultList');
        let totalAssets = 0;
        let html = "";

        divisions.forEach(div => {
            // --- CORRECTION CRUCIALE 2 ---
            // Le dump a montré que la liste s'appelle "units", pas "asset_ids"
            if(div.units && div.units.length > 0) {
                totalAssets += div.units.length;
                
                div.units.forEach(unit => {
                    // Structure: { key: "role", value: "asset_id" }
                    const assetId = unit.value; 
                    const role = unit.key;

                    html += `
                        <div class="item">
                            <div>
                                <span class="tag-role">${role}</span>
                                <strong>${assetId}</strong> 
                                <span class="tag-div">(Div #${div.division_id})</span>
                            </div>
                            <a href="https://wax.atomichub.io/explorer/asset/${assetId}" target="_blank" class="link-btn">Voir sur AtomicHub</a>
                        </div>
                    `;
                });
            }
        });

        document.getElementById('divCount').innerText = divisions.length;
        document.getElementById('assetCount').innerText = totalAssets;
        
        list.innerHTML = html || "<div style='padding:20px; text-align:center'>Divisions vides trouvées.</div>";
    }
</script>

</body>
</html>
