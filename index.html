<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DoV - COMMAND V183 (FINAL UI)</title>
    <style>
        /* --- WEB3 VARIABLES --- */
        :root {
            --bg-body: #0b0c15; 
            --bg-panel: #12131f; 
            --bg-card: #151621; /* Slightly lighter than body */
            --border: #2b2d42;
            
            --primary: #3498db; 
            --accent: #00e676; 
            --dovx: #e056fd;
            
            --fuel: #e67e22; 
            --health: #e74c3c; 
            --repair: #3498db; 
            --supply: #feca57;

            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-mono: 'Consolas', monospace;
            --text-white: #ffffff;
            --text-gray: #8d99ae;
        }

        /* --- RESET & LAYOUT --- */
        body { background-color: var(--bg-body); color: var(--text-gray); font-family: var(--font-main); margin: 0; display: flex; height: 100vh; overflow: hidden; font-size: 12px; }
        * { box-sizing: border-box; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-body); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        /* --- HEADER --- */
        header { 
            height: 50px; background: rgba(18, 19, 31, 0.9); border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; padding: 0 20px; justify-content: space-between; z-index: 10;
        }
        .brand { display:flex; align-items:center; gap:10px; }
        .logo-dot { width:10px; height:10px; background:var(--accent); border-radius:50%; box-shadow:0 0 10px var(--accent); }
        h1 { color: #fff; margin: 0; font-size: 14px; letter-spacing: 1px; font-weight: 700; text-transform: uppercase; }
        .version { font-size:10px; color:var(--text-gray); opacity:0.7; margin-left:5px; }

        /* --- SIDEBAR --- */
        .layout { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 280px; background: var(--bg-panel); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }

        .panel-group { display: flex; flex-direction: column; gap: 5px; }
        .group-label { font-size: 10px; font-weight: 700; color: #57606f; text-transform: uppercase; margin-bottom: 5px; }
        
        .box-framed { border: 1px solid var(--border); padding: 15px; border-radius: 6px; background: rgba(255,255,255,0.02); }
        
        /* CONTROLS */
        input { width: 100%; padding: 8px; background: #050508; border: 1px solid #333; color: #fff; border-radius: 4px; font-family: var(--font-mono); margin-bottom: 8px; }
        
        button { width: 100%; padding: 10px; cursor: pointer; border: none; font-weight: 700; font-size: 10px; text-transform: uppercase; border-radius: 4px; transition: 0.2s; color:#fff; margin-bottom: 5px; }
        button:hover { opacity: 0.9; }
        .btn-row { display:flex; gap:10px; }
        
        .btn-green { background: linear-gradient(135deg, #00b894, #00cec9); color:#000; }
        .btn-orange { background: linear-gradient(135deg, #f39c12, #e67e22); color:#000; }
        .btn-blue { background: linear-gradient(135deg, #2980b9, #3498db); }
        .btn-dark { background: #2c3e50; border:1px solid #34495e; }
        .btn-red { background: #c0392b; }
        .btn-ghost { background:transparent; border:1px solid #444; color:#888; }
        .btn-ghost:hover { border-color:#fff; color:#fff; }

        /* --- MAIN VIEW --- */
        .main-view { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
        
        /* HEADER STATS BANNER */
        .g-main-count { 
            background: linear-gradient(90deg, #151621 0%, #1a1b26 100%);
            border: 1px solid var(--border); padding: 20px; border-radius: 12px; 
            display:flex; justify-content:space-between; align-items:center; 
            margin-bottom: 25px; border-left: 4px solid var(--accent);
        }
        .g-title { font-size:18px; font-weight:800; color:#fff; margin-bottom:5px; }
        .g-sub { font-size:11px; color:#666; font-family:var(--font-mono); }
        
        .g-cost-box { text-align:right; }
        .g-cost-lbl { font-size:10px; color:#666; text-transform:uppercase; letter-spacing:1px; }
        .g-cost-val { font-size:24px; font-weight:800; color:#fff; }
        .g-cost-curr { color:var(--dovx); font-size:14px; }

        /* TOP CARDS GRID */
        .cards-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        .res-card { 
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; 
            padding: 20px; text-align: center; position: relative; overflow: hidden;
        }
        .res-card::before { content:''; position: absolute; top:0; left:0; width: 4px; height: 100%; background: #fff; }
        .rc-label { font-size: 11px; font-weight: 700; color: #888; text-transform: uppercase; margin-bottom: 10px; }
        .rc-val { font-size: 22px; font-weight: 800; color: #fff; }
        .rc-sub { font-size: 9px; color: #444; margin-top: 5px; text-transform: uppercase; }

        /* BREAKDOWN LISTS GRID */
        .lists-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        .list-panel { 
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; 
            overflow: hidden; display: flex; flex-direction: column; min-height: 200px;
        }
        
        .lp-header { 
            background: #1a1c29; padding: 12px 15px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .lp-title { font-weight: 700; color: #ccc; font-size: 11px; text-transform: uppercase; }
        
        .lp-badges { display:flex; gap:5px; }
        .badge { 
            font-size: 9px; padding: 3px 8px; border-radius: 4px; 
            background: #252838; border: 1px solid #333; color: #fff; font-family: var(--font-mono); 
        }
        .badge-cost { border-color: rgba(224, 86, 253, 0.3); color: var(--dovx); background: rgba(224, 86, 253, 0.05); }

        .t-header { 
            display: grid; grid-template-columns: 3fr 0.5fr 1.5fr 1.5fr; 
            padding: 8px 15px; font-size: 9px; color: #555; font-weight: 700; text-transform: uppercase; 
            border-bottom: 1px solid #222; background: rgba(0,0,0,0.2);
        }
        
        .t-body { overflow-y: auto; max-height: 400px; } /* SCROLLABLE CONTENT */

        .t-row { 
            display: grid; grid-template-columns: 3fr 0.5fr 1.5fr 1.5fr; 
            padding: 8px 15px; border-bottom: 1px solid rgba(255,255,255,0.02); 
            font-size: 11px; align-items: center; color: #eee; 
            transition: background 0.1s;
        }
        .t-row:hover { background: rgba(255,255,255,0.03); }
        .t-name { font-weight: 500; color: #dcdde1; }
        .t-act { color: var(--accent); font-weight: bold; text-align: center; }
        .t-val { text-align: right; font-family: var(--font-mono); color: #fff; }
        .t-val-dim { text-align: right; font-family: var(--font-mono); color: #777; }

        /* --- BUILDINGS LIST (USER SCAN) --- */
        .build-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .b-card { background: var(--bg-card); padding: 15px; border: 1px solid var(--border); border-radius: 8px; }
        .b-head { font-weight:bold; color:#fff; margin-bottom:5px; font-size:11px; }
        .b-sub { font-size:10px; color:#666; font-family:monospace; }
        .b-stat { font-size:14px; font-weight:bold; color:#fff; margin-top:10px; text-align:right; }

        /* UTILS & COLORS */
        .border-fuel::before { background: var(--fuel); } .txt-fuel { color: var(--fuel); }
        .border-health::before { background: var(--health); } .txt-health { color: var(--health); }
        .border-repair::before { background: var(--repair); } .txt-repair { color: var(--repair); }
        .border-supply::before { background: var(--supply); } .txt-supply { color: var(--supply); }
        
        .view-section { display: none; }
        #systemBadge { position: absolute; top: 15px; right: 20px; font-size: 10px; color: #555; }
    </style>
</head>
<body>

<header>
    <div class="brand">
        <div class="logo-dot"></div>
        <h1>DoV COMMAND <span class="version">V183</span></h1>
    </div>
    <div id="systemBadge">SYSTEM READY</div>
</header>

<div class="layout">
    <aside class="sidebar">
        <div class="panel-group">
            <span class="group-label">OPERATIONS</span>
            <div class="box-framed">
                <div class="btn-row">
                    <button class="btn-green" onclick="dispatchGlobalScan()">GLOBAL SCAN</button>
                    <button class="btn-red" onclick="stopSignal=true">STOP</button>
                </div>
            </div>
        </div>

        <div class="panel-group">
            <span class="group-label">TARGET ACCOUNT</span>
            <div class="box-framed">
                <input type="text" id="targetIn" value="u2d2k.c.wam">
                <div class="btn-row">
                    <button class="btn-blue" onclick="startTarget()">DIVISIONS</button>
                    <button class="btn-blue" onclick="startBuildings()">BUILDINGS</button>
                </div>
            </div>
        </div>

        <div class="panel-group">
            <span class="group-label">CONFIGURATION</span>
            <div class="box-framed">
                <div style="margin-bottom:10px; font-size:10px; color:#666;">
                    TEMPLATES: <b id="dictSize" style="color:#fff">0</b>
                </div>
                <button class="btn-ghost" onclick="updateDictionary()">UPDATE DICTIONARY</button>
                <button class="btn-ghost" onclick="hardReset()">FACTORY RESET</button>
            </div>
        </div>
    </aside>

    <main class="main-view">
        
        <div id="globalView" class="view-section" style="display:block;">
            
            <div class="g-main-count">
                <div>
                    <div class="g-title">GLOBAL SCAN LIVE</div>
                    <div class="g-sub">Rows: <b id="cntRows">0</b> &nbsp;|&nbsp; Assets: <b id="cntAssets">0</b></div>
                </div>
                <div class="g-cost-box">
                    <div class="g-cost-lbl">TOTAL MAINTENANCE COST</div>
                    <div><span class="g-cost-val" id="gTotalCost">0</span> <span class="g-cost-curr">DOVX</span></div>
                </div>
            </div>

            <div class="cards-container" id="dynamicCardsArea"></div>

            <div class="lists-grid" id="dynamicListsArea"></div>

        </div>

        <div id="buildingsView" class="view-section">
            <div class="g-main-count" style="border-left-color: #3498db;">
                <div class="g-title">PLAYER BUILDINGS</div>
                <div class="g-sub" id="buildStatus">Ready to scan...</div>
            </div>
            <div id="buildList" class="build-grid"></div>
        </div>

        <div id="divisionsView" class="view-section">
            <div class="g-main-count" style="border-left-color: #3498db;">
                <div class="g-title">PLAYER DIVISIONS</div>
                <div class="g-sub" id="divStatus">Ready to scan...</div>
            </div>
            <div id="divList"></div>
        </div>

    </main>
</div>

<script>
    // --- UTILS ---
    function switchView(id) {
        document.querySelectorAll('.view-section').forEach(e => e.style.display = 'none');
        document.getElementById(id).style.display = 'block';
    }

    // --- DEFAULT DATA (STRICT) ---
    const DEFAULT_DATA = {
        resourceDefs: {
            "F": { label: "FUEL", color: "#e67e22", css: "border-fuel", txt: "txt-fuel" },
            "H": { label: "HEALTH", color: "#e74c3c", css: "border-health", txt: "txt-health" },
            "R": { label: "REPAIR", color: "#3498db", css: "border-repair", txt: "txt-repair" },
            "S": { label: "SUPPLY", color: "#feca57", css: "border-supply", txt: "txt-supply" }
        },
        gameConfig: {
            maintenanceCost: 0.085,
            cycleHours: 24,
            tokenMap: { "DOVF": "F", "DOVH": "H", "DOVR": "R", "DOVS": "S" }
        },
        templates: {
            "490122": { "name": "C_F1_PRODUCER_FUEL", "prod": 5.4 }, "492383": { "name": "C_F1_PRODUCER_FUEL", "prod": 5.4 },
            "492385": { "name": "C_F2_PRODUCER_FUEL", "prod": 12.15 }, "492363": { "name": "C_F2_PRODUCER_FUEL (VAR)", "prod": 12.15 },
            "492389": { "name": "C_F3_PRODUCER_FUEL", "prod": 30.38 }, "492366": { "name": "C_F3_PRODUCER_FUEL (VAR)", "prod": 30.38 },
            "492397": { "name": "C_F4_PRODUCER_FUEL", "prod": 83.53 }, "492373": { "name": "R_F1_PRODUCER_FUEL", "prod": 16.20 },
            "492379": { "name": "R_F1_PRODUCER_FUEL", "prod": 16.20 }, "492376": { "name": "R_F2_PRODUCER_FUEL", "prod": 36.45 },
            "492386": { "name": "R_F3_PRODUCER_FUEL", "prod": 91.13 }, "492390": { "name": "R_F4_PRODUCER_FUEL", "prod": 250.59 },
            "492380": { "name": "E_F1_PRODUCER_FUEL", "prod": 48.60 }, "492381": { "name": "E_F2_PRODUCER_FUEL", "prod": 109.35 },
            "492387": { "name": "E_F3_PRODUCER_FUEL", "prod": 273.38 }, "492388": { "name": "E_F4_PRODUCER_FUEL", "prod": 751.78 },
            "492368": { "name": "L_F1_PRODUCER_FUEL", "prod": 145.80 }, "492370": { "name": "L_F2_PRODUCER_FUEL", "prod": 328.05 },
            "492372": { "name": "L_F3_PRODUCER_FUEL", "prod": 820.13 }, "544068": { "name": "S1_OWNER_FUEL", "prod": 2255.34 },
            "492392": { "name": "S1_OWNER_FUEL (VAR)", "prod": 2255.34 }, "492377": { "name": "SC_F2_PRODUCER_FUEL", "prod": 54.00 },
            "492391": { "name": "SC_F3_PRODUCER_FUEL", "prod": 121.50 },
            "492394": { "name": "C_F1_PRODUCER_HEALTH", "prod": 5.4 }, "492395": { "name": "C_F2_PRODUCER_HEALTH", "prod": 12.15 },
            "492396": { "name": "C_F3_PRODUCER_HEALTH", "prod": 30.38 }, "492399": { "name": "R_F1_PRODUCER_HEALTH", "prod": 16.20 },
            "492401": { "name": "R_F2_PRODUCER_HEALTH", "prod": 36.45 }, "492535": { "name": "R_F3_PRODUCER_HEALTH", "prod": 91.13 },
            "492537": { "name": "R_F4_PRODUCER_HEALTH", "prod": 250.59 }, "492539": { "name": "E_F1_PRODUCER_HEALTH", "prod": 48.60 },
            "492543": { "name": "E_F2_PRODUCER_HEALTH", "prod": 109.35 }, "492545": { "name": "E_F3_PRODUCER_HEALTH", "prod": 273.38 },
            "492546": { "name": "E_F4_PRODUCER_HEALTH", "prod": 751.78 }, "492550": { "name": "L_F1_PRODUCER_HEALTH", "prod": 145.80 },
            "492554": { "name": "L_F2_PRODUCER_HEALTH", "prod": 328.05 }, "492555": { "name": "L_F3_PRODUCER_HEALTH", "prod": 820.13 },
            "544070": { "name": "S1_OWNER_HEALTH", "prod": 2255.34 }, "492460": { "name": "C_F1_PRODUCER_REPAIR", "prod": 5.4 },
            "492461": { "name": "C_F2_PRODUCER_REPAIR", "prod": 12.15 }, "492462": { "name": "C_F3_PRODUCER_REPAIR", "prod": 30.38 },
            "492463": { "name": "C_F4_PRODUCER_REPAIR", "prod": 83.53 }, "492464": { "name": "R_F1_PRODUCER_REPAIR", "prod": 16.20 },
            "492465": { "name": "R_F2_PRODUCER_REPAIR", "prod": 36.45 }, "492466": { "name": "R_F3_PRODUCER_REPAIR", "prod": 91.13 },
            "492467": { "name": "R_F4_PRODUCER_REPAIR", "prod": 250.59 }, "492469": { "name": "E_F1_PRODUCER_REPAIR", "prod": 48.60 },
            "492471": { "name": "E_F2_PRODUCER_REPAIR", "prod": 109.35 }, "492472": { "name": "E_F3_PRODUCER_REPAIR", "prod": 273.38 },
            "492473": { "name": "E_F4_PRODUCER_REPAIR", "prod": 751.78 }, "492474": { "name": "L_F1_PRODUCER_REPAIR", "prod": 145.80 },
            "492475": { "name": "L_F2_PRODUCER_REPAIR", "prod": 328.05 }, "492476": { "name": "L_F3_PRODUCER_REPAIR", "prod": 820.13 },
            "544071": { "name": "S1_OWNER_REPAIR", "prod": 2255.34 }, "492507": { "name": "C_F1_PRODUCER_SUPPLY", "prod": 5.4 },
            "492509": { "name": "C_F2_PRODUCER_SUPPLY", "prod": 12.15 }, "492511": { "name": "C_F3_PRODUCER_SUPPLY", "prod": 30.38 },
            "492513": { "name": "C_F4_PRODUCER_SUPPLY", "prod": 83.53 }, "492515": { "name": "R_F1_PRODUCER_SUPPLY", "prod": 16.20 },
            "492518": { "name": "R_F2_PRODUCER_SUPPLY", "prod": 36.45 }, "492521": { "name": "R_F3_PRODUCER_SUPPLY", "prod": 91.13 },
            "492523": { "name": "R_F4_PRODUCER_SUPPLY", "prod": 250.59 }, "492526": { "name": "E_F1_PRODUCER_SUPPLY", "prod": 48.60 },
            "492528": { "name": "E_F2_PRODUCER_SUPPLY", "prod": 109.35 }, "492529": { "name": "E_F3_PRODUCER_SUPPLY", "prod": 273.38 },
            "492530": { "name": "E_F4_PRODUCER_SUPPLY", "prod": 751.78 }, "492532": { "name": "L_F1_PRODUCER_SUPPLY", "prod": 145.80 },
            "492533": { "name": "L_F2_PRODUCER_SUPPLY", "prod": 328.05 }, "492534": { "name": "L_F3_PRODUCER_SUPPLY", "prod": 820.13 },
            "544069": { "name": "S1_OWNER_SUPPLY", "prod": 2255.34 }
        }
    };

    let CORE_DATA = JSON.parse(JSON.stringify(DEFAULT_DATA));
    let stopSignal = false; 

    function initApp() {
        const stored = localStorage.getItem('DOV_DATA');
        if(stored) { try { let loaded = JSON.parse(stored); CORE_DATA = { ...DEFAULT_DATA, ...loaded }; CORE_DATA.templates = { ...DEFAULT_DATA.templates, ...(loaded.templates || {}) }; } catch(e) {} }
        document.getElementById('dictSize').innerText = Object.keys(CORE_DATA.templates).length;
        initUI();
    }
    
    function initUI() {
        const c = document.getElementById('dynamicCardsArea'); 
        const l = document.getElementById('dynamicListsArea');
        c.innerHTML = ""; l.innerHTML = "";
        
        // Creates the layout skeletons
        for(let k in CORE_DATA.resourceDefs) {
            let r = CORE_DATA.resourceDefs[k];
            // 1. Top Card
            c.innerHTML += `<div class="res-card ${r.css}"><div class="rc-label">${r.label}</div><div class="rc-val" style="color:${r.color}" id="pwr-${k}">0</div><div class="rc-sub">PROD / HOUR</div></div>`;
            // 2. Breakdown Table
            l.innerHTML += `
            <div class="list-panel">
                <div class="lp-header">
                    <div class="lp-title">${r.label} BREAKDOWN</div>
                    <div class="lp-badges"><span class="badge">PROD: <span id="tot-p-${k}">0</span></span><span class="badge badge-cost">COST: <span id="tot-c-${k}">0</span></span></div>
                </div>
                <div class="t-header"><span>TEMPLATE</span><span>ACT</span><span style="text-align:right">TOT/H</span><span style="text-align:right">TOT/24H</span></div>
                <div class="t-body" id="list-${k}"></div>
            </div>`;
        }
    }

    function hardReset() { if(confirm("RESET ALL?")) { localStorage.removeItem('DOV_DATA'); location.reload(); } }
    
    // --- API ---
    async function fetchRows(scope) {
        let rows = []; let next = "";
        try {
            while(true) {
                let res = await fetch("https://wax.greymass.com/v1/chain/get_table_rows", {
                    method: 'POST',
                    body: JSON.stringify({ json:true, code:"dovutilstake", scope:scope, table:"buildings", limit:1000, lower_bound:next })
                });
                let data = await res.json();
                if(!data.rows) break;
                rows = rows.concat(data.rows);
                if(!data.more || stopSignal) break;
                next = data.next_key;
                await new Promise(r => setTimeout(r, 50));
            }
        } catch(e) { console.error(e); }
        return rows;
    }

    // --- LOGIC (V180 STRICT) ---
    function processRows(rows) {
        const now = Date.now()/1000;
        let stats = { totalCost:0, types:{} };
        let groups = {};
        
        // Init
        for(let k in CORE_DATA.resourceDefs) { 
            stats.types[k] = { p:0, c:0 }; 
            groups[k] = {}; 
        }

        for(let row of rows) {
            let tid = row.template_id.toString();
            let count = row.asset_ids ? row.asset_ids.length : 1;
            
            // Lookups
            let tpl = CORE_DATA.templates[tid];
            let name = tpl ? tpl.name : `UNKNOWN [${tid}]`;
            let nominal = tpl ? tpl.prod : 0;
            
            // Token Type
            let rawStr = (Array.isArray(row.power)?row.power[0]:row.power) || "";
            let type = "F"; 
            for(let t in CORE_DATA.gameConfig.tokenMap) if(rawStr.includes(t)) { type = CORE_DATA.gameConfig.tokenMap[t]; break; }

            // Calcs
            let totH = count * nominal;
            let totD = totH * CORE_DATA.gameConfig.cycleHours;
            let cost = totD * CORE_DATA.gameConfig.maintenanceCost;

            // Aggregation
            let active = now < (parseFloat(row.last_claim) + parseFloat(row.delay));
            
            if(active) {
                if(!groups[type][name]) groups[type][name] = { name:name, count:0, totH:0, totD:0 };
                groups[type][name].count += count;
                groups[type][name].totH += totH;
                groups[type][name].totD += totD;
                
                stats.types[type].p += totH;
                stats.types[type].c += cost;
                stats.totalCost += cost;
            }
        }
        return { stats, groups, rowCount: rows.length };
    }

    // --- ACTIONS ---
    async function dispatchGlobalScan() {
        stopSignal = false;
        switchView('globalView');
        document.getElementById('cntRows').innerText = "...";
        
        // 1. Fetch
        let rows = await fetchRows("dovutilstake");
        
        // 2. Process
        let res = processRows(rows);
        
        // 3. Render
        document.getElementById('cntRows').innerText = res.rowCount;
        document.getElementById('gTotalCost').innerText = Math.floor(res.stats.totalCost).toLocaleString();
        
        for(let k in CORE_DATA.resourceDefs) {
            // Update Headers
            document.getElementById(`pwr-${k}`).innerText = res.stats.types[k].p.toLocaleString(undefined, {maximumFractionDigits:2});
            document.getElementById(`tot-p-${k}`).innerText = res.stats.types[k].p.toLocaleString(undefined, {maximumFractionDigits:2});
            document.getElementById(`tot-c-${k}`).innerText = Math.round(res.stats.types[k].c).toLocaleString();
            
            // Update List
            let listEl = document.getElementById(`list-${k}`);
            let html = "";
            let arr = Object.values(res.groups[k]).sort((a,b) => b.totH - a.totH);
            let colorClass = CORE_DATA.resourceDefs[k].txt;
            
            arr.forEach(item => {
                html += `
                <div class="t-row">
                    <div class="t-name">${item.name}</div>
                    <div class="t-act">${item.count}</div>
                    <div class="t-val ${colorClass}">${item.totH.toLocaleString(undefined, {maximumFractionDigits:2})}</div>
                    <div class="t-val-dim">${item.totD.toLocaleString(undefined, {maximumFractionDigits:2})}</div>
                </div>`;
            });
            listEl.innerHTML = html;
        }
    }

    async function startBuildings() {
        stopSignal = false;
        switchView('buildingsView');
        let user = document.getElementById('targetIn').value;
        let el = document.getElementById('buildList');
        el.innerHTML = "Scanning...";
        
        let rows = await fetchRows(user);
        let res = processRows(rows); // Reuse logic for calculation
        
        // Flatten groups for display
        let html = "";
        for(let k in res.groups) {
             let arr = Object.values(res.groups[k]);
             let color = CORE_DATA.resourceDefs[k].color;
             arr.forEach(i => {
                 html += `
                 <div class="b-card" style="border-left:3px solid ${color}">
                    <div class="b-head" style="color:${color}">${i.name}</div>
                    <div class="b-sub">ACTIVE: ${i.count}</div>
                    <div class="b-stat">${i.totH.toLocaleString()} /h</div>
                 </div>`;
             });
        }
        el.innerHTML = html || "No active buildings found.";
        document.getElementById('buildStatus').innerText = `Scan complete. Found ${rows.length} items.`;
    }
    
    async function startTarget() {
        alert("Divisions scan logic not requested in this update.");
    }
    
    async function updateDictionary() { alert("Fetch API placeholder."); }

    window.onload = initApp;
</script>
</body>
</html>
