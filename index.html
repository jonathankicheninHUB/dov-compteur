<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DoV COMMAND V262 - STABLE & SYNC</title>
    <style>
        :root {
            --bg-app: #0b0c10; --bg-panel: #13141b; --bg-header: #1c1d26; --border: #2d2e3a;
            --green: #00f090; --red: #ff3b30; --blue: #2979ff; --orange: #ff9100; --purple: #d500f9; --yellow: #ffea00;
            --text-main: #e0e0e0; --text-muted: #858595;
            --font-ui: 'Inter', system-ui, sans-serif; --font-num: 'JetBrains Mono', monospace; 
        }
        body { background: var(--bg-app); color: var(--text-muted); font-family: var(--font-ui); margin: 0; display: flex; height: 100vh; overflow: hidden; font-size: 11px; }
        .sidebar { width: 280px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 15px; gap: 15px; flex-shrink: 0; }
        .main-content { flex: 1; overflow-y: auto; padding: 25px; background: #08080a; display:flex; flex-direction:column; }
        
        /* TERMINAL LOG */
        .terminal-box { background: #000; border: 1px solid #333; padding: 8px; border-radius: 4px; height: 120px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 9px; }
        .log-line { color: #888; margin-bottom: 2px; } .log-ok { color: var(--green); } .log-err { color: var(--red); }

        /* BUTTONS */
        button { padding: 10px; border: none; border-radius: 4px; font-weight: 700; font-size: 10px; text-transform: uppercase; cursor: pointer; transition: 0.2s; width: 100%; margin-bottom: 5px; }
        .btn-green { background: var(--green); color: #000; } .btn-red { background: rgba(255, 59, 48, 0.15); color: var(--red); border: 1px solid var(--red); }
        .btn-blue { background: var(--blue); color: #fff; } .btn-ghost { background: transparent; border: 1px solid #333; color: #888; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }

        /* DASHBOARD ELEMENTS */
        .dashboard-header { display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 15px; border-bottom: 1px solid var(--border); margin-bottom: 25px; }
        .tc-val { font-family: var(--font-num); font-size: 24px; font-weight: 700; color: #fff; }
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
        .kpi-card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; padding: 15px; border-left: 4px solid #333; }
        .kc-val { font-family: var(--font-num); font-size: 18px; font-weight: 700; color: #fff; }

        /* ZONES */
        .zones-map { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .zone-card { background: var(--bg-panel); border: 1px solid var(--border); padding: 10px; border-radius: 4px; height: 150px; display: flex; flex-direction: column; justify-content: space-between; }
        .zone-card.active { border-color: var(--blue); }
        .zs-item { display: flex; justify-content: space-between; font-family: var(--font-num); margin-bottom: 2px; }

        .view-section { display: none; } .active-view { display: block; }
    </style>
</head>
<body>

<div class="layout">
    <aside class="sidebar">
        <div style="color:#fff; font-weight:800; font-size:14px;">DOV COMMAND <span style="opacity:0.5">V262</span></div>
        
        <div class="terminal-box" id="termLog"><div class="log-line">SYSTEM BOOT...</div></div>

        <div class="control-group">
            <button id="btnScanGlobal" class="btn-green" onclick="startBuildingScan()">SCAN BUILDINGS</button>
            <button id="btnScanZones" class="btn-blue" onclick="startZoneScan()">SCAN WAR MAP</button>
            <button class="btn-red" onclick="stopSignal=true">STOP ALL</button>
        </div>

        <div style="margin-top:auto">
            <button class="btn-ghost" onclick="hardReset()">FACTORY RESET</button>
        </div>
    </aside>

    <main class="main-content">
        <div id="viewGlobal" class="view-section active-view">
            <div class="dashboard-header">
                <div><h2 style="color:#fff;margin:0">BUILDING PRODUCTION</h2><div id="buildMeta">Ready.</div></div>
                <div style="text-align:right"><div style="font-size:9px">DAILY MAINTENANCE</div><div class="tc-val" id="gTotalCost">0</div></div>
            </div>
            <div class="kpi-grid" id="buildKpis">
                </div>
            <div id="buildList" style="background:var(--bg-panel); border:1px solid var(--border); border-radius:6px; overflow:hidden;"></div>
        </div>

        <div id="viewZones" class="view-section">
            <div class="dashboard-header" style="border-left: 4px solid var(--blue); padding-left:15px">
                <div><h2 style="color:#fff;margin:0">GLOBAL WAR MAP</h2><div>COLLECTION SCAN</div></div>
                <div style="text-align:right"><div style="font-size:9px">DIVISIONS FOUND</div><div class="tc-val" id="zTotalDivsHeader">0</div></div>
            </div>
            <div class="kpi-grid">
                <div class="kpi-card" style="border-left-color:var(--green)"><div style="font-size:9px">IN FIGHT</div><div class="kc-val" id="zActiveDivs">0</div></div>
                <div class="kpi-card" style="border-left-color:var(--blue)"><div style="font-size:9px">TOTAL WEIGHT</div><div class="kc-val" id="zTotalWeight">0</div></div>
                <div class="kpi-card" style="border-left-color:var(--purple)"><div style="font-size:9px">DAILY REWARD</div><div class="kc-val" id="zTotalProd">0</div></div>
            </div>
            <div class="zones-map" id="areaZones"></div>
        </div>
    </main>
</div>

<script>
    const STORAGE_KEY = 'DOV_DATA_V262';
    const getId = (id) => document.getElementById(id);
    let stopSignal = false;
    let ACTIVE_RPC = "https://wax.greymass.com";

    const DATA = {
        zones: { 
            1: {name:"Beach 1", cost:1160, win:400, min_w:0}, 2: {name:"Beach 2", cost:6968, win:2405, min_w:0}, 3: {name:"Beach 3", cost:8800, win:3037, min_w:0},
            4: {name:"Bunker", cost:11120, win:3838, min_w:90}, 5: {name:"Forest 1", cost:14024, win:4840, min_w:3}, 6: {name:"Forest 2", cost:17704, win:6110, min_w:3},
            7: {name:"Forest 3", cost:22352, win:7714, min_w:3}, 8: {name:"Camp", cost:28220, win:9739, min_w:90}, 9: {name:"Hill 1", cost:37052, win:12788, min_w:3},
            10: {name:"Hill 2", cost:48652, win:16791, min_w:3}, 11: {name:"Hill 3", cost:64516, win:22266, min_w:3}, 12: {name:"Radar", cost:84712, win:29236, min_w:90},
            13: {name:"Plain 1", cost:99384, win:34300, min_w:0}, 14: {name:"Plain 2", cost:125708, win:43385, min_w:0}, 15: {name:"Plain 3", cost:151164, win:52171, min_w:0},
            16: {name:"HQ", cost:188000, win:64884, min_w:0}
        },
        templates: {
            // FUEL
            "490122": { "name": "C_F1_PRODUCER_FUEL", "prod": 5.4 }, "492363": { "name": "C_F2_PRODUCER_FUEL", "prod": 12.15 },
            "492366": { "name": "C_F3_PRODUCER_FUEL", "prod": 30.38 }, "492368": { "name": "C_F4_PRODUCER_FUEL", "prod": 83.53 },
            "492373": { "name": "R_F1_PRODUCER_FUEL", "prod": 16.20 }, "492376": { "name": "R_F2_PRODUCER_FUEL", "prod": 36.45 },
            "492379": { "name": "R_F3_PRODUCER_FUEL", "prod": 91.13 }, "492381": { "name": "R_F4_PRODUCER_FUEL", "prod": 250.59 },
            "492383": { "name": "E_F1_PRODUCER_FUEL", "prod": 48.60 }, "492385": { "name": "E_F2_PRODUCER_FUEL", "prod": 109.35 },
            "492386": { "name": "E_F3_PRODUCER_FUEL", "prod": 273.38 }, "492387": { "name": "E_F4_PRODUCER_FUEL", "prod": 751.78 },
            "492389": { "name": "L_F1_PRODUCER_FUEL", "prod": 145.80 }, "492390": { "name": "L_F2_PRODUCER_FUEL", "prod": 328.05 },
            "492391": { "name": "L_F3_PRODUCER_FUEL", "prod": 820.13 }, "492392": { "name": "L_F4_PRODUCER_FUEL", "prod": 2255.34 },
            "544068": { "name": "S1_OWNER_FUEL", "prod": 2255.34 },
            // HEALTH
            "492394": { "name": "C_F1_PRODUCER_HEALTH", "prod": 5.4 }, "492395": { "name": "C_F2_PRODUCER_HEALTH", "prod": 12.15 },
            "492396": { "name": "C_F3_PRODUCER_HEALTH", "prod": 30.38 }, "492397": { "name": "C_F4_PRODUCER_HEALTH", "prod": 83.53 },
            "492399": { "name": "R_F1_PRODUCER_HEALTH", "prod": 16.20 }, "492401": { "name": "R_F2_PRODUCER_HEALTH", "prod": 36.45 },
            "492535": { "name": "R_F3_PRODUCER_HEALTH", "prod": 91.13 }, "492537": { "name": "R_F4_PRODUCER_HEALTH", "prod": 250.59 },
            "492539": { "name": "E_F1_PRODUCER_HEALTH", "prod": 48.60 }, "492543": { "name": "E_F2_PRODUCER_HEALTH", "prod": 109.35 },
            "492545": { "name": "E_F3_PRODUCER_HEALTH", "prod": 273.38 }, "492546": { "name": "E_F4_PRODUCER_HEALTH", "prod": 751.78 },
            "492550": { "name": "L_F1_PRODUCER_HEALTH", "prod": 145.80 }, "492554": { "name": "L_F2_PRODUCER_HEALTH", "prod": 328.05 },
            "492555": { "name": "L_F3_PRODUCER_HEALTH", "prod": 820.13 }, "492557": { "name": "L_F4_PRODUCER_HEALTH", "prod": 2255.34 },
            "544070": { "name": "S1_OWNER_HEALTH", "prod": 2255.34 },
            // REPAIR
            "492559": { "name": "C_F1_PRODUCER_REPAIR", "prod": 5.4 }, "492560": { "name": "C_F2_PRODUCER_REPAIR", "prod": 12.15 },
            "492561": { "name": "C_F3_PRODUCER_REPAIR", "prod": 30.38 }, "492562": { "name": "C_F4_PRODUCER_REPAIR", "prod": 83.53 },
            "492563": { "name": "R_F1_PRODUCER_REPAIR", "prod": 16.20 }, "492465": { "name": "R_F2_PRODUCER_REPAIR", "prod": 36.45 },
            "492566": { "name": "R_F3_PRODUCER_REPAIR", "prod": 91.13 }, "492568": { "name": "R_F4_PRODUCER_REPAIR", "prod": 250.59 },
            "492964": { "name": "E_F1_PRODUCER_REPAIR", "prod": 48.60 }, "492965": { "name": "E_F2_PRODUCER_REPAIR", "prod": 109.35 },
            "492966": { "name": "E_F3_PRODUCER_REPAIR", "prod": 273.38 }, "492967": { "name": "E_F4_PRODUCER_REPAIR", "prod": 751.78 },
            "492572": { "name": "L_F1_PRODUCER_REPAIR", "prod": 145.80 }, "492579": { "name": "L_F2_PRODUCER_REPAIR", "prod": 328.05 },
            "492582": { "name": "L_F3_PRODUCER_REPAIR", "prod": 820.13 }, "492583": { "name": "L_F4_PRODUCER_REPAIR", "prod": 2255.34 },
            "544061": { "name": "S1_OWNER_REPAIR", "prod": 2255.34 },
            // SUPPLY
            "492585": { "name": "C_F1_PRODUCER_SUPPLY", "prod": 5.4 }, "492587": { "name": "C_F2_PRODUCER_SUPPLY", "prod": 12.15 },
            "492589": { "name": "C_F3_PRODUCER_SUPPLY", "prod": 30.38 }, "492702": { "name": "C_F4_PRODUCER_SUPPLY", "prod": 83.53 },
            "492703": { "name": "R_F1_PRODUCER_SUPPLY", "prod": 16.20 }, "492704": { "name": "R_F2_PRODUCER_SUPPLY", "prod": 36.45 },
            "492706": { "name": "R_F3_PRODUCER_SUPPLY", "prod": 91.13 }, "492707": { "name": "R_F4_PRODUCER_SUPPLY", "prod": 250.59 },
            "492708": { "name": "E_F1_PRODUCER_SUPPLY", "prod": 48.60 }, "492709": { "name": "E_F2_PRODUCER_SUPPLY", "prod": 109.35 },
            "492710": { "name": "E_F3_PRODUCER_SUPPLY", "prod": 273.38 }, "492711": { "name": "E_F4_PRODUCER_SUPPLY", "prod": 751.78 },
            "492712": { "name": "L_F1_PRODUCER_SUPPLY", "prod": 145.80 }, "492713": { "name": "L_F2_PRODUCER_SUPPLY", "prod": 328.05 },
            "492714": { "name": "L_F3_PRODUCER_SUPPLY", "prod": 820.13 }, "492715": { "name": "L_F4_PRODUCER_SUPPLY", "prod": 2255.34 },
            "544064": { "name": "S1_OWNER_SUPPLY", "prod": 2255.34 }
        }
    };

    function log(m, cls="") {
        let l = getId('termLog');
        l.innerHTML += `<div class="log-line ${cls}">> ${m}</div>`;
        l.scrollTop = l.scrollHeight;
    }

    function buildUI() {
        const types = { F:"FUEL", H:"HEALTH", R:"REPAIR", S:"SUPPLY" };
        const kGrid = getId('buildKpis'); kGrid.innerHTML = '';
        Object.entries(types).forEach(([k,v]) => {
            kGrid.innerHTML += `<div class="kpi-card" style="border-left-color:var(--${k==='F'?'orange':k==='H'?'red':k==='R'?'blue':'yellow'})">
                <div style="font-size:9px">${v} / HOUR</div><div class="kc-val" id="val-${k}">0</div><div style="font-size:9px" id="act-${k}">0 ACTIVE</div>
            </div>`;
        });
        renderZones({}, {total:0, active:0, weight:0, reward:0});
    }

    async function fetchRPC(code, scope, table, lower="") {
        try {
            let res = await fetch(ACTIVE_RPC + "/v1/chain/get_table_rows", {
                method: 'POST', body: JSON.stringify({json:true, code, scope, table, limit:1000, lower_bound:lower})
            });
            return res.ok ? await res.json() : {rows:[]};
        } catch(e) { return {rows:[]}; }
    }

    // --- BUILDING SCAN ---
    async function startBuildingScan() {
        stopSignal = false; getId('viewGlobal').classList.add('active-view'); getId('viewZones').classList.remove('active-view');
        log("SCANNING BUILDINGS (COLLECTION)...");
        let stats = { cost:0, F:0, H:0, R:0, S:0, aF:0, aH:0, aR:0, aS:0 };
        let next = "";
        while(!stopSignal) {
            let json = await fetchRPC("dovutilstake", "dovutilstake", "buildings", next);
            if(!json.rows.length) break;
            const now = Date.now()/1000;
            json.rows.forEach(r => {
                let tpl = DATA.templates[r.template_id];
                if(!tpl) return;
                let count = r.asset_ids ? r.asset_ids.length : 1;
                let active = now < (parseFloat(r.last_claim) + parseFloat(r.delay));
                if(active) {
                    let h = count * tpl.prod;
                    if(tpl.name.includes("FUEL")) { stats.F+=h; stats.aF+=count; }
                    else if(tpl.name.includes("HEALTH")) { stats.H+=h; stats.aH+=count; }
                    else if(tpl.name.includes("REPAIR")) { stats.R+=h; stats.aR+=count; }
                    else if(tpl.name.includes("SUPPLY")) { stats.S+=h; stats.aS+=count; }
                    stats.cost += (h * 24 * 0.085);
                }
            });
            updateBuildUI(stats);
            if(json.more) next = json.next_key; else break;
        }
        log("BUILDING SCAN COMPLETE.", "log-ok");
    }

    function updateBuildUI(s) {
        getId('val-F').innerText = s.F.toFixed(2); getId('val-H').innerText = s.H.toFixed(2);
        getId('val-R').innerText = s.R.toFixed(2); getId('val-S').innerText = s.S.toFixed(2);
        getId('act-F').innerText = s.aF + " ASSETS"; getId('act-H').innerText = s.aH + " ASSETS";
        getId('act-R').innerText = s.aR + " ASSETS"; getId('act-S').innerText = s.aS + " ASSETS";
        getId('gTotalCost').innerText = Math.round(s.cost).toLocaleString() + " DOVX";
    }

    // --- ZONE SCAN ---
    async function startZoneScan() {
        stopSignal = false; getId('viewZones').classList.add('active-view'); getId('viewGlobal').classList.remove('active-view');
        log("SCANNING WAR MAP (COLLECTION)...");
        let stats = { total:0, active:0, weight:0, reward:0 };
        let zData = {}; Object.keys(DATA.zones).forEach(id => zData[id] = { count:0, active:0, weight:0 });
        let next = "";
        while(!stopSignal) {
            let json = await fetchRPC("dovpvecontrl", "dovpvecontrl", "sdivisions", next);
            if(!json.rows.length) break;
            const now = Date.now()/1000;
            json.rows.forEach(r => {
                let zid = r.zone_id || r.zoneID;
                if(!zData[zid]) return;
                zData[zid].count++; stats.total++;
                let et = parseFloat(r.unlock_time || 0);
                let isFighting = et > (et > 1000000000000 ? Date.now() : now);
                if(isFighting) {
                    zData[zid].active++; stats.active++;
                    let w = parseFloat(r.weight || 0);
                    zData[zid].weight += w; stats.weight += w;
                    stats.reward += DATA.zones[zid].win;
                }
            });
            renderZones(zData, stats);
            if(json.more) next = json.next_key; else break;
        }
        log("WAR MAP SCAN COMPLETE.", "log-ok");
    }

    function renderZones(data, s) {
        getId('zTotalDivsHeader').innerText = s.total;
        getId('zActiveDivs').innerText = s.active;
        getId('zTotalWeight').innerText = s.weight.toLocaleString();
        getId('zTotalProd').innerText = s.reward.toLocaleString();
        let html = "";
        Object.keys(DATA.zones).forEach(id => {
            let z = DATA.zones[id]; let d = data[id] || {count:0, active:0, weight:0};
            html += `<div class="zone-card ${d.active>0?'active':''}">
                <div class="zc-top"><span>${z.name}</span><span>${d.active}/${d.count}</span></div>
                <div class="zc-mid">
                    <div class="zs-item"><span>WEIGHT</span><span style="color:var(--blue)">${d.weight}</span></div>
                    <div class="zs-item"><span>WIN/U</span><span style="color:var(--green)">${z.win}</span></div>
                    <div class="zs-item"><span>COST/U</span><span style="color:var(--orange)">${z.cost}</span></div>
                </div>
                <div class="zc-bot"><span>REQ: ${z.min_w}W</span><span style="color:var(--purple)">${(d.active*z.win).toLocaleString()}</span></div>
            </div>`;
        });
        getId('areaZones').innerHTML = html;
    }

    function hardReset() { if(confirm("RESET?")) { localStorage.removeItem(STORAGE_KEY); location.reload(); } }
    window.onload = () => { buildUI(); log("READY."); };
</script>
</body>
</html>
