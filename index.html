<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DoV - COMMAND V90 (STRICT TEMPLATE)</title>
    <style>
        :root { 
            --main: #00e676; --alert: #ff1744; --sec: #29b6f6; --warn: #ff9800; --dovx: #9c27b0; 
            --gold: #ffd700; --money: #2ecc71;
            --fuel: #e67e22; --health: #e74c3c; --repair: #bdc3c7; --supply: #f1c40f;
            --bg: #050505; --panel: #111; --card-bg: #141414;
        }
        body { background-color: var(--bg); color: #ccc; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { height: 40px; background: #000; border-bottom: 1px solid #333; display: flex; align-items: center; padding: 0 15px; justify-content: space-between; }
        h1 { color: var(--gold); margin: 0; font-size: 16px; letter-spacing: 1px; text-transform: uppercase; font-weight: 800; }
        .rpc-badge { font-size: 10px; background: #222; padding: 2px 6px; border-radius: 4px; border: 1px solid #444; color: #888; }
        .layout { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 260px; background: var(--panel); border-right: 1px solid #333; padding: 15px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .main-view { flex: 1; padding: 20px; overflow-y: auto; position: relative; background: #080808; }
        
        .box { border: 1px solid #333; padding: 10px; background: #000; margin-bottom: 10px; border-radius: 4px; }
        .box-title { color: #fff; font-size: 11px; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #222; padding-bottom: 4px; text-transform: uppercase; }
        button { width: 100%; padding: 8px; cursor: pointer; border: none; font-weight: bold; font-family: monospace; text-transform: uppercase; margin-bottom: 5px; font-size: 11px; border-radius: 2px; }
        .btn-global { background: #fff; color: #000; } .btn-stop { background: var(--alert); color: #fff; display: none; }
        input { width: 100%; padding: 6px; background: #222; border: 1px solid #444; color: #fff; box-sizing: border-box; margin-bottom: 5px; }
        
        /* DASHBOARD */
        .g-main-count { background: #fff; color: #000; padding: 15px; border-radius: 4px; display:flex; justify-content:space-between; align-items:center; border-left: 5px solid var(--main); margin-bottom: 20px; }
        .g-cost-val { color: var(--dovx); font-weight:bold; font-size:20px; }
        
        /* LISTE V90 */
        .model-list-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .ml-col { background: #111; border: 1px solid #333; border-radius: 4px; overflow: hidden; }
        .ml-header { padding: 8px; background: #222; font-weight: bold; font-size: 12px; text-transform: uppercase; color: #fff; }
        .ml-row { display: grid; grid-template-columns: 3.5fr 0.7fr 1fr 1.2fr; padding: 8px 10px; border-bottom: 1px solid #1a1a1a; font-size: 11px; align-items: center; }
        .ml-name a { color: var(--sec); text-decoration: none; font-weight:bold; }
        .ml-tid { font-size: 9px; color: #555; margin-left:5px; }
        .ml-total { color: #fff; font-weight: bold; text-align: right; }
        .c-f { border-left: 4px solid var(--fuel); } .c-h { border-left: 4px solid var(--health); }
        .logs { height: 100px; background: #000; border-top: 1px solid #333; padding: 10px; font-size: 11px; color: #666; overflow-y: auto; }
        .view-section { display: none; } .view-active { display: block; }
    </style>
</head>
<body>

<header>
    <h1>DoV COMMAND <span style="color:var(--sec)">V90 STRICT TEMPLATE</span></h1>
    <span class="rpc-badge" id="rpcStatus">PRÊT</span>
</header>

<div class="layout">
    <aside class="sidebar">
        <div class="box">
            <div class="box-title">CONFIGURATION</div>
            <input type="number" id="inpWax" value="0.00786" step="0.00001" onchange="updateRates()">
            <input type="text" id="inpProxy" value="https://corsproxy.io/?">
        </div>
        <div class="box">
            <button class="btn-global" onclick="startGlobalBuildings()">SCAN GLOBAL (V90)</button>
            <button class="btn-stop" id="btnStop" onclick="stopSignal=true">ARRÊT</button>
        </div>
    </aside>

    <main class="main-view">
        <div id="buildingView" class="view-section view-active">
            <div class="g-main-count">
                <div><b>FLUX RÉEL ACTIF (24H)</b><br><span id="globalCount">0 Bâtiments</span></div>
                <div style="text-align:right"><small>COÛT DOV-X</small><br><span class="g-cost-val" id="gTotalCost">0</span></div>
            </div>
            
            <div class="model-list-container">
                <div class="ml-col c-f" id="list-F"><div class="ml-header">FUEL</div></div>
                <div class="ml-col c-h" id="list-H"><div class="ml-header">HEALTH</div></div>
            </div>
        </div>
        <div class="logs" id="console"></div>
    </main>
</div>

<script>
    // --- DICTIONNAIRE DE RÉFÉRENCE STRICT ---
    // Clé: Valeur "Power" d'un seul exemplaire
    const PRODUCTION_TABLE = {
        5.40: "C_F1_PRODUCER", 54.00: "SC_F2_PRODUCER", 12.15: "C_F2_PRODUCER",
        121.50: "SC_F3_PRODUCER", 30.38: "C_F3_PRODUCER", 83.53: "C_F4_PRODUCER",
        1458.0: "SC_F5_PRODUCER", 16.20: "R_F1_PRODUCER", 36.45: "R_F2_PRODUCER",
        91.13: "R_F3_PRODUCER", 250.59: "R_F4_PRODUCER", 48.60: "E_F1_PRODUCER",
        109.35: "E_F2_PRODUCER", 273.38: "E_F3_PRODUCER", 751.78: "E_F4_PRODUCER",
        145.80: "L_F1_PRODUCER", 328.05: "L_F2_PRODUCER", 820.13: "L_F3_PRODUCER",
        2255.34: "S1_OWNER" // Identifié pour #544068
    };

    const COST_TABLE = { 5.40: 0.4590, 54.00: 4.5900, 12.15: 1.0328, 121.50: 10.3275, 30.38: 2.5819, 83.53: 7.1002, 1458.0: 123.9300, 2255.34: 191.7042 };

    let TEMPLATE_MAP = {}; 
    let stopSignal = false; 
    let rpcIndex = 0;
    const RPCS = ["https://wax.greymass.com", "https://api.waxsweden.org"];

    function log(msg, color="#888") { document.getElementById('console').innerHTML = `<div style="color:${color}">${msg}</div>` + document.getElementById('console').innerHTML; }

    async function robustFetch(code, table, lowerBound) {
        const proxy = document.getElementById('inpProxy').value;
        const url = proxy + encodeURIComponent(RPCS[rpcIndex % RPCS.length] + "/v1/chain/get_table_rows");
        const res = await fetch(url, { method: 'POST', body: JSON.stringify({ json: true, code, scope: code, table, limit: 500, lower_bound: lowerBound || "0" }) });
        return await res.json();
    }

    async function loadBDATA() {
        log("Chargement du catalogue blockchain...");
        let next = "0"; let more = true;
        while(more && !stopSignal) {
            const data = await robustFetch("dovutilstake", "bdata", next);
            data.rows.forEach(r => {
                let out = Array.isArray(r.output) ? r.output[0] : r.output;
                let val = parseFloat(out.replace(/[^0-9.]/g, ''));
                let type = out.includes("DOVF") ? "FUEL" : out.includes("DOVH") ? "HEALTH" : "OTHER";
                TEMPLATE_MAP[r.template_id] = { val, type };
            });
            if(data.more) next = data.next_key; else more = false;
        }
    }

    async function startGlobalBuildings() {
        stopSignal = false; document.getElementById('btnStop').style.display = 'block';
        await loadBDATA();
        let next = "0"; let more = true;
        let stats = { total: 0, cost: 0, groups: { FUEL: {}, HEALTH: {} } };
        const now = Date.now()/1000;

        while(more && !stopSignal) {
            const data = await robustFetch("dovutilstake", "buildings", next);
            data.rows.forEach(b => {
                stats.total++;
                let t = TEMPLATE_MAP[b.template_id];
                if(!t || t.type === "OTHER") return;

                let rdy = now > (parseFloat(b.last_claim) + parseFloat(b.delay));
                if(!rdy) {
                    let curP = parseFloat(Array.isArray(b.power) ? b.power[0] : b.power);
                    let stack = Math.round(curP / t.val) || 1;
                    
                    // NOMINAGE STRICT
                    let baseName = PRODUCTION_TABLE[t.val] || "MODEL";
                    let fullName = baseName.replace("_F", "_" + t.type[0]) + "_" + t.type;
                    
                    if(!stats.groups[t.type][b.template_id]) stats.groups[t.type][b.template_id] = { name: fullName, count: 0, prod: 0 };
                    
                    stats.groups[t.type][b.template_id].count += stack;
                    stats.groups[t.type][b.template_id].prod += (t.val * 24) * stack;
                    stats.cost += ( (COST_TABLE[t.val] || (t.val * 0.085)) * 4 ) * stack;
                }
            });
            document.getElementById('globalCount').innerText = stats.total + " Bâtiments";
            document.getElementById('gTotalCost').innerText = Math.round(stats.cost).toLocaleString() + " DOVX";
            renderLists(stats.groups);
            if(data.more) next = data.next_key; else more = false;
        }
        log("✅ Scan Terminé.");
    }

    function renderLists(groups) {
        for(let g in groups) {
            let container = document.getElementById('list-' + g[0]);
            if(!container) continue;
            let html = `<div class="ml-header">${g}</div>`;
            for(let tid in groups[g]) {
                let item = groups[g][tid];
                let link = `https://wax.atomichub.io/explorer/template/wax-mainnet/dovdivisions/${tid}`;
                html += `<div class="ml-row">
                    <div class="ml-name"><a href="${link}" target="_blank">${item.name}</a><span class="ml-tid">#${tid}</span></div>
                    <div class="ml-count">${item.count} act.</div>
                    <div class="ml-unit">${Math.round(item.prod/item.count).toLocaleString()}/u</div>
                    <div class="ml-total">${Math.round(item.prod).toLocaleString()}</div>
                </div>`;
            }
            container.innerHTML = html;
        }
    }
</script>
</body>
</html>
