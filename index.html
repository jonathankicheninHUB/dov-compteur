<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DoV - COMMAND V193 (DATA FIX)</title>
    <style>
        /* --- DESIGN SYSTEM DARK WEB3 --- */
        :root {
            --bg-body: #0b0c15; 
            --bg-panel: #12131f; 
            --bg-card: #161722; 
            --border: #2b2d42;
            
            --cyan: #00e676; 
            --purple: #9b59b6;
            --blue: #3498db;
            --orange: #e67e22;
            --red: #e74c3c;
            --yellow: #f1c40f;
            --dovx: #e056fd;

            --text-main: #ffffff;
            --text-muted: #8d99ae;
            
            --font-ui: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-code: 'Consolas', 'Monaco', monospace;
        }

        /* --- LAYOUT --- */
        body { background-color: var(--bg-body); color: var(--text-muted); font-family: var(--font-ui); margin: 0; display: flex; height: 100vh; overflow: hidden; font-size: 12px; }
        * { box-sizing: border-box; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0b0c15; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

        /* --- HEADER --- */
        header { 
            height: 50px; background: rgba(18,19,31,0.95); border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; padding: 0 20px; justify-content: space-between; z-index: 100;
        }
        .logo-area { display: flex; align-items: center; gap: 10px; }
        .logo-dot { width: 8px; height: 8px; background: var(--cyan); border-radius: 50%; box-shadow: 0 0 10px var(--cyan); }
        h1 { color: #fff; font-size: 14px; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; margin: 0; }
        .sys-badge { font-size: 10px; background: #222; border: 1px solid #444; padding: 4px 8px; border-radius: 4px; color: var(--cyan); }

        /* --- SIDEBAR --- */
        .layout { display: flex; flex: 1; overflow: hidden; }
        .sidebar { 
            width: 260px; background: var(--bg-panel); border-right: 1px solid var(--border); 
            padding: 15px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; 
        }

        .panel-box { border: 1px solid var(--border); background: rgba(255,255,255,0.02); border-radius: 6px; padding: 10px; }
        .panel-title { font-size: 10px; font-weight: 700; color: #57606f; text-transform: uppercase; margin-bottom: 8px; display: block; }

        input { width: 100%; padding: 8px; background: #050508; border: 1px solid #444; color: #fff; border-radius: 4px; font-family: var(--font-code); margin-bottom: 5px; }
        input:focus { border-color: var(--blue); outline: none; }

        button { width: 100%; padding: 10px; cursor: pointer; border: none; font-weight: 700; font-size: 10px; text-transform: uppercase; border-radius: 4px; transition: 0.2s; margin-bottom: 5px; }
        button:hover { filter: brightness(1.1); }
        .btn-cyan { background: var(--cyan); color: #000; }
        .btn-orange { background: var(--orange); color: #fff; }
        .btn-blue { background: var(--blue); color: #fff; }
        .btn-red { background: var(--red); color: #fff; }
        .btn-dark { background: #2c3e50; color: #fff; border: 1px solid #34495e; }
        .btn-ghost { background: transparent; border: 1px solid #444; color: #888; }
        .btn-row { display: flex; gap: 5px; }

        /* --- MAIN VIEW --- */
        .main-view { flex: 1; padding: 25px; overflow-y: auto; background: radial-gradient(circle at 50% 0%, #1a1b26 0%, #0b0c15 100%); }

        .dash-header { 
            background: linear-gradient(90deg, #151621 0%, #1a1b26 100%);
            border: 1px solid var(--border); border-left: 4px solid var(--cyan);
            padding: 20px; border-radius: 8px; margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .dh-title { font-size: 20px; font-weight: 800; color: #fff; margin-bottom: 5px; }
        .dh-sub { font-size: 11px; color: #666; font-family: var(--font-code); }
        .dh-cost-val { font-size: 28px; font-weight: 800; color: #fff; }
        .dh-cost-unit { font-size: 14px; color: var(--dovx); font-weight: 700; }

        /* GLOBAL CARDS */
        .top-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 15px; text-align: center; position: relative; overflow: hidden; }
        .sc-lbl { font-size: 11px; font-weight: 700; color: #888; text-transform: uppercase; margin-bottom: 8px; }
        .sc-val { font-size: 22px; font-weight: 800; color: #fff; letter-spacing: -0.5px; }
        .sc-sub { font-size: 9px; color: #444; margin-top: 5px; text-transform: uppercase; }

        /* LISTS */
        .lists-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .list-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; display: flex; flex-direction: column; min-height: 250px; overflow: hidden; }
        .lb-header { background: #1e202e; padding: 10px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .lb-title { font-weight: 800; font-size: 12px; color: #fff; text-transform: uppercase; }
        
        .badges-row { display: flex; gap: 5px; }
        .badge-info { background: #252838; border: 1px solid #333; color: #ccc; padding: 2px 6px; font-size: 10px; border-radius: 3px; font-family: var(--font-code); }
        .badge-dovx { border-color: var(--dovx); color: var(--dovx); background: rgba(224, 86, 253, 0.1); }

        /* TABLE */
        .tbl-header { display: grid; grid-template-columns: 3fr 1fr 1fr 1fr; padding: 8px 12px; font-size: 9px; font-weight: 700; color: #555; text-transform: uppercase; background: rgba(0,0,0,0.2); border-bottom: 1px solid #222; }
        .tbl-row { display: grid; grid-template-columns: 3fr 1fr 1fr 1fr; padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 11px; align-items: center; color: #eee; }
        .tbl-row:hover { background: rgba(255,255,255,0.05); }
        
        .col-name { font-weight: 600; color: #dcdde1; display: flex; align-items: center; gap: 6px; }
        .stack-badge { background: rgba(0, 230, 118, 0.1); color: #00e676; border: 1px solid #00e676; font-size: 9px; padding: 0 4px; border-radius: 3px; font-weight: 800; font-family: var(--font-code); }
        
        .col-act { color: var(--text-muted); font-size: 10px; text-align: right; }
        .col-val { text-align: right; font-family: var(--font-code); font-weight: 700; }
        .col-tot { text-align: right; font-family: var(--font-code); color: #ccc; }

        /* ZONES & ECO */
        .zones-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .zone-card { background: #151621; border: 1px solid var(--border); padding: 10px; border-radius: 4px; transition: 0.2s; position: relative; }
        .zone-card:hover { border-color: var(--cyan); background: #1a1b29; }
        .zone-card.active { border-color: var(--blue); background: rgba(52, 152, 219, 0.1); }
        .zc-header { display: flex; justify-content: space-between; font-weight: 800; font-size: 11px; color: #fff; margin-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 3px; }
        .zc-row { display: flex; justify-content: space-between; font-size: 10px; margin-top: 2px; font-family: var(--font-code); }
        .zc-cost { color: var(--red); } .zc-tups { color: var(--text-muted); }

        .eco-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .eco-box { background: var(--bg-card); border: 1px solid var(--border); padding: 15px; border-radius: 6px; }
        .eco-lbl { font-size: 10px; font-weight: 700; color: #666; text-transform: uppercase; }
        .eco-num { font-size: 20px; font-weight: 800; color: #fff; margin-top: 5px; }

        /* TARGET */
        .build-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .bld-card { background: #151621; border: 1px solid var(--border); padding: 10px; border-radius: 4px; font-size: 11px; }

        /* UTILS */
        .c-fuel { color: var(--fuel); } .b-fuel { border-top: 3px solid var(--fuel); }
        .c-health { color: var(--health); } .b-health { border-top: 3px solid var(--health); }
        .c-repair { color: var(--repair); } .b-repair { border-top: 3px solid var(--repair); }
        .c-supply { color: var(--supply); } .b-supply { border-top: 3px solid var(--supply); }
        .view-section { display: none; } .active-view { display: block; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; align-items: center; justify-content: center; }
        .modal-win { width: 600px; background: var(--bg-card); border: 1px solid var(--border); padding: 20px; border-radius: 8px; }
        textarea { width: 100%; height: 100px; background: #0b0c15; color: #ccc; border: 1px solid #333; font-family: monospace; padding: 10px; }
    </style>
</head>
<body>

<header>
    <div class="logo-area">
        <div class="logo-dot"></div>
        <h1>DoV COMMAND V193</h1>
    </div>
    <div class="sys-badge" id="statusBadge">SYSTEM READY</div>
</header>

<div class="layout">
    <aside class="sidebar">
        <div class="panel-box">
            <span class="panel-title">GLOBAL OPERATIONS</span>
            <div class="btn-row">
                <button class="btn-cyan" onclick="dispatchGlobalScan()">SCAN GLOBAL</button>
                <button class="btn-red" onclick="stopSignal=true">STOP</button>
            </div>
            <div class="btn-row">
                <button class="btn-blue" onclick="startZoneScan()">ZONES</button>
                <button class="btn-orange" onclick="startEconomyScan()">ECONOMY</button>
            </div>
        </div>

        <div class="panel-box">
            <span class="panel-title">TARGET ACCOUNT</span>
            <input type="text" id="targetIn" value="u2d2k.c.wam">
            <div class="btn-row">
                <button class="btn-dark" onclick="startTargetDivisions()">DIVISIONS</button>
                <button class="btn-dark" onclick="startTargetBuildings()">BUILDINGS</button>
            </div>
        </div>

        <div class="panel-box">
            <span class="panel-title">CONFIGURATION</span>
            <div style="font-size:10px; margin-bottom:5px;">Templates: <b id="dictSize" style="color:#fff">0</b></div>
            <button class="btn-ghost" onclick="openSettings()">EDIT SETTINGS</button>
            <button class="btn-ghost" onclick="hardReset()" style="color:var(--red)">FACTORY RESET</button>
        </div>
    </aside>

    <main class="main-view">
        
        <div id="viewGlobal" class="view-section active-view">
            <div class="dash-header">
                <div>
                    <div class="dh-title">GLOBAL SCAN LIVE</div>
                    <div class="dh-sub">Rows: <span id="cntRows">0</span> &bull; Assets: <span id="cntAssets">0</span></div>
                </div>
                <div class="dh-cost">
                    <div class="sc-lbl">TOTAL MAINTENANCE</div>
                    <div><span class="dh-cost-val" id="gTotalCost">0</span> <span class="dh-cost-unit">DOVX</span></div>
                </div>
            </div>
            <div class="top-grid" id="areaCards"></div>
            <div class="lists-grid" id="areaLists"></div>
        </div>

        <div id="viewZones" class="view-section">
            <div class="dash-header" style="border-left-color: var(--blue)">
                <div class="dh-title">ZONE ACTIVITY MAP</div>
                <div class="dh-sub" id="zoneStatus">Ready.</div>
            </div>
            <div class="zones-container" id="areaZones"></div>
        </div>

        <div id="viewEco" class="view-section">
            <div class="dash-header" style="border-left-color: var(--orange)">
                <div class="dh-title">ECONOMY METRICS</div>
                <div class="dh-sub" id="ecoStatus">Ready.</div>
            </div>
            <div class="eco-stats">
                <div class="eco-box"><div class="eco-lbl">DEMAND (TU/DAY)</div><div class="eco-num" id="valDemandTU">0</div></div>
                <div class="eco-box"><div class="eco-lbl">ACTIVE ZONES</div><div class="eco-num" id="valActiveZones">0</div></div>
                <div class="eco-box"><div class="eco-lbl">DOVX BURN ESTIMATE</div><div class="eco-num" id="valDovxBurn">0</div></div>
            </div>
        </div>

        <div id="viewTarget" class="view-section">
            <div class="dash-header" style="border-left-color: var(--purple)">
                <div class="dh-title">TARGET INSPECTOR</div>
                <div class="dh-sub" id="targetStatus">Ready.</div>
            </div>
            <div id="areaTarget" class="build-grid"></div>
        </div>

    </main>
</div>

<div class="modal-overlay" id="settingsModal">
    <div class="modal-win">
        <h3 style="margin-top:0; color:#fff">CONFIGURATION</h3>
        <span class="panel-title">RESOURCES UI</span><textarea id="cfgResources"></textarea>
        <span class="panel-title">GAME RULES</span><textarea id="cfgGameRules"></textarea>
        <span class="panel-title">ZONES</span><textarea id="cfgZones"></textarea>
        <span class="panel-title">TEMPLATES</span><textarea id="cfgTemplates"></textarea>
        <div style="text-align:right; margin-top:10px;">
            <button class="btn-cyan" style="width:auto" onclick="saveConfig()">SAVE</button>
            <button class="btn-ghost" style="width:auto" onclick="closeModal('settingsModal')">CANCEL</button>
        </div>
    </div>
</div>

<script>
    const getId = (id) => document.getElementById(id);
    const closeModal = (id) => getId(id).style.display = 'none';
    const switchView = (id) => {
        document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active-view'));
        getId(id).classList.add('active-view');
    };
    const fmt = (n) => n.toLocaleString('fr-FR', {maximumFractionDigits: 0});
    const fmtDec = (n) => n.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2});

    const DEFAULT_DATA = {
        apiConfig: { endpoint: "https://wax.greymass.com/v1/chain/get_table_rows" },
        resourceDefs: {
            "F": { label: "FUEL", color: "#e67e22", css: "b-fuel", txt: "c-fuel" },
            "H": { label: "HEALTH", color: "#e74c3c", css: "b-health", txt: "c-health" },
            "R": { label: "REPAIR", color: "#3498db", css: "b-repair", txt: "c-repair" },
            "S": { label: "SUPPLY", color: "#feca57", css: "b-supply", txt: "c-supply" }
        },
        gameConfig: { maintenanceCost: 0.085, cycleHours: 24, tokenMap: { "DOVF": "F", "DOVH": "H", "DOVR": "R", "DOVS": "S" } },
        zones: { 
            1:{name:"Beach 1",cost:1160},2:{name:"Beach 2",cost:6968},3:{name:"Beach 3",cost:8800},4:{name:"Bunker",cost:11120},
            5:{name:"Forest 1",cost:14024},6:{name:"Forest 2",cost:17704},7:{name:"Forest 3",cost:22352},8:{name:"Camp",cost:28220},
            9:{name:"Hill 1",cost:37052},10:{name:"Hill 2",cost:48652},11:{name:"Hill 3",cost:64516},12:{name:"Radar",cost:84712},
            13:{name:"Plain 1",cost:99384},14:{name:"Plain 2",cost:125708},15:{name:"Plain 3",cost:151164},16:{name:"HQ",cost:188000},
            17:{name:"City 1",cost:0},18:{name:"City 2",cost:0},19:{name:"City 3",cost:0},20:{name:"City 4",cost:0}
        },
        templates: {
            // FIXED 492368 -> C_F4
            "492368": { "name": "C_F4_PRODUCER_FUEL", "prod": 83.53 }, 
            // FIXED 492389 -> L_F1
            "492389": { "name": "L_F1_PRODUCER_FUEL", "prod": 145.80 }, 

            "490122": { "name": "C_F1_PRODUCER_FUEL", "prod": 5.4 }, "492383": { "name": "C_F1_PRODUCER_FUEL", "prod": 5.4 },
            "492385": { "name": "C_F2_PRODUCER_FUEL", "prod": 12.15 }, "492363": { "name": "C_F2_PRODUCER_FUEL (VAR)", "prod": 12.15 },
            "492366": { "name": "C_F3_PRODUCER_FUEL (VAR)", "prod": 30.38 },
            "492397": { "name": "C_F4_PRODUCER_FUEL", "prod": 83.53 }, "492373": { "name": "R_F1_PRODUCER_FUEL", "prod": 16.20 },
            "492379": { "name": "R_F1_PRODUCER_FUEL", "prod": 16.20 }, "492376": { "name": "R_F2_PRODUCER_FUEL", "prod": 36.45 },
            "492386": { "name": "R_F3_PRODUCER_FUEL", "prod": 91.13 }, "492390": { "name": "R_F4_PRODUCER_FUEL", "prod": 250.59 },
            "492380": { "name": "E_F1_PRODUCER_FUEL", "prod": 48.60 }, "492381": { "name": "E_F2_PRODUCER_FUEL", "prod": 109.35 },
            "492387": { "name": "E_F3_PRODUCER_FUEL", "prod": 273.38 }, "492388": { "name": "E_F4_PRODUCER_FUEL", "prod": 751.78 },
            "492368": { "name": "L_F1_PRODUCER_FUEL", "prod": 145.80 }, "492370": { "name": "L_F2_PRODUCER_FUEL", "prod": 328.05 },
            "492372": { "name": "L_F3_PRODUCER_FUEL", "prod": 820.13 }, "544068": { "name": "S1_OWNER_FUEL", "prod": 2255.34 },
            "492392": { "name": "S1_OWNER_FUEL (VAR)", "prod": 2255.34 }, "492377": { "name": "SC_F2_PRODUCER_FUEL", "prod": 54.00 },
            "492391": { "name": "SC_F3_PRODUCER_FUEL", "prod": 121.50 },
            "492394": { "name": "C_F1_PRODUCER_HEALTH", "prod": 5.4 }, "492395": { "name": "C_F2_PRODUCER_HEALTH", "prod": 12.15 },
            "492396": { "name": "C_F3_PRODUCER_HEALTH", "prod": 30.38 }, "492399": { "name": "R_F1_PRODUCER_HEALTH", "prod": 16.20 },
            "492401": { "name": "R_F2_PRODUCER_HEALTH", "prod": 36.45 }, "492535": { "name": "R_F3_PRODUCER_HEALTH", "prod": 91.13 },
            "492537": { "name": "R_F4_PRODUCER_HEALTH", "prod": 250.59 }, "492539": { "name": "E_F1_PRODUCER_HEALTH", "prod": 48.60 },
            "492543": { "name": "E_F2_PRODUCER_HEALTH", "prod": 109.35 }, "492545": { "name": "E_F3_PRODUCER_HEALTH", "prod": 273.38 },
            "492546": { "name": "E_F4_PRODUCER_HEALTH", "prod": 751.78 }, "492550": { "name": "L_F1_PRODUCER_HEALTH", "prod": 145.80 },
            "492554": { "name": "L_F2_PRODUCER_HEALTH", "prod": 328.05 }, "492555": { "name": "L_F3_PRODUCER_HEALTH", "prod": 820.13 },
            "544070": { "name": "S1_OWNER_HEALTH", "prod": 2255.34 }, "492460": { "name": "C_F1_PRODUCER_REPAIR", "prod": 5.4 },
            "492461": { "name": "C_F2_PRODUCER_REPAIR", "prod": 12.15 }, "492462": { "name": "C_F3_PRODUCER_REPAIR", "prod": 30.38 },
            "492463": { "name": "C_F4_PRODUCER_REPAIR", "prod": 83.53 }, "492464": { "name": "R_F1_PRODUCER_REPAIR", "prod": 16.20 },
            "492465": { "name": "R_F2_PRODUCER_REPAIR", "prod": 36.45 }, "492466": { "name": "R_F3_PRODUCER_REPAIR", "prod": 91.13 },
            "492467": { "name": "R_F4_PRODUCER_REPAIR", "prod": 250.59 }, "492469": { "name": "E_F1_PRODUCER_REPAIR", "prod": 48.60 },
            "492471": { "name": "E_F2_PRODUCER_REPAIR", "prod": 109.35 }, "492472": { "name": "E_F3_PRODUCER_REPAIR", "prod": 273.38 },
            "492473": { "name": "E_F4_PRODUCER_REPAIR", "prod": 751.78 }, "492474": { "name": "L_F1_PRODUCER_REPAIR", "prod": 145.80 },
            "492475": { "name": "L_F2_PRODUCER_REPAIR", "prod": 328.05 }, "492476": { "name": "L_F3_PRODUCER_REPAIR", "prod": 820.13 },
            "544071": { "name": "S1_OWNER_REPAIR", "prod": 2255.34 }, "492507": { "name": "C_F1_PRODUCER_SUPPLY", "prod": 5.4 },
            "492509": { "name": "C_F2_PRODUCER_SUPPLY", "prod": 12.15 }, "492511": { "name": "C_F3_PRODUCER_SUPPLY", "prod": 30.38 },
            "492513": { "name": "C_F4_PRODUCER_SUPPLY", "prod": 83.53 }, "492515": { "name": "R_F1_PRODUCER_SUPPLY", "prod": 16.20 },
            "492518": { "name": "R_F2_PRODUCER_SUPPLY", "prod": 36.45 }, "492521": { "name": "R_F3_PRODUCER_SUPPLY", "prod": 91.13 },
            "492523": { "name": "R_F4_PRODUCER_SUPPLY", "prod": 250.59 }, "492526": { "name": "E_F1_PRODUCER_SUPPLY", "prod": 48.60 },
            "492528": { "name": "E_F2_PRODUCER_SUPPLY", "prod": 109.35 }, "492529": { "name": "E_F3_PRODUCER_SUPPLY", "prod": 273.38 },
            "492530": { "name": "E_F4_PRODUCER_SUPPLY", "prod": 751.78 }, "492532": { "name": "L_F1_PRODUCER_SUPPLY", "prod": 145.80 },
            "492533": { "name": "L_F2_PRODUCER_SUPPLY", "prod": 328.05 }, "492534": { "name": "L_F3_PRODUCER_SUPPLY", "prod": 820.13 },
            "544069": { "name": "S1_OWNER_SUPPLY", "prod": 2255.34 },
            // REPAIR
            "492559": { "name": "C_F1_PRODUCER_REPAIR", "prod": 5.4 }, "492560": { "name": "C_F2_PRODUCER_REPAIR", "prod": 12.15 },
            "492561": { "name": "C_F3_PRODUCER_REPAIR", "prod": 30.38 }, "492562": { "name": "C_F4_PRODUCER_REPAIR", "prod": 83.53 },
            "492563": { "name": "R_F1_PRODUCER_REPAIR", "prod": 16.20 }, "492565": { "name": "R_F2_PRODUCER_REPAIR", "prod": 36.45 },
            "492566": { "name": "R_F3_PRODUCER_REPAIR", "prod": 91.13 }, "492568": { "name": "R_F4_PRODUCER_REPAIR", "prod": 250.59 },
            "492964": { "name": "E_F1_PRODUCER_REPAIR", "prod": 48.60 }, "492965": { "name": "E_F2_PRODUCER_REPAIR", "prod": 109.35 },
            "492966": { "name": "E_F3_PRODUCER_REPAIR", "prod": 273.38 }, "492967": { "name": "E_F4_PRODUCER_REPAIR", "prod": 751.78 },
            "492572": { "name": "L_F1_PRODUCER_REPAIR", "prod": 145.80 }, "492579": { "name": "L_F2_PRODUCER_REPAIR", "prod": 328.05 },
            "492582": { "name": "L_F3_PRODUCER_REPAIR", "prod": 820.13 }, "544061": { "name": "S1_OWNER_REPAIR", "prod": 2255.34 },
            "492583": { "name": "L_F4_PRODUCER_REPAIR", "prod": 2255.34 }
        }
    };

    let DATA = JSON.parse(JSON.stringify(DEFAULT_DATA));
    let stopSignal = false; 

    function init() {
        const local = localStorage.getItem('DOV_DATA');
        if(local) { 
            try { 
                let loaded = JSON.parse(local);
                // PATCH: If we detect the old wrong mapping for 492389, we force update
                if(loaded.templates && loaded.templates["492389"] && loaded.templates["492389"].name.startsWith("C_F3")) {
                    console.log("Patching template 492389...");
                    DATA = { ...DEFAULT_DATA };
                } else if(!loaded.templates || Object.keys(loaded.templates).length < 50) {
                    DATA = { ...DEFAULT_DATA };
                } else {
                    DATA = { ...DEFAULT_DATA, ...loaded, templates: { ...DEFAULT_DATA.templates, ...loaded.templates } };
                }
            } catch(e) { localStorage.setItem('DOV_DATA', JSON.stringify(DEFAULT_DATA)); DATA = JSON.parse(JSON.stringify(DEFAULT_DATA)); } 
        }
        getId('dictSize').innerText = Object.keys(DATA.templates).length;
        buildUI();
    }

    function buildUI() {
        const areaC = getId('areaCards');
        const areaL = getId('areaLists');
        areaC.innerHTML = ''; areaL.innerHTML = '';

        for(let k in DATA.resourceDefs) {
            let rd = DATA.resourceDefs[k];
            areaC.innerHTML += `<div class="res-card ${rd.css}"><div class="rc-label">${rd.label}</div><div class="rc-val" style="color:${rd.color}" id="val-${k}">0</div><div class="rc-sub">PROD / HOUR</div></div>`;
            areaL.innerHTML += `
            <div class="list-box">
                <div class="lb-header">
                    <div class="lb-title">${rd.label} DETAILS</div>
                    <div class="badges-row"><span class="badge-info">PROD: <span id="btot-${k}">0</span></span><span class="badge-info badge-dovx">COST: <span id="bcost-${k}">0</span></span></div>
                </div>
                <div class="tbl-header"><span>TEMPLATE</span><span>ACTIVE</span><span style="text-align:right">UNIT</span><span style="text-align:right">TOTAL/H</span></div>
                <div id="tbl-${k}"></div>
            </div>`;
        }
    }

    function processRow(row) {
        let tid = row.template_id.toString();
        let count = row.asset_ids ? row.asset_ids.length : 1;
        let tpl = DATA.templates[tid];
        let name = tpl ? tpl.name : `UNK_${tid}`;
        let nominal = tpl ? tpl.prod : 0;

        let rawStr = (Array.isArray(row.power) ? row.power[0] : row.power) || "";
        let rawVal = parseFloat(rawStr.replace(/[^0-9.]/g,'')) || 0;
        let stackVis = (nominal > 0 && rawVal > 0) ? Math.round(rawVal / nominal) : 1;

        let hourly = count * nominal;
        let daily = hourly * DATA.gameConfig.cycleHours;
        let cost = daily * DATA.gameConfig.maintenanceCost;

        let type = "F";
        for(let t in DATA.gameConfig.tokenMap) if(rawStr.includes(t)) { type = DATA.gameConfig.tokenMap[t]; break; }

        return { name, type, count, hourly, daily, cost, nominal, stackVis };
    }

    async function dispatchGlobalScan() {
        stopSignal = false; switchView('viewGlobal');
        getId('cntRows').innerText = "...";
        let next = "";
        let stats = { totalCost:0, types:{} };
        let groups = {};
        for(let k in DATA.resourceDefs) { stats.types[k] = {p:0, c:0}; groups[k] = []; }
        let rowCount = 0; let assetCount = 0;

        try {
            while(!stopSignal) {
                let res = await fetch(DATA.apiConfig.endpoint, {
                    method:'POST', body:JSON.stringify({json:true, code:"dovutilstake", scope:"dovutilstake", table:"buildings", limit:1000, lower_bound:next})
                });
                let json = await res.json();
                if(!json.rows || json.rows.length === 0) break;

                const now = Date.now()/1000;
                for(let r of json.rows) {
                    rowCount++;
                    let d = processRow(r);
                    assetCount += d.count;
                    let active = now < (parseFloat(r.last_claim) + parseFloat(r.delay));
                    if(active) {
                        let existing = groups[d.type].find(x => x.name === d.name);
                        if(existing) {
                            existing.act += d.count;
                            existing.totH += d.hourly;
                            existing.totC += d.cost;
                        } else {
                            groups[d.type].push({ name:d.name, stack:d.stackVis, act:d.count, unit:d.nominal, totH:d.hourly, totC:d.cost });
                        }
                        stats.types[d.type].p += d.hourly;
                        stats.types[d.type].c += d.cost;
                        stats.totalCost += d.cost;
                    }
                }
                updateGlobalUI(rowCount, assetCount, stats, groups);
                if(json.more) next = json.next_key; else break;
                await new Promise(r => setTimeout(r, 50));
            }
        } catch(e) { console.error(e); }
    }

    function updateGlobalUI(rows, assets, stats, groups) {
        getId('cntRows').innerText = fmt(rows); getId('cntAssets').innerText = fmt(assets); getId('gTotalCost').innerText = fmt(stats.totalCost);
        for(let k in DATA.resourceDefs) {
            let rd = DATA.resourceDefs[k];
            getId(`val-${k}`).innerText = fmtDec(stats.types[k].p); getId(`btot-${k}`).innerText = fmtDec(stats.types[k].p); getId(`bcost-${k}`).innerText = fmt(stats.types[k].c);
            let list = groups[k].sort((a,b) => b.totH - a.totH);
            let html = "";
            list.forEach(i => {
                let badge = i.stack > 1 ? `<span class="stack-badge">x${i.stack}</span>` : '';
                html += `<div class="tbl-row"><div class="col-name">${i.name} ${badge}</div><div class="col-act"><b>${i.act}</b> ACTIF</div><div class="col-val" style="color:#888">${fmtDec(i.unit)}/h</div><div class="col-tot" style="color:${rd.color}">${fmtDec(i.totH)}</div></div>`;
            });
            getId(`tbl-${k}`).innerHTML = html;
        }
    }

    async function startZoneScan() {
        stopSignal = false; switchView('viewZones');
        getId('zoneStatus').innerText = "Scanning..."; getId('areaZones').innerHTML = "";
        let counts = {}; Object.keys(DATA.zones).forEach(id => counts[id] = 0);
        let next = "";
        while(!stopSignal) {
            let res = await fetch(DATA.apiConfig.endpoint, { method:'POST', body:JSON.stringify({json:true, code:"dovpvecontrl", scope:"dovpvecontrl", table:"sdivisions", limit:1000, lower_bound:next}) });
            let json = await res.json(); if(!json.rows) break;
            for(let r of json.rows) { let id = r.zone_id || r.zoneID; if(counts[id] !== undefined) counts[id]++; }
            let html = "";
            Object.keys(counts).forEach(id => {
                let z = DATA.zones[id]; let activeClass = counts[id] > 0 ? "active" : "";
                html += `<div class="zone-card ${activeClass}"><div class="zc-header"><span>${z.name}</span><span>${counts[id]}</span></div><div class="zc-row"><span class="zc-tups">COST:</span><span class="zc-cost">${z.cost} TU</span></div></div>`;
            });
            getId('areaZones').innerHTML = html;
            if(!json.more) break; next = json.next_key; await new Promise(r => setTimeout(r, 50));
        }
        getId('zoneStatus').innerText = "Scan Complete";
    }

    async function startEconomyScan() {
        stopSignal = false; switchView('viewEco');
        getId('ecoStatus').innerText = "Scanning...";
        let next = ""; let dTU = 0, activeZ = 0;
        while(!stopSignal) {
            let res = await fetch(DATA.apiConfig.endpoint, { method:'POST', body:JSON.stringify({json:true, code:"dovpvecontrl", scope:"dovpvecontrl", table:"sdivisions", limit:1000, lower_bound:next}) });
            let json = await res.json(); if(!json.rows) break;
            for(let r of json.rows) { let z = DATA.zones[r.zone_id]; if(z && z.cost > 0) { dTU += z.cost; activeZ++; } }
            getId('valDemandTU').innerText = fmt(dTU); getId('valActiveZones').innerText = fmt(activeZ);
            if(!json.more) break; next = json.next_key; await new Promise(r => setTimeout(r, 50));
        }
        getId('ecoStatus').innerText = "Scan Complete";
    }

    async function startTargetBuildings() {
        stopSignal = false; switchView('viewTarget');
        let user = getId('targetIn').value.trim(); getId('targetStatus').innerText = "Buildings of " + user; getId('areaTarget').innerHTML = "Scanning...";
        let next = ""; let html = "";
        while(!stopSignal) {
            let res = await fetch(DATA.apiConfig.endpoint, { method:'POST', body:JSON.stringify({json:true, code:"dovutilstake", scope:user, table:"buildings", limit:1000, lower_bound:next}) });
            let json = await res.json(); if(!json.rows) break;
            for(let r of json.rows) {
                let d = processRow(r); let col = DATA.resourceDefs[d.type].color;
                html += `<div class="bld-card" style="border-left:3px solid ${col}"><div style="font-weight:bold; color:${col}">${d.name}</div><div style="display:flex; justify-content:space-between; margin-top:5px;"><span>QTY: ${d.count}</span><span style="color:#fff; font-weight:700">${fmtDec(d.hourly)} /h</span></div></div>`;
            }
            getId('areaTarget').innerHTML = html || "No buildings found.";
            if(!json.more) break; next = json.next_key;
        }
    }

    async function startTargetDivisions() {
        stopSignal = false; switchView('viewTarget');
        let user = getId('targetIn').value.trim(); getId('targetStatus').innerText = "Divisions of " + user; getId('areaTarget').innerHTML = "Scanning...";
        let next = ""; let html = "";
        while(!stopSignal) {
            let res = await fetch(DATA.apiConfig.endpoint, { method:'POST', body:JSON.stringify({json:true, code:"dovpvecontrl", scope:user, table:"sdivisions", limit:1000, lower_bound:next}) });
            let json = await res.json(); if(!json.rows) break;
            for(let r of json.rows) {
                let z = DATA.zones[r.zone_id];
                html += `<div class="bld-card" style="border-left:3px solid var(--accent)"><div style="font-weight:bold; color:#fff">${z ? z.name : 'Zone '+r.zone_id}</div><div style="color:var(--accent); text-align:right; font-weight:bold;">READY / ENGAGED</div></div>`;
            }
            getId('areaTarget').innerHTML = html || "No divisions found.";
            if(!json.more) break; next = json.next_key;
        }
    }

    function openSettings() { getId('cfgResources').value = JSON.stringify(DATA.resourceDefs, null, 4); getId('cfgGameRules').value = JSON.stringify(DATA.gameConfig, null, 4); getId('cfgZones').value = JSON.stringify(DATA.zones, null, 4); getId('cfgTemplates').value = JSON.stringify(DATA.templates, null, 4); getId('settingsModal').style.display = 'flex'; }
    function saveConfig() { try { DATA.resourceDefs = JSON.parse(getId('cfgResources').value); DATA.gameConfig = JSON.parse(getId('cfgGameRules').value); DATA.zones = JSON.parse(getId('cfgZones').value); DATA.templates = JSON.parse(getId('cfgTemplates').value); localStorage.setItem('DOV_DATA', JSON.stringify(DATA)); closeModal('settingsModal'); init(); } catch(e) { alert("JSON ERROR"); } }
    function hardReset() { if(confirm("FULL RESET?")) { localStorage.removeItem('DOV_DATA'); location.reload(); } }

    window.onload = init;
</script>
</body>
</html>
