<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DoV - COMMAND V172 (UI FIXED)</title>
    <style>
        /* --- CORE VARIABLES --- */
        :root { 
            --main: #00e676; --alert: #ff1744; --sec: #29b6f6; --warn: #ff9800; --dovx: #9c27b0; 
            --gold: #ffd700; --money: #2ecc71;
            --fuel: #e67e22; --health: #e74c3c; --repair: #bdc3c7; --supply: #f1c40f;
            --bg: #050505; --panel: #111; --border: #333;
        }
        
        /* --- SCROLLBARS (Senior Polish) --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        body { background-color: var(--bg); color: #ccc; font-family: 'Consolas', monospace; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { height: 40px; background: #000; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 15px; justify-content: space-between; }
        h1 { color: var(--gold); margin: 0; font-size: 16px; letter-spacing: 1px; text-transform: uppercase; }
        .layout { display: flex; flex: 1; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 280px; background: var(--panel); border-right: 1px solid var(--border); padding: 15px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .main-view { flex: 1; padding: 20px; overflow-y: auto; position: relative; background: #000; }
        .box { border: 1px solid #444; padding: 10px; background: #080808; margin-bottom: 10px; }
        .box-title { color: #fff; font-size: 11px; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 4px; }
        
        /* BUTTONS */
        button { width: 100%; padding: 10px; cursor: pointer; border: none; font-weight: bold; font-family: monospace; text-transform: uppercase; margin-bottom: 5px; font-size: 11px; transition:0.2s; }
        button:hover { opacity: 0.8; }
        .btn-zone { background: var(--main); color: #000; } .btn-eco { background: var(--gold); color: #000; } .btn-stop { background: var(--alert); color: #fff; display: none; } 
        .btn-target { background: var(--sec); color: #000; } .btn-build { background: #9b59b6; color: #fff; } .btn-global { background: #fff; color: #000; }
        .btn-settings { background: #333; color: var(--sec); border:1px solid var(--sec); margin-bottom:15px; } .btn-settings:hover { background: #444; }
        .btn-update { background: #e67e22; color: #fff; font-size: 10px; margin-bottom: 10px; }
        .btn-reset { background: #b71c1c; color: #fff; font-size: 10px; border: 1px solid #ff1744; margin-top:5px;}
        .btn-time { background: #333; color: #fff; border: 1px solid #555; padding: 5px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; margin-left: 10px; }
        .btn-time:hover { background: #555; }
        
        input, select, textarea { width: 100%; padding: 8px; background: #222; border: 1px solid #444; color: #fff; box-sizing: border-box; font-family: monospace; margin-bottom: 5px; }
        .inp-label { font-size: 10px; color: #888; margin-bottom: 2px; display: block; }
        .rpc-badge { font-size: 10px; background: #222; padding: 2px 6px; border-radius: 4px; border: 1px solid #444; color: #888; }
        
        /* TOP STATS BANNER */
        .g-main-count { background: #fff; color: #000; padding: 15px; border-radius: 4px; display:flex; justify-content:space-between; align-items:center; border-left: 5px solid var(--gold); margin-bottom: 20px; }
        .g-mc-left { display: flex; flex-direction: column; } 
        .g-mc-right { text-align: right; }
        /* V172 FIX: Color Black for title on white background */
        .g-title { font-weight:bold; color:#000; font-size:14px; margin-bottom:2px; }
        .scan-stats-row { display: flex; gap: 20px; font-size: 12px; margin-top: 5px; color:#555; }
        .g-cost-val { color: var(--dovx); font-weight:bold; font-size:20px; }
        
        /* CARDS GRID */
        .g-detail-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .g-card { background: #111; border: 1px solid #333; padding: 10px; display: flex; flex-direction: column; justify-content:space-between; min-height:100px; }
        .g-card-head { font-weight:bold; font-size:12px; border-bottom:1px solid #222; padding-bottom:5px; text-align:center; color:#fff; }
        .g-prod-val { font-size:16px; font-weight:bold; color:#fff; text-align:center; margin-top:10px; }
        .g-prod-lbl { font-size:9px; color:#888; text-align:center; text-transform:uppercase; }
        
        /* LISTS */
        .model-list-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top:20px; }
        .ml-col { background: #111; border: 1px solid #333; border-radius: 4px; overflow: hidden; display: flex; flex-direction: column; }
        
        /* V172: HEADER AS GRID TO ALIGN WITH ROWS */
        .ml-header { 
            padding: 8px 10px; 
            background: #222; 
            font-weight: bold; 
            font-size: 11px; 
            text-transform: uppercase; 
            color: #fff; 
            border-bottom: 1px solid #444;
            display: grid;
            grid-template-columns: 4fr 1.5fr 2fr; /* Name | Prod | Cost/Total */
            align-items: center;
        }
        
        .ml-row { 
            display: grid; 
            grid-template-columns: 4fr 1.5fr 2fr; /* Matches Header */
            padding: 6px 10px; 
            border-bottom: 1px solid #1a1a1a; 
            font-size: 11px; 
            align-items: center; 
        }
        .ml-row:hover { background: #161616; }
        
        .row-left { display: flex; flex-direction: column; }
        .row-meta { display: flex; align-items: center; gap: 5px; margin-top: 2px; }
        .row-mid { text-align: right; color: #fff; font-weight: bold; }
        .row-right { text-align: right; display: flex; flex-direction: column; }
        
        .ml-name { color: #ccc; font-weight:bold; text-decoration:none; }
        .ml-mult { color: #000; font-size:9px; background:var(--main); padding:0 3px; border-radius:2px; margin-left:5px; font-weight:bold; }
        .c-active { color: var(--main); font-size: 9px; }
        .c-cost-mini { color: var(--dovx); font-size: 9px; }
        
        /* Resource Colors Borders */
        .c-f { border-left: 4px solid var(--fuel); } .c-h { border-left: 4px solid var(--health); }
        .c-r { border-left: 4px solid var(--repair); } .c-s { border-left: 4px solid var(--supply); }
        
        /* DEBUG BOX */
        .debug-box { margin-top:30px; border:1px solid #444; background:#080808; padding:10px; }
        .debug-grid { display:grid; grid-template-columns: repeat(4, 1fr); gap:5px; font-size:10px; max-height:300px; overflow-y:auto; }
        .d-row { background:#111; padding:4px; border:1px solid #222; display:flex; justify-content:space-between; align-items:center; }
        .d-id { color:var(--sec); font-family:monospace; cursor:pointer; }
        .logs { height: 120px; background: #000; border-top: 1px solid #333; padding: 10px; font-size: 11px; color: #888; overflow-y: auto; font-family: monospace; white-space: pre-wrap; margin-top:20px; }

        /* OTHER VIEWS */
        .stats-row { display: grid; grid-template-columns: 1fr 1fr 1.5fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat { background: #111; padding: 10px; text-align: center; border: 1px solid #333; border-top: 2px solid #444; display: flex; flex-direction: column; justify-content: center; }
        .stat-val { display: block; font-size: 18px; color: #fff; font-weight: bold; }
        .stat-lbl { font-size: 10px; color: #888; text-transform: uppercase; margin-top: 5px; }
        .val-win { color: var(--main); } .val-cost-x { color: var(--dovx); font-weight: bold; }
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; width: 100%; }
        .res-item { display: flex; justify-content: space-between; font-size: 11px; padding: 4px 8px; background: #1a1a1a; border-radius: 3px; align-items: center; }
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .d-fuel { background: var(--fuel); } .d-health { background: var(--health); } .d-repair { background: var(--repair); } .d-supply { background: var(--supply); }
        .zones-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .zone { background: #0a0a0a; border: 1px solid #333; padding: 8px; min-height: 80px; cursor: pointer; transition: 0.2s; position: relative; }
        .zone:hover { border-color: var(--sec); background: #111; box-shadow: 0 0 10px rgba(41, 182, 246, 0.1); }
        .zone.active { border-color: #444; background: #0e0e0e; }
        .z-head { display: flex; justify-content: space-between; color: #fff; font-size: 11px; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid #222; padding-bottom: 4px; margin-bottom: 4px; }
        .z-metrics { font-size: 10px; color: #888; margin-bottom: 5px; display: grid; grid-template-columns: 1fr; gap: 3px; }
        .z-row { display: flex; justify-content: space-between; }
        .z-earn { color: var(--main); font-weight: bold; } .z-burn { color: var(--alert); } .z-burn-x { color: var(--dovx); font-weight: bold; }
        .z-act-text { font-size: 9px; display: flex; justify-content: space-between; margin-top: 2px; color: #666; }
        .z-activity { height: 4px; background: #222; display: flex; border-radius: 2px; overflow: hidden; margin-top: auto; }
        .z-act-mission { background: var(--warn); height: 100%; } .z-act-ready { background: var(--main); height: 100%; }
        .view-section { display: none; } .view-active { display: block; }
        .status-bar { color: var(--sec); font-size: 10px; text-align: center; margin-bottom: 10px; border: 1px solid #333; padding: 5px; background: #080808; display:none; }
        .eco-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .eco-card { background: #111; border: 1px solid #333; padding: 15px; display: flex; flex-direction: column; justify-content: space-between; min-height: 80px; }
        .eco-head { font-size: 11px; color: #888; text-transform: uppercase; border-bottom: 1px solid #222; padding-bottom: 5px; margin-bottom: 5px; display:flex; justify-content:space-between; }
        .eco-val { font-size: 18px; font-weight: bold; color: #fff; } .eco-usd { font-size: 11px; color: var(--money); font-weight: bold; margin-top: auto; padding-top: 5px; text-align: right; }
        .c-fighter { border-top: 3px solid var(--alert); } .c-producer { border-top: 3px solid var(--main); } .c-market { border-top: 3px solid var(--dovx); }
        .dovx-breakdown { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 10px; }
        .db-card { background: #080808; border: 1px solid #333; padding: 10px; display: flex; flex-direction: column; justify-content: space-between; height: 80px; }
        .db-head { font-size: 10px; color: #888; text-transform: uppercase; border-bottom: 1px solid #222; padding-bottom: 3px; margin-bottom: 5px; }
        .db-val { font-size: 16px; font-weight: bold; color: #fff; } .db-usd { font-size: 11px; color: var(--money); text-align: right; }
        .balance-container { background:#111; padding:15px; border:1px solid #333; margin-bottom:20px; }
        .balance-header { display: grid; grid-template-columns: 1fr 1fr 1fr; font-size: 11px; font-weight: bold; margin-bottom: 8px; text-transform: uppercase; }
        .balance-bar { width: 100%; height: 12px; background: #222; display: flex; border-radius: 3px; overflow: hidden; }
        .bal-demand { background: var(--alert); height: 100%; transition: width 0.5s; } .bal-supply { background: var(--main); height: 100%; transition: width 0.5s; }
        .t-row { display: flex; justify-content: space-between; background: #0a0a0a; padding: 8px; border: 1px solid #222; font-size: 11px; align-items: center; margin-bottom: 5px; }
        .st-mission { color: var(--warn); border: 1px solid var(--warn); padding: 0 4px; border-radius: 3px; font-size: 9px; } .st-ready { color: var(--main); border: 1px solid var(--main); padding: 0 4px; border-radius: 3px; font-size: 9px; }
        .b-card { background: #111; border: 1px solid #333; padding: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; position: relative; }
        .b-title { font-weight: bold; color: #9b59b6; font-size: 13px; } .b-sub { font-size: 10px; color: #666; } .b-stats { text-align: right; font-size: 11px; display: flex; flex-direction: column; gap: 2px; }
        .b-badge-ok { background: var(--main); color: #000; font-size: 9px; padding: 2px 5px; border-radius: 2px; font-weight: bold; }
        .b-badge-claim { background: var(--warn); color: #000; font-size: 9px; padding: 2px 5px; border-radius: 2px; font-weight: bold; animation: pulse 2s infinite; }
        .build-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-top: 15px; }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal-box { background: #111; border: 1px solid var(--sec); width: 600px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.8); }
        .modal-head { padding: 10px 15px; background: #222; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-weight: bold; color: var(--sec); text-transform: uppercase; }
        .modal-close { cursor: pointer; color: #fff; font-weight: bold; font-size: 14px; padding: 5px; }
        .modal-body { padding: 15px; overflow-y: auto; color: #ccc; font-size: 11px; }
        .set-group { margin-bottom: 15px; border: 1px solid #333; padding: 10px; }
        .set-title { color: var(--gold); font-weight: bold; margin-bottom: 5px; display:block; border-bottom:1px solid #444; padding-bottom:3px; }
        .set-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 5px; }
        .btn-action { background: var(--main); color: #000; width: auto; display: inline-block; padding: 5px 15px; cursor: pointer; border:none; font-weight:bold; }
        .btn-action:hover { opacity:0.8; }
        .sybil-cluster { border: 1px solid var(--alert); background: rgba(255, 23, 68, 0.1); margin-bottom: 8px; padding: 5px; border-radius: 3px; }
        .cluster-head { color: var(--alert); font-weight: bold; font-size: 10px; border-bottom: 1px solid #444; margin-bottom: 4px; display: flex; justify-content: space-between; }
        .player-row { padding: 3px 0; display: flex; justify-content: space-between; align-items: center; }
        .player-row:hover { background: #1a1a1a; }
        .p-name { color: var(--main); font-weight: bold; cursor: pointer; }
        .btn-audit { background: #333; border: 1px solid #555; color: #fff; font-size: 9px; padding: 1px 5px; cursor: pointer; margin-left: 5px; width: auto; display: inline-block; }
        .btn-audit:hover { background: var(--sec); border-color: var(--sec); }
    </style>
</head>
<body>

<header>
    <h1>DoV COMMAND <span style="color:var(--sec)">V172 UI FIXED</span></h1>
    <div>
        <button class="btn-time" onclick="toggleTimeMode()" id="btnTimeMode">‚è±Ô∏è MODE: 1H (LIVE)</button>
        <span class="rpc-badge" id="rpcStatus">PR√äT</span>
    </div>
</header>

<div class="layout">
    <aside class="sidebar">
        <button class="btn-settings" onclick="openSettings()">‚öôÔ∏è PARAM√àTRES</button>
        <button class="btn-reset" onclick="hardReset()">‚ö†Ô∏è RESET USINE (SI BUG)</button>
        
        <div class="box">
            <div class="box-title">DICTIONNAIRE</div>
            <div style="font-size:10px; margin-bottom:5px; color:#888;">Templates connus : <b id="dictSize" style="color:#fff">0</b></div>
            <button class="btn-update" onclick="updateDictionary()">üì• T√âL√âCHARGER (OPTIONNEL)</button>
        </div>

        <div class="box" style="border-color: var(--gold)">
            <div class="box-title" style="color:var(--gold)">CONFIGURATION RAPIDE</div>
            <label class="inp-label">Prix WAX ($)</label>
            <input type="number" id="inpWax" step="0.00001" class="inp-money" onchange="updateRates()">
            <label class="inp-label">Parit√© DOVX</label>
            <input type="number" id="inpDovx" step="0.00000001" onchange="updateRates()">
            <label class="inp-label">Parit√© TU</label>
            <input type="number" id="inpTu" step="0.00000001" onchange="updateRates()">
        </div>
        <div class="box">
            <div class="box-title">1. Global (Monde)</div>
            <button class="btn-zone" onclick="startZoneScan()">SCAN ZONES (MAP)</button>
            <button class="btn-eco" onclick="startEconomyScan()">SCAN ECONOMY ($)</button>
            <button class="btn-stop" id="btnStop" onclick="stopSignal=true">ARR√äT</button>
        </div>
        <div class="box">
            <div class="box-title">2. Batiments (Buildings)</div>
            <button class="btn-global" onclick="dispatchGlobalScan()">SCAN MASTER (ALL)</button>
            <div style="border-top:1px solid #333; margin: 10px 0;"></div>
            <div class="box-title">3. Joueur (Target)</div>
            <input type="text" id="targetIn" value="u2d2k.c.wam">
            <button class="btn-target" onclick="startTarget()">SCAN DIVISIONS</button>
            <button class="btn-build" onclick="startBuildings()">SCAN B√ÇTIMENTS</button>
        </div>
    </aside>

    <main class="main-view">
        <div id="statusMsg" class="status-bar"></div>

        <div id="zoneView" class="view-section view-active">
            <div class="stats-row">
                <div class="stat"><span class="stat-val" id="dDivs">0</span><span class="stat-lbl">Divisions</span></div>
                <div class="stat"><span class="stat-val val-win" id="dGain">0</span><span class="stat-lbl">GAIN (DOVX)</span></div>
                <div class="stat" style="border-top-color: #444">
                    <div class="res-grid">
                        <div class="res-item"><span><span class="dot d-fuel"></span>DOVF</span> <span id="lFuel" style="color:var(--fuel)">0</span></div>
                        <div class="res-item"><span><span class="dot d-health"></span>DOVH</span> <span id="lHealth" style="color:var(--health)">0</span></div>
                        <div class="res-item"><span><span class="dot d-repair"></span>DOVR</span> <span id="lRepair" style="color:var(--repair)">0</span></div>
                        <div class="res-item"><span><span class="dot d-supply"></span>DOVS</span> <span id="lSupply" style="color:var(--supply)">0</span></div>
                    </div>
                    <span class="stat-lbl">CONSO ACTIVE / 24H</span>
                </div>
                <div class="stat"><span class="stat-val val-cost-x" id="dCostX">0</span><span class="stat-lbl">Conso. Villes</span></div>
            </div>
            <div class="zones-grid" id="zonesArea"></div>
        </div>

        <div id="ecoView" class="view-section">
            <div class="eco-grid">
                <div class="eco-card c-fighter"><div class="eco-head"><span>DEMANDE</span> <span>üî• BURN</span></div><div class="eco-val" id="valDemandTU">0 TU</div><div class="eco-usd" id="valDemandUSD">$0.00 / 24h</div></div>
                <div class="eco-card c-producer"><div class="eco-head"><span>OFFRE</span> <span>‚ö° MINT</span></div><div class="eco-val" id="valSupplyTU">0 TU</div><div class="eco-usd" id="valSupplyUSD">$0.00 / 24h</div></div>
                <div class="eco-card c-market"><div class="eco-head"><span>PRESSION DOVX</span> <span>üìâ INPUT</span></div><div class="eco-val" id="valDovxBurn">0 DOVX</div><div class="eco-usd" id="valDovxUSD">$0.00 / 24h</div></div>
            </div>
            <div class="balance-container">
                <div class="balance-header">
                    <div style="color:var(--alert); text-align:left;">DEMANDE</div>
                    <div style="text-align:center; color:#fff" id="ratioTxt">Calcul...</div>
                    <div style="color:var(--main); text-align:right;">OFFRE</div>
                </div>
                <div class="balance-bar"><div class="bal-demand" id="barDemand" style="width:50%"></div><div class="bal-supply" id="barSupply" style="width:50%"></div></div>
            </div>
            <div style="background:#111; padding:15px; border:1px solid var(--dovx); margin-top:20px;">
                <div style="font-weight:bold; color:var(--dovx); margin-bottom:10px; text-transform:uppercase;">BALANCE DOVX</div>
                <div class="dovx-breakdown">
                    <div class="db-card" style="border-color:var(--main)"><div class="db-head" style="color:var(--main)">GAINS (MINT)</div><div class="db-val" style="color:var(--main)" id="valDovxMint">0</div><div class="db-usd" id="usdDovxMint">$0.00</div></div>
                    <div class="db-card" style="border-color:var(--alert)"><div class="db-head" style="color:var(--alert)">CO√õTS (BURN)</div><div class="db-val" style="color:var(--alert)" id="valDovxBurnTotal">0</div><div class="db-usd" id="usdDovxBurnTotal">$0.00</div></div>
                    <div class="db-card" style="border-color:#fff"><div class="db-head" style="color:#fff">NET</div><div class="db-val" id="valDovxNet">0</div><div class="db-usd" id="usdDovxNet">$0.00</div></div>
                </div>
            </div>
        </div>

        <div id="targetView" class="view-section"></div>
        
        <div id="buildingView" class="view-section">
            <div id="buildDash"></div>
            <div id="globalStatsArea" style="display:none; margin-bottom:20px;">
                <div class="g-main-count">
                    <div class="g-mc-left">
                        <div class="g-title" id="scanModeTitle">SCAN GLOBAL (LIVE)</div>
                        <div class="scan-stats-row">
                            <div class="scan-stat-item"><span style="color:#555">Lignes scann√©es:</span> <b id="cntRows">0</b></div>
                            <div class="scan-stat-item"><span style="color:var(--main)">Total Cartes (NFTs):</span> <b id="cntAssets">0</b></div>
                        </div>
                    </div>
                    <div class="g-mc-right"><div class="g-cost-label">CO√õT TOTAL DOV-X</div><div class="g-cost-val" id="gTotalCost">0</div></div>
                </div>
                <div class="g-detail-grid" id="dynamicCardsArea"></div>
                <div class="model-list-container" id="dynamicListsArea"></div>

                <div class="debug-box">
                    <div class="debug-title">RAPPORT DE SCAN (TEMPLATES TROUV√âS)</div>
                    <div class="debug-grid" id="debugGrid"></div>
                </div>
            </div>
            <div id="buildList" class="build-grid"></div>
        </div>
    </main>
</div>

<div class="modal-overlay" id="zoneModal" onclick="if(event.target===this) closeModal('zoneModal')">
    <div class="modal-box">
        <div class="modal-head">
            <div class="modal-title" id="zmTitle">RADAR MULTI-COMPTES</div>
            <div class="modal-close" onclick="closeModal('zoneModal')">X</div>
        </div>
        <div class="modal-body" id="zmBody">
            <div style="text-align:center; padding:10px;">En attente de scan...</div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="settingsModal" onclick="if(event.target===this) closeModal('settingsModal')">
    <div class="modal-box" style="width:700px;">
        <div class="modal-head">
            <div class="modal-title">‚öôÔ∏è PARAM√àTRES AVANC√âS (DYNAMIC UI)</div>
            <div class="modal-close" onclick="closeModal('settingsModal')">X</div>
        </div>
        <div class="modal-body">
            <div class="set-group">
                <span class="set-title">INTERFACE & RESSOURCES (JSON)</span>
                <textarea id="cfgResources" style="height:100px; font-size:10px; font-family:monospace; color:#ccc; background:#1a1a1a; border:1px solid #333;"></textarea>
                <div style="font-size:9px; color:#888; margin-top:2px;">D√©finit les colonnes, couleurs et labels.</div>
            </div>
            
            <div class="set-group">
                <span class="set-title">R√àGLES DE JEU (GAME RULES)</span>
                <textarea id="cfgGameRules" style="height:80px; font-size:10px; font-family:monospace; color:#ccc; background:#1a1a1a; border:1px solid #333;"></textarea>
            </div>
            
            <div class="set-group">
                <span class="set-title">CONFIGURATION ZONES (JSON)</span>
                <textarea id="cfgZones" style="height:80px; font-size:10px; font-family:monospace; color:#ccc; background:#1a1a1a; border:1px solid #333;"></textarea>
            </div>
            <div class="set-group">
                <span class="set-title">DICTIONNAIRE TEMPLATES</span>
                <textarea id="cfgTemplates" style="height:100px; font-size:10px; font-family:monospace; color:#ccc; background:#1a1a1a; border:1px solid #333;"></textarea>
            </div>
            
            <div style="text-align:right;">
                <button class="btn-action" style="background:#444;" onclick="resetConfig()">R√âINITIALISER TOUT</button>
                <button class="btn-action" onclick="saveConfig()">SAUVEGARDER CONFIG</button>
            </div>
        </div>
    </div>
</div>

<div class="logs" id="console">> V172. UI FIXED.</div>

<script>
    // GLOBAL CLOSE MODAL FIX
    window.closeModal = function(id) { document.getElementById(id).style.display = 'none'; }

    // ==========================================
    // I. DONN√âES DE JEU (GAME DATA) - DEFAULT
    // ==========================================
    const DEFAULT_DATA = {
        // V171: RESOURCE DEFINITIONS (THE SOURCE OF TRUTH FOR UI)
        resourceDefs: {
            "F": { label: "FUEL",   color: "var(--fuel)",   css: "c-f" },
            "H": { label: "HEALTH", color: "var(--health)", css: "c-h" },
            "R": { label: "REPAIR", color: "var(--repair)", css: "c-r" },
            "S": { label: "SUPPLY", color: "var(--supply)", css: "c-s" }
        },
        gameConfig: {
            maintenanceCost: 0.085, // 8.5%
            cycleHours: 24,
            tokenMap: { "DOVF": "F", "DOVH": "H", "DOVR": "R", "DOVS": "S" }
        },
        zones: { 1:{name:"Beach 1",cost:1160,costX:0,reward:400},2:{name:"Beach 2",cost:6968,costX:0,reward:2405},3:{name:"Beach 3",cost:8800,costX:0,reward:3037},4:{name:"Bunker",cost:11120,costX:0,reward:3838},5:{name:"Forest 1",cost:14024,costX:0,reward:4839},6:{name:"Forest 2",cost:17704,costX:0,reward:6092},7:{name:"Forest 3",cost:22352,costX:0,reward:7659},8:{name:"Camp",cost:28220,costX:0,reward:9617},9:{name:"Hill 1",cost:37052,costX:0,reward:12557},10:{name:"Hill 2",cost:48652,costX:0,reward:16418},11:{name:"Hill 3",cost:64516,costX:0,reward:21703},12:{name:"Radar",cost:84712,costX:0,reward:28427},13:{name:"Plain 1",cost:99384,costX:0,reward:34300},14:{name:"Plain 2",cost:125708,costX:0,reward:42083},15:{name:"Plain 3",cost:151164,costX:0,reward:50570},16:{name:"HQ",cost:188000,costX:0,reward:64884},17:{name:"City 1",cost:0,costX:1664,reward:0},18:{name:"City 2",cost:0,costX:4448,reward:0},19:{name:"City 3",cost:0,costX:13440,reward:0},20:{name:"City 4",cost:0,costX:29120,reward:0}},
        templates: {
            "490122": { "name": "C_F1_PRODUCER_FUEL", "prod": 5.4 }, "492383": { "name": "C_F1_PRODUCER_FUEL", "prod": 5.4 },
            "492385": { "name": "C_F2_PRODUCER_FUEL", "prod": 12.15 }, "492389": { "name": "C_F3_PRODUCER_FUEL", "prod": 30.38 },
            "492397": { "name": "C_F4_PRODUCER_FUEL", "prod": 83.53 }, "492373": { "name": "R_F1_PRODUCER_FUEL", "prod": 16.20 },
            "492379": { "name": "R_F1_PRODUCER_FUEL", "prod": 16.20 }, "492376": { "name": "R_F2_PRODUCER_FUEL", "prod": 36.45 },
            "492386": { "name": "R_F3_PRODUCER_FUEL", "prod": 91.13 }, "492390": { "name": "R_F4_PRODUCER_FUEL", "prod": 250.59 },
            "492380": { "name": "E_F1_PRODUCER_FUEL", "prod": 48.60 }, "492381": { "name": "E_F2_PRODUCER_FUEL", "prod": 109.35 },
            "492387": { "name": "E_F3_PRODUCER_FUEL", "prod": 273.38 }, "492388": { "name": "E_F4_PRODUCER_FUEL", "prod": 751.78 },
            "492368": { "name": "L_F1_PRODUCER_FUEL", "prod": 145.80 }, "492370": { "name": "L_F2_PRODUCER_FUEL", "prod": 328.05 },
            "492372": { "name": "L_F3_PRODUCER_FUEL", "prod": 820.13 }, "544068": { "name": "S1_OWNER_FUEL", "prod": 2255.34 },
            "492377": { "name": "SC_F2_PRODUCER_FUEL", "prod": 54.00 }, "492391": { "name": "SC_F3_PRODUCER_FUEL", "prod": 121.50 },
            "492392": { "name": "S1_OWNER_FUEL (VAR)", "prod": 2255.34 }, "492366": { "name": "C_F3_PRODUCER_FUEL (VAR)", "prod": 30.38 }, "492363": { "name": "C_F2_PRODUCER_FUEL (VAR)", "prod": 12.15 },
            "492394": { "name": "C_F1_PRODUCER_HEALTH", "prod": 5.4 }, "492395": { "name": "C_F2_PRODUCER_HEALTH", "prod": 12.15 },
            "492396": { "name": "C_F3_PRODUCER_HEALTH", "prod": 30.38 }, "492399": { "name": "R_F1_PRODUCER_HEALTH", "prod": 16.20 },
            "492401": { "name": "R_F2_PRODUCER_HEALTH", "prod": 36.45 }, "492535": { "name": "R_F3_PRODUCER_HEALTH", "prod": 91.13 },
            "492537": { "name": "R_F4_PRODUCER_HEALTH", "prod": 250.59 }, "492539": { "name": "E_F1_PRODUCER_HEALTH", "prod": 48.60 },
            "492543": { "name": "E_F2_PRODUCER_HEALTH", "prod": 109.35 }, "492545": { "name": "E_F3_PRODUCER_HEALTH", "prod": 273.38 },
            "492546": { "name": "E_F4_PRODUCER_HEALTH", "prod": 751.78 }, "492550": { "name": "L_F1_PRODUCER_HEALTH", "prod": 145.80 },
            "492554": { "name": "L_F2_PRODUCER_HEALTH", "prod": 328.05 }, "492555": { "name": "L_F3_PRODUCER_HEALTH", "prod": 820.13 },
            "544070": { "name": "S1_OWNER_HEALTH", "prod": 2255.34 },
            "492460": { "name": "C_F1_PRODUCER_REPAIR", "prod": 5.4 }, "492461": { "name": "C_F2_PRODUCER_REPAIR", "prod": 12.15 },
            "492462": { "name": "C_F3_PRODUCER_REPAIR", "prod": 30.38 }, "492463": { "name": "C_F4_PRODUCER_REPAIR", "prod": 83.53 },
            "492464": { "name": "R_F1_PRODUCER_REPAIR", "prod": 16.20 }, "492465": { "name": "R_F2_PRODUCER_REPAIR", "prod": 36.45 },
            "492466": { "name": "R_F3_PRODUCER_REPAIR", "prod": 91.13 }, "492467": { "name": "R_F4_PRODUCER_REPAIR", "prod": 250.59 },
            "492469": { "name": "E_F1_PRODUCER_REPAIR", "prod": 48.60 }, "492471": { "name": "E_F2_PRODUCER_REPAIR", "prod": 109.35 },
            "492472": { "name": "E_F3_PRODUCER_REPAIR", "prod": 273.38 }, "492473": { "name": "E_F4_PRODUCER_REPAIR", "prod": 751.78 },
            "492474": { "name": "L_F1_PRODUCER_REPAIR", "prod": 145.80 }, "492475": { "name": "L_F2_PRODUCER_REPAIR", "prod": 328.05 },
            "492476": { "name": "L_F3_PRODUCER_REPAIR", "prod": 820.13 }, "544071": { "name": "S1_OWNER_REPAIR", "prod": 2255.34 },
            "492507": { "name": "C_F1_PRODUCER_SUPPLY", "prod": 5.4 }, "492509": { "name": "C_F2_PRODUCER_SUPPLY", "prod": 12.15 },
            "492511": { "name": "C_F3_PRODUCER_SUPPLY", "prod": 30.38 }, "492513": { "name": "C_F4_PRODUCER_SUPPLY", "prod": 83.53 },
            "492515": { "name": "R_F1_PRODUCER_SUPPLY", "prod": 16.20 }, "492518": { "name": "R_F2_PRODUCER_SUPPLY", "prod": 36.45 },
            "492521": { "name": "R_F3_PRODUCER_SUPPLY", "prod": 91.13 }, "492523": { "name": "R_F4_PRODUCER_SUPPLY", "prod": 250.59 },
            "492526": { "name": "E_F1_PRODUCER_SUPPLY", "prod": 48.60 }, "492528": { "name": "E_F2_PRODUCER_SUPPLY", "prod": 109.35 },
            "492529": { "name": "E_F3_PRODUCER_SUPPLY", "prod": 273.38 }, "492530": { "name": "E_F4_PRODUCER_SUPPLY", "prod": 751.78 },
            "492532": { "name": "L_F1_PRODUCER_SUPPLY", "prod": 145.80 }, "492533": { "name": "L_F2_PRODUCER_SUPPLY", "prod": 328.05 },
            "492534": { "name": "L_F3_PRODUCER_SUPPLY", "prod": 820.13 }, "544069": { "name": "S1_OWNER_SUPPLY", "prod": 2255.34 }
        },
        rates: { WAX_USD: 0.00786, DOVX_WAX: 0.00528553, TU_WAX: 0.00045262 }
    };
    
    // --- II. CONFIG SYSTEME ---
    let SYSTEM_CONFIG = {
        strategy: 'B', batchSize: 1000, delay: 200, startKey: '',
        sortOrder: ["C_F1","C_F2","C_F3","C_F4","R_F1","R_F2","R_F3","R_F4","E_F1","E_F2","E_F3","E_F4","L_F1","L_F2","L_F3","S1","SC_F2","SC_F3"],
        atomicApi: "https://wax.api.atomicassets.io/atomicassets/v1/templates?collection_name=dovdivisions&schema_name=warbuildings&limit=500",
        rpcs: ["https://wax.greymass.com", "https://api.waxsweden.org", "https://wax.eosn.io", "https://api.wax.alohaeos.com"],
        proxies: ["", "https://corsproxy.io/?", "https://api.allorigins.win/raw?url=", "https://thingproxy.freeboard.io/fetch/"]
    };

    // --- III. VARIABLES D'√âTAT ---
    let CORE_DATA = JSON.parse(JSON.stringify(DEFAULT_DATA));
    let SYS_CONFIG = JSON.parse(JSON.stringify(SYSTEM_CONFIG));
    let ZONE_DETAILS = {}; let stopSignal = false; let rpcIndex = 0; let proxyIndex = 0;
    let ECO_DATA = { demand: { fuel:0, health:0, repair:0, supply:0 }, supply: { fuel:0, health:0, repair:0, supply:0 }, dovx: { cities:0, buildings:0, rewards:0 }, scanned: 0 };
    let USE_HOURLY = true; 

    // --- UTILS ---
    function log(msg, color="#aaa") { const c = document.getElementById('console'); if(c) c.innerHTML = `<div style="color:${color}">[${new Date().toLocaleTimeString()}] ${msg}</div>` + c.innerHTML; }
    function switchView(id) { document.querySelectorAll('.view-section').forEach(el => el.classList.remove('view-active')); document.getElementById(id).classList.add('view-active'); }
    function setTextSafe(id, txt) { let el = document.getElementById(id); if(el) el.innerText = txt; }
    function getProp(obj, keys) { for(let k of keys) if(obj[k] !== undefined) return obj[k]; return 0; }
    function isBusy(row) { return (getProp(row, ['end_time', 'end']) > (Date.now()/1000)); }
    function getId(row) { return row.asset_id || row.id || row.division_id || 0; }
    function extractPower(row) { let val = Array.isArray(row.power) ? row.power[0] : (row.power || row.pwr); if (typeof val === 'string') val = val.replace(/[^0-9.]/g, ''); return parseFloat(val) || 0; }
    function computeDovxReward(baseReward, divisionPower) { if(!CORE_DATA.claimLevels) return 0; for (let lvl of CORE_DATA.claimLevels) { if (divisionPower >= lvl.minPower) return baseReward * lvl.coeff; } return 0; }
    function updateRates() { CORE_DATA.rates.WAX_USD = parseFloat(document.getElementById('inpWax').value) || 0; CORE_DATA.rates.DOVX_WAX = parseFloat(document.getElementById('inpDovx').value) || 0; CORE_DATA.rates.TU_WAX = parseFloat(document.getElementById('inpTu').value) || 0; if(document.getElementById('ecoView').classList.contains('view-active')) updateEcoDisplay(); }

    // --- V171: DYNAMIC UI INJECTION ---
    function initUI() {
        const cardContainer = document.getElementById('dynamicCardsArea');
        const listContainer = document.getElementById('dynamicListsArea');
        
        // Clean existing
        cardContainer.innerHTML = '';
        listContainer.innerHTML = '';
        
        // Iterate over Configured Resources
        for(let key in CORE_DATA.resourceDefs) {
            let res = CORE_DATA.resourceDefs[key];
            
            // 1. Create Top Card
            let card = document.createElement('div');
            card.className = "g-card";
            card.style.borderTop = `3px solid ${res.color}`;
            card.innerHTML = `
                <div class="g-card-head">${res.label}</div>
                <div class="g-prod-val" style="color:${res.color}" id="pwr-${key}">0</div>
                <div class="g-prod-lbl" id="lbl-${key}">PROD / H</div>
            `;
            cardContainer.appendChild(card);
            
            // 2. Create List Column
            let col = document.createElement('div');
            col.className = `ml-col ${res.css || ''}`;
            if(res.color) col.style.borderLeft = `4px solid ${res.color}`;
            col.id = `list-${key}`;
            // HEADER INJECTED BY RENDERLISTS
            listContainer.appendChild(col);
        }
    }

    function initApp() {
        const storedSys = localStorage.getItem('DOV_SYS');
        if(storedSys) try { SYS_CONFIG = { ...SYSTEM_CONFIG, ...JSON.parse(storedSys) }; } catch(e) {}
        const storedData = localStorage.getItem('DOV_DATA');
        if(storedData) {
            try { 
                let loaded = JSON.parse(storedData);
                CORE_DATA.zones = loaded.zones || DEFAULT_DATA.zones;
                CORE_DATA.templates = { ...DEFAULT_DATA.templates, ...(loaded.templates || {}) };
                CORE_DATA.rates = loaded.rates || DEFAULT_DATA.rates;
                CORE_DATA.claimLevels = loaded.claimLevels || DEFAULT_DATA.claimLevels; 
                CORE_DATA.gameConfig = { ...DEFAULT_DATA.gameConfig, ...(loaded.gameConfig || {}) };
                CORE_DATA.resourceDefs = { ...DEFAULT_DATA.resourceDefs, ...(loaded.resourceDefs || {}) };
            } catch(e) { CORE_DATA = JSON.parse(JSON.stringify(DEFAULT_DATA)); }
        }
        document.getElementById('inpWax').value = CORE_DATA.rates.WAX_USD;
        document.getElementById('inpDovx').value = CORE_DATA.rates.DOVX_WAX;
        document.getElementById('inpTu').value = CORE_DATA.rates.TU_WAX;
        document.getElementById('dictSize').innerText = Object.keys(CORE_DATA.templates).length;
        
        initUI(); // Generate UI
        initGrid();
        log("‚úÖ Syst√®me initialis√©.", "#00e676");
    }

    function hardReset() {
        if(confirm("‚ö†Ô∏è RESET TOTAL ?")) {
            localStorage.removeItem('DOV_SYS'); localStorage.removeItem('DOV_DATA'); location.reload();
        }
    }

    // --- V168: TIME TOGGLE ---
    function toggleTimeMode() {
        USE_HOURLY = !USE_HOURLY;
        let btn = document.getElementById('btnTimeMode');
        btn.innerText = USE_HOURLY ? "‚è±Ô∏è MODE: 1H (LIVE)" : "üìÖ MODE: 24H (DAILY)";
        btn.style.background = USE_HOURLY ? "#333" : "#004d40"; 
        let suffix = USE_HOURLY ? "/ H" : "/ 24H";
        
        // V171 Update Labels dynamically
        for(let key in CORE_DATA.resourceDefs) {
            let el = document.getElementById('lbl-'+key); 
            if(el) el.innerText = "PROD " + suffix;
        }
        if(document.getElementById('globalStatsArea').style.display === 'block') {
            log("Mode chang√©. Relancez le scan pour mise √† jour.", "#ffd700");
        }
    }

    // --- FETCH ---
    async function robustFetch(code, table, lowerBound, limit=1000, customScope=null, indexPos=1, keyType="") {
        let attempts = 0;
        const effectiveLimit = limit || SYS_CONFIG.batchSize;
        const effectiveDelay = SYS_CONFIG.delay;
        const effectiveScope = customScope ? customScope : code;
        while(attempts < 20 && !stopSignal) {
            const server = SYS_CONFIG.rpcs[rpcIndex % SYS_CONFIG.rpcs.length];
            const proxy = SYS_CONFIG.proxies[proxyIndex % SYS_CONFIG.proxies.length];
            rpcIndex++; 
            const url = server + "/v1/chain/get_table_rows";
            let finalUrl = url;
            if(proxy && proxy.length > 5) finalUrl = proxy + encodeURIComponent(url);
            try {
                let statusText = `[RPC: ${new URL(server).hostname}]`;
                if(proxy && proxy.length > 5) statusText += ` + [PXY: ${new URL(proxy).hostname}]`; else statusText += ` + [DIRECT]`;
                if(document.getElementById('rpcStatus')) document.getElementById('rpcStatus').innerText = statusText;
                const controller = new AbortController(); setTimeout(() => controller.abort(), 15000); 
                const payload = { json: true, code: code, scope: effectiveScope, table: table, limit: effectiveLimit, lower_bound: lowerBound };
                if(indexPos > 1) { payload.index_position = indexPos; payload.key_type = keyType; payload.upper_bound = lowerBound; }
                const res = await fetch(finalUrl, { method: 'POST', body: JSON.stringify(payload), signal: controller.signal });
                if(!res.ok) throw new Error("HTTP " + res.status);
                const contentType = res.headers.get("content-type");
                if (contentType && !contentType.includes("application/json")) throw new Error("Not JSON");
                if(effectiveDelay > 0) await new Promise(r => setTimeout(r, effectiveDelay));
                return await res.json();
            } catch(e) { 
                attempts++;
                if(SYS_CONFIG.proxies.length > 1) proxyIndex++; 
                await new Promise(r => setTimeout(r, 200));
            }
        }
        throw new Error("Arr√™t (Trop d'erreurs).");
    }

    // --- LOGIC ---
    function getSortScore(name) {
        if(!name) return 999;
        for(let i=0; i<SYS_CONFIG.sortOrder.length; i++) { if(name.startsWith(SYS_CONFIG.sortOrder[i])) return i; }
        return 999;
    }
    
    function conformBuilding(b) {
        let tid = b.template_id.toString(); 
        let stack = (b.asset_ids && Array.isArray(b.asset_ids)) ? b.asset_ids.length : 1;
        let rawStr = (Array.isArray(b.power)?b.power[0]:b.power) || "";
        let hourlyProd = parseFloat(rawStr.replace(/[^0-9.]/g,'')) || 0;
        let dailyProd = hourlyProd * CORE_DATA.gameConfig.cycleHours;
        
        let pType = null;
        for(let token in CORE_DATA.gameConfig.tokenMap) {
            if(rawStr.includes(token)) {
                pType = CORE_DATA.gameConfig.tokenMap[token];
                break;
            }
        }
        if(!pType) pType = "F"; 

        let tpl = CORE_DATA.templates[tid];
        let name = tpl ? tpl.name : `INCONNU [${tid}]`;
        let base = tpl ? tpl.prod : 0;
        
        if(base > 0 && hourlyProd > 0) stack = Math.round(hourlyProd / base);
        
        let dispUnit = 0; let dispTotal = 0;
        if(USE_HOURLY) {
            dispUnit = base > 0 ? base : (stack > 0 ? hourlyProd/stack : hourlyProd);
            dispTotal = hourlyProd;
        } else {
            dispUnit = base > 0 ? (base * CORE_DATA.gameConfig.cycleHours) : (stack > 0 ? dailyProd/stack : dailyProd);
            dispTotal = dailyProd;
        }
        
        // V172: COST IS ALWAYS BASED ON DISPLAYED TOTAL PROD (Consistency)
        let dispCost = dispTotal * CORE_DATA.gameConfig.maintenanceCost; 
        let sortScore = getSortScore(name);
        return { name, type:pType, stack, tid, unitProd: dispUnit, tp: dispTotal, cost: dispCost, sortScore: sortScore };
    }

    async function dispatchGlobalScan() {
        stopSignal = false; switchView('buildingView'); document.getElementById('globalStatsArea').style.display = 'block'; document.getElementById('buildList').style.display = 'none'; document.getElementById('btnStop').style.display = 'inline-block';
        let start = SYS_CONFIG.startKey || "0";
        await runGlobalScan(start);   
    }

    async function runGlobalScan(next) {
        log(`üåç START GLOBAL SCAN...`, "#fff");
        let more = true; 
        let groups = {}; 
        let stats = { total: 0, cost: 0, p: {}, c: {} };
        for(let key in CORE_DATA.resourceDefs) {
            groups[key] = {};
            stats.p[key] = 0;
            stats.c[key] = 0;
        }

        const now = Date.now()/1000;
        let scanRows = 0; let scanAssets = 0; let templateAudit = {}; 
        try { while (more && !stopSignal) {
            const data = await robustFetch("dovutilstake", "buildings", next); 
            if (!data.rows) break;
            scanRows += data.rows.length;
            for(let b of data.rows) {
                stats.total++;
                let info = conformBuilding(b); 
                scanAssets += info.stack; 
                if(!templateAudit[info.tid]) templateAudit[info.tid] = { name: info.name, count: 0 };
                templateAudit[info.tid].count += info.stack;
                
                if(!groups[info.type]) groups[info.type] = {};

                let k = info.stack > 1 ? `${info.name} (x${info.stack})` : info.name;
                if (!groups[info.type][k]) groups[info.type][k] = { name: info.name, stack: info.stack, tid: info.tid, cp: 0, cr: 0, tp: 0, unitProd: info.unitProd, sortScore: info.sortScore };
                let active = now < (parseFloat(b.last_claim) + parseFloat(b.delay));
                if (active) { 
                    groups[info.type][k].cp++; 
                    groups[info.type][k].tp += info.tp; 
                    stats.p[info.type] += info.tp; 
                    stats.c[info.type] += info.cost; 
                    stats.cost += info.cost; 
                } else { groups[info.type][k].cr++; }
            }
            if(document.getElementById('cntRows')) {
                document.getElementById('cntRows').innerText = scanRows.toLocaleString(); document.getElementById('cntAssets').innerText = scanAssets.toLocaleString();
                document.getElementById('gTotalCost').innerText = Math.round(stats.cost).toLocaleString() + " DOVX";
                
                for(let key in CORE_DATA.resourceDefs) {
                     let pwrEl = document.getElementById('pwr-'+key);
                     if(pwrEl) pwrEl.innerText = Math.round(stats.p[key] || 0).toLocaleString();
                }

                let dbgHTML = "";
                let auditKeys = Object.keys(templateAudit);
                auditKeys.sort((a,b) => getSortScore(templateAudit[a].name) - getSortScore(templateAudit[b].name));
                for(let tid of auditKeys) {
                    let n = templateAudit[tid].name;
                    let color = n.includes("INCONNU") ? "var(--warn)" : "#aaa";
                    dbgHTML += `<div class="d-row"><a href="#" class="d-id">[${tid}]</a> <span style="font-size:9px; color:${color}; overflow:hidden; white-space:nowrap; width:80px;">${n}</span> <span class="d-cnt">x${templateAudit[tid].count}</span></div>`;
                }
                document.getElementById('debugGrid').innerHTML = dbgHTML;
                renderLists(groups, stats.p, stats.c);
            }
            if (data.more && data.next_key) next = data.next_key; else more = false;
        } log("‚úÖ SCAN TERMIN√â.", "#00e676"); document.getElementById('btnStop').style.display='none'; } catch(e) { log("Erreur: " + e.message, "red"); }
    }

    function renderLists(groups, typeTotals, costTotals){
        for(let t in groups){
            let container = document.getElementById('list-'+t);
            if(!container) continue;

            let keys=Object.keys(groups[t]);
            keys.sort((a,b) => {
                let scoreA = groups[t][a].sortScore; let scoreB = groups[t][b].sortScore;
                if(scoreA === scoreB) return groups[t][b].unitProd - groups[t][a].unitProd;
                return scoreA - scoreB; 
            });
            
            let totalForType = typeTotals && typeTotals[t] ? Math.round(typeTotals[t]).toLocaleString() : "0";
            let costForType = costTotals && costTotals[t] ? Math.round(costTotals[t]).toLocaleString() : "0";
            
            let resDef = CORE_DATA.resourceDefs[t] || { label: "UNKNOWN" };

            // V172: GRID HEADER
            let h = `<div class="ml-header">
                        <div>${resDef.label}</div>
                        <div style="text-align:right;"></div>
                        <div style="text-align:right;">
                             <span class="header-cost-badge">TOT: ${totalForType}</span><br>
                             <span class="c-cost-mini">CO√õT: ${costForType}</span>
                        </div>
                     </div>`;
                     
            let unitLabel = USE_HOURLY ? "/h" : "/24h";
            keys.forEach(k=>{
                let i=groups[t][k]; if(i.cp===0 && i.cr===0) return;
                let stackLabel = i.stack > 1 ? `<span class="ml-mult">x${i.stack}</span>` : '';
                h+=`<div class="ml-row"><div class="ml-name row-left">${i.name} ${stackLabel}<span class="c-active">${i.cp} ACTIF</span></div><div class="row-mid">${Math.round(i.unitProd).toLocaleString()}${unitLabel}</div><div class="row-right"><span>${Math.round(i.tp).toLocaleString()}</span></div></div>`;
            });
            container.innerHTML=h;
        }
    }

    // --- OTHER SCANS & UI ---
    async function startBuildings() { 
        const user = document.getElementById('targetIn').value.trim().toLowerCase(); 
        switchView('buildingView'); document.getElementById('globalStatsArea').style.display = 'none'; document.getElementById('buildList').style.display = 'grid'; document.getElementById('buildDash').innerHTML = ""; document.getElementById('buildList').innerHTML = ""; 
        log(`üîç Scan Joueur ${user}...`, "#fff"); 
        let nextKey = ""; let hasMore = true; 
        try { while(hasMore && !stopSignal) { 
            const data = await robustFetch("dovutilstake", "buildings", nextKey, 1000, user); 
            if(!data.rows || data.rows.length === 0) break; 
            const now = Date.now()/1000; 
            data.rows.forEach(b => { 
                let info = conformBuilding(b); let isReady = now > (parseFloat(b.last_claim) + parseFloat(b.delay)); 
                let typeColor = CORE_DATA.resourceDefs[info.type] ? CORE_DATA.resourceDefs[info.type].color : "#fff";
                let card = `<div class="b-card"><div><div class="b-title" style="color:${typeColor}">${info.name} ${info.stack>1?'x'+info.stack:''}</div><div class="b-sub">#${b.asset_id}</div></div><div>${isReady?'<span class="b-badge-claim">PR√äT</span>':'<span class="b-badge-ok">ACTIF</span>'}</div><div class="b-stats"><div style="font-weight:bold">${Math.round(info.prod24).toLocaleString()} /24h</div></div></div>`; 
                document.getElementById('buildList').insertAdjacentHTML('beforeend', card); 
            }); 
            if(data.more && data.next_key) nextKey = data.next_key; else hasMore = false; 
        } log(`‚úÖ Scan Joueur termin√©.`, "#00e676"); } catch(e){ log("Err: "+e.message, "red"); } 
    }
    
    async function startTarget() { 
        const user = document.getElementById('targetIn').value.trim().toLowerCase(); switchView('targetView'); const view = document.getElementById('targetView'); view.innerHTML="Recherche divisions..."; 
        try { 
            const data = await robustFetch("dovpvecontrl", "sdivisions", user, 500, null, 2, "i64"); 
            const rows = data.rows ? data.rows : []; 
            let htmlBuffer = `<div style="background:#111; padding:10px; color:var(--sec)">JOUEUR : ${user.toUpperCase()} (${rows.length} Divs)</div>`; 
            rows.forEach(r => { 
                const zID = getProp(r, ['zoneID', 'zone_id']); 
                const zName = CORE_DATA.zones[zID] ? CORE_DATA.zones[zID].name : 'Zone '+zID;
                htmlBuffer += `<div class="t-row"><div style="color:var(--main)">#${getId(r)}</div><div style="color:var(--sec)">${zName}</div><div>${isBusy(r)?'<span class="st-mission">MISSION</span>':'<span class="st-ready">PR√äT</span>'}</div></div>`; 
            }); 
            view.innerHTML = htmlBuffer; 
        } catch(e){ log("Erreur Target: "+e.message, "red"); } 
    }

    async function startZoneScan() { 
        stopSignal = false; switchView('zoneView'); initGrid(); document.getElementById('btnStop').style.display = 'inline-block'; 
        ZONE_DETAILS = {}; let stats = { divs: 0, burn: { fuel: 0, health: 0, repair: 0, supply: 0 }, totalCostX: 0, totalGain: 0, zones: {} }; 
        Object.keys(CORE_DATA.zones).forEach(id => { stats.zones[id] = { count: 0, active: 0, idle: 0 }; });
        let nextKey = ""; let hasMore = true; log("Mapping Zones...", "#fff"); 
        try { while(hasMore && !stopSignal) { 
            const data = await robustFetch("dovpvecontrl", "sdivisions", nextKey); if(!data.rows) break; 
            for(let row of data.rows) { 
                stats.divs++; const zID = getProp(row, ['zoneID', 'zone_id']); const busy = isBusy(row); 
                if(busy) {
                    if(!ZONE_DETAILS[zID]) ZONE_DETAILS[zID] = [];
                    const ownerName = row.owner || row.user || row.account || row.player;
                    if(ownerName) ZONE_DETAILS[zID].push({ name: ownerName, time: row.end_time || 0 });
                }
                if(stats.zones[zID]) { 
                    stats.zones[zID].count++; const zInfo = CORE_DATA.zones[zID]; 
                    if(busy) { 
                        stats.zones[zID].active++; 
                        if(zInfo) {
                            if(zInfo.cost > 0) { stats.burn.fuel+=zInfo.cost; stats.burn.health+=zInfo.cost; stats.burn.repair+=zInfo.cost; stats.burn.supply+=zInfo.cost; } 
                            stats.totalCostX += zInfo.costX; 
                            const power = extractPower(row); if(zInfo.reward > 0) stats.totalGain += computeDovxReward(zInfo.reward, power); 
                        }
                    } else stats.zones[zID].idle++; 
                } 
            } if (stats.divs % 1000 === 0) updateZoneDash(stats); 
            if(data.more && data.next_key) nextKey = data.next_key; else hasMore = false; 
        } updateZoneDash(stats); log("Mapping OK.", "#00e676"); document.getElementById('btnStop').style.display='none'; } catch(e) { log("Err: "+e.message, "red"); } 
    }
    
    function updateZoneDash(stats) { const fmt = (n) => n.toLocaleString(undefined, {maximumFractionDigits:0}); setTextSafe('dDivs', fmt(stats.divs)); setTextSafe('dGain', "+ " + fmt(stats.totalGain) + " DOVX"); setTextSafe('dCostX', "- " + fmt(stats.totalCostX) + " DOVX"); setTextSafe('lFuel', "-" + fmt(stats.burn.fuel)); setTextSafe('lHealth', "-" + fmt(stats.burn.health)); setTextSafe('lRepair', "-" + fmt(stats.burn.repair)); setTextSafe('lSupply', "-" + fmt(stats.burn.supply)); Object.keys(stats.zones).forEach(id => { const data = stats.zones[id]; const card = document.getElementById(`z-card-${id}`); if(card && data) { if(data.count > 0) card.classList.add('active'); document.getElementById(`z-count-${id}`).innerText = data.count; document.getElementById(`z-miss-${id}`).innerText = data.active + " Act."; document.getElementById(`z-rdy-${id}`).innerText = data.idle + " Rdy"; } }); }
    function openZoneDetail(id) {
        const zInfo = CORE_DATA.zones[id]; const title = zInfo ? zInfo.name : "ZONE " + id;
        document.getElementById('zmTitle').innerText = title + " (RADAR)";
        const rawList = ZONE_DETAILS[id] || [];
        if(rawList.length === 0) { document.getElementById('zmBody').innerHTML = "<div style='text-align:center; padding:20px; color:#666'>Aucun joueur. Lancez le scan.</div>"; document.getElementById('zoneModal').style.display = 'flex'; return; }
        let clusters = {}; let singles = []; rawList.sort((a,b) => a.time - b.time); let processed = new Set();
        for(let i=0; i<rawList.length; i++) {
            if(processed.has(i)) continue;
            let group = [rawList[i]]; processed.add(i);
            if(rawList[i].time > 0) {
                for(let j=i+1; j<rawList.length; j++) {
                    if(processed.has(j)) continue;
                    if(rawList[j].time > 0 && Math.abs(rawList[i].time - rawList[j].time) <= 2) { group.push(rawList[j]); processed.add(j); }
                }
            }
            if(group.length >= 3) clusters["TIME_"+rawList[i].time] = group; else singles.push(...group);
        }
        let h = "";
        for(let k in clusters) {
            let grp = clusters[k]; let uniqueNames = [...new Set(grp.map(x=>x.name))]; if(uniqueNames.length < 2) continue;
            h += `<div class="sybil-cluster"><div class="cluster-head"><span>‚ö†Ô∏è SUSPICION (${uniqueNames.length} comptes)</span></div>`;
            uniqueNames.forEach(n => { h += `<div class="player-row"><span class="p-name" onclick="setTarget('${n}')">${n}</span><button class="btn-audit" onclick="checkFunding('${n}')">üîç AUDIT</button></div>`; }); h += `</div>`;
        }
        let uniqueSingles = [...new Set(singles.map(x=>x.name))];
        uniqueSingles.forEach(n => { h += `<div class="player-row"><span class="p-name" onclick="setTarget('${n}')">${n}</span><button class="btn-audit" onclick="checkFunding('${n}')">üîç</button></div>`; });
        document.getElementById('zmBody').innerHTML = h; document.getElementById('zoneModal').style.display = 'flex';
    }

    async function startEconomyScan() { stopSignal = false; switchView('ecoView'); document.getElementById('btnStop').style.display='inline-block'; ECO_DATA = { demand: { fuel:0, health:0, repair:0, supply:0 }, supply: { fuel:0, health:0, repair:0, supply:0 }, dovx: { cities:0, buildings:0, rewards:0 }, scanned: 0 }; log("Audit Eco...", "#fff"); try { let nextKey = ""; let hasMore = true; while(hasMore && !stopSignal) { const data = await robustFetch("dovpvecontrl", "sdivisions", nextKey); if(!data.rows) break; for(let row of data.rows) { ECO_DATA.scanned++; const zID = getProp(row, ['zoneID', 'zone_id']); const zInfo = CORE_DATA.zones[zID]; const busy = isBusy(row); if(zInfo && busy) { if(zInfo.cost > 0) { ECO_DATA.demand.fuel += zInfo.cost; ECO_DATA.demand.health += zInfo.cost; ECO_DATA.demand.repair += zInfo.cost; ECO_DATA.demand.supply += zInfo.cost; } if(zInfo.costX > 0) ECO_DATA.dovx.cities += zInfo.costX; const power = extractPower(row); if(zInfo.reward > 0) ECO_DATA.dovx.rewards += computeDovxReward(zInfo.reward, power); } } if (ECO_DATA.scanned % 1000 === 0) updateEcoDisplay(); if(data.more && data.next_key) nextKey = data.next_key; else hasMore = false; } updateEcoDisplay(); log("Audit OK.", "#00e676"); document.getElementById('btnStop').style.display='none'; } catch(e) { log(e.message, "red"); } }
    function updateEcoDisplay() { const fmt = (n) => n.toLocaleString(undefined, {maximumFractionDigits:0}); const fmtUSD = (n) => "$" + n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); let totalD = ECO_DATA.demand.fuel + ECO_DATA.demand.health + ECO_DATA.demand.repair + ECO_DATA.demand.supply; let totalS = ECO_DATA.supply.fuel + ECO_DATA.supply.health + ECO_DATA.supply.repair + ECO_DATA.supply.supply; let totalDovxIn = ECO_DATA.dovx.cities + ECO_DATA.dovx.buildings; setTextSafe('valDemandTU', fmt(totalD) + " TU"); setTextSafe('valDemandUSD', fmtUSD(totalD * CORE_DATA.rates.TU_WAX * CORE_DATA.rates.WAX_USD) + " / 24h"); setTextSafe('valSupplyTU', fmt(totalS) + " TU"); setTextSafe('valSupplyUSD', fmtUSD(totalS * CORE_DATA.rates.TU_WAX * CORE_DATA.rates.WAX_USD) + " / 24h"); setTextSafe('valDovxBurn', fmt(totalDovxIn) + " DOVX"); setTextSafe('valDovxUSD', fmtUSD(totalDovxIn * CORE_DATA.rates.DOVX_WAX * CORE_DATA.rates.WAX_USD) + " / 24h"); let mint = ECO_DATA.dovx.rewards; let burn = ECO_DATA.dovx.cities + ECO_DATA.dovx.buildings; let net = mint - burn; setTextSafe('valDovxMint', "+ " + fmt(mint)); setTextSafe('usdDovxMint', fmtUSD(mint * CORE_DATA.rates.DOVX_WAX * CORE_DATA.rates.WAX_USD)); setTextSafe('valDovxBurnTotal', "- " + fmt(burn)); setTextSafe('usdDovxBurnTotal', fmtUSD(burn * CORE_DATA.rates.DOVX_WAX * CORE_DATA.rates.WAX_USD)); setTextSafe('valDovxNet', fmt(net)); setTextSafe('usdDovxNet', fmtUSD(net * CORE_DATA.rates.DOVX_WAX * CORE_DATA.rates.WAX_USD)); }

    function initGrid() { const grid = document.getElementById('zonesArea'); let htmlBuffer = ""; Object.keys(CORE_DATA.zones).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(id => { const z = CORE_DATA.zones[id]; let costDisplay = z.cost > 0 ? `<span class="z-burn">-${z.cost.toLocaleString()}/TU</span>` : `<span class="z-burn-x">-${z.costX.toLocaleString()} DOVX</span>`; htmlBuffer += `<div class="zone" id="z-card-${id}" onclick="openZoneDetail(${id})"><div class="z-head"><span>${z.name}</span><span id="z-count-${id}">0</span></div><div class="z-metrics"><div class="z-row"><span>Co√ªt:</span> ${costDisplay}</div><div class="z-row"><span>Gain Win:</span> <span class="z-earn">+${z.reward}</span></div></div><div class="z-act-text"><span style="color:var(--warn)" id="z-miss-${id}">0 act.</span><span style="color:var(--main)" id="z-rdy-${id}">0 rdy</span></div></div>`; }); if(grid) grid.innerHTML = htmlBuffer; }
    
    function openSettings() { 
        try {
            document.getElementById('cfgStrategy').value = SYS_CONFIG.strategy; document.getElementById('cfgBatch').value = SYS_CONFIG.batchSize; document.getElementById('cfgDelay').value = SYS_CONFIG.delay; document.getElementById('cfgStart').value = SYS_CONFIG.startKey; 
            document.getElementById('cfgSort').value = SYS_CONFIG.sortOrder.join(', '); document.getElementById('cfgRpc').value = SYS_CONFIG.rpcs.join('\n'); document.getElementById('cfgProxy').value = SYS_CONFIG.proxies.join('\n');
            document.getElementById('cfgZones').value = JSON.stringify(CORE_DATA.zones, null, 4); document.getElementById('cfgTemplates').value = JSON.stringify(CORE_DATA.templates, null, 4); 
            if(CORE_DATA.claimLevels) document.getElementById('cfgLevels').value = JSON.stringify(CORE_DATA.claimLevels, null, 4);
            document.getElementById('cfgGameRules').value = JSON.stringify(CORE_DATA.gameConfig, null, 4);
            document.getElementById('cfgResources').value = JSON.stringify(CORE_DATA.resourceDefs, null, 4);
            document.getElementById('settingsModal').style.display = 'flex'; 
        } catch(e) { alert("Erreur ouverture settings (Donn√©es corrompues ? Essayez RESET USINE). " + e.message); }
    }
    function saveConfig() {
        SYS_CONFIG.strategy = document.getElementById('cfgStrategy').value; SYS_CONFIG.batchSize = parseInt(document.getElementById('cfgBatch').value)||1000; SYS_CONFIG.delay = parseInt(document.getElementById('cfgDelay').value)||200; SYS_CONFIG.startKey = document.getElementById('cfgStart').value.trim();
        let rawSort = document.getElementById('cfgSort').value.trim().split(','); let cleanSort = rawSort.map(s => s.trim()).filter(s => s.length > 0); if(cleanSort.length > 0) SYS_CONFIG.sortOrder = cleanSort;
        let rawRpc = document.getElementById('cfgRpc').value.trim().split('\n'); let cleanRpc = rawRpc.map(r => r.trim()).filter(r => r.startsWith('http')); if(cleanRpc.length > 0) SYS_CONFIG.rpcs = cleanRpc;
        let rawProxy = document.getElementById('cfgProxy').value.trim().split('\n'); let cleanProxy = rawProxy.map(r => r.trim()).filter(r => r.startsWith('http') || r === ""); if(cleanProxy.length > 0) SYS_CONFIG.proxies = cleanProxy;
        try { 
            CORE_DATA.zones = JSON.parse(document.getElementById('cfgZones').value); 
            CORE_DATA.templates = JSON.parse(document.getElementById('cfgTemplates').value); 
            CORE_DATA.claimLevels = JSON.parse(document.getElementById('cfgLevels').value);
            CORE_DATA.gameConfig = JSON.parse(document.getElementById('cfgGameRules').value);
            CORE_DATA.resourceDefs = JSON.parse(document.getElementById('cfgResources').value);
        } catch(e) { alert("JSON Invalide: "+e.message); return; }
        localStorage.setItem('DOV_SYS', JSON.stringify(SYS_CONFIG)); localStorage.setItem('DOV_DATA', JSON.stringify(CORE_DATA));
        window.closeModal('settingsModal'); log("‚öôÔ∏è Config Sauvegard√©e.", "#ffd700"); initApp(); // Re-init to redraw UI
    }

    window.onload = function() { initApp(); }
</script>

</body>
</html>
