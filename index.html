<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoV - Liste Finale</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background: white; width: 100%; max-width: 700px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2c3e50; }
        
        .input-group { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
        input { padding: 12px; width: 60%; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
        button { padding: 12px 20px; background-color: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }
        button:hover { background-color: #2ecc71; }
        button:disabled { background-color: #bdc3c7; }

        .stats { display: flex; justify-content: space-around; background: #ecf0f1; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .stat-box { text-align: center; }
        .stat-num { font-size: 24px; font-weight: bold; color: #2c3e50; }

        .log { background: #333; color: #0f0; padding: 10px; font-family: monospace; font-size: 12px; margin-bottom: 20px; border-radius: 5px; min-height: 40px; }
        
        .asset-list { max-height: 500px; overflow-y: auto; border-top: 1px solid #eee; }
        .item { padding: 10px; border-bottom: 1px solid #f1f1f1; display: flex; justify-content: space-between; align-items: center; }
        .item:hover { background-color: #fafafa; }
        .item a { text-decoration: none; color: #3498db; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>Inspecteur DoV</h1>
    
    <div class="input-group">
        <input type="text" id="userInput" placeholder="Compte WAX (ex: u2d2k.c.wam)" value="u2d2k.c.wam">
        <button id="btn" onclick="lancerScan()">VOIR MES CARTES</button>
    </div>

    <div class="log" id="logBox">Prêt. Cliquez sur le bouton.</div>

    <div class="stats">
        <div class="stat-box">
            <div class="stat-num" id="divCount">0</div>
            <div>Divisions</div>
        </div>
        <div class="stat-box">
            <div class="stat-num" id="assetCount">0</div>
            <div>Cartes (Assets)</div>
        </div>
    </div>

    <div class="asset-list" id="resultList"></div>
</div>

<script>
    // On garde le serveur qui a fonctionné pour toi (waxsweden)
    const RPC = "https://api.waxsweden.org/v1/chain/get_table_rows";

    async function lancerScan() {
        const account = document.getElementById('userInput').value.trim().toLowerCase();
        const logBox = document.getElementById('logBox');
        const list = document.getElementById('resultList');
        const btn = document.getElementById('btn');

        if(!account) return alert("Nom manquant");

        // Reset
        btn.disabled = true;
        list.innerHTML = "";
        document.getElementById('divCount').innerText = "0";
        document.getElementById('assetCount').innerText = "0";
        
        logBox.innerText = `Recherche des divisions pour ${account}...`;

        let allDivisions = [];
        let more = true;
        let nextKey = "";

        try {
            while(more) {
                // LA CORRECTION EST ICI : key_type: "name"
                const response = await fetch(RPC, {
                    method: 'POST',
                    body: JSON.stringify({
                        json: true,
                        code: "dovpvecontrl",
                        scope: "dovpvecontrl",
                        table: "sdivisions",
                        index_position: 2,     // Index Utilisateur
                        key_type: "name",      // <--- C'EST CA QUI MANQUAIT !
                        lower_bound: nextKey || account,
                        upper_bound: account,
                        limit: 200
                    })
                });

                if(!response.ok) throw new Error("Erreur réseau WAX");

                const data = await response.json();
                
                // Filtrage strict
                const rows = data.rows.filter(r => r.user === account);
                allDivisions = [...allDivisions, ...rows];

                logBox.innerText = `Trouvé ${allDivisions.length} divisions... (Chargement suite...)`;

                more = data.more;
                if(more && data.next_key) {
                    nextKey = data.next_key;
                } else {
                    more = false; // Sécurité anti-boucle infinie si next_key bug
                }
            }

            // Affichage final
            if(allDivisions.length === 0) {
                logBox.innerText = "Aucune division trouvée. (Vérifie qu'elles sont bien stakées)";
                logBox.style.color = "orange";
            } else {
                logBox.innerText = "Chargement terminé avec succès !";
                logBox.style.color = "#0f0";
                afficherResultats(allDivisions);
            }

        } catch (e) {
            logBox.innerText = "Erreur: " + e.message;
            logBox.style.color = "red";
        }
        
        btn.disabled = false;
    }

    function afficherResultats(divisions) {
        const list = document.getElementById('resultList');
        let totalAssets = 0;
        let html = "";

        divisions.forEach(div => {
            if(div.asset_ids && div.asset_ids.length > 0) {
                totalAssets += div.asset_ids.length;
                div.asset_ids.forEach(id => {
                    html += `
                        <div class="item">
                            <div>
                                <strong>Asset ${id}</strong> 
                                <span style="font-size:12px; color:#888; margin-left:10px">(Div #${div.division_id})</span>
                            </div>
                            <a href="https://wax.atomichub.io/explorer/asset/${id}" target="_blank">Voir sur AtomicHub →</a>
                        </div>
                    `;
                });
            }
        });

        document.getElementById('divCount').innerText = divisions.length;
        document.getElementById('assetCount').innerText = totalAssets;
        list.innerHTML = html;
    }
</script>

</body>
</html>
