<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoV TITAN v11 (GLOBAL + V61 LEGACY)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #050505; color: #ccc; font-family: 'Consolas', monospace; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        
        /* Styles V61 conserv√©s */
        .text-main { color: #00e676; }
        .text-alert { color: #ff1744; }
        .text-sec { color: #29b6f6; }
        .text-warn { color: #ff9800; }
        .text-dovx { color: #9c27b0; }
        .bg-panel { background-color: #111; border: 1px solid #333; }
        
        .zone-card { background: #0a0a0a; border: 1px solid #333; padding: 8px; opacity: 0.7; }
        .zone-card.active { opacity: 1; border-color: #444; background: #0e0e0e; }
        
        .progress-bar { transition: width 0.5s; height: 4px; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- 1. DATA LAYER (ORIGINE V61 & 28) ---
        const RPCS = [
            "https://wax.greymass.com", "https://api.waxsweden.org", "https://wax.eosn.io", "https://api.wax.alohaeos.com",
            "https://api-wax.eosarabia.net", "https://wax.bountyblok.io", "https://wax.eu.eosamsterdam.net", "https://api.wax.liquidstudios.io",
            "https://wax.eosphere.io", "https://wax.cryptolions.io", "https://api-wax.bountyblok.io", "https://wax.eosusa.news",
            "https://wax-bp.wizardsguild.one", "https://api.hivebp.io", "https://wax.blacklusion.io"
        ];

        const ZONE_DB = {
            1: { name: "Beach 1", cost: 1160, costX: 0, reward: 400.00 }, 2: { name: "Beach 2", cost: 6968, costX: 0, reward: 2405.00 },
            3: { name: "Beach 3", cost: 8800, costX: 0, reward: 3037.00 }, 4: { name: "Bunker", cost: 11120, costX: 0, reward: 3838.00 },
            5: { name: "Forest 1", cost: 14024, costX: 0, reward: 4839.00 }, 6: { name: "Forest 2", cost: 17704, costX: 0, reward: 6092.00 },
            7: { name: "Forest 3", cost: 22352, costX: 0, reward: 7659.00 }, 8: { name: "Camp", cost: 28220, costX: 0, reward: 9617.00 },
            9: { name: "Hill 1", cost: 37052, costX: 0, reward: 12557.00 }, 10: { name: "Hill 2", cost: 48652, costX: 0, reward: 16418.00 },
            11: { name: "Hill 3", cost: 64516, costX: 0, reward: 21703.00 }, 12: { name: "Radar", cost: 84712, costX: 0, reward: 28427.00 },
            13: { name: "Plain 1", cost: 99384, costX: 0, reward: 34300.00 }, 14: { name: "Plain 2", cost: 125708, costX: 0, reward: 42083.00 },
            15: { name: "Plain 3", cost: 151164, costX: 0, reward: 50570.00 }, 16: { name: "HQ", cost: 188000, costX: 0, reward: 64884.00 },
            17: { name: "City 1", cost: 0, costX: 1664, reward: 0 }, 18: { name: "City 2", cost: 0, costX: 4448, reward: 0 },
            19: { name: "City 3", cost: 0, costX: 13440, reward: 0 }, 20: { name: "City 4", cost: 0, costX: 29120, reward: 0 }
        };
        const ZONE_ORDER = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20];

        // --- UTILS V61 ---
        const extractPower = (row) => {
            let val = Array.isArray(row.power) ? row.power[0] : (row.power || row.pwr);
            if (typeof val === 'string') val = val.replace(/[^0-9.]/g, '');
            return parseFloat(val) || 0;
        };
        const getProp = (obj, keys) => { for(let k of keys) if(obj[k] !== undefined) return obj[k]; return 0; };
        const isBusy = (row) => (getProp(row, ['end_time', 'end']) > (Date.now()/1000));

        // ==========================================
        // FACE A: GLOBAL MARKET OBSERVER (Le Nouveau Module)
        // ==========================================
        const FaceA_Global = () => {
            const [scanning, setScanning] = useState(false);
            const [logs, setLogs] = useState("Pr√™t √† scanner l'√©cosyst√®me entier.");
            const [globalStats, setGlobalStats] = useState(null);
            
            // Logique de scan "Massif" (sans filtre owner)
            const startGlobalScan = async () => {
                setScanning(true); setLogs("Initialisation...");
                let allData = [];
                let next = ""; let more = true;
                let stats = { count: 0, totalProd: 0, totalBurn: 0, types: { F:0, H:0, R:0, S:0 } };

                try {
                    let attempts = 0;
                    while(more) {
                        const rpc = RPCS[Math.floor(Math.random()*RPCS.length)];
                        try {
                            const res = await fetch(`${rpc}/v1/chain/get_table_rows`, {
                                method: 'POST', body: JSON.stringify({json:true, code:"dovutilstake", scope:"dovutilstake", table:"buildings", limit:1000, lower_bound:next})
                            });
                            if(!res.ok) throw new Error('RPC Error');
                            const d = await res.json();
                            
                            if(!d.rows || d.rows.length === 0) break;
                            
                            // Traitement √† la vol√©e pour √©conomiser la m√©moire
                            d.rows.forEach(b => {
                                stats.count++;
                                const p = extractPower(b);
                                const costRaw = Array.isArray(b.token_in) ? b.token_in[0] : b.token_in;
                                const cost = parseFloat((costRaw || "0").replace(/[^0-9.]/g, '')) || 0;
                                
                                stats.totalProd += p;
                                stats.totalBurn += cost;

                                const pRaw = Array.isArray(b.power) ? b.power[0] : b.power;
                                if(pRaw.includes("DOVF")) stats.types.F++;
                                else if(pRaw.includes("DOVH")) stats.types.H++;
                                else if(pRaw.includes("DOVR")) stats.types.R++;
                                else if(pRaw.includes("DOVS")) stats.types.S++;
                            });

                            setLogs(`Scann√©: ${stats.count} actifs...`);
                            if(d.more && d.next_key !== next) next = d.next_key; else more = false;
                            
                            // S√©curit√© pour la d√©mo (√©viter freeze navigateur si > 50k items)
                            if(stats.count > 10000) more = false;

                        } catch(e) { attempts++; if(attempts > 5) more = false; }
                    }
                    setGlobalStats(stats);
                    setLogs("Scan Global Termin√©.");
                } catch(e) { setLogs("Erreur: "+e.message); }
                setScanning(false);
            };

            return (
                <div className="p-4 animate-fade-in">
                    <div className="bg-panel p-4 mb-4 flex justify-between items-center">
                        <div>
                            <h2 className="text-sec font-bold text-xl">üåç GLOBAL MARKET OBSERVER</h2>
                            <p className="text-xs text-gray-500 font-mono">{logs}</p>
                        </div>
                        <button onClick={startGlobalScan} disabled={scanning} className={`px-6 py-2 font-bold text-black rounded ${scanning ? 'bg-gray-600' : 'bg-sec hover:bg-white'}`}>
                            {scanning ? 'SCAN EN COURS...' : 'LANCER SCAN MONDIAL'}
                        </button>
                    </div>

                    {globalStats && (
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="bg-panel p-4 border-t-4 border-green-500">
                                <div className="text-gray-500 text-xs uppercase">Production Mondiale</div>
                                <div className="text-3xl font-bold text-white">{globalStats.totalProd.toLocaleString()} <span className="text-sm">TU/j</span></div>
                            </div>
                            <div className="bg-panel p-4 border-t-4 border-purple-500">
                                <div className="text-gray-500 text-xs uppercase">Burn Maintenance (DOVX)</div>
                                <div className="text-3xl font-bold text-dovx">{globalStats.totalBurn.toLocaleString()} <span className="text-sm">DOVX/j</span></div>
                            </div>
                            <div className="bg-panel p-4 border-t-4 border-blue-500">
                                <div className="text-gray-500 text-xs uppercase">B√¢timents Actifs</div>
                                <div className="text-3xl font-bold text-sec">{globalStats.count.toLocaleString()}</div>
                                <div className="flex gap-2 text-[10px] mt-1">
                                    <span className="text-orange-400">F:{globalStats.types.F}</span>
                                    <span className="text-red-400">H:{globalStats.types.H}</span>
                                    <span className="text-gray-400">R:{globalStats.types.R}</span>
                                    <span className="text-yellow-400">S:{globalStats.types.S}</span>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // FACE B: PERSONAL MANAGER (V61 LEGACY PORT)
        // ==========================================
        const FaceB_Personal = () => {
            const [user, setUser] = useState('u2d2k.c.wam');
            const [view, setView] = useState('ZONES'); // ZONES, ECO, TARGET
            const [logs, setLogs] = useState([]);
            
            // STATES V61
            const [zoneStats, setZoneStats] = useState(null);
            const [ecoStats, setEcoStats] = useState(null);
            const [targetDivs, setTargetDivs] = useState(null);
            const [stop, setStop] = useState(false);

            const log = (msg) => setLogs(prev => [`[${new Date().toLocaleTimeString()}] ${msg}`, ...prev].slice(0, 50));

            // MOTEUR V61 (RobustFetch adapt√© React)
            const robustFetch = async (code, table, lower, limit=100) => {
                let attempts = 0;
                while(attempts < 15 && !stop) {
                    const rpc = RPCS[Math.floor(Math.random()*RPCS.length)];
                    try {
                        const res = await fetch(`${rpc}/v1/chain/get_table_rows`, {
                            method: 'POST', body: JSON.stringify({json:true, code, scope:code, table, lower_bound:lower, limit})
                        });
                        if(res.ok) return await res.json();
                    } catch(e) { attempts++; }
                }
                return {rows:[]};
            };

            // FONCTION 1: SCAN ZONES (Replique V61)
            const startZoneScan = async () => {
                setView('ZONES'); setStop(false);
                let stats = { divs: 0, burn: { fuel:0, health:0, repair:0, supply:0 }, totalCostX: 0, totalGain: 0, zones: {} };
                ZONE_ORDER.forEach(id => stats.zones[id] = { count: 0, active: 0, idle: 0 });
                let next = ""; let more = true;
                log("Mapping Zones V61...");

                try {
                    while(more && !stop) {
                        const d = await robustFetch("dovpvecontrl", "sdivisions", next);
                        if(!d.rows?.length) break;
                        d.rows.forEach(row => {
                            // Filtre USER (V61 specific)
                            if(row.owner !== user && row.user !== user) return; 

                            stats.divs++; 
                            const zID = getProp(row, ['zoneID', 'zone_id']); 
                            const busy = isBusy(row);
                            if(stats.zones[zID]) {
                                stats.zones[zID].count++; 
                                const zInfo = ZONE_DB[zID];
                                if(busy) { 
                                    stats.zones[zID].active++; 
                                    if(zInfo.cost > 0) { stats.burn.fuel+=zInfo.cost; stats.burn.health+=zInfo.cost; stats.burn.repair+=zInfo.cost; stats.burn.supply+=zInfo.cost; }
                                    stats.totalCostX += zInfo.costX; 
                                    const power = extractPower(row);
                                    if(zInfo.reward > 0) stats.totalGain += (zInfo.reward * (power >= 1200 ? 1 : 0.25)); // Simplifi√©
                                } else stats.zones[zID].idle++;
                            }
                        });
                        if(d.more && d.next_key !== next) next = d.next_key; else more = false;
                        setZoneStats({...stats}); // Update UI live
                    }
                    log("Scan Zones termin√©.");
                } catch(e) { log("Err: "+e.message); }
            };

            // FONCTION 2: SCAN ECONOMY (Replique V61)
            const startEcoScan = async () => {
                setView('ECO'); setStop(false);
                let data = { demand: { F:0, H:0, R:0, S:0 }, supply: { F:0, H:0, R:0, S:0 }, dovx: { city:0, build:0, mint:0 } };
                log("Audit Financier V61...");
                
                // 1. Scan Divisions (Demand)
                let next = ""; let more = true;
                while(more && !stop) {
                    const d = await robustFetch("dovpvecontrl", "sdivisions", next);
                    if(!d.rows?.length) break;
                    d.rows.forEach(row => {
                        if(row.owner !== user && row.user !== user) return;
                        const zID = getProp(row, ['zoneID', 'zone_id']); const z = ZONE_DB[zID];
                        if(z && isBusy(row)) {
                            if(z.cost>0) { data.demand.F+=z.cost; data.demand.H+=z.cost; data.demand.R+=z.cost; data.demand.S+=z.cost; }
                            if(z.costX>0) data.dovx.city+=z.costX;
                            if(z.reward>0) data.dovx.mint+=z.reward; // Simplified logic
                        }
                    });
                    if(d.more && d.next_key !== next) next = d.next_key; else more = false;
                }

                // 2. Scan Buildings (Supply)
                next = ""; more = true;
                while(more && !stop) {
                    const d = await robustFetch("dovutilstake", "buildings", next);
                    if(!d.rows?.length) break;
                    d.rows.forEach(b => {
                        if(b.owner !== user) return;
                        const p = extractPower(b);
                        const cost = parseFloat((Array.isArray(b.token_in)?b.token_in[0]:b.token_in).replace(/[^0-9.]/g,''))||0;
                        data.dovx.build += cost;
                        
                        const pRaw = Array.isArray(b.power)?b.power[0]:b.power;
                        if(pRaw.includes("DOVF")) data.supply.F += p;
                        else if(pRaw.includes("DOVH")) data.supply.H += p;
                        else if(pRaw.includes("DOVR")) data.supply.R += p;
                        else if(pRaw.includes("DOVS")) data.supply.S += p;
                    });
                    if(d.more && d.next_key !== next) next = d.next_key; else more = false;
                    setEcoStats({...data});
                }
                log("Audit Eco termin√©.");
            };

            // FONCTION 3: TARGET (Replique V61)
            const startTargetScan = async () => {
                setView('TARGET'); setStop(false); setTargetDivs([]);
                log(`Scan Cible ${user}...`);
                try {
                    const d = await robustFetch("dovpvecontrl", "sdivisions", user, 500);
                    const rows = d.rows ? d.rows.filter(r => r.owner===user || r.user===user) : [];
                    setTargetDivs(rows);
                    log(`${rows.length} divisions trouv√©es.`);
                } catch(e) { log("Err: "+e.message); }
            };

            return (
                <div className="flex flex-col md:flex-row h-full animate-fade-in">
                    {/* SIDEBAR V61 */}
                    <div className="w-full md:w-64 bg-panel p-4 flex flex-col gap-4">
                        <div className="border border-yellow-600 p-2">
                            <div className="text-yellow-500 font-bold text-xs mb-2">CONFIGURATION</div>
                            <input value={user} onChange={e=>setUser(e.target.value)} className="w-full bg-black text-white border border-gray-600 px-2 py-1 mb-2 font-mono text-xs"/>
                        </div>
                        <div>
                            <div className="text-white font-bold text-xs mb-2">1. COMMANDES</div>
                            <button onClick={startZoneScan} className="w-full bg-main text-black font-bold py-2 mb-2 text-xs">SCAN ZONES (MAP)</button>
                            <button onClick={startEcoScan} className="w-full bg-yellow-500 text-black font-bold py-2 mb-2 text-xs">SCAN ECONOMY ($)</button>
                            <button onClick={()=>setStop(true)} className="w-full bg-alert text-white font-bold py-2 text-xs">ARR√äT URGENCE</button>
                        </div>
                        <div>
                            <div className="text-white font-bold text-xs mb-2">2. CIBLE</div>
                            <button onClick={startTargetScan} className="w-full bg-sec text-black font-bold py-2 text-xs">SCAN DIVISIONS</button>
                        </div>
                        <div className="bg-black h-32 overflow-y-auto text-[10px] text-gray-500 font-mono p-1 border border-gray-800">
                            {logs.map((l,i)=><div key={i}>{l}</div>)}
                        </div>
                    </div>

                    {/* MAIN VIEW V61 */}
                    <div className="flex-1 bg-black p-4 overflow-y-auto h-[600px]">
                        {view === 'ZONES' && zoneStats && (
                            <div>
                                <div className="grid grid-cols-4 gap-2 mb-4 text-center">
                                    <div className="bg-panel p-2"><span className="block text-xl font-bold text-white">{zoneStats.divs}</span><span className="text-xs text-gray-500">Divs</span></div>
                                    <div className="bg-panel p-2"><span className="block text-xl font-bold text-main">+{zoneStats.totalGain}</span><span className="text-xs text-gray-500">Gain DOVX</span></div>
                                    <div className="bg-panel p-2"><span className="block text-xl font-bold text-dovx">-{zoneStats.totalCostX}</span><span className="text-xs text-gray-500">Cost City</span></div>
                                    <div className="bg-panel p-2 text-[10px] text-gray-400 text-left pl-4">
                                        <div>F: -{zoneStats.burn.fuel}</div>
                                        <div>H: -{zoneStats.burn.health}</div>
                                        <div>R: -{zoneStats.burn.repair}</div>
                                        <div>S: -{zoneStats.burn.supply}</div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-4 gap-2">
                                    {ZONE_ORDER.map(id => {
                                        const z = ZONE_DB[id]; const s = zoneStats.zones[id];
                                        return (
                                            <div key={id} className={`zone-card ${s.count>0?'active':''}`}>
                                                <div className="flex justify-between text-xs font-bold text-white border-b border-gray-800 mb-1">
                                                    <span>{z.name}</span><span>{s.count}</span>
                                                </div>
                                                <div className="text-[10px] text-gray-500 flex justify-between">
                                                    <span className="text-warn">{s.active} Act.</span>
                                                    <span className="text-main">{s.idle} Rdy</span>
                                                </div>
                                                <div className="h-1 bg-gray-800 mt-1 flex">
                                                    <div className="bg-warn h-full" style={{width:`${s.count?(s.active/s.count)*100:0}%`}}></div>
                                                    <div className="bg-main h-full" style={{width:`${s.count?(s.idle/s.count)*100:0}%`}}></div>
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>
                        )}

                        {view === 'ECO' && ecoStats && (
                            <div className="space-y-4">
                                <div className="grid grid-cols-3 gap-4">
                                    <div className="bg-panel p-4 border-t-2 border-alert">
                                        <div className="text-xs text-gray-500">DEMANDE (BURN)</div>
                                        <div className="text-2xl font-bold text-white">{(ecoStats.demand.F+ecoStats.demand.H+ecoStats.demand.R+ecoStats.demand.S).toLocaleString()} TU</div>
                                    </div>
                                    <div className="bg-panel p-4 border-t-2 border-main">
                                        <div className="text-xs text-gray-500">OFFRE (MINT)</div>
                                        <div className="text-2xl font-bold text-white">{(ecoStats.supply.F+ecoStats.supply.H+ecoStats.supply.R+ecoStats.supply.S).toLocaleString()} TU</div>
                                    </div>
                                    <div className="bg-panel p-4 border-t-2 border-dovx">
                                        <div className="text-xs text-gray-500">NET DOVX</div>
                                        <div className="text-2xl font-bold text-white">{(ecoStats.dovx.mint - (ecoStats.dovx.city + ecoStats.dovx.build)).toLocaleString()}</div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-4 gap-2">
                                    {['F','H','R','S'].map(t => {
                                        const net = ecoStats.supply[t] - ecoStats.demand[t];
                                        return (
                                            <div key={t} className="bg-panel p-2 text-center">
                                                <div className="font-bold text-white">{t}</div>
                                                <div className={`text-sm ${net>=0?'text-main':'text-alert'}`}>{net>=0?'+':''}{net.toLocaleString()}</div>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>
                        )}

                        {view === 'TARGET' && targetDivs && (
                            <div className="space-y-1">
                                <div className="bg-panel p-2 text-sec font-bold">JOUEUR: {user} ({targetDivs.length} Divs)</div>
                                {targetDivs.map((r, i) => {
                                    const zID = getProp(r, ['zoneID', 'zone_id']);
                                    const z = ZONE_DB[zID];
                                    const busy = isBusy(r);
                                    return (
                                        <div key={i} className="flex justify-between bg-panel p-2 text-xs">
                                            <div className="text-main">#{getId(r)}</div>
                                            <div className="text-sec">{z ? z.name : 'Zone '+zID}</div>
                                            <div className={busy?'text-warn':'text-main'}>{busy?'MISSION':'PR√äT'}</div>
                                        </div>
                                    )
                                })}
                            </div>
                        )}
                        {!zoneStats && !ecoStats && !targetDivs && <div className="text-center text-gray-500 mt-20">En attente d'une commande...</div>}
                    </div>
                </div>
            );
        };

        // ==========================================
        // SHELL PRINCIPAL
        // ==========================================
        const App = () => {
            const [face, setFace] = useState('FACE_A'); // FACE_A = GLOBAL, FACE_B = PERSO

            return (
                <div className="max-w-[1600px] mx-auto min-h-screen border-x border-gray-800">
                    {/* NAV BAR */}
                    <div className="flex bg-black border-b border-gray-800">
                        <button onClick={()=>setFace('FACE_A')} className={`flex-1 py-4 text-sm font-bold tracking-widest ${face==='FACE_A' ? 'bg-blue-900 text-white' : 'text-gray-500 hover:text-white'}`}>
                            FACE A : √âCOSYST√àME (MONDE)
                        </button>
                        <button onClick={()=>setFace('FACE_B')} className={`flex-1 py-4 text-sm font-bold tracking-widest ${face==='FACE_B' ? 'bg-green-900 text-white' : 'text-gray-500 hover:text-white'}`}>
                            FACE B : MANAGER (PERSONNEL V61)
                        </button>
                    </div>

                    {/* CONTENT */}
                    <div className="bg-[#050505] min-h-[800px]">
                        {face === 'FACE_A' ? <FaceA_Global /> : <FaceB_Personal />}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
