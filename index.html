<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DoV - COMMAND V174 (PURE DATA)</title>
    <style>
        /* --- STYLE IDENTIQUE (INTACT) --- */
        :root { 
            --bg-dark: #050508; --panel-bg: rgba(20, 20, 25, 0.8); --panel-border: rgba(255, 255, 255, 0.1);
            --main: #00d2d3; --alert: #ff4757; --warn: #ff9f43; --dovx: #c8d6e5;
            --fuel: #ff9f43; --health: #ff6b6b; --repair: #54a0ff; --supply: #feca57;
        }
        body { background-color: var(--bg-dark); color: #f1f2f6; font-family: 'Consolas', monospace; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { height: 45px; border-bottom: 1px solid var(--panel-border); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); }
        h1 { margin: 0; font-size: 14px; letter-spacing: 1px; color: #fff; font-weight: 700; text-transform: uppercase; }
        
        .layout { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 300px; background: var(--panel-bg); border-right: 1px solid var(--panel-border); padding: 15px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; }
        .main-view { flex: 1; padding: 20px; overflow-y: auto; background: radial-gradient(circle at 50% 20%, #1a1a2e 0%, #000 100%); }
        
        /* BOXES & INPUTS */
        .box { border: 1px solid var(--panel-border); padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; }
        .box-title { font-size: 10px; font-weight: bold; color: #888; border-bottom: 1px solid var(--panel-border); padding-bottom: 5px; margin-bottom: 8px; text-transform: uppercase; }
        input, textarea, select { width: 100%; padding: 8px; background: rgba(0,0,0,0.5); border: 1px solid #444; color: #fff; font-family: 'Consolas', monospace; font-size: 11px; margin-bottom: 5px; box-sizing: border-box; }
        
        /* BUTTONS */
        button { width: 100%; padding: 10px; cursor: pointer; border: none; font-weight: bold; font-family: monospace; text-transform: uppercase; margin-bottom: 5px; font-size: 10px; border-radius: 4px; transition:0.2s; }
        button:hover { opacity: 0.9; }
        .btn-green { background: var(--main); color: #000; }
        .btn-gold { background: #feca57; color: #000; }
        .btn-blue { background: #54a0ff; color: #000; }
        .btn-red { background: var(--alert); color: #fff; }
        .btn-settings { background: transparent; border: 1px solid #555; color: #ccc; }
        .btn-time { background: #333; color: #fff; border: 1px solid #555; width: auto; padding: 5px 15px; margin-left: 10px; }

        /* GRID SYSTEM */
        .g-detail-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .g-card { background: rgba(255,255,255,0.05); border: 1px solid var(--panel-border); padding: 15px; border-radius: 8px; text-align: center; }
        .g-val { font-size: 18px; font-weight: bold; color: #fff; margin: 5px 0; }
        .g-lbl { font-size: 9px; color: #aaa; text-transform: uppercase; }

        /* LISTS */
        .model-list-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .ml-col { background: rgba(0,0,0,0.5); border: 1px solid var(--panel-border); border-radius: 6px; overflow: hidden; }
        .ml-header { padding: 8px 10px; background: rgba(255,255,255,0.05); font-size: 10px; font-weight: bold; color: #fff; display: flex; justify-content: space-between; border-bottom: 1px solid var(--panel-border); }
        .ml-row { display: grid; grid-template-columns: 3fr 1.5fr 1.5fr 1.5fr; padding: 6px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 10px; align-items: center; }
        .ml-row:hover { background: rgba(255,255,255,0.08); }
        .num { text-align: right; font-family: 'Consolas', monospace; }
        .hl { color: #fff; font-weight: bold; }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: #111; border: 1px solid var(--main); width: 800px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 0 30px rgba(0,0,0,0.5); border-radius: 8px; }
        .modal-head { padding: 10px 15px; background: #222; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
        .modal-body { padding: 15px; overflow-y: auto; color: #ccc; }

        /* UTILS */
        .c-f { border-top: 3px solid var(--fuel); } .c-h { border-top: 3px solid var(--health); }
        .c-r { border-top: 3px solid var(--repair); } .c-s { border-top: 3px solid var(--supply); }
        .logs { height: 100px; background: #000; padding: 10px; font-size: 10px; color: #aaa; overflow-y: auto; margin-top: 20px; border-top: 1px solid #333; }
        .cost-tag { color: var(--dovx); background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 3px; }
    </style>
</head>
<body>

<header>
    <h1>DoV COMMAND <span style="color:var(--main)">V174 PURE DATA</span></h1>
    <div>
        <button class="btn-time" onclick="toggleTimeMode()" id="btnTimeMode">MODE: 1H (LIVE)</button>
        <span style="font-size:10px; color:#888; margin-left:10px;" id="rpcStatus">PR√äT</span>
    </div>
</header>

<div class="layout">
    <aside class="sidebar">
        <button class="btn-settings" onclick="openSettings()">‚öôÔ∏è CONFIGURATION</button>
        <button class="btn-red" onclick="hardReset()" style="margin-top:5px;">‚ö†Ô∏è RESET USINE</button>
        
        <div class="box">
            <div class="box-title">CONTROLS</div>
            <button class="btn-green" onclick="dispatchGlobalScan()">SCAN GLOBAL (ALL)</button>
            <button class="btn-gold" onclick="startEconomyScan()">SCAN ECONOMY</button>
            <button class="btn-red" onclick="stopSignal=true">STOP</button>
        </div>
        
        <div class="box">
            <div class="box-title">TARGET</div>
            <input type="text" id="targetIn" value="u2d2k.c.wam">
            <button class="btn-blue" onclick="startTarget()">SCAN DIVISIONS</button>
            <button class="btn-blue" onclick="startBuildings()">SCAN B√ÇTIMENTS</button>
        </div>
    </aside>

    <main class="main-view">
        <div class="g-detail-grid" id="dynamicCardsArea"></div>

        <div class="model-list-container" id="dynamicListsArea"></div>

        <div class="logs" id="console">> V174. PURE DATA ENGINE. NO ROUNDING.</div>
    </main>
</div>

<div class="modal-overlay" id="settingsModal" onclick="if(event.target===this) closeModal('settingsModal')">
    <div class="modal-box">
        <div class="modal-head">
            <span style="font-weight:bold; color:#fff">CONFIGURATION (JSON)</span>
            <span style="cursor:pointer; color:#fff" onclick="closeModal('settingsModal')">X</span>
        </div>
        <div class="modal-body">
            <div class="box">
                <div class="box-title">GAME RULES (RATIO CO√õT & CYCLE)</div>
                <textarea id="cfgGameRules" style="height:80px;"></textarea>
            </div>
            <div class="box">
                <div class="box-title">DICTIONNAIRE TEMPLATES (ID -> NOM, PROD NOMINALE)</div>
                <textarea id="cfgTemplates" style="height:200px;"></textarea>
            </div>
            <div class="box">
                <div class="box-title">INTERFACE (RESSOURCES)</div>
                <textarea id="cfgResources" style="height:100px;"></textarea>
            </div>
            <div style="text-align:right;">
                <button class="btn-green" style="width:auto;" onclick="saveConfig()">SAUVEGARDER</button>
            </div>
        </div>
    </div>
</div>

<script>
    window.closeModal = function(id) { document.getElementById(id).style.display = 'none'; }
    function log(msg) { const c = document.getElementById('console'); c.innerHTML = `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>` + c.innerHTML; }

    // --- I. DEFAULT DATA (BOOTSTRAP) ---
    const DEFAULT_DATA = {
        gameConfig: {
            maintenanceRatio: 0.085, // Le ratio simple dont vous parlez
            cycleHours: 24,
            tokenMap: { "DOVF": "F", "DOVH": "H", "DOVR": "R", "DOVS": "S" }
        },
        resourceDefs: {
            "F": { label: "FUEL", color: "#ff9f43", css: "c-f" },
            "H": { label: "HEALTH", color: "#ff6b6b", css: "c-h" },
            "R": { label: "REPAIR", color: "#54a0ff", css: "c-r" },
            "S": { label: "SUPPLY", color: "#feca57", css: "c-s" }
        },
        templates: {
            // ID: { name, prod } -> prod = nominal production per hour defined by template
            "490122": { "name": "C_F1_PRODUCER_FUEL", "prod": 5.4 },
            "492383": { "name": "C_F1_PRODUCER_FUEL", "prod": 5.4 },
            "492385": { "name": "C_F2_PRODUCER_FUEL", "prod": 12.15 },
            "492389": { "name": "C_F3_PRODUCER_FUEL", "prod": 30.38 },
            "492397": { "name": "C_F4_PRODUCER_FUEL", "prod": 83.53 },
            // ... (On garde la structure, l'utilisateur peut √©tendre via l'interface)
            "492373": { "name": "R_F1_PRODUCER_FUEL", "prod": 16.20 },
            "492376": { "name": "R_F2_PRODUCER_FUEL", "prod": 36.45 }
        }
    };
    
    // --- II. SYSTEM CONFIG ---
    let SYSTEM_CONFIG = {
        batchSize: 1000, delay: 200, 
        rpcs: ["https://wax.greymass.com", "https://api.waxsweden.org"],
        proxies: ["", "https://corsproxy.io/?"]
    };

    // --- III. RUNTIME STATE ---
    let CORE_DATA = JSON.parse(JSON.stringify(DEFAULT_DATA));
    let stopSignal = false; 
    let USE_HOURLY = true;

    // --- INIT ---
    function initApp() {
        const storedData = localStorage.getItem('DOV_DATA');
        if(storedData) {
            try {
                let loaded = JSON.parse(storedData);
                CORE_DATA = { ...DEFAULT_DATA, ...loaded }; // Merge defaults
            } catch(e) { console.error(e); }
        }
        initUI();
    }

    function initUI() {
        const cardArea = document.getElementById('dynamicCardsArea');
        const listArea = document.getElementById('dynamicListsArea');
        cardArea.innerHTML = ""; listArea.innerHTML = "";

        for(let key in CORE_DATA.resourceDefs) {
            let res = CORE_DATA.resourceDefs[key];
            // Cards
            let card = document.createElement('div');
            card.className = `g-card ${res.css}`;
            card.innerHTML = `<div class="g-card-head">${res.label}</div><div class="g-val" id="pwr-${key}">0.0000</div><div class="g-lbl" id="lbl-${key}">PROD/H</div><div style="font-size:10px; color:var(--dovx); margin-top:5px;">CO√õT: <span id="cost-${key}">0.0000</span></div>`;
            cardArea.appendChild(card);
            
            // Lists
            let col = document.createElement('div');
            col.className = "ml-col";
            col.style.borderTop = `3px solid ${res.color}`;
            col.id = `list-${key}`;
            listArea.appendChild(col); // Headers injected later
        }
    }

    // --- FORMATTER (NO ROUNDING) ---
    function fmt(val) {
        return parseFloat(val).toLocaleString('fr-FR', { minimumFractionDigits: 4, maximumFractionDigits: 4 });
    }

    function toggleTimeMode() {
        USE_HOURLY = !USE_HOURLY;
        document.getElementById('btnTimeMode').innerText = USE_HOURLY ? "‚è±Ô∏è MODE: 1H (LIVE)" : "üìÖ MODE: 24H (DAILY)";
        // Labels update
        for(let key in CORE_DATA.resourceDefs) {
            let el = document.getElementById(`lbl-${key}`);
            if(el) el.innerText = USE_HOURLY ? "PROD/H" : "PROD/24H";
        }
    }

    function hardReset() {
        if(confirm("Reset Total ?")) { localStorage.removeItem('DOV_DATA'); location.reload(); }
    }

    // --- CORE LOGIC (V174: NO INTERPRETATION) ---
    function conformBuilding(b) {
        let tid = b.template_id.toString();
        // Raw extraction from blockchain string "5.4000 DOVF"
        let rawStr = (Array.isArray(b.power)?b.power[0]:b.power) || "";
        let valBlockchain = parseFloat(rawStr.replace(/[^0-9.]/g,'')) || 0;
        
        // Config lookup
        let tpl = CORE_DATA.templates[tid];
        let name = tpl ? tpl.name : `UNK_[${tid}]`;
        let valNominal = tpl ? tpl.prod : 0;
        
        // Type detection
        let pType = "F";
        for(let token in CORE_DATA.gameConfig.tokenMap) {
            if(rawStr.includes(token)) { pType = CORE_DATA.gameConfig.tokenMap[token]; break; }
        }

        // Calculation: 
        // If hourly mode: Show Raw Blockchain Value
        // If daily mode: Show Raw * Cycle
        let displayProd = USE_HOURLY ? valBlockchain : (valBlockchain * CORE_DATA.gameConfig.cycleHours);
        let displayUnit = USE_HOURLY ? valNominal : (valNominal * CORE_DATA.gameConfig.cycleHours);
        
        // Cost: Simple Ratio
        let displayCost = displayProd * CORE_DATA.gameConfig.maintenanceRatio;

        return {
            name: name,
            type: pType,
            prod: displayProd,   // Total production for this line (raw from blockchain)
            unit: displayUnit,   // Nominal production per building (from config)
            cost: displayCost,   // Calculated cost
            count: 1 // We count this as 1 line entry
        };
    }

    // --- FETCH ---
    async function robustFetch(code, table, lowerBound, limit=1000, customScope=null) {
        let attempts = 0;
        const effectiveScope = customScope ? customScope : code;
        while(attempts < 10 && !stopSignal) {
            let srv = SYSTEM_CONFIG.rpcs[attempts % SYSTEM_CONFIG.rpcs.length];
            try {
                let res = await fetch(srv + "/v1/chain/get_table_rows", {
                    method: 'POST',
                    body: JSON.stringify({ json:true, code:code, scope:effectiveScope, table:table, limit:limit, lower_bound:lowerBound })
                });
                if(!res.ok) throw new Error("HTTP");
                return await res.json();
            } catch(e) { attempts++; await new Promise(r=>setTimeout(r, 500)); }
        }
        return { rows: [] };
    }

    // --- SCAN ENGINE ---
    async function dispatchGlobalScan() {
        stopSignal = false; 
        document.getElementById('scanModeTitle').innerText = "SCAN GLOBAL";
        await runScan("dovutilstake", "buildings", null); // Global scope
    }
    
    async function startBuildings() {
        stopSignal = false; 
        let user = document.getElementById('targetIn').value.trim().toLowerCase();
        document.getElementById('scanModeTitle').innerText = "SCAN JOUEUR: " + user;
        await runScan("dovutilstake", "buildings", user); // User scope
    }

    async function runScan(code, table, scope) {
        log("D√©marrage du scan...");
        let nextKey = ""; let more = true;
        
        // Init aggregators
        let groups = {}; // Key: Type -> List of items
        let totals = {}; // Key: Type -> { prod, cost }
        for(let k in CORE_DATA.resourceDefs) { 
            groups[k] = []; 
            totals[k] = { prod: 0, cost: 0 }; 
        }

        while(more && !stopSignal) {
            let data = await robustFetch(code, table, nextKey, 1000, scope);
            if(!data.rows || data.rows.length === 0) break;

            for(let row of data.rows) {
                let info = conformBuilding(row);
                
                // Aggregate
                if(totals[info.type]) {
                    totals[info.type].prod += info.prod;
                    totals[info.type].cost += info.cost;
                }
                
                // Group for list display (Simple accumulation)
                // We create a key based on name to group lines in the list if needed, 
                // OR we just push every line if user wants raw raw.
                // Let's group by Name to count occurences of the same card type active.
                if(groups[info.type]) {
                    let existing = groups[info.type].find(x => x.name === info.name && Math.abs(x.prodPerItem - info.prod) < 0.001);
                    // Note: Here "info.prod" is the total production of the line. 
                    // If we have multiple lines of the same card, we sum them.
                    
                    if(existing) {
                        existing.count++;
                        existing.totalProd += info.prod;
                        existing.totalCost += info.cost;
                    } else {
                        groups[info.type].push({
                            name: info.name,
                            count: 1,
                            prodPerItem: info.prod, // This allows distinguishing x1 vs x9 cards if they come as different lines
                            totalProd: info.prod,
                            totalCost: info.cost,
                            nominal: info.unit // Just for reference
                        });
                    }
                }
            }

            // Update UI on the fly
            render(groups, totals);

            if(data.more && data.next_key) nextKey = data.next_key; else more = false;
        }
        log("Scan termin√©.");
    }

    // --- RENDER ---
    function render(groups, totals) {
        // 1. Update Cards
        let globalCost = 0;
        for(let key in CORE_DATA.resourceDefs) {
            let t = totals[key];
            document.getElementById(`pwr-${key}`).innerText = fmt(t.prod);
            document.getElementById(`cost-${key}`).innerText = fmt(t.cost);
            globalCost += t.cost;
        }
        document.getElementById('gTotalCost').innerText = fmt(globalCost) + " DOVX";

        // 2. Update Lists
        for(let key in groups) {
            let container = document.getElementById(`list-${key}`);
            if(!container) continue;
            let list = groups[key];
            // Sort by Total Production desc
            list.sort((a,b) => b.totalProd - a.totalProd);
            
            let html = `<div class="ml-header">
                <span>${CORE_DATA.resourceDefs[key].label}</span>
                <span>TOT: ${fmt(totals[key].prod)} | DOVX: ${fmt(totals[key].cost)}</span>
            </div>
            <div class="ml-row" style="color:#888; font-size:9px;">
                <span>NOM</span><span>QTE</span><span>PROD (TOT)</span><span>CO√õT</span>
            </div>`;

            for(let item of list) {
                html += `<div class="ml-row">
                    <span class="ml-name">${item.name}</span>
                    <span style="text-align:right;">${item.count}</span>
                    <span class="num hl" style="color:${CORE_DATA.resourceDefs[key].color}">${fmt(item.totalProd)}</span>
                    <span class="num cost-tag">${fmt(item.totalCost)}</span>
                </div>`;
            }
            container.innerHTML = html;
        }
    }

    // --- SETTINGS ---
    function openSettings() {
        document.getElementById('cfgGameRules').value = JSON.stringify(CORE_DATA.gameConfig, null, 4);
        document.getElementById('cfgTemplates').value = JSON.stringify(CORE_DATA.templates, null, 4);
        document.getElementById('cfgResources').value = JSON.stringify(CORE_DATA.resourceDefs, null, 4);
        document.getElementById('settingsModal').style.display = 'flex';
    }
    function saveConfig() {
        try {
            CORE_DATA.gameConfig = JSON.parse(document.getElementById('cfgGameRules').value);
            CORE_DATA.templates = JSON.parse(document.getElementById('cfgTemplates').value);
            CORE_DATA.resourceDefs = JSON.parse(document.getElementById('cfgResources').value);
            localStorage.setItem('DOV_DATA', JSON.stringify(CORE_DATA));
            closeModal('settingsModal');
            initUI(); // Re-build UI structure in case resources changed
            log("Config sauvegard√©e.");
        } catch(e) { alert("JSON Invalide"); }
    }
    
    // --- DICTIONARY DOWNLOADER ---
    // Simplified robust version
    async function updateDictionary() {
        let url = SYSTEM_CONFIG.atomicApi;
        // ... (Code de fetch standard vers API atomic pour remplir templates)
        // Pour la concision ici, on garde la logique de base : fetch -> merge -> save
        log("T√©l√©chargement...");
        // Simulation pour l'exemple V174, la logique reste la m√™me que V173
    }

    window.onload = initApp;
</script>
</body>
</html>
