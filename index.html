<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoV - DIAGNOSTIC</title>
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: monospace; padding: 20px; }
        .box { border: 2px solid #333; padding: 20px; max-width: 800px; margin: 0 auto; background: #1e1e1e; }
        h1 { color: #bb86fc; text-align: center; }
        
        .input-group { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
        input { padding: 10px; background: #333; border: 1px solid #555; color: white; width: 60%; }
        button { padding: 10px 20px; background: #03dac6; border: none; color: black; font-weight: bold; cursor: pointer; }
        button:hover { background: #018786; }

        #console { 
            background: black; 
            border: 1px solid #444; 
            height: 400px; 
            overflow-y: auto; 
            padding: 10px; 
            font-size: 13px;
            white-space: pre-wrap; 
        }

        .log-info { color: #888; }
        .log-success { color: #4caf50; font-weight: bold; }
        .log-error { color: #ff5252; font-weight: bold; border-left: 3px solid #ff5252; padding-left: 5px; }
        .log-data { color: #4fc3f7; }
    </style>
</head>
<body>

<div class="box">
    <h1>MODE DIAGNOSTIC</h1>
    <p style="text-align:center">Si ça ne marche pas, lisez le texte ci-dessous.</p>
    
    <div class="input-group">
        <input type="text" id="userInput" placeholder="Nom du compte (ex: tonami.wam)">
        <button onclick="lancerTest()">LANCER LE TEST</button>
    </div>

    <div id="console">En attente...</div>
</div>

<script>
    // On utilise un serveur souvent plus permissif pour les navigateurs
    const RPC_URL = "https://api.waxsweden.org/v1/chain/get_table_rows";

    function log(msg, type = "info") {
        const c = document.getElementById('console');
        const time = new Date().toLocaleTimeString();
        c.innerHTML += `<div class="log-${type}">[${time}] ${msg}</div>`;
        c.scrollTop = c.scrollHeight;
    }

    async function lancerTest() {
        const account = document.getElementById('userInput').value.trim().toLowerCase();
        document.getElementById('console').innerHTML = ""; // Reset
        
        if (!account) return alert("Mets un nom !");

        log("1. Démarrage du test...", "info");
        log(`2. Cible : ${account}`, "info");
        log(`3. Serveur visé : ${RPC_URL}`, "info");

        // Configuration de la demande
        const payload = {
            json: true,
            code: "dovpvecontrl",
            scope: "dovpvecontrl",
            table: "sdivisions",
            index_position: 2,     // Recherche par USER
            key_type: "i64",       // ESSAI STANDARD D'ABORD
            lower_bound: account,
            upper_bound: account,
            limit: 50
        };

        try {
            log("4. Envoi de la requête internet...", "info");
            
            const response = await fetch(RPC_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            });

            log(`5. Réponse reçue ! Code: ${response.status}`, response.ok ? "success" : "error");

            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status} (${response.statusText})`);
            }

            const data = await response.json();
            log("6. Données décodées.", "success");

            if (!data.rows) {
                log("ERREUR : Le serveur a répondu mais sans données (pas de 'rows').", "error");
                return;
            }

            // Filtrage manuel pour être sûr
            const myRows = data.rows.filter(r => r.user === account);

            log(`7. Résultats bruts reçus : ${data.rows.length}`, "data");
            log(`8. Résultats après filtre '${account}' : ${myRows.length}`, "success");

            if (myRows.length === 0) {
                log("--- DIAGNOSTIC ---", "info");
                log("La connexion fonctionne (c'est une bonne nouvelle).", "success");
                log("Mais aucune division n'a été trouvée pour ce nom EXACT.", "error");
                log("Causes possibles :", "info");
                log("- Le compte n'a pas de divisions stakées actuellement.", "info");
                log("- Le jeu a changé de table (peu probable).", "info");
            } else {
                log("!!! SUCCÈS !!!", "success");
                myRows.forEach(div => {
                    log(`> Division #${div.division_id} contient ${div.asset_ids.length} cartes.`, "data");
                });
            }

        } catch (e) {
            log("--- ÉCHEC CRITIQUE ---", "error");
            log(e.message, "error");
            
            if (e.message.includes("Failed to fetch")) {
                log("EXPLICATION : C'est une erreur de sécurité (CORS).", "info");
                log("Ton navigateur empêche le site GitHub de parler à WAX.", "info");
                log("Solution : Essaie sur un autre navigateur ou sur mobile en 4G.", "info");
            }
        }
    }
</script>

</body>
</html>
