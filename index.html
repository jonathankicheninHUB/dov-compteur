<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compteur DoV</title>
    <style>
        /* Design simple et propre */
        body { font-family: sans-serif; background-color: #f4f6f8; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; width: 100%; max-width: 400px; }
        h1 { margin-top: 0; color: #333; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 5px; width: 65%; font-size: 16px; margin-bottom: 10px; }
        button { padding: 12px 20px; background-color: #2c3e50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }
        button:hover { background-color: #34495e; }
        button:disabled { background-color: #95a5a6; cursor: not-allowed; }
        .result-box { margin-top: 20px; padding: 20px; background: #e8f6f3; border-radius: 8px; color: #1abc9c; }
        .count { font-size: 50px; font-weight: bold; line-height: 1; }
        .status { margin-top: 10px; font-size: 14px; color: #7f8c8d; }
    </style>
</head>
<body>

<div class="card">
    <h1>Divisions DoV</h1>
    <p>Entrez un compte pour compter ses divisions.</p>
    
    <input type="text" id="accountName" placeholder="Ex: tonnom.wam" />
    <button id="btnAction" onclick="lancerCompteur()">Compter</button>

    <div class="result-box">
        <div class="count" id="displayCount">0</div>
        <div class="status" id="statusMsg">En attente...</div>
    </div>
</div>

<script>
    // Configuration WAX
    const RPC_URL = "https://wax.greymass.com/v1/chain/get_table_rows";
    const CONTRACT = "dovpvecontrl";
    const TABLE = "sdivisions";

    async function lancerCompteur() {
        // 1. Récupérer le nom
        const account = document.getElementById('accountName').value.trim().toLowerCase();
        const display = document.getElementById('displayCount');
        const status = document.getElementById('statusMsg');
        const btn = document.getElementById('btnAction');

        if (!account) { alert("Mets un nom de compte !"); return; }

        // 2. Préparer l'interface
        btn.disabled = true;
        btn.innerText = "Calcul...";
        status.innerText = "Chargement des données...";
        display.innerText = "0";

        let total = 0;
        let more = true;
        let nextKey = ""; // Pour la pagination

        try {
            // 3. Boucle tant qu'il y a des résultats (pour gérer les +1000)
            while (more) {
                // Requête directe à la blockchain (pas besoin de plugin)
                const response = await fetch(RPC_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        json: true,
                        code: CONTRACT,
                        scope: CONTRACT,
                        table: TABLE,
                        index_position: 2,     // Trie par USER
                        key_type: 'i64',       // Format de clé standard
                        lower_bound: nextKey || account, // Commence au compte
                        upper_bound: account,  // S'arrête APRES le compte (filtre)
                        limit: 1000            // Maximum autorisé par WAX
                    })
                });

                const data = await response.json();

                if (!data.rows) throw new Error("Erreur API WAX");

                // Filtrage de sécurité (garder uniquement les lignes du user)
                const mesDivisions = data.rows.filter(r => r.user === account);
                total += mesDivisions.length;

                // Mise à jour visuelle immédiate
                display.innerText = total;
                status.innerText = `Analyse en cours... (${total} trouvées)`;

                // Vérifier s'il y a une page suivante
                more = data.more;
                if (more && data.next_key) {
                    nextKey = data.next_key;
                }
            }

            status.innerText = "Calcul terminé avec succès.";
            
        } catch (error) {
            console.error(error);
            status.innerText = "Erreur : " + error.message;
        }

        btn.disabled = false;
        btn.innerText = "Compter";
    }
</script>

</body>
</html>
