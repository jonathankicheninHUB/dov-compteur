<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DoV - COMMAND V279 (DRILL DOWN)</title>
    <style>
        /* --- DESIGN SYSTEM : FINANCIAL DARK --- */
        :root {
            --bg-app: #0b0c10; --bg-panel: #13141b; --bg-header: #1c1d26; --border: #2d2e3a;
            --green: #00f090; --red: #ff3b30; --blue: #2979ff; --orange: #ff9100; --purple: #d500f9; --yellow: #ffea00;
            --text-main: #e0e0e0; --text-muted: #858595;
            --font-ui: 'Inter', system-ui, sans-serif; --font-num: 'JetBrains Mono', 'Consolas', monospace; 
        }

        body { background: var(--bg-app); color: var(--text-muted); font-family: var(--font-ui); margin: 0; display: flex; height: 100vh; overflow: hidden; font-size: 11px; }
        * { box-sizing: border-box; }
        ::-webkit-scrollbar { width: 6px; background: var(--bg-app); } ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        .layout { display: flex; width: 100%; height: 100%; }
        .sidebar { width: 250px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 15px; gap: 20px; flex-shrink: 0; }
        .main-content { flex: 1; overflow-y: auto; padding: 25px; background: linear-gradient(180deg, var(--bg-app) 0%, #08080a 100%); display:flex; flex-direction:column; }

        .app-title { color: #fff; font-weight: 800; font-size: 14px; letter-spacing: 1px; display:flex; align-items:center; gap:8px; }
        .status-dot { width: 8px; height: 8px; background: var(--green); border-radius: 50%; box-shadow: 0 0 8px var(--green); }
        .control-group { display: flex; flex-direction: column; gap: 8px; }
        .grp-lbl { font-size: 9px; font-weight: 700; color: #555; text-transform: uppercase; letter-spacing: 0.5px; }
        
        input { background: #08080a; border: 1px solid #333; color: #fff; padding: 8px; border-radius: 4px; font-family: var(--font-num); width: 100%; }
        button { padding: 9px; border: none; border-radius: 4px; font-weight: 700; font-size: 10px; text-transform: uppercase; cursor: pointer; transition: 0.2s; width: 100%; }
        button:hover { filter: brightness(1.1); transform: translateY(-1px); }
        
        .btn-green { background: var(--green); color: #000; } .btn-red { background: rgba(255, 59, 48, 0.15); color: var(--red); border: 1px solid rgba(255, 59, 48, 0.3); }
        .btn-blue { background: var(--blue); color: #fff; } .btn-orange { background: var(--orange); color: #000; }
        .btn-purple { background: var(--purple); color: #fff; }
        .btn-ghost { background: transparent; border: 1px solid #333; color: #888; }
        .btn-row { display: flex; gap: 8px; }

        .dashboard-header { display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 15px; border-bottom: 1px solid var(--border); margin-bottom: 25px; }
        .page-h1 { font-size: 20px; font-weight: 800; color: #fff; margin: 0; }
        .total-cost { text-align: right; }
        .tc-val { font-family: var(--font-num); font-size: 24px; font-weight: 700; color: #fff; }
        .tc-unit { color: var(--purple); font-size: 12px; font-weight: 700; }

        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
        .kpi-card { 
            background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; padding: 15px; 
            position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between; 
            min-height: 140px; 
        }
        .kpi-card::before { content:''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
        .kc-title { font-size: 10px; font-weight: 700; color: #888; text-transform: uppercase; }
        .kc-val { font-family: var(--font-num); font-size: 20px; font-weight: 700; color: #fff; margin-top: 2px; }
        .kc-val-huge { font-family: var(--font-num); font-size: 26px; font-weight: 800; color: #fff; margin-top: 2px; letter-spacing: -1px; }
        .kc-sub { font-size: 10px; color: #666; font-family: var(--font-num); margin-top: auto; }
        .kc-sep { height:1px; background:rgba(255,255,255,0.1); margin:8px 0; }

        .fuel .kpi-card::before { background: var(--orange); } .fuel .kc-val, .fuel .kc-val-huge { color: var(--orange); } 
        .health .kpi-card::before { background: var(--red); } .health .kc-val, .health .kc-val-huge { color: var(--red); } 
        .repair .kpi-card::before { background: var(--blue); } .repair .kc-val, .repair .kc-val-huge { color: var(--blue); } 
        .supply .kpi-card::before { background: var(--yellow); } .supply .kc-val, .supply .kc-val-huge { color: var(--yellow); } 

        .pie-container { display: flex; align-items: center; justify-content: center; height: 100%; }
        .pie-chart { width: 80px; height: 80px; border-radius: 50%; background: conic-gradient(var(--green) 0% 0%, #333 0% 100%); display: flex; align-items: center; justify-content: center; position: relative; }
        .pie-chart::after { content: ''; position: absolute; width: 60px; height: 60px; background: var(--bg-panel); border-radius: 50%; }
        .pie-val { position: absolute; z-index: 2; font-family: var(--font-num); font-weight: 700; color: #fff; font-size: 14px; }

        .tables-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start; }
        .data-panel { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; display: flex; flex-direction: column; }
        .dp-head { padding: 10px 15px; background: var(--bg-header); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .dp-title { font-weight: 800; font-size: 11px; color: #fff; text-transform: uppercase; }
        .dp-badges { display: flex; gap: 8px; font-family: var(--font-num); font-size: 10px; }
        .dt-grid { display: grid; grid-template-columns: minmax(140px, 2fr) 50px 70px 90px 90px 70px 70px; }
        .dt-header { padding: 8px 12px; font-size: 9px; font-weight: 700; color: #666; text-transform: uppercase; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2); }
        .dt-row { padding: 6px 12px; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 11px; align-items: center; color: #ccc; transition: 0.1s; }
        .dt-row:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .cell { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .c-right { text-align: right; justify-content: flex-end; }
        .c-center { text-align: center; justify-content: center; }
        
        .zones-map { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .zone-card { background: var(--bg-panel); border: 1px solid var(--border); padding: 10px; border-radius: 4px; display: flex; flex-direction: column; justify-content: space-between; height: 160px; cursor: pointer; transition: 0.2s; }
        .zone-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); border-color: var(--blue); }
        .zone-card.active { border-color: var(--blue); background: rgba(41, 121, 255, 0.05); }
        .zc-top { display: flex; justify-content: space-between; font-weight: 700; color: #fff; font-size: 11px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 4px; margin-bottom: 6px;}
        .zc-mid { display: flex; flex-direction: column; gap: 4px; flex: 1; }
        .zs-item { display: flex; justify-content: space-between; font-family: var(--font-num); font-size: 9px; color: #888; }
        .zc-bot { display: flex; justify-content: space-between; font-size: 10px; font-family: var(--font-num); border-top: 1px solid rgba(255,255,255,0.05); padding-top:4px; margin-top: auto; }
        .tc-f { color: var(--orange); } .tc-h { color: var(--red); } .tc-r { color: var(--blue); } .tc-s { color: var(--yellow); }

        /* INSPECTOR STYLE */
        .abi-layout { display: grid; grid-template-columns: 250px 250px 1fr; gap: 15px; height: 65vh; }
        .abi-col { background: #000; border: 1px solid #333; display: flex; flex-direction: column; overflow: hidden; }
        .abi-title { padding: 8px; background: #1c1d26; color: #fff; font-weight: bold; border-bottom: 1px solid #333; font-size: 10px; }
        .abi-content { overflow-y: auto; flex: 1; padding: 0; }
        .abi-item { padding: 8px 10px; border-bottom: 1px solid #222; cursor: pointer; color: #888; transition: 0.1s; font-family: var(--font-num); font-size: 10px; }
        .abi-item:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .abi-item.selected { background: var(--purple); color: #fff; }
        .abi-json { padding: 15px; font-family: 'Courier New', monospace; color: #0f0; white-space: pre-wrap; font-size: 11px; }

        .view-section { display: none; } .active-view { display: block; }
        a.atomic { color: inherit; text-decoration: none; border-bottom: 1px dotted #444; }
        a.atomic:hover { color: var(--blue); border-bottom-color: var(--blue); }

        .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:999; justify-content:center; align-items:center; }
        .modal-box { width:650px; background:var(--bg-panel); border:1px solid var(--border); padding:20px; border-radius:6px; box-shadow:0 20px 50px #000; max-height:90vh; overflow-y:auto; }
        textarea { width:100%; height:100px; background:#000; border:1px solid #333; color:#ccc; font-family:var(--font-num); padding:10px; }
    </style>
</head>
<body>

<div class="layout">
    <aside class="sidebar">
        <div class="app-title"><div class="status-dot"></div> DOV COMMAND <span style="opacity:0.5; font-weight:400;">V279</span></div>
        
        <div class="control-group">
            <span class="grp-lbl">OPERATIONS</span>
            <div class="btn-row">
                <button class="btn-green" onclick="dispatchGlobalScan()">SCAN GLOBAL</button>
                <button class="btn-red" onclick="stopSignal=true">STOP</button>
            </div>
            <div class="btn-row">
                <button class="btn-blue" onclick="startZoneScan()">ALL ZONES</button>
                <button class="btn-orange" onclick="startEconomyScan()">ECONOMY</button>
            </div>
        </div>

        <div class="control-group">
            <span class="grp-lbl">CONTRACT TOOLS</span>
            <button class="btn-purple" onclick="initInspector()">ABI EXPLORER</button>
        </div>

        <div class="control-group">
            <span class="grp-lbl">TARGET INTELLIGENCE</span>
            <input type="text" id="targetIn" value="u2d2k.c.wam">
            <div class="btn-row">
                <button class="btn-ghost" style="color:#fff" onclick="startTargetDivisions()">DIVISIONS</button>
                <button class="btn-ghost" style="color:#fff" onclick="startTargetBuildings()">BUILDINGS</button>
            </div>
        </div>

        <div class="control-group" style="margin-top:auto">
            <div style="display:flex; justify-content:space-between; font-size:10px; color:#666;">
                <span>DB SIZE</span> <span id="dictSize" style="color:#fff">0</span>
            </div>
            <button class="btn-ghost" onclick="openSettings()">SETTINGS</button>
            <button class="btn-ghost" style="color:var(--red); border-color:var(--red);" onclick="hardReset()">FACTORY RESET</button>
        </div>
    </aside>

    <main class="main-content">
        <div id="viewGlobal" class="view-section active-view">
            <div class="dashboard-header">
                <div>
                    <h2 class="page-h1">GLOBAL PRODUCTION</h2>
                    <div class="page-meta">COLLECTION SCAN &bull; ROWS: <span id="cntRows">0</span></div>
                </div>
                <div class="total-cost">
                    <div class="grp-lbl">DAILY MAINTENANCE</div>
                    <div><span class="tc-val" id="gTotalCost">0</span> <span class="tc-unit">DOVX</span></div>
                </div>
            </div>
            <div class="kpi-grid" id="areaCards"></div>
            <div class="tables-grid" id="areaLists"></div>
        </div>

        <div id="viewZones" class="view-section">
            <div class="dashboard-header" style="border-left: 4px solid var(--blue)">
                <div>
                    <h2 class="page-h1">GLOBAL WAR MAP</h2>
                    <div class="page-meta">SCANNING COLLECTION: <span id="zTotalDivsHeader" style="color:#fff; font-weight:bold;">0</span> UNITS</div>
                </div>
                <div class="total-cost">
                    <div class="grp-lbl">UTILITY PRODUCTION COST (24H)</div>
                    <div style="font-family:var(--font-num); font-size:14px; font-weight:800; margin-top:4px; letter-spacing:0.5px;">
                        <span class="tc-f">FUEL <span id="gBurnF">0</span></span> <span style="color:#444; margin:0 5px;">|</span>
                        <span class="tc-h">HEALTH <span id="gBurnH">0</span></span> <span style="color:#444; margin:0 5px;">|</span>
                        <span class="tc-r">REPAIR <span id="gBurnR">0</span></span> <span style="color:#444; margin:0 5px;">|</span>
                        <span class="tc-s">SUPPLY <span id="gBurnS">0</span></span>
                    </div>
                </div>
            </div>
            
            <div class="kpi-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom:20px;">
                <div class="kpi-card">
                    <div class="kc-title">TOTAL DIVISIONS</div>
                    <div class="kc-val" id="zTotalDivs">0</div>
                    <div class="kc-sub">ALL PLAYERS STAKED</div>
                </div>
                <div class="kpi-card">
                    <div class="kc-title">IN FIGHT</div>
                    <div class="kc-val" id="zActiveDivs" style="color:var(--green)">0</div>
                    <div class="kc-sub">TIMER ACTIVE</div>
                </div>
                <div class="kpi-card" style="align-items:center; justify-content:center;">
                    <div class="pie-container">
                        <div class="pie-chart" id="zPieChart">
                            <span class="pie-val" id="zPieVal">0%</span>
                        </div>
                    </div>
                    <div class="kc-sub" style="margin-top:5px; text-align:center;">ACTIVE RATIO</div>
                </div>
                <div class="kpi-card">
                    <div class="kc-title">TOTAL DOVX MINT</div>
                    <div class="kc-val" id="zTotalProd" style="color:var(--purple)">0</div>
                    <div class="kc-sub">GLOBAL DAILY YIELD</div>
                </div>
            </div>

            <div class="zones-map" id="areaZones"></div>
        </div>

        <div id="viewInspector" class="view-section">
            <div class="dashboard-header" style="border-left: 4px solid var(--purple)">
                <div><h2 class="page-h1">DEEP SCOPE HUNTER</h2><div class="page-meta">CONTRACTS: dovutilstake, dovpvecontrl</div></div>
            </div>
            <div class="abi-layout">
                <div class="abi-col"><div class="abi-title">1. TABLES (ABI)</div><div class="abi-content" id="inspTables"></div></div>
                <div class="abi-col"><div class="abi-title">2. SCOPES (DATA POCKETS)</div><div class="abi-content" id="inspScopes"></div></div>
                <div class="abi-col"><div class="abi-title">3. RAW DATA (JSON)</div><div class="abi-content abi-json" id="inspData">Select a Table then a Scope to extract data.</div></div>
            </div>
        </div>

        <div id="viewEco" class="view-section"><div class="dashboard-header" style="border-left: 4px solid var(--orange)"><h2 class="page-h1">MACRO ECONOMICS</h2><div class="page-meta" id="ecoStatus">Ready.</div></div></div>
        <div id="viewTarget" class="view-section"><div class="dashboard-header"><h2 class="page-h1">TARGET INSPECTOR</h2><div class="page-meta" id="targetMeta">Ready.</div></div><div id="areaTarget" class="tables-grid" style="grid-template-columns: 1fr;"></div></div>
    </main>
</div>

<div class="modal-overlay" id="settingsModal"><div class="modal-box">
    <h3 style="margin-top:0; color:#fff; border-bottom:1px solid #333; padding-bottom:10px;">SYSTEM CONFIG</h3>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:15px;">
        <div style="grid-column: 1 / -1;"><span class="grp-lbl">RPC NODES</span><textarea id="cfgApi"></textarea></div>
        <div><span class="grp-lbl">RESOURCES</span><textarea id="cfgResources"></textarea></div>
        <div><span class="grp-lbl">RULES</span><textarea id="cfgGameRules"></textarea></div>
        <div><span class="grp-lbl">ZONES</span><textarea id="cfgZones"></textarea></div>
        <div><span class="grp-lbl">TEMPLATES</span><textarea id="cfgTemplates"></textarea></div>
        <div style="grid-column: 1 / -1;"><span class="grp-lbl">DIVISIONS</span><textarea id="cfgDivisions"></textarea></div>
    </div>
    <div style="text-align:right; margin-top:15px;">
        <button class="btn-green" style="width:auto; display:inline-block;" onclick="saveConfig()">SAVE & RESTART</button>
        <button class="btn-ghost" style="width:auto; display:inline-block;" onclick="closeModal('settingsModal')">CANCEL</button>
    </div>
</div></div>

<div class="modal-overlay" id="zoneDetailModal"><div class="modal-box" style="width:800px;">
    <h3 id="zdTitle" style="margin-top:0; color:#fff; border-bottom:1px solid #333; padding-bottom:10px; display:flex; justify-content:space-between;">ZONE DETAIL <span style="color:var(--blue)" id="zdCount">0 UNITS</span></h3>
    <div style="height:400px; overflow-y:auto; margin-top:15px;">
        <div class="dt-grid dt-header" style="grid-template-columns: 1fr 100px 100px 100px 80px;">
            <div class="cell">OWNER</div><div class="cell c-right">ASSET ID</div><div class="cell c-right">WEIGHT</div><div class="cell c-right">MINT</div><div class="cell c-center">LINK</div>
        </div>
        <div id="zdList"></div>
    </div>
    <div style="text-align:right; margin-top:15px;">
        <button class="btn-ghost" style="width:auto; display:inline-block;" onclick="closeModal('zoneDetailModal')">CLOSE</button>
    </div>
</div></div>

<script>
    const STORAGE_KEY = 'DOV_DATA_V279';
    const getId = (id) => document.getElementById(id);
    const closeModal = (id) => getId(id).style.display = 'none';
    const switchView = (id) => { document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active-view')); getId(id).classList.add('active-view'); };
    const fmt = (n) => n.toLocaleString('fr-FR', {maximumFractionDigits: 0});
    const fmtDec = (n) => n.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2});

    const DEFAULT_DATA = {
        apiConfig: { 
            rpcNodes: [
                "https://wax.greymass.com", "https://wax.eosio.online", "https://wax.api.eosnation.io", 
                "https://wax.pink.gg", "https://api.wax.alohaeos.com", "https://wax.dapplica.io",
                "https://api.waxsweden.org", "https://wax.eosphere.io", "https://wax.eu.eosamsterdam.net",
                "https://api.wax.liquidstudios.io", "https://wax.cryptolions.io", "https://api-wax.eosauthority.com",
                "https://wax.eosdac.io", "https://api.wax.bountyblok.io", "https://wax.blacklusion.io",
                "https://wax-bp.wizardsguild.one", "https://api.wax.greeneosio.com", "https://wax.publicnode.com",
                "https://api.wax.luminarys.io", "https://wax.tmy.io"
            ]
        },
        resourceDefs: { "F": { label: "FUEL", class: "fuel" }, "H": { label: "HEALTH", class: "health" }, "R": { label: "REPAIR", class: "repair" }, "S": { label: "SUPPLY", class: "supply" } },
        gameConfig: { maintenanceCost: 0.085, cycleHours: 24, rewardRatio: 0.1, tokenMap: { "DOVF": "F", "DOVH": "H", "DOVR": "R", "DOVS": "S" } },
        templates: { /* COMPRESSED FOR BREVITY */ 
            "FUEL": { "490122": { "name": "C_F1_PRODUCER_FUEL", "prod": 5.4 }, "492363": { "name": "C_F2_PRODUCER_FUEL", "prod": 12.15 }, "492366": { "name": "C_F3_PRODUCER_FUEL", "prod": 30.38 }, "492368": { "name": "C_F4_PRODUCER_FUEL", "prod": 83.53 }, "492373": { "name": "R_F1_PRODUCER_FUEL", "prod": 16.20 }, "492376": { "name": "R_F2_PRODUCER_FUEL", "prod": 36.45 }, "492379": { "name": "R_F3_PRODUCER_FUEL", "prod": 91.13 }, "492381": { "name": "R_F4_PRODUCER_FUEL", "prod": 250.59 }, "492383": { "name": "E_F1_PRODUCER_FUEL", "prod": 48.60 }, "492385": { "name": "E_F2_PRODUCER_FUEL", "prod": 109.35 }, "492386": { "name": "E_F3_PRODUCER_FUEL", "prod": 273.38 }, "492387": { "name": "E_F4_PRODUCER_FUEL", "prod": 751.78 }, "492389": { "name": "L_F1_PRODUCER_FUEL", "prod": 145.80 }, "492390": { "name": "L_F2_PRODUCER_FUEL", "prod": 328.05 }, "492391": { "name": "L_F3_PRODUCER_FUEL", "prod": 820.13 }, "492392": { "name": "L_F4_PRODUCER_FUEL", "prod": 2255.34 }, "544068": { "name": "S1_OWNER_FUEL", "prod": 2255.34 } },
            "HEALTH": { "492394": { "name": "C_F1_PRODUCER_HEALTH", "prod": 5.4 }, "492395": { "name": "C_F2_PRODUCER_HEALTH", "prod": 12.15 }, "492396": { "name": "C_F3_PRODUCER_HEALTH", "prod": 30.38 }, "492397": { "name": "C_F4_PRODUCER_HEALTH", "prod": 83.53 }, "492399": { "name": "R_F1_PRODUCER_HEALTH", "prod": 16.20 }, "492401": { "name": "R_F2_PRODUCER_HEALTH", "prod": 36.45 }, "492535": { "name": "R_F3_PRODUCER_HEALTH", "prod": 91.13 }, "492537": { "name": "R_F4_PRODUCER_HEALTH", "prod": 250.59 }, "492539": { "name": "E_F1_PRODUCER_HEALTH", "prod": 48.60 }, "492543": { "name": "E_F2_PRODUCER_HEALTH", "prod": 109.35 }, "492545": { "name": "E_F3_PRODUCER_HEALTH", "prod": 273.38 }, "492546": { "name": "E_F4_PRODUCER_HEALTH", "prod": 751.78 }, "492550": { "name": "L_F1_PRODUCER_HEALTH", "prod": 145.80 }, "492554": { "name": "L_F2_PRODUCER_HEALTH", "prod": 328.05 }, "492555": { "name": "L_F3_PRODUCER_HEALTH", "prod": 820.13 }, "492557": { "name": "L_F4_PRODUCER_HEALTH", "prod": 2255.34 }, "544070": { "name": "S1_OWNER_HEALTH", "prod": 2255.34 } },
            "REPAIR": { "492559": { "name": "C_F1_PRODUCER_REPAIR", "prod": 5.4 }, "492560": { "name": "C_F2_PRODUCER_REPAIR", "prod": 12.15 }, "492561": { "name": "C_F3_PRODUCER_REPAIR", "prod": 30.38 }, "492562": { "name": "C_F4_PRODUCER_REPAIR", "prod": 83.53 }, "492563": { "name": "R_F1_PRODUCER_REPAIR", "prod": 16.20 }, "492465": { "name": "R_F2_PRODUCER_REPAIR", "prod": 36.45 }, "492566": { "name": "R_F3_PRODUCER_REPAIR", "prod": 91.13 }, "492568": { "name": "R_F4_PRODUCER_REPAIR", "prod": 250.59 }, "492964": { "name": "E_F1_PRODUCER_REPAIR", "prod": 48.60 }, "492965": { "name": "E_F2_PRODUCER_REPAIR", "prod": 109.35 }, "492966": { "name": "E_F3_PRODUCER_REPAIR", "prod": 273.38 }, "492967": { "name": "E_F4_PRODUCER_REPAIR", "prod": 751.78 }, "492572": { "name": "L_F1_PRODUCER_REPAIR", "prod": 145.80 }, "492579": { "name": "L_F2_PRODUCER_REPAIR", "prod": 328.05 }, "492582": { "name": "L_F3_PRODUCER_REPAIR", "prod": 820.13 }, "492583": { "name": "L_F4_PRODUCER_REPAIR", "prod": 2255.34 }, "544061": { "name": "S1_OWNER_REPAIR", "prod": 2255.34 } },
            "SUPPLY": { "492585": { "name": "C_F1_PRODUCER_SUPPLY", "prod": 5.4 }, "492587": { "name": "C_F2_PRODUCER_SUPPLY", "prod": 12.15 }, "492589": { "name": "C_F3_PRODUCER_SUPPLY", "prod": 30.38 }, "492702": { "name": "C_F4_PRODUCER_SUPPLY", "prod": 83.53 }, "492703": { "name": "R_F1_PRODUCER_SUPPLY", "prod": 16.20 }, "492704": { "name": "R_F2_PRODUCER_SUPPLY", "prod": 36.45 }, "492706": { "name": "R_F3_PRODUCER_SUPPLY", "prod": 91.13 }, "492707": { "name": "R_F4_PRODUCER_SUPPLY", "prod": 250.59 }, "492708": { "name": "E_F1_PRODUCER_SUPPLY", "prod": 48.60 }, "492709": { "name": "E_F2_PRODUCER_SUPPLY", "prod": 109.35 }, "492710": { "name": "E_F3_PRODUCER_SUPPLY", "prod": 273.38 }, "492711": { "name": "E_F4_PRODUCER_SUPPLY", "prod": 751.78 }, "492712": { "name": "L_F1_PRODUCER_SUPPLY", "prod": 145.80 }, "492713": { "name": "L_F2_PRODUCER_SUPPLY", "prod": 328.05 }, "492714": { "name": "L_F3_PRODUCER_SUPPLY", "prod": 820.13 }, "492715": { "name": "L_F4_PRODUCER_SUPPLY", "prod": 2255.34 }, "544064": { "name": "S1_OWNER_SUPPLY", "prod": 2255.34 } }
        }
    };

    const SMART_ZONES_BIBLE = {
        1: { name:"Beach 1", cost:1160, win:400, draw:398, loss:396, wWin:13.92, wDraw:11.44, wLoss:9.66 },
        2: { name:"Beach 2", cost:6968, win:2405, draw:2393, loss:2380, wWin:27.29, wDraw:20.58, wLoss:17.50 },
        3: { name:"Beach 3", cost:8800, win:3037, draw:3021, loss:3006, wWin:54.59, wDraw:41.17, wLoss:35.00 },
        4: { name:"Bunker", cost:11120, win:3838, draw:3818, loss:3798, wWin:108.53, wDraw:82.33, wLoss:69.99 },
        5: { name:"Forest 1", cost:14024, win:4840, draw:4815, loss:4790, wWin:218.35, wDraw:164.66, wLoss:139.99 },
        6: { name:"Forest 2", cost:17704, win:6110, draw:6079, loss:6047, wWin:341.18, wDraw:280.68, wLoss:255.18 },
        7: { name:"Forest 3", cost:22352, win:7714, draw:7675, loss:7635, wWin:450.00, wDraw:450.00, wLoss:450.00 },
        8: { name:"Camp", cost:28220, win:9739, draw:9689, loss:9640, wWin:511.76, wDraw:421.02, wLoss:382.78 },
        9: { name:"Hill 1", cost:37052, win:12788, draw:12722, loss:12657, wWin:694.78, wDraw:547.61, wLoss:415.82 },
        10: { name:"Hill 2", cost:48652, win:16791, draw:16705, loss:16649, wWin:868.55, wDraw:684.56, wLoss:519.82 },
        11: { name:"Hill 3", cost:64516, win:22266, draw:22151, loss:22038, wWin:1085.69, wDraw:891.36, wLoss:649.77 },
        12: { name:"Radar", cost:84712, win:29236, draw:29086, loss:28937, wWin:1357.04, wDraw:1114.14, wLoss:812.17 },
        13: { name:"Plain 1", cost:99384, win:34300, draw:34123, loss:33948, wWin:1696.33, wDraw:1392.70, wLoss:1298.56 },
        14: { name:"Plain 2", cost:125708, win:43385, draw:43162, loss:42940, wWin:1865.84, wDraw:1710.00, wLoss:1428.32 },
        15: { name:"Plain 3", cost:151164, win:52171, draw:51902, loss:51636, wWin:2051.96, wDraw:1880.57, wLoss:1570.79 },
        16: { name:"HQ", cost:188000, win:64884, draw:64549, loss:64219, wWin:2494.23, wDraw:2069.13, wLoss:1728.29 },
        17: { name:"City 1", cost:1664, win:0, draw:0, loss:0, wWin:108.53, wDraw:82.33, wLoss:69.99 },
        18: { name:"City 2", cost:4448, win:0, draw:0, loss:0, wWin:511.76, wDraw:421.02, wLoss:382.78 },
        19: { name:"City 3", cost:13440, win:0, draw:0, loss:0, wWin:1357.04, wDraw:1114.14, wLoss:812.17 },
        20: { name:"Bridge", cost:29856, win:0, draw:0, loss:0, wWin:2494.23, wDraw:2069.13, wLoss:1728.29 }
    };

    let DATA = JSON.parse(JSON.stringify(DEFAULT_DATA));
    let stopSignal = false;
    let currentContract = ""; let currentTable = "";
    // V279: STORAGE FOR DETAIL VIEW
    let zoneDetailsCache = {}; 

    function init() {
        const local = localStorage.getItem(STORAGE_KEY);
        if(local) { try { let loaded = JSON.parse(local); DATA = { ...DEFAULT_DATA, ...loaded, templates: { ...DEFAULT_DATA.templates, ...loaded.templates } }; } catch(e){} }
        getId('dictSize').innerText = Object.keys(DATA.templates).length;
        buildUI();
    }

    function buildUI() {
        const areaC = getId('areaCards'); const areaL = getId('areaLists');
        areaC.innerHTML = ''; areaL.innerHTML = '';
        const order = ["F", "H", "R", "S"];
        
        for(let k of order) {
            let rd = DATA.resourceDefs[k];
            areaC.innerHTML += `
            <div class="kpi-card ${rd.class}">
                <div><div class="kc-title">${rd.label} / HOUR</div><div class="kc-val" id="val-${k}">0</div></div>
                <div class="kc-sep"></div>
                <div><div class="kc-title" style="color:#fff; opacity:0.8;">DAILY PRODUCTION</div><div class="kc-val-huge" id="val24-${k}">0</div></div>
                <div class="kc-sub" id="act-${k}">0 ACTIVE</div>
            </div>`;
            
            areaL.innerHTML += `
            <div class="data-panel">
                <div class="dp-head"><span class="dp-title">${rd.label} BREAKDOWN</span><div class="dp-badges"><span style="color:#888">PROD:</span> <span id="btot-${k}" style="color:#fff">0</span> <span style="color:#888; margin-left:5px;">COST:</span> <span id="bcost-${k}" style="color:var(--purple)">0</span></div></div>
                <div class="dt-grid dt-header"><div class="cell">TEMPLATE</div><div class="cell c-center">ACT / TOT</div><div class="cell c-right">UNIT</div><div class="cell c-right">PROD/H</div><div class="cell c-right">PROD/24</div><div class="cell c-right" style="color:var(--purple)">COST/H</div><div class="cell c-right" style="color:var(--purple)">COST/24</div></div>
                <div id="tbl-${k}"></div>
            </div>`;
        }
    }

    function findTemplate(tid) {
        if(DATA.templates.FUEL[tid]) return { ...DATA.templates.FUEL[tid], type:'F' };
        if(DATA.templates.HEALTH[tid]) return { ...DATA.templates.HEALTH[tid], type:'H' };
        if(DATA.templates.REPAIR[tid]) return { ...DATA.templates.REPAIR[tid], type:'R' };
        if(DATA.templates.SUPPLY[tid]) return { ...DATA.templates.SUPPLY[tid], type:'S' };
        return null;
    }

    async function fetchSmartCluster(endpoint, body) {
        let nodes = DATA.apiConfig.rpcNodes;
        let shuffled = [...nodes].sort(() => 0.5 - Math.random());
        for(let i=0; i<shuffled.length; i++) { 
            let node = shuffled[i];
            try {
                let controller = new AbortController();
                setTimeout(() => controller.abort(), 2500); 
                let res = await fetch(node + endpoint, { method: 'POST', body: body, signal: controller.signal });
                if(res.ok) return await res.json();
            } catch(e) { }
        }
        throw new Error("CLUSTER UNREACHABLE");
    }

    async function dispatchGlobalScan() {
        stopSignal = false; switchView('viewGlobal'); getId('cntRows').innerText = "...";
        let next = ""; 
        let stats = { totalCost:0, types:{F:{p:0,c:0,a:0,t:0}, H:{p:0,c:0,a:0,t:0}, R:{p:0,c:0,a:0,t:0}, S:{p:0,c:0,a:0,t:0}} }; 
        let groups = {F:[], H:[], R:[], S:[]};
        let rowCount = 0; let assetCount = 0;
        try {
            while(!stopSignal) {
                let res = await fetchSmartCluster("/v1/chain/get_table_rows", JSON.stringify({json:true, code:"dovutilstake", scope:"dovutilstake", table:"buildings", limit:1000, lower_bound:next}));
                if(!res.rows || res.rows.length === 0) break;
                const now = Date.now()/1000;
                for(let r of res.rows) {
                    let tid = r.template_id.toString();
                    let tpl = findTemplate(tid); if(!tpl) continue;
                    rowCount++; let count = r.asset_ids ? r.asset_ids.length : 1; assetCount += count;
                    stats.types[tpl.type].t += count;
                    let isActive = now < (parseFloat(r.last_claim) + parseFloat(r.delay));
                    if(isActive) stats.types[tpl.type].a += count;
                    let existing = groups[tpl.type].find(x => x.name === tpl.name);
                    if(!existing) { existing = { id:tid, name:tpl.name, act:0, tot:0, unit:tpl.prod, totH:0, totD:0, costH:0, costD:0 }; groups[tpl.type].push(existing); }
                    existing.tot += count;
                    if(isActive) {
                        let hourly = count * tpl.prod; let daily = hourly * 24; let costD = daily * 0.085; let costH = costD / 24;
                        existing.act += count; existing.totH += hourly; existing.totD += daily; existing.costH += costH; existing.costD += costD;
                        stats.types[tpl.type].p += hourly; stats.types[tpl.type].c += costD; stats.totalCost += costD;
                    }
                }
                updateGlobalUI(rowCount, assetCount, stats, groups);
                if(res.more) next = res.next_key; else break; await new Promise(r => setTimeout(r, 50));
            }
        } catch(e) { console.error(e); }
    }

    function updateGlobalUI(rows, assets, stats, groups) {
        getId('cntRows').innerText = fmt(rows); getId('gTotalCost').innerText = fmt(stats.totalCost);
        for(let k in DATA.resourceDefs) {
            let rd = DATA.resourceDefs[k];
            getId(`val-${k}`).innerText = fmtDec(stats.types[k].p); 
            getId(`val24-${k}`).innerText = fmtDec(stats.types[k].p * 24);
            getId(`act-${k}`).innerText = fmt(stats.types[k].a) + " ACTIVE";
            getId(`btot-${k}`).innerText = fmtDec(stats.types[k].p); 
            getId(`bcost-${k}`).innerText = fmt(stats.types[k].c);
            let list = groups[k].sort((a,b) => b.totH - a.totH);
            let html = "";
            list.forEach(i => {
                let link = `https://wax.atomichub.io/explorer/template/wax-mainnet/dovdivisions/${i.id}`;
                html += `<div class="dt-grid dt-row"><div class="cell"><a href="${link}" target="_blank" class="atomic">${i.name}</a></div><div class="cell c-center" style="font-weight:700;"><span style="color:var(--green)">${i.act}</span> / <span style="color:#666">${i.tot}</span></div><div class="cell c-right" style="color:#666">${fmtDec(i.unit)}</div><div class="cell c-right ${rd.class}" style="font-weight:700;">${fmtDec(i.totH)}</div><div class="cell c-right" style="color:#888;">${fmtDec(i.totD)}</div><div class="cell c-right" style="color:var(--purple)">${fmtDec(i.costH)}</div><div class="cell c-right" style="color:var(--purple)">${fmtDec(i.costD)}</div></div>`;
            });
            getId(`tbl-${k}`).innerHTML = html;
        }
    }

    function getEndTime(row) {
        let keys = ['unlock_time', 'end_time', 'finish_time', 'lock_until', 'free_at', 'return_time'];
        for (let k of keys) { if (row[k] !== undefined && row[k] !== null) return parseFloat(row[k]); }
        return 0;
    }

    async function startZoneScan() {
        stopSignal = false; switchView('viewZones'); getId('zTotalDivsHeader').innerText = "SCANNING...";
        
        let stats = { totalDivs: 0, activeDivs: 0, totalProd: 0, totalWeight: 0, burnF:0, burnH:0, burnR:0, burnS:0 };
        // V279: Reset Cache
        zoneDetailsCache = {}; 
        Object.keys(SMART_ZONES_BIBLE).forEach(id => { 
            zoneDetailsCache[id] = []; // Array to store divisions for modal
        });
        let zonesData = {}; Object.keys(SMART_ZONES_BIBLE).forEach(id => { zonesData[id] = { count: 0, active: 0, prod: 0, weight: 0, bf:0, bh:0, br:0, bs:0 }; });
        updateZoneUI(zonesData, stats); 
        
        let next = "";
        try {
            while(!stopSignal) {
                let json = await fetchSmartCluster("/v1/chain/get_table_rows", JSON.stringify({json:true, code:"dovpvecontrl", scope:"dovpvecontrl", table:"sdivisions", limit:1000, lower_bound:next}));
                if(!json.rows) break;
                const nowSec = Date.now()/1000;
                for(let r of json.rows) {
                    let zid = r.zone_id || r.zoneID;
                    if(zonesData[zid]) {
                        zonesData[zid].count++; stats.totalDivs++;
                        let weight = parseFloat(r.weight || r.power || 0);
                        zonesData[zid].weight += weight; stats.totalWeight += weight;
                        let endTime = getEndTime(r); let isFighting = false;
                        if (endTime > 1000000000000) isFighting = endTime > Date.now(); else isFighting = endTime > nowSec;
                        if(isFighting) {
                            zonesData[zid].active++; stats.activeDivs++;
                            let zConf = SMART_ZONES_BIBLE[zid];
                            
                            let currentCost = zConf.cost;
                            zonesData[zid].bf += currentCost; zonesData[zid].bh += currentCost; zonesData[zid].br += currentCost; zonesData[zid].bs += currentCost;
                            stats.burnF += currentCost; stats.burnH += currentCost; stats.burnR += currentCost; stats.burnS += currentCost;
                            
                            let reward = 0;
                            if(weight >= zConf.wWin) reward = zConf.win;
                            else if(weight >= zConf.wDraw) reward = zConf.draw;
                            else if(weight >= zConf.wLoss) reward = zConf.loss;
                            else reward = 0;
                            
                            zonesData[zid].prod += reward; stats.totalProd += reward;

                            // V279: STORE FOR MODAL
                            // Use asset_id if available, or try to use primary key from dump logic (which was messy, so we fallback safely)
                            let assetId = r.asset_id || r.id || "N/A"; 
                            zoneDetailsCache[zid].push({ owner: r.owner, asset: assetId, weight: weight, reward: reward });
                        }
                    }
                }
                updateZoneUI(zonesData, stats);
                if(!json.more) break; next = json.next_key; await new Promise(r => setTimeout(r, 50));
            }
        } catch(e) { console.error(e); }
        getId('zoneStatus').innerText = "Complete.";
    }

    function updateZoneUI(zonesData, stats) {
        getId('zTotalDivsHeader').innerText = fmt(stats.totalDivs);
        getId('zTotalDivs').innerText = fmt(stats.totalDivs);
        getId('zActiveDivs').innerText = fmt(stats.activeDivs);
        
        let activePct = stats.totalDivs > 0 ? (stats.activeDivs / stats.totalDivs) * 100 : 0;
        let pChart = getId('zPieChart');
        if(pChart) {
            pChart.style.background = `conic-gradient(var(--green) 0% ${activePct}%, #333 ${activePct}% 100%)`;
            getId('zPieVal').innerText = activePct.toFixed(0) + "%";
        }

        getId('zTotalProd').innerText = fmt(stats.totalProd); 
        getId('gBurnF').innerText = fmt(stats.burnF); getId('gBurnH').innerText = fmt(stats.burnH); getId('gBurnR').innerText = fmt(stats.burnR); getId('gBurnS').innerText = fmt(stats.burnS);
        
        let html = "";
        Object.keys(zonesData).forEach(id => {
            let z = SMART_ZONES_BIBLE[id];
            let d = zonesData[id];
            let activeClass = d.count > 0 ? "active" : "";
            // V279: CLICK EVENT added, Labels changed, WEIGHT removed
            html += `<div class="zone-card ${activeClass}" onclick="openZoneDetail('${id}')">
                <div class="zc-top"><span>${z.name}</span> <span style="color:${d.active>0?'var(--green)':'#666'}">${d.active} FIGHT</span> / <span style="color:#fff">${d.count} TOT</span></div>
                <div class="zc-mid">
                    <div class="zs-item"><span>MINT (DOVX)</span> <span style="color:var(--purple)">${fmt(d.prod)}</span></div>
                    <div style="height:1px; background:#333; margin:2px 0;"></div>
                    <div class="zs-item" style="color:#888; font-size:9px;">UTILITY COST</div>
                    <div class="zs-item" style="font-size:9px;">
                        <span class="tc-f">${fmt(d.bf)}</span> <span class="tc-h">${fmt(d.bh)}</span> <span class="tc-r">${fmt(d.br)}</span> <span class="tc-s">${fmt(d.bs)}</span>
                    </div>
                </div>
                <div class="zc-bot">
                    <span style="color:#666">MIN W: ${z.wWin}</span>
                    <span style="color:var(--green)">REWARD: ${z.win}</span>
                </div>
            </div>`;
        });
        getId('areaZones').innerHTML = html;
    }

    // V279: MODAL LOGIC
    function openZoneDetail(zid) {
        if(!zoneDetailsCache[zid] || zoneDetailsCache[zid].length === 0) return;
        let list = zoneDetailsCache[zid].sort((a,b) => b.weight - a.weight);
        let zName = SMART_ZONES_BIBLE[zid].name;
        getId('zdTitle').innerHTML = `${zName} <span style="color:var(--blue)">${list.length} FIGHTERS</span>`;
        let html = "";
        list.forEach(i => {
            let link = `https://wax.atomichub.io/explorer/asset/${i.asset}`;
            html += `<div class="dt-grid dt-row" style="grid-template-columns: 1fr 100px 100px 100px 80px;">
                <div class="cell">${i.owner}</div>
                <div class="cell c-right" style="color:#666">${i.asset}</div>
                <div class="cell c-right" style="color:var(--blue)">${fmt(i.weight)}</div>
                <div class="cell c-right" style="color:var(--purple)">${fmt(i.reward)}</div>
                <div class="cell c-center"><a href="${link}" target="_blank" class="btn-ghost" style="padding:2px 6px; font-size:9px;">VIEW</a></div>
            </div>`;
        });
        getId('zdList').innerHTML = html;
        getId('zoneDetailModal').style.display = 'flex';
    }

    async function initInspector() { /* Same V278 */ }
    async function loadScopes(contract, table, el) { /* Same V278 */ }
    async function loadData(scope, el) { /* Same V278 */ }
    async function startEconomyScan() { /* Same V199 */ }
    async function startTargetBuildings() { /* Same V199 */ }
    async function startTargetDivisions() { /* Same V199 */ }
    function openSettings() { /* Same V278 */ }
    function saveConfig() { /* Same V278 */ }
    function hardReset() { if(confirm("FULL RESET?")) { localStorage.removeItem(STORAGE_KEY); location.reload(); } }

    window.onload = init;
</script>
</body>
</html>
