<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DoV - MONITORING V3.2 (Configured)</title>
    <style>
        :root { --main: #00e676; --alert: #ff1744; --sec: #29b6f6; --bg: #111; --panel: #1a1a1a; }
        body { background-color: var(--bg); color: #ddd; font-family: monospace; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* HEADER */
        header { height: 50px; background: #000; border-bottom: 1px solid #333; display: flex; align-items: center; padding: 0 20px; justify-content: space-between; }
        h1 { color: var(--main); margin: 0; font-size: 18px; letter-spacing: 2px; }
        .rpc-status { font-size: 10px; color: #666; }

        /* LAYOUT */
        .layout { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 260px; background: var(--panel); border-right: 1px solid #333; padding: 15px; display: flex; flex-direction: column; gap: 20px; }
        .main-view { flex: 1; padding: 20px; overflow-y: auto; position: relative; }

        /* CONTROLS */
        .box { border: 1px solid #444; padding: 10px; background: #000; }
        .box-title { color: var(--sec); font-size: 11px; font-weight: bold; margin-bottom: 8px; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 4px; }
        
        button { width: 100%; padding: 10px; cursor: pointer; border: none; font-weight: bold; font-family: monospace; text-transform: uppercase; margin-bottom: 5px; }
        .btn-start { background: var(--main); color: #000; } .btn-start:hover { background: #00c853; }
        .btn-stop { background: var(--alert); color: #fff; display: none; }
        .btn-target { background: var(--sec); color: #000; }

        input { width: 100%; padding: 8px; background: #222; border: 1px solid #444; color: #fff; box-sizing: border-box; font-family: monospace; margin-bottom: 5px; }

        /* DASHBOARD */
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat { background: #222; padding: 10px; text-align: center; border: 1px solid #333; }
        .stat-val { display: block; font-size: 22px; color: #fff; font-weight: bold; }
        .stat-lbl { font-size: 10px; color: #888; text-transform: uppercase; }

        /* ZONES */
        .zones-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; }
        .zone { background: #151515; border: 1px solid #333; padding: 10px; cursor: pointer; transition: 0.2s; }
        .zone:hover { border-color: var(--sec); background: #1a1a1a; }
        .z-head { display: flex; justify-content: space-between; font-weight: bold; color: var(--sec); font-size: 13px; }
        .z-sub { font-size: 11px; color: #888; margin-top: 5px; }
        .bar-bg { height: 4px; background: #333; margin-top: 8px; width: 100%; }
        .bar-fill { height: 100%; background: var(--main); width: 0%; transition: width 0.3s; }

        /* TARGET LIST */
        .target-area { display: none; flex-direction: column; gap: 5px; }
        .t-row { display: flex; justify-content: space-between; background: #111; padding: 8px; border-bottom: 1px solid #222; font-size: 12px; }
        .badge { padding: 2px 5px; border-radius: 3px; font-size: 10px; color: #000; font-weight: bold; margin-right: 5px; }
        .b-off { background: #f1c40f; } .b-com { background: #e74c3c; } .b-sup { background: #3498db; }

        /* CONSOLE */
        .logs { height: 120px; background: #000; border-top: 1px solid #333; padding: 10px; font-size: 11px; color: #aaa; overflow-y: auto; font-family: monospace; }
    </style>
</head>
<body>

<header>
    <h1>DoV WAR ROOM <span style="color:#666; font-size:12px">v3.2 Configured</span></h1>
    <span class="rpc-status" id="rpcDisplay">Déconnecté</span>
</header>

<div class="layout">
    <aside class="sidebar">
        <div class="box">
            <div class="box-title">Scanner Global</div>
            <button class="btn-start" id="btnRun" onclick="runGlobal()">LANCER SCAN</button>
            <button class="btn-stop" id="btnStop" onclick="stopSignal=true">STOP</button>
            <div id="statusTxt" style="text-align:center; font-size:10px; color:#666; margin-top:5px">En attente</div>
        </div>

        <div class="box">
            <div class="box-title">Cible Unique</div>
            <input type="text" id="targetIn" value="u2d2k.c.wam" placeholder="Nom du compte">
            <button class="btn-target" onclick="runTarget()">SCANNER JOUEUR</button>
        </div>
    </aside>

    <main class="main-view">
        <div id="dashView">
            <div class="stats-row">
                <div class="stat"><span class="stat-val" id="valDivs">0</span><span class="stat-lbl">Divisions</span></div>
                <div class="stat"><span class="stat-val" id="valPower">0</span><span class="stat-lbl">Puissance</span></div>
                <div class="stat"><span class="stat-val" id="valUnits">0</span><span class="stat-lbl">Unités</span></div>
                <div class="stat"><span class="stat-val" id="valZones">0</span><span class="stat-lbl">Zones Actives</span></div>
            </div>
            <div class="zones-grid" id="zonesArea">
                <div style="color:#444">Cliquez sur "LANCER SCAN" pour charger la carte.</div>
            </div>
        </div>
        <div id="targetView" class="target-area"></div>
    </main>
</div>

<div class="logs" id="console">> Système prêt. Configuration zones chargée.</div>

<script>
    // LISTE DES SERVEURS
    const RPCS = [
        "https://wax.greymass.com",
        "https://wax.eosn.io",
        "https://api.wax.alohaeos.com",
        "https://wax.pink.gg",
        "https://api.waxsweden.org"
    ];

    // CONFIGURATION DES ZONES (Basée sur ta liste)
    // On assume que Beach 1 = ID 1, Beach 2 = ID 2, etc.
    const ZONE_LIST = [
        "Beach 1", "Beach 2", "Beach 3", "Bunker",
        "Forest 1", "Forest 2", "Forest 3", "Camp",
        "Hill 1", "Hill 2", "Hill 3", "Radar",
        "Plain 1", "Plain 2", "Plain 3", "HQ",
        "city 1", "city 2", "city 3", "city 4"
    ];

    // Création du dictionnaire ID -> Nom
    let zoneNames = {};
    ZONE_LIST.forEach((name, index) => {
        zoneNames[index + 1] = name; // ID commence à 1
    });

    let currentRPC = null;
    let stopSignal = false;

    function log(msg, color="#aaa") {
        const c = document.getElementById('console');
        const t = new Date().toLocaleTimeString();
        c.innerHTML = `<div style="color:${color}">[${t}] ${msg}</div>` + c.innerHTML;
    }

    // --- 1. CONNEXION ---
    async function initConnection() {
        if(currentRPC) return currentRPC;
        
        log("Connexion au réseau WAX...", "#29b6f6");
        for(let rpc of RPCS) {
            try {
                await fetch(rpc + "/v1/chain/get_info", { method: 'POST' });
                currentRPC = rpc;
                document.getElementById('rpcDisplay').innerText = "Connecté : " + new URL(rpc).hostname;
                document.getElementById('rpcDisplay').style.color = "#00e676";
                log(`Connecté sur ${rpc}`, "#00e676");
                return rpc;
            } catch(e) {}
        }
        log("ERREUR CRITIQUE : Aucun serveur RPC ne répond.", "#ff1744");
        throw new Error("No RPC");
    }

    // --- 2. SCAN GLOBAL ---
    async function runGlobal() {
        stopSignal = false;
        
        // UI Reset
        document.getElementById('targetView').style.display = 'none';
        document.getElementById('dashView').style.display = 'block';
        document.getElementById('btnRun').style.display = 'none';
        document.getElementById('btnStop').style.display = 'inline-block';
        document.getElementById('zonesArea').innerHTML = "";

        let stats = { divs: 0, power: 0, units: 0, zones: {} };

        try {
            const rpc = await initConnection();
            let nextKey = "";
            let hasMore = true;

            log("DÉMARRAGE DU MONITORING...", "#fff");

            while(hasMore && !stopSignal) {
                document.getElementById('statusTxt').innerText = `Scan... (${stats.divs} divs)`;

                const res = await fetch(rpc + "/v1/chain/get_table_rows", {
                    method: 'POST',
                    body: JSON.stringify({
                        json: true, code: "dovpvecontrl", scope: "dovpvecontrl", table: "sdivisions",
                        limit: 300, lower_bound: nextKey // Gros paquets pour aller vite
                    })
                });

                const data = await res.json();
                if(!data.rows || data.rows.length === 0) break;

                // TRAITEMENT
                for(let row of data.rows) {
                    stats.divs++;
                    const p = parseInt(row.power || 0);
                    stats.power += p;
                    
                    const u = row.units || row.asset_ids || [];
                    stats.units += u.length;

                    const zID = row.zoneID || 0;
                    if(!stats.zones[zID]) stats.zones[zID] = { count: 0, power: 0 };
                    stats.zones[zID].count++;
                    stats.zones[zID].power += p;
                }

                updateUI(stats);

                if(data.more && data.next_key) nextKey = data.next_key;
                else hasMore = false;
            }
            
            if(stopSignal) log("Arrêt manuel.", "orange");
            else log(`SCAN COMPLET TERMINÉ.`, "#00e676");

        } catch(e) {
            log("Erreur: " + e.message, "red");
        }

        document.getElementById('btnStop').style.display = 'none';
        document.getElementById('btnRun').style.display = 'inline-block';
        document.getElementById('statusTxt').innerText = "Terminé";
    }

    // --- 3. SCAN CIBLE ---
    async function runTarget() {
        const user = document.getElementById('targetIn').value.trim().toLowerCase();
        if(!user) return;

        document.getElementById('dashView').style.display = 'none';
        const view = document.getElementById('targetView');
        view.style.display = 'flex';
        view.innerHTML = `<div style="padding:20px; color:#888">Analyse tactique de ${user}...</div>`;

        try {
            const rpc = await initConnection();
            let rows = [];
            let nextKey = user;
            let searching = true;

            while(searching) {
                const res = await fetch(rpc + "/v1/chain/get_table_rows", {
                    method: 'POST',
                    body: JSON.stringify({
                        json: true, code: "dovpvecontrl", scope: "dovpvecontrl", table: "sdivisions",
                        index_position: 2, key_type: "name", lower_bound: nextKey, limit: 100
                    })
                });
                const data = await res.json();
                if(!data.rows || data.rows.length === 0) break;

                for(let r of data.rows) {
                    const owner = r.owner || r.user;
                    if(owner === user) rows.push(r);
                    else if(owner.localeCompare(user) > 0) { searching = false; break; }
                }
                if(searching && data.more) nextKey = data.next_key; else searching = false;
            }

            // Rendu Liste Target
            let html = `<h3 style="padding:10px; border-bottom:1px solid #333; margin:0; color:var(--sec)">${user} : ${rows.length} Divisions Engagées</h3>`;
            
            if(rows.length === 0) html += `<div style="padding:20px; color:orange">Aucune présence détectée.</div>`;

            rows.forEach(r => {
                let badges = "";
                const units = r.units || [];
                units.forEach(u => {
                    let role = (typeof u === 'object') ? u.key : 'unit';
                    let cls = "b-sup";
                    if(role.includes('combat')) cls = "b-com";
                    if(role.includes('officer')) cls = "b-off";
                    badges += `<span class="badge ${cls}"></span>`; // Carrés de couleur
                });
                
                // Nom de la zone pour le joueur
                const zName = zoneNames[r.zoneID] || ("Zone " + r.zoneID);

                html += `
                <div class="t-row">
                    <div style="width:70px; color:var(--main)">#${r.division_id}</div>
                    <div style="flex:1">${badges} <span style="color:#666; font-size:10px">(${units.length})</span></div>
                    <div style="color:var(--sec); width:100px; text-align:right">${zName}</div>
                </div>`;
            });
            view.innerHTML = html;
            log(`Rapport tactique : ${user}`, "#29b6f6");

        } catch(e) {
            log("Erreur cible: " + e.message, "red");
        }
    }

    // --- MISE A JOUR UI ---
    function updateUI(stats) {
        document.getElementById('valDivs').innerText = stats.divs.toLocaleString();
        document.getElementById('valPower').innerText = stats.power.toLocaleString();
        document.getElementById('valUnits').innerText = stats.units.toLocaleString();
        document.getElementById('valZones').innerText = Object.keys(stats.zones).length;

        const grid = document.getElementById('zonesArea');
        let html = "";
        
        // Tri par nombre de divisions
        const sorted = Object.keys(stats.zones).sort((a,b) => stats.zones[b].count - stats.zones[a].count);
        const max = sorted.length ? stats.zones[sorted[0]].count : 1;

        sorted.forEach(id => {
            const z = stats.zones[id];
            const name = zoneNames[id] || `Zone ${id}`;
            const pct = (z.count / max) * 100;
            
            html += `
            <div class="zone" title="ID: ${id}">
                <div class="z-head"><span>${name}</span><span>${z.count}</span></div>
                <div class="z-sub">Puissance: ${z.power.toLocaleString()}</div>
                <div class="bar-bg"><div class="bar-fill" style="width:${pct}%"></div></div>
            </div>`;
        });
        grid.innerHTML = html;
    }
</script>

</body>
</html>
