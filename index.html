<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DoV - COMMAND V342 (FINAL STABLE)</title>
    <style>
        :root {
            --bg-app: #0b0c10; --bg-panel: #13141b; --bg-header: #1c1d26; --border: #2d2e3a;
            --green: #00f090; --red: #ff3b30; --blue: #2979ff; --orange: #ff9100; --purple: #d500f9; --yellow: #ffea00;
            --text-main: #ffffff; --text-muted: #cccccc;
            
            /* ATOMIC HUB RARITY COLORS */
            --r-common: #787878; --r-rare: #4b90ea; --r-epic: #a64dff; --r-leg: #ffae00;
            
            --font-ui: 'Inter', system-ui, sans-serif; --font-num: 'JetBrains Mono', 'Consolas', monospace; 
        }
        body { background: var(--bg-app); color: var(--text-muted); font-family: var(--font-ui); margin: 0; display: flex; height: 100vh; overflow: hidden; font-size: 11px; }
        * { box-sizing: border-box; }
        ::-webkit-scrollbar { width: 6px; background: var(--bg-app); } ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .layout { display: flex; width: 100%; height: 100%; }
        .sidebar { width: 280px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 15px; gap: 15px; flex-shrink: 0; z-index: 10; }
        .main-content { flex: 1; overflow-y: auto; padding: 25px; background: linear-gradient(180deg, var(--bg-app) 0%, #08080a 100%); display:flex; flex-direction:column; }
        .app-title { color: #fff; font-weight: 800; font-size: 14px; letter-spacing: 1px; display:flex; align-items:center; gap:8px; margin-bottom: 10px; }
        .status-dot { width: 8px; height: 8px; background: var(--green); border-radius: 50%; box-shadow: 0 0 8px var(--green); }
        .control-group { display: flex; flex-direction: column; gap: 8px; }
        .grp-lbl { font-size: 9px; font-weight: 700; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
        input, select { background: #08080a; border: 1px solid #333; color: #fff; padding: 8px; border-radius: 4px; font-family: var(--font-num); width: 100%; }
        button { padding: 9px; border: none; border-radius: 4px; font-weight: 700; font-size: 10px; text-transform: uppercase; cursor: pointer; transition: 0.2s; width: 100%; }
        button:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-green { background: var(--green); color: #000; } .btn-red { background: rgba(255, 59, 48, 0.15); color: var(--red); border: 1px solid rgba(255, 59, 48, 0.3); }
        .btn-blue { background: var(--blue); color: #fff; } .btn-orange { background: var(--orange); color: #000; }
        .btn-purple { background: var(--purple); color: #fff; } .btn-yellow { background: var(--yellow); color: #000; }
        .btn-ghost { background: transparent; border: 1px solid #333; color: #888; }
        .btn-row { display: flex; gap: 8px; }
        .console-log { flex: 1; background: #000; border: 1px solid #333; border-radius: 4px; padding: 10px; font-family: var(--font-num); font-size: 9px; color: #0f0; overflow-y: auto; white-space: pre-wrap; display: flex; flex-direction: column-reverse; max-height: 300px; margin-top: auto; }
        .log-entry { margin-bottom: 2px; border-bottom: 1px solid #111; padding-bottom: 2px; }
        .log-time { color: #555; margin-right: 5px; }
        .dashboard-header { display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 15px; border-bottom: 1px solid var(--border); margin-bottom: 25px; }
        .page-h1 { font-size: 20px; font-weight: 800; color: #fff; margin: 0; }
        .page-sub { font-size: 11px; color: #888; margin-top: 5px; }
        .total-cost { text-align: right; }
        .tc-val { font-family: var(--font-num); font-size: 28px; font-weight: 800; color: var(--purple); text-shadow: 0 0 10px rgba(213, 0, 249, 0.3); } 
        .tc-unit { color: #888; font-size: 12px; font-weight: 700; }
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
        .kpi-card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; padding: 15px; position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between; min-height: 180px; }
        .kpi-card::before { content:''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
        .kc-title { font-size: 10px; font-weight: 700; color: #aaa; text-transform: uppercase; }
        .kc-val { font-family: var(--font-num); font-size: 20px; font-weight: 700; color: #fff; margin-top: 2px; }
        .kc-val-huge { font-family: var(--font-num); font-size: 26px; font-weight: 800; color: #fff; margin-top: 2px; letter-spacing: -1px; }
        .kc-sub { font-size: 10px; color: #888; font-family: var(--font-num); margin-top: auto; }
        .kc-sep { height:1px; background:rgba(255,255,255,0.1); margin:8px 0; }
        .fuel .kpi-card::before { background: var(--orange); } .fuel .kc-val, .fuel .kc-val-huge { color: var(--orange); } 
        .health .kpi-card::before { background: var(--red); } .health .kc-val, .health .kc-val-huge { color: var(--red); } 
        .repair .kpi-card::before { background: var(--blue); } .repair .kc-val, .repair .kc-val-huge { color: var(--blue); } 
        .supply .kpi-card::before { background: var(--yellow); } .supply .kc-val, .supply .kc-val-huge { color: var(--yellow); } 
        .eco .kpi-card::before { background: #fff; }
        .pie-container { display: flex; align-items: center; justify-content: center; height: 100%; }
        .pie-chart { width: 80px; height: 80px; border-radius: 50%; background: conic-gradient(var(--green) 0% 0%, #333 0% 100%); display: flex; align-items: center; justify-content: center; position: relative; }
        .pie-chart::after { content: ''; position: absolute; width: 60px; height: 60px; background: var(--bg-panel); border-radius: 50%; }
        .pie-val { position: absolute; z-index: 2; font-family: var(--font-num); font-weight: 700; color: #fff; font-size: 14px; }
        .tables-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start; }
        .data-panel { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; display: flex; flex-direction: column; }
        .dp-head { padding: 10px 15px; background: var(--bg-header); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .dp-title { font-weight: 800; font-size: 11px; color: #fff; text-transform: uppercase; }
        .dp-badges { display: flex; gap: 8px; font-family: var(--font-num); font-size: 10px; }
        .dt-grid { display: grid; grid-template-columns: minmax(140px, 2fr) 50px 70px 90px 90px 90px 70px 70px; }
        .dt-header { padding: 8px 12px; font-size: 9px; font-weight: 700; color: #888; text-transform: uppercase; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2); }
        .dt-row { padding: 6px 12px; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 11px; align-items: center; color: #ccc; transition: 0.1s; }
        .dt-row:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .cell { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .c-right { text-align: right; justify-content: flex-end; }
        .c-center { text-align: center; justify-content: center; }
        .zones-map { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        
        /* CARD STYLES V342 - STABLE & VISUAL */
        .zone-card { 
            background-color: #1a1a1a;
            background-size: cover; background-position: center;
            border: 1px solid var(--border); 
            padding: 10px; border-radius: 4px; 
            display: flex; flex-direction: column; justify-content: space-between; 
            height: 170px; cursor: pointer; transition: 0.2s; 
            position: relative; overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .zone-card::after { 
            content: ''; position: absolute; top:0; left:0; width:100%; height:100%; 
            background: linear-gradient(180deg, rgba(8,10,14,0.9) 0%, rgba(8,10,14,0.6) 40%, rgba(8,10,14,0.95) 100%); 
            z-index: 1; pointer-events: none; 
        }
        .zc-top, .zc-mid, .zc-bot { z-index: 2; position: relative; }

        /* THEMES CSS */
        .theme-beach { background-image: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=400&q=80'); border-top: 3px solid #00aaff; }
        .theme-forest { background-image: url('https://images.unsplash.com/photo-1448375240586-dfd8f3793371?auto=format&fit=crop&w=400&q=80'); border-top: 3px solid #00ff44; }
        .theme-hill { background-image: url('https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?auto=format&fit=crop&w=400&q=80'); border-top: 3px solid #888; }
        .theme-plain { background-image: url('https://images.unsplash.com/photo-1533240332313-0db49b459ad6?auto=format&fit=crop&w=400&q=80'); border-top: 3px solid #ffae00; }
        .theme-city { background-image: url('https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?auto=format&fit=crop&w=400&q=80'); border-top: 3px solid #d500f9; }
        .theme-mil { background-image: url('https://images.unsplash.com/photo-1599365638266-9903b9f39002?auto=format&fit=crop&w=400&q=80'); border-top: 3px solid #ff3b30; } 
        .theme-camp { background-image: url('https://images.unsplash.com/photo-1534951474654-88451f265d1d?auto=format&fit=crop&w=400&q=80'); border-top: 3px solid #aa5500; }
        .theme-bridge { background-image: url('https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?auto=format&fit=crop&w=400&q=80'); border-top: 3px solid #0055ff; }
        .theme-default { background-image: url('https://images.unsplash.com/photo-1626084926084-3c812d09b43e?auto=format&fit=crop&w=400&q=80'); border-top: 3px solid #666; }

        .zone-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.5); filter: brightness(1.1); }
        .zone-card.active { border-color: #fff; box-shadow: 0 0 15px rgba(255, 255, 255, 0.2); }
        
        .zc-header { border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; margin-bottom: 8px; }
        .zone-title { font-size: 16px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; color: #ffffff; text-shadow: 0 2px 4px #000; display:block; margin-bottom:2px; }
        .zc-sub { display:flex; justify-content: space-between; font-size:11px; font-weight:bold; text-shadow:0 1px 2px #000; }
        .zc-mid { flex: 1; display:flex; flex-direction:column; justify-content:center; gap:8px; }
        .zs-item { display: flex; justify-content: space-between; font-family: var(--font-num); font-size: 11px; color: #eee; text-shadow:0 1px 2px #000; }
        .zc-bot { border-top: 1px solid rgba(255,255,255,0.1); padding-top:6px; margin-top: auto; }
        
        .tc-f { color: #ffa726; font-weight:bold; } .tc-h { color: #ef5350; font-weight:bold; } 
        .tc-r { color: #42a5f5; font-weight:bold; } .tc-s { color: #ffee58; font-weight:bold; }
        
        .view-section { display: none; } .active-view { display: block; }
        a.atomic { color: inherit; text-decoration: none; border-bottom: 1px dotted #444; }
        a.atomic:hover { color: var(--blue); border-bottom-color: var(--blue); }
        .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:999; justify-content:center; align-items:center; }
        .modal-box { width:650px; background:var(--bg-panel); border:1px solid var(--border); padding:20px; border-radius:6px; box-shadow:0 20px 50px #000; max-height:90vh; overflow-y:auto; }
        .market-ticker { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-bottom: 20px; }
        .ticker-item { background: #191a21; border: 1px solid #333; padding: 10px; border-radius: 4px; text-align: center; }
        .t-sym { font-weight: 800; color: #fff; font-size: 12px; }
        .t-price { font-family: var(--font-num); color: var(--blue); font-size: 11px; margin-top: 4px; }
        .t-usd { font-family: var(--font-num); color: #666; font-size: 10px; }
        
        /* BADGES */
        .badge-named { display:inline-flex; align-items:center; margin-right:4px; margin-bottom:4px; padding: 4px 8px; border-radius:4px; font-family: var(--font-num); font-size:10px; font-weight:bold; text-transform: uppercase; cursor:pointer; transition:0.2s; text-decoration: none; color:#fff; background: rgba(0,0,0,0.6); border: 1px solid #888; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .badge-named:hover { background: #fff; color:#000; }
        .r-common { border-color: #aaa; color: #ddd; } .r-rare { border-color: #4b90ea; color: #4b90ea; } .r-epic { border-color: #d500f9; color: #d500f9; } .r-leg { border-color: #ffae00; color: #ffae00; }
        .badge-weight { font-size:10px; padding:3px 6px; border-radius:3px; background:rgba(0,0,0,0.6); border:1px solid #444; color:#fff; display:inline-block; font-family:var(--font-num); vertical-align:middle; margin-right:4px; font-weight:bold; text-shadow:0 1px 2px #000; }
        
        #error-banner { display:none; background:var(--red); color:#fff; padding:10px; text-align:center; position:fixed; top:0; left:0; width:100%; z-index:9999; font-weight:bold; }
        .dr-section { margin-bottom: 20px; border-bottom: 1px solid #222; padding-bottom: 20px; }
        .dr-title { color: var(--blue); font-size: 12px; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; }
        .dr-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .dr-item { background: #000; padding: 10px; border: 1px solid #333; border-radius: 4px; font-size: 11px; display: flex; justify-content: space-between; align-items: center; }
        .dr-item a { color: #fff; text-decoration: none; } .dr-item a:hover { color: var(--blue); }
        .dr-logo { width: 100px; height: 100px; border-radius: 50%; border: 2px solid #333; margin: 0 auto 20px auto; display: block; object-fit: cover; }
        .sys-clock { font-family:var(--font-num); color:var(--orange); font-size:11px; margin-left:auto; display:flex; gap:10px; align-items:center; border:1px solid #333; padding:5px 10px; border-radius:4px; background:#000; }
        .clock-copy { opacity:0.7; }
        #chartContainer { width:100%; height:280px; background:#08080a; border:1px solid #333; border-radius:4px; margin-bottom:15px; position:relative; }
        canvas { display:block; width:100%; height:100%; }
        .stats-table-wrapper { max-height:300px; overflow-y:auto; }
        .chart-controls { display:flex; gap:10px; margin-bottom:10px; }
        .chart-btn { padding:5px 10px; border:1px solid #444; background:#111; color:#888; font-size:10px; cursor:pointer; border-radius:4px; }
        .chart-btn.active { background:var(--blue); color:#fff; border-color:var(--blue); }
        .analysis-box { background:rgba(41,121,255,0.1); border-left:3px solid var(--blue); padding:10px; color:#ccc; font-size:11px; margin-bottom:15px; font-family:var(--font-ui); }
        .sim-grid { display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
        .sim-result { background:var(--bg-panel); border:1px solid var(--border); padding:15px; border-radius:6px; margin-top:20px; text-align:center; }
        .rec-box { margin-top:10px; font-size:14px; font-weight:bold; color:var(--yellow); padding:10px; border:1px dashed var(--yellow); border-radius:4px; }
        .gap-row { display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid #333; color:#ccc; }
        .gap-val { font-family:var(--font-num); font-weight:bold; }
        .val-red { color:var(--red); } .val-green { color:var(--green); }
        
        .xray-ctrl, .sybil-ctrl { display:flex; gap:10px; margin-bottom:15px; background:#111; padding:10px; border:1px solid #333; border-radius:4px; }
        .xray-res { background:#000; border:1px solid #333; padding:15px; border-radius:4px; min-height:200px; font-family:var(--font-num); color:#0f0; white-space:pre-wrap; overflow-x:auto; }
        .xray-table { width:100%; border-collapse:collapse; }
        .xray-table th { text-align:left; color:#888; font-size:9px; border-bottom:1px solid #333; padding:5px; }
        .xray-table td { color:#ccc; font-size:10px; border-bottom:1px solid #222; padding:5px; }
        .sybil-ctrl { background:#150000; border:1px solid var(--red); flex-direction:column; }
        .sybil-res { display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px; }
        .sybil-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:15px; }
        .sybil-cluster { background:#220000; border:1px solid #500; border-radius:6px; overflow:hidden; }
        .sc-head { padding:10px; background:#400000; color:#fff; font-weight:bold; font-size:11px; display:flex; justify-content:space-between; align-items:center; }
        .sc-body { padding:10px; }
        .sc-row { display:flex; justify-content:space-between; font-family:var(--font-num); font-size:10px; color:#ccc; border-bottom:1px dotted #442222; padding:4px 0; }
        .sc-row:last-child { border:none; }
        .tag-safe { background:#004400; color:#0f0; padding:2px 4px; border-radius:2px; font-size:9px; }
        .tag-risk { background:#440000; color:#f00; padding:2px 4px; border-radius:2px; font-size:9px; }
    </style>
</head>
<body>
<div id="error-banner"></div>
<div class="layout">
    <aside class="sidebar">
        <div class="app-title"><div class="status-dot"></div> DOV COMMAND <span style="opacity:0.5; font-weight:400;">V342</span></div>
        <div class="control-group">
            <span class="grp-lbl">OPERATIONS</span>
            <div class="btn-row"><button class="btn-green" onclick="dispatchGlobalScan()">B√ÇTIMENTS</button></div>
            <div class="btn-row"><button class="btn-blue" onclick="startZoneScan()">DIVISIONS</button><button class="btn-orange" onclick="startEconomyScan()">ECONOMY</button></div>
            <div class="btn-row"><button class="btn-purple" onclick="showStatsView()">STATISTICS</button></div>
            <div class="btn-row"><button class="btn-yellow" onclick="showSimView()">WAR ROOM</button></div>
        </div>
        <div class="control-group">
            <span class="grp-lbl">PROJECT INTELLIGENCE</span>
            <button class="btn-ghost" style="color:#fff; border-color:#555;" onclick="openDataRoom()">DATA ROOM</button>
            <button class="btn-ghost" style="color:var(--purple); border-color:var(--purple); margin-top:5px;" onclick="showXrayView()">X-RAY SCANNER</button>
            <button class="btn-red" style="margin-top:5px;" onclick="showSybilView()">SYBIL RADAR</button>
        </div>
        <div class="control-group">
            <span class="grp-lbl">BLACK BOX LOGGING</span>
            <div class="btn-row"><button class="btn-purple" onclick="takeLogSnapshot(true)">FORCE SNAPSHOT</button><button class="btn-ghost" style="color:#fff" onclick="exportLogs()">EXPORT CSV</button></div>
            <button class="btn-red" style="margin-top:8px;" onclick="openAuditView()">AUDIT INACTIFS ‚ö†Ô∏è</button>
        </div>
        <div class="control-group"><span class="grp-lbl">TARGET INTELLIGENCE</span><input type="text" id="targetIn" value="u2d2k.c.wam"><div class="btn-row"><button class="btn-ghost" style="color:#fff">DIVISIONS</button><button class="btn-ghost" style="color:#fff">BUILDINGS</button></div></div>
        <div class="control-group" style="margin-top:auto"><div style="display:flex; justify-content:space-between; font-size:10px; color:#666;"><span>DB</span> <span id="dictSize" style="color:#fff">0</span></div><button class="btn-ghost" style="color:var(--red); border-color:var(--red);" onclick="hardReset()">FACTORY RESET</button></div>
        <div class="console-log" id="sysLog"><div class="log-entry"><span class="log-time">SYS:</span>V342. Fix Total.</div></div>
    </aside>

    <main class="main-content">
        <div id="viewGlobal" class="view-section active-view">
            <div class="dashboard-header">
                <div><h2 class="page-h1">PRODUCTION B√ÇTIMENTS</h2><div class="page-meta">ROWS: <span id="cntRows">0</span></div></div>
                <div class="sys-clock"><span id="liveTime">00:00:00</span> <span style="color:#666">|</span> <span id="liveDate">YYYY-MM-DD</span></div>
                <div class="total-cost"><div class="grp-lbl">MAINTENANCE DOVX / 24H</div><div><span class="tc-val" id="gTotalCost">0</span></div></div>
            </div>
            <div class="kpi-grid" id="areaCards"></div><div class="tables-grid" id="areaLists"></div>
        </div>
        
        <div id="viewZones" class="view-section">
            <div class="dashboard-header" style="border-left: 4px solid var(--blue)">
                <div><h2 class="page-h1">STAKED ASSET ALLOCATION</h2><div class="page-sub">Deployment vectors & strategic yield generation zones. Real-time asset tracking.</div></div>
                <div class="sys-clock"><span class="clock-copy"></span></div>
                <div class="total-cost"><div class="grp-lbl">CONSOMMATION DU DOVX 24H00</div><div style="font-family:var(--font-num); font-size:14px; font-weight:800; margin-top:4px;"><span class="tc-f">FUEL <span id="gBurnF">0</span></span> | <span class="tc-h">HEALTH <span id="gBurnH">0</span></span> | <span class="tc-r">REPAIR <span id="gBurnR">0</span></span> | <span class="tc-s">SUPPLY <span id="gBurnS">0</span></span></div><div style="text-align:right; margin-top:5px; font-size:11px; color:var(--purple); font-weight:bold;">CITY DOVX BURN: <span id="gCityBurn">0</span></div></div>
            </div>

            <div class="kpi-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom:20px;">
                <div class="kpi-card"><div class="kc-title">TOTAL DIVISIONS</div><div class="kc-val" id="zTotalDivs">0</div></div>
                <div class="kpi-card"><div class="kc-title">IN FIGHT</div><div class="kc-val" id="zActiveDivs" style="color:var(--green)">0</div></div>
                <div class="kpi-card" style="align-items:center; justify-content:center;"><div class="pie-container"><div class="pie-chart" id="zPieChart"><span class="pie-val" id="zPieVal">0%</span></div></div></div>
                <div class="kpi-card"><div class="kc-title">TOTAL DOVX MINT</div><div class="kc-val" id="zTotalProd" style="color:var(--purple)">0</div></div>
            </div>
            <div class="zones-map" id="areaZones"></div>
        </div>

        <div id="viewSybil" class="view-section">
            <div class="dashboard-header" style="border-left: 4px solid var(--red)">
                <div><h2 class="page-h1" style="color:var(--red)">SYBIL RADAR</h2><div class="page-meta">PRECISION CLUSTER ANALYSIS</div></div>
                <div class="sys-clock"><span class="clock-copy"></span></div>
            </div>
            <div class="sybil-ctrl">
                <div style="color:#fff; font-weight:bold; margin-bottom:5px;">AUTOMATED SWEEP V2 (WHITELIST ENABLED)</div>
                <div style="font-size:11px; color:#ccc; margin-bottom:10px;">Scans active players. Ignores exchanges. Detects similar names. Groups by Funding Source.</div>
                <div style="display:flex; gap:10px;"><button class="btn-red" onclick="runAutoSybilScan()">LAUNCH FULL SCAN (TOP 50)</button><div id="sybilProgress" style="color:var(--orange); font-family:var(--font-num); align-self:center;"></div></div>
            </div>
            <div id="sybilResults" class="sybil-grid"></div>
        </div>

        <div id="viewXray" class="view-section">
            <div class="dashboard-header" style="border-left: 4px solid var(--purple)">
                <div><h2 class="page-h1">X-RAY SCANNER</h2><div class="page-meta">SMART CONTRACT INSPECTOR</div></div>
                <div class="sys-clock"><span class="clock-copy"></span></div>
            </div>
            <div class="xray-ctrl"><div style="flex:1"><span class="grp-lbl">CONTRACT</span><select id="xrayContract" onchange="onXrayContractChange()"><option value="dawnfvictory">dawnfvictory (CORE)</option><option value="dovutilstake">dovutilstake (STAKING)</option><option value="dovpvecontrl">dovpvecontrl (WAR)</option></select></div><div style="width:150px;"><span class="grp-lbl">ACTION</span><button class="btn-blue" onclick="loadXrayAbi()">1. LOAD TABLES</button></div></div>
            <div class="xray-ctrl"><div style="flex:1"><span class="grp-lbl">TARGET TABLE</span><select id="xrayTable"><option>Load ABI first...</option></select></div><div style="flex:1"><span class="grp-lbl">SCOPE</span><input type="text" id="xrayScope" value="dawnfvictory"></div><div style="width:150px;"><span class="grp-lbl">EXECUTE</span><button class="btn-purple" onclick="runXrayScan()">2. SCAN DATA</button></div></div>
            <div class="xray-res" id="xrayResults">Awaiting Scan...</div>
        </div>

        <div id="viewEco" class="view-section">
            <div class="dashboard-header" style="border-left: 4px solid var(--orange)">
                <div><h2 class="page-h1">INVESTOR DASHBOARD</h2><div class="page-meta" id="ecoStatus">BUSINESS INTELLIGENCE</div></div>
                <div class="sys-clock"><span class="clock-copy"></span></div>
            </div>
            <div class="market-ticker" id="marketTicker"></div>
            <div class="kpi-grid eco" style="grid-template-columns: repeat(3, 1fr); gap:15px; margin-bottom:25px;">
                <div class="kpi-card"><div class="kc-title">UNIQUE WALLETS (USERS)</div><div class="kc-val-huge" style="color:var(--blue)" id="ecoWallets">0</div><div class="kc-sub">NFTHIVE SNAPSHOT</div></div>
                <div class="kpi-card"><div class="kc-title">NFT MARKET CAP</div><div class="kc-val" style="color:#fff" id="ecoNftCap">0</div><div class="kc-sub" id="ecoNftCapUsd">$0.00</div></div>
                <div class="kpi-card"><div class="kc-title">TOTAL ASSETS</div><div class="kc-val" id="ecoTVL">0</div><div class="kc-sub">CIRCULATING SUPPLY</div></div>
                <div class="kpi-card"><div class="kc-title">TOTAL SALES VOLUME</div><div class="kc-val" style="color:var(--yellow)" id="ecoSales">$0.00</div></div>
                <div class="kpi-card"><div class="kc-title">MARKET FEE</div><div class="kc-val" id="ecoFee">0%</div></div>
                <div class="kpi-card"><div class="kc-title">DAILY GDP (VALUE)</div><div class="kc-val" style="color:var(--green)" id="ecoGdpUsd">$0.00</div><div class="kc-sub" id="ecoGdpWax">0 WAX</div></div>
            </div>
            <div class="data-panel" style="margin-bottom:25px;"><div class="dp-head"><span class="dp-title">FINANCIAL PROJECTIONS (REVENUE)</span></div><div class="dt-grid dt-header" style="grid-template-columns: 200px 1fr 1fr;"><div class="cell">PERIOD</div><div class="cell c-right">REVENUE (WAX)</div><div class="cell c-right">REVENUE (USD)</div></div><div id="projTable"></div></div>
        </div>

        <div id="viewStats" class="view-section">
            <div class="dashboard-header" style="border-left: 4px solid var(--purple)">
                <div><h2 class="page-h1">FINANCIAL SUITE</h2><div class="page-meta">ADVANCED ANALYTICS</div></div>
                <div class="sys-clock"><span class="clock-copy"></span></div>
            </div>
            <div class="chart-controls"><button class="chart-btn active" onclick="switchChart('pnl')">PNL (NET PROFIT)</button><button class="chart-btn" onclick="switchChart('scissors')">SCISSORS (REV vs COST)</button><button class="chart-btn" onclick="switchChart('tvl')">TVL GROWTH</button></div>
            <div id="chartContainer"><canvas id="analyticsChart"></canvas></div>
            <div id="financialInsight" class="analysis-box">Waiting for data...</div>
            <div class="data-panel"><div class="dp-head"><span class="dp-title">LOG HISTORY (EXTENDED)</span></div><div class="dt-grid dt-header" style="grid-template-columns: 140px 60px 100px 100px 100px 100px;"><div class="cell">TIMESTAMP</div><div class="cell">TYPE</div><div class="cell c-right">REV (USD)</div><div class="cell c-right">COST (USD)</div><div class="cell c-right">NET (USD)</div><div class="cell c-right">ASSETS</div></div><div id="logTable" class="stats-table-wrapper"></div></div>
        </div>

        <div id="viewSim" class="view-section">
            <div class="dashboard-header" style="border-left: 4px solid var(--yellow)">
                <div><h2 class="page-h1" style="color:var(--yellow)">WAR ROOM</h2><div class="page-meta">GAP & CAPACITY PLANNING</div></div>
                <div class="sys-clock"><span class="clock-copy"></span></div>
            </div>
            <div style="margin-bottom:20px;"><button class="btn-yellow" style="width:250px; font-weight:bold;" onclick="runSimulation()">CALCULATE GAP & NEEDS</button><span style="font-size:10px; color:#666; margin-left:10px;">BASED ON LIVE SCANNED DATA</span></div>
            <div class="sim-grid"><div class="data-panel"><div class="dp-head"><span class="dp-title" style="color:var(--blue)">CURRENT SUPPLY / DEMAND</span></div><div id="simGapList" style="padding:15px; font-family:var(--font-num);">Scan to Analyze...</div></div><div class="data-panel"><div class="dp-head"><span class="dp-title" style="color:var(--green)">CONSTRUCTION ORDERS</span></div><div id="simBuildList" style="padding:15px; font-family:var(--font-num);">Scan to Analyze...</div></div></div>
            <div class="sim-result"><div id="simBalanceTable"></div><div id="simRec" class="rec-box">AWAITING CALCULATION...</div></div>
        </div>
    </main>
</div>

<div class="modal-overlay" id="dataRoomModal"><div class="modal-box" style="width:700px;"><img src="https://ipfs.io/ipfs/QmcR7QTbt2tYHxMZ8rsH45FxYU8fuHPCy7UeAguZW3QupE" class="dr-logo" alt="DOV Logo"><h3 style="text-align:center; color:#fff; margin-top:0;">DAWN OF VICTORY - INVESTOR DATA ROOM</h3><div id="drContent"></div><div style="text-align:right; margin-top:15px;"><button class="btn-ghost" onclick="closeModal('dataRoomModal')">CLOSE</button></div></div></div>
<div class="modal-overlay" id="auditModal"><div class="modal-box" style="width:800px;"><h3 style="margin-top:0; color:var(--red); border-bottom:1px solid #333; padding-bottom:10px;">AUDIT RAPPORT: ACTIFS INACTIFS</h3><div style="height:400px; overflow-y:auto; margin-top:15px;"><div class="dt-grid dt-header" style="grid-template-columns: 1fr 1fr 1fr 100px 100px;"><div class="cell">WALLET (OWNER)</div><div class="cell">TEMPLATE</div><div class="cell">ARR√äT√â LE</div><div class="cell">INACTIF</div><div class="cell c-center">ACTION</div></div><div id="auditList"></div></div><div style="text-align:right; margin-top:15px;"><button class="btn-ghost" onclick="closeModal('auditModal')">CLOSE</button></div></div></div>
<div class="modal-overlay" id="zoneDetailModal"><div class="modal-box" style="width:800px;"><h3 id="zdTitle" style="margin-top:0; color:#fff; border-bottom:1px solid #333; padding-bottom:10px;">ZONE DETAIL</h3><div style="height:400px; overflow-y:auto; margin-top:15px;"><div id="zdList"></div></div><div style="text-align:right; margin-top:15px;"><button class="btn-ghost" onclick="closeModal('zoneDetailModal')">CLOSE</button></div></div></div>

<script>
    const CONFIG_PRIX = { WAX_USD: 0.00751, DOVX_WAX: 0.00528553, DOVR_WAX: 0.00052051, DOVF_WAX: 0.00052051, DOVH_WAX: 0.00052051, DOVS_WAX: 0.00052051 };
    const NFTHIVE_SNAPSHOT = { sales: "$954.1K", assets: "140 466", marketCap: "$883.3K", users: "8 334", fee: "6%" };
    const SYBIL_WHITELIST = ['alcordexmain', 'eosio.stake', 'atomicmarket', 'waxapps', 'farmersworld', 'alien.worlds', 'cpu4', 'blenderizerx', 'neftyblocksd', 'dovutilstake'];
    const PROJECT_DATA = { links: [ { name: "Official Website", url: "https://dawnofvictory.io/" }, { name: "Whitepaper", url: "https://dawn-of-victory.gitbook.io/dov/" }, { name: "Beta Access", url: "https://beta.dawnofvictory.io/" }, { name: "Twitter", url: "https://twitter.com/DOVNFT" }, { name: "Telegram", url: "https://t.me/dawnofvictorynft" }, { name: "Email", url: "mailto:info@dawnofvictory.io" }, { name: "Top 100 Holders", url: "https://wax.bloks.io/tokens/DOVX-wax-dovvaultfort" }, { name: "Nefty Blends", url: "https://neftyblocks.com/c/dovdivisions/blends" }, { name: "Whimsical Info", url: "https://whimsical.com/dawn-of-victory-marketing-NgpNonWnGyLUqosCRRJ5Ng@3CRerdhrAvzbxBHgLbRvGZoU" } ], markets: [ { name: "DOVX (Swap)", url: "https://wax.alcor.exchange/swap?output=DOVX-dovvaultfort&input=WAX-eosio.token" }, { name: "DOVX / WAX", url: "https://alcor.exchange/trade/dovx-dovvaultfort_wax-eosio.token" }, { name: "DOVF / WAX", url: "https://wax.alcor.exchange/trade/dovf-dovvaultfort_wax-eosio.token" }, { name: "DOVH / WAX", url: "https://wax.alcor.exchange/trade/dovh-dovvaultfort_wax-eosio.token" }, { name: "DOVR / WAX", url: "https://wax.alcor.exchange/trade/dovr-dovvaultfort_wax-eosio.token" }, { name: "DOVS / WAX", url: "https://wax.alcor.exchange/trade/dovs-dovvaultfort_wax-eosio.token" } ], contracts: [ "dovutilstake", "dovpvecontrl", "dawnfvictory", "atomicdropsx", "neftyblocksd" ] };

    const STORAGE_KEY = 'DOV_DATA_V342'; const LOG_STORAGE_KEY = 'DOV_LOGS_V342';
    const HYPERION_NODES = [ "https://wax.eosrio.io", "https://wax.greymass.com", "https://api.waxsweden.org", "https://wax.eu.eosamsterdam.net" ];
    
    const getId = (id) => document.getElementById(id);
    const closeModal = (id) => getId(id).style.display = 'none';
    const switchView = (id) => { document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active-view')); getId(id).classList.add('active-view'); };
    const fmt = (n) => n.toLocaleString('fr-FR', {maximumFractionDigits: 0});
    const fmtDec = (n) => n.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    const fmtUsd = (n) => n.toLocaleString('en-US', {style:'currency', currency:'USD', minimumFractionDigits: 4});

    const DEFAULT_DATA = { apiConfig: { rpcNodes: [ "https://wax.greymass.com", "https://wax.eosio.online", "https://wax.api.eosnation.io", "https://wax.dapplica.io", "https://wax.eosphere.io" ] }, resourceDefs: { "F": { label: "FUEL", class: "fuel" }, "H": { label: "HEALTH", class: "health" }, "R": { label: "REPAIR", class: "repair" }, "S": { label: "SUPPLY", class: "supply" } }, templates: { "FUEL": { "490122": { "name": "C_F1_PRODUCER_FUEL", "prod": 5.4 }, "492363": { "name": "C_F2_PRODUCER_FUEL", "prod": 12.15 }, "492366": { "name": "C_F3_PRODUCER_FUEL", "prod": 30.38 }, "492368": { "name": "C_F4_PRODUCER_FUEL", "prod": 83.53 } }, "HEALTH": { "492394": { "name": "C_F1_PRODUCER_HEALTH", "prod": 5.4 } }, "REPAIR": { "492559": { "name": "C_F1_PRODUCER_REPAIR", "prod": 5.4 } }, "SUPPLY": { "492585": { "name": "C_F1_PRODUCER_SUPPLY", "prod": 5.4 } } } };

    const SMART_ZONES_BIBLE = {
        1: { name:"Beach 1", cost:1160, win:400, minW:9.66, maxW:13.92, req:[] }, 
        2: { name:"Beach 2", cost:6968, win:2405, minW:17.50, maxW:27.29, req:[871036] }, 
        3: { name:"Beach 3", cost:8800, win:3037, minW:35.00, maxW:54.59, req:[871037] }, 
        4: { name:"Bunker", cost:11120, win:3838, minW:69.99, maxW:108.53, req:[296767, 295956, 871038] }, 
        5: { name:"Forest 1", cost:14024, win:4840, minW:139.99, maxW:218.35, req:[296767, 296754, 871039, 401181] }, 
        6: { name:"Forest 2", cost:17704, win:6110, minW:255.18, maxW:341.18, req:[296768, 296754, 871041, 401181] }, 
        7: { name:"Forest 3", cost:22352, win:7714, minW:450.00, maxW:450.00, req:[296768, 296754, 871043, 401181] }, 
        8: { name:"Camp", cost:28220, win:9739, minW:382.78, maxW:511.76, req:[296768, 298537, 296761, 871045, 401182] }, 
        9: { name:"Hill 1", cost:37052, win:12788, minW:415.82, maxW:694.78, req:[296768, 298537, 298529, 871048, 401182] }, 
        10: { name:"Hill 2", cost:48652, win:16791, minW:519.82, maxW:868.55, req:[296769, 298537, 298529, 871049, 401182] }, 
        11: { name:"Hill 3", cost:64516, win:22266, minW:649.77, maxW:1085.69, req:[296769, 298539, 298529, 871051, 401184] }, 
        12: { name:"Radar", cost:84712, win:29236, minW:812.17, maxW:1357.04, req:[296770, 298539, 871052, 298548, 401184] }, 
        13: { name:"Plain 1", cost:99384, win:34300, minW:1298.56, maxW:1696.33, req:[296770, 298539, 871053, 298548, 401184] }, 
        14: { name:"Plain 2", cost:125708, win:43385, minW:1428.32, maxW:1865.84, req:[296770, 298541, 871054, 298549, 401187] }, 
        15: { name:"Plain 3", cost:151164, win:52171, minW:1570.79, maxW:2051.96, req:[296770, 298541, 871055, 298553, 401187] }, 
        16: { name:"HQ", cost:188000, win:64884, minW:1728.29, maxW:2494.23, req:[296770, 298543, 871057, 298551, 401187] }, 
        17: { name:"City 1", cost:1664, win:0, minW:69.99, maxW:108.53, req:[871058, 645495, 645444, 645455, 645463] }, 
        18: { name:"City 2", cost:4448, win:0, minW:382.78, maxW:511.76, req:[871059, 645504, 645450, 645469, 645485] }, 
        19: { name:"City 3", cost:13440, win:0, minW:812.17, maxW:1357.04, req:[871060, 645500, 645457, 645482, 649646] }, 
        20: { name:"Bridge", cost:29856, win:0, minW:1728.29, maxW:2494.23, req:[871061, 297681, 649648, 645465, 645464] }
    };

    // V342: MAPPING THEME PAR ID (ROBUSTE)
    const ZONE_BG_MAP = {
        1: "beach", 2: "beach", 3: "beach",
        4: "mil",
        5: "forest", 6: "forest", 7: "forest",
        8: "camp",
        9: "hill", 10: "hill", 11: "hill",
        12: "mil",
        13: "plain", 14: "plain", 15: "plain",
        16: "mil",
        17: "city", 18: "city", 19: "city",
        20: "bridge"
    };

    const REQ_DICT = {
        "871036": { n: "üîë KEY BEACH 2", r: "r-rare" },
        "871037": { n: "üîë KEY BEACH 3", r: "r-rare" },
        "871038": { n: "üîë KEY BUNKER", r: "r-rare" },
        "871039": { n: "üîë KEY FOREST 1", r: "r-rare" },
        "871041": { n: "üîë KEY FOREST 2", r: "r-rare" },
        "871043": { n: "üîë KEY FOREST 3", r: "r-rare" },
        "871045": { n: "üîë KEY CAMP", r: "r-rare" },
        "871048": { n: "üîë KEY HILL 1", r: "r-rare" },
        "871049": { n: "üîë KEY HILL 2", r: "r-rare" },
        "871051": { n: "üîë KEY HILL 3", r: "r-rare" },
        "871052": { n: "üîë KEY RADAR", r: "r-rare" },
        "871053": { n: "üîë KEY PLAIN 1", r: "r-rare" },
        "871054": { n: "üîë KEY PLAIN 2", r: "r-rare" },
        "871055": { n: "üîë KEY PLAIN 3", r: "r-rare" },
        "871057": { n: "üîë KEY HQ", r: "r-rare" },
        "871058": { n: "üèôÔ∏è CITY 1 PASS", r: "r-epic" },
        "871059": { n: "üèôÔ∏è CITY 2 PASS", r: "r-epic" },
        "871060": { n: "üèôÔ∏è CITY 3 PASS", r: "r-epic" },
        "871061": { n: "üåâ BRIDGE PASS", r: "r-leg" },
        "296767": { n: "üõ†Ô∏è ENGINEER", r: "r-epic" },      
        "296768": { n: "üõ†Ô∏è ENGINEER II", r: "r-epic" },   
        "296769": { n: "üõ†Ô∏è ENGINEER III", r: "r-leg" },   
        "296770": { n: "üõ†Ô∏è ENGINEER IV", r: "r-leg" },    
        "401181": { n: "üèπ RANGER", r: "r-rare" },
        "401182": { n: "üßó CLIMBER", r: "r-epic" },
        "401184": { n: "üì° TECH", r: "r-epic" },
        "401187": { n: "üéñÔ∏è GENERAL", r: "r-leg" },
        "295956": { n: "‚öôÔ∏è PART A", r: "r-common" },
        "296754": { n: "‚öôÔ∏è PART B", r: "r-common" },
        "298537": { n: "‚öôÔ∏è PART C", r: "r-common" },
        "296761": { n: "‚öôÔ∏è PART D", r: "r-common" },
        "298529": { n: "‚öôÔ∏è PART E", r: "r-common" },
        "298539": { n: "‚öôÔ∏è PART F", r: "r-common" },
        "298548": { n: "‚öôÔ∏è PART G", r: "r-common" },
        "298541": { n: "‚öôÔ∏è PART H", r: "r-common" },
        "298549": { n: "‚öôÔ∏è PART I", r: "r-common" },
        "298553": { n: "‚öôÔ∏è PART J", r: "r-common" },
        "298543": { n: "‚öôÔ∏è PART K", r: "r-common" },
        "298551": { n: "‚öôÔ∏è PART L", r: "r-common" },
        "645495": { n: "üìú PERMIT A", r: "r-common" },
        "645444": { n: "üìú PERMIT B", r: "r-common" },
        "645455": { n: "üìú PERMIT C", r: "r-common" },
        "645463": { n: "üìú PERMIT D", r: "r-common" },
        "645504": { n: "üìú PERMIT E", r: "r-common" },
        "645450": { n: "üìú PERMIT F", r: "r-common" },
        "645469": { n: "üìú PERMIT G", r: "r-common" },
        "645485": { n: "üìú PERMIT H", r: "r-common" },
        "645500": { n: "üìú PERMIT I", r: "r-common" },
        "645457": { n: "üìú PERMIT J", r: "r-common" },
        "645482": { n: "üìú PERMIT K", r: "r-common" },
        "649646": { n: "üìú PERMIT L", r: "r-common" },
        "297681": { n: "üìú PERMIT M", r: "r-common" },
        "649648": { n: "üìú PERMIT N", r: "r-common" },
        "645465": { n: "üìú PERMIT O", r: "r-common" },
        "645464": { n: "üìú PERMIT P", r: "r-common" }
    };

    let DATA = JSON.parse(JSON.stringify(DEFAULT_DATA));
    let stopSignal = false;
    let zoneDetailsCache = {}; 
    let ecoStats = { buildings: { active:0, prodF:0, prodH:0, prodR:0, prodS:0, totalCost:0 }, divisions: { active:0, mint:0, cost:0 }, cityBurn: 0, burns: {F:0,H:0,R:0,S:0}, uniqueWalletCount: 0, totalAssetsAtomic: 0 };
    let runtimeWalletSet = new Set(); 
    let currentChartMode = 'pnl';
    let inactiveAssetsLog = [];

    function saveData() { DATA.ecoStats = ecoStats; localStorage.setItem(STORAGE_KEY, JSON.stringify(DATA)); log("Data Saved."); }
    function hardReset() { if(confirm("FULL RESET?")) { localStorage.removeItem(STORAGE_KEY); localStorage.removeItem(LOG_STORAGE_KEY); location.reload(); } }

    function init() {
        const local = localStorage.getItem(STORAGE_KEY);
        if(local) { 
            try { 
                let loaded = JSON.parse(local); 
                DATA = { ...DEFAULT_DATA, ...loaded, templates: { ...DEFAULT_DATA.templates, ...loaded.templates } }; 
                if(loaded.ecoStats) {
                    ecoStats = loaded.ecoStats;
                    if(!ecoStats.burns) ecoStats.burns = {F:0, H:0, R:0, S:0};
                }
            } catch(e){} 
        }
        let count = 0; Object.values(DATA.templates).forEach(t => count += Object.keys(t).length);
        if(getId('dictSize')) getId('dictSize').innerText = count;
        
        // CRITICAL ORDER FIX FOR V342
        buildUI(); // MUST BE FIRST
        startClock(); 
        startMonitoringRoutine();
        renderTicker(); 
        updateEcoUI(); 
        
        if(ecoStats.buildings.active > 0 && getId('gTotalCost')) { 
            getId('gTotalCost').innerText = fmt(ecoStats.buildings.totalCost); 
            getId('cntRows').innerText = fmt(ecoStats.buildings.active); 
        }
        if(ecoStats.divisions.active > 0 && getId('zTotalDivsHeader')) { 
            getId('zTotalDivsHeader').innerText = fmt(ecoStats.divisions.active); 
        }
        log("Ready. Mode: V342 Final Stable.");
    }

    // --- LEVENSHTEIN DISTANCE (For Name Similarity) ---
    function levenshtein(a, b) {
        if(a.length === 0) return b.length; 
        if(b.length === 0) return a.length;
        const matrix = [];
        for(let i = 0; i <= b.length; i++){ matrix[i] = [i]; }
        for(let j = 0; j <= a.length; j++){ matrix[0][j] = j; }
        for(let i = 1; i <= b.length; i++){
            for(let j = 1; j <= a.length; j++){
                if(b.charAt(i-1) == a.charAt(j-1)){ matrix[i][j] = matrix[i-1][j-1]; }
                else { matrix[i][j] = Math.min(matrix[i-1][j-1] + 1, Math.min(matrix[i][j-1] + 1, matrix[i-1][j] + 1)); }
            }
        }
        return matrix[b.length][a.length];
    }

    function checkSimilarity(target, allNames) {
        for (let name of allNames) {
            if (name !== target && Math.abs(name.length - target.length) < 3) {
                let dist = levenshtein(target, name);
                if (dist <= 2) return name; 
            }
        }
        return null;
    }

    // --- SYBIL RADAR MODULE V333 ---
    function showSybilView() { switchView('viewSybil'); }
    
    async function runAutoSybilScan() {
        if(runtimeWalletSet.size === 0) { alert("Please run a standard scan first to find players."); return; }
        let suspects = Array.from(runtimeWalletSet).slice(0, 50);
        getId('sybilResults').innerHTML = `<div style="color:#fff; grid-column:1/-1; text-align:center;">SCANNING ${suspects.length} SUSPECTS... ANALYSIS IN PROGRESS...</div>`;
        
        let clusters = {}; 
        let count = 0;

        for(let target of suspects) {
            count++;
            getId('sybilProgress').innerText = `${count} / ${suspects.length}`;
            
            try {
                let creator = "Unknown";
                let resC = await fetchHistoryCluster(`/v2/history/get_actions?account=${target}&filter=eosio:newaccount&limit=1`);
                if(resC && resC.actions.length > 0) {
                    creator = resC.actions[0].act.data.creator;
                } else {
                    let resF = await fetchHistoryCluster(`/v2/history/get_actions?account=${target}&filter=eosio.token:transfer&limit=1&sort=asc`);
                    if(resF && resF.actions.length > 0) {
                        let data = resF.actions[0].act.data;
                        if(data.to === target) creator = data.from + " (Funding)";
                    }
                }
                
                let funnel = "None";
                let resF = await fetchHistoryCluster(`/v2/history/get_actions?account=${target}&filter=eosio.token:transfer&limit=50&sort=desc`);
                if(resF && resF.actions) {
                    let lastOut = resF.actions.find(a => a.act.data.from === target && !SYBIL_WHITELIST.includes(a.act.data.to));
                    if(lastOut) funnel = lastOut.act.data.to;
                }

                let similarTo = checkSimilarity(target, suspects);
                let clusterKey = "INDEPENDENT";
                let riskLevel = "SAFE";

                if (funnel !== "None") {
                    clusterKey = "FUNNEL: " + funnel;
                    riskLevel = "HIGH";
                } 
                
                if(similarTo) {
                    if(clusterKey === "INDEPENDENT") clusterKey = "PATTERN: " + target.substring(0,6) + "*";
                    riskLevel = riskLevel === "HIGH" ? "CRITICAL" : "MEDIUM";
                }

                if(!clusters[clusterKey]) clusters[clusterKey] = [];
                clusters[clusterKey].push({ name: target, creator: creator, funnel: funnel, similar: similarTo, risk: riskLevel });
                
                renderSybilClusters(clusters);
                await new Promise(r => setTimeout(r, 600)); 

            } catch(e) { console.log(e); }
        }
        getId('sybilProgress').innerText = "SCAN COMPLETE.";
    }

    function renderSybilClusters(clusters) {
        let html = "";
        let sortedKeys = Object.keys(clusters).sort((a,b) => clusters[b].length - clusters[a].length);
        
        sortedKeys.forEach(key => {
            let group = clusters[key];
            let isRisk = key.includes("FUNNEL") || key.includes("PATTERN");
            let borderColor = isRisk ? "var(--red)" : "var(--green)";
            if(group.length < 2 && isRisk) borderColor = "var(--orange)";
            
            html += `<div class="sybil-cluster" style="border-color:${borderColor}">
                <div class="sc-head" style="background:${borderColor === 'var(--green)' ? '#003300' : '#440000'}">
                    <span>${key}</span>
                    <span>${group.length} ACCOUNTS</span>
                </div>
                <div class="sc-body">`;
                
            group.forEach(m => {
                let riskTag = m.risk === "HIGH" || m.risk === "CRITICAL" ? `<span class="tag-risk">${m.risk}</span>` : `<span class="tag-safe">SAFE</span>`;
                html += `<div class="sc-row">
                    <span style="color:#fff; font-weight:bold;">${m.name}</span>
                    <span>Created: ${m.creator.split(' ')[0]}</span>
                    ${riskTag}
                </div>`;
            });
            html += `</div></div>`;
        });
        getId('sybilResults').innerHTML = html;
    }

    async function fetchHistoryCluster(endpoint) {
        let nodes = HYPERION_NODES; let shuffled = [...nodes].sort(() => 0.5 - Math.random());
        for(let i=0; i<shuffled.length; i++) { try { let controller = new AbortController(); setTimeout(() => controller.abort(), 5000); let res = await fetch(shuffled[i] + endpoint, { method: 'GET', signal: controller.signal }); if(res.ok) return await res.json(); } catch(e) { } }
        throw new Error("HISTORY NODES BUSY");
    }

    // --- STANDARD FUNCTIONS (Explicit) ---
    function buildUI() { 
        const areaC = getId('areaCards'); 
        const areaL = getId('areaLists'); 
        if(!areaC || !areaL) return; // Safety check
        
        areaC.innerHTML = ''; areaL.innerHTML = ''; 
        const order = ["F", "H", "R", "S"]; 
        for(let k of order) { 
            let rd = DATA.resourceDefs[k]; 
            areaC.innerHTML += `<div class="kpi-card ${rd.class}" id="card-${k}"><div><div class="kc-title">${rd.label} / HOUR</div><div class="kc-val" id="val-${k}">0</div></div><div class="kc-sep"></div><div><div class="kc-title" style="color:#fff; opacity:0.8;">DAILY PRODUCTION</div><div class="kc-val-huge" id="val24-${k}">0</div></div><div class="kc-sub" id="act-${k}">0 ACTIVE</div></div>`; 
            areaL.innerHTML += `<div class="data-panel"><div class="dp-head"><span class="dp-title">${rd.label} BREAKDOWN</span><div class="dp-badges"><span style="color:#888">PROD:</span> <span id="btot-${k}" style="color:#fff">0</span></div></div><div class="dt-grid dt-header"><div class="cell">TEMPLATE</div><div class="cell c-center">ACT / TOT</div><div class="cell c-right">UNIT</div><div class="cell c-right">PROD/H</div><div class="cell c-right">PROD/24</div><div class="cell c-right" style="color:#aaa">YIELD (TU/DOVX)</div><div class="cell c-right" style="color:var(--purple)">COST/24</div></div><div id="tbl-${k}"></div></div>`; 
        } 
    }

    function renderTicker() { let html = `<div class="ticker-item"><div class="t-sym" style="color:var(--orange)">WAX</div><div class="t-price">$${CONFIG_PRIX.WAX_USD}</div></div>`; const tokens = [ { s:"DOVX", p: CONFIG_PRIX.DOVX_WAX }, { s:"DOVF", p: CONFIG_PRIX.DOVF_WAX }, { s:"DOVH", p: CONFIG_PRIX.DOVH_WAX }, { s:"DOVR", p: CONFIG_PRIX.DOVR_WAX }, { s:"DOVS", p: CONFIG_PRIX.DOVS_WAX } ]; tokens.forEach(t => { let usd = t.p * CONFIG_PRIX.WAX_USD; html += `<div class="ticker-item"><div class="t-sym">${t.s}</div><div class="t-price">${t.p} WAX</div><div class="t-usd">$${usd.toFixed(6)}</div></div>`; }); getId('marketTicker').innerHTML = html; }
    function startClock() { setInterval(() => { const now = new Date(); const time = now.toLocaleTimeString('fr-FR'); const date = now.toLocaleDateString('fr-FR', { year:'numeric', month:'2-digit', day:'2-digit' }); if(getId('liveTime')) { getId('liveTime').innerText = time; getId('liveDate').innerText = date; } let copies = document.querySelectorAll('.clock-copy'); copies.forEach(c => c.innerText = `${time} | ${date}`); }, 1000); }
    async function takeLogSnapshot(isManual) { if(isManual) { log("Manual Snapshot Initiated..."); await dispatchGlobalScan(true); await startZoneScan(true); } let logs = JSON.parse(localStorage.getItem(LOG_STORAGE_KEY) || "[]"); let dailyIndustryWax = (ecoStats.buildings.prodF * 24 * CONFIG_PRIX.DOVF_WAX) + (ecoStats.buildings.prodH * 24 * CONFIG_PRIX.DOVH_WAX) + (ecoStats.buildings.prodR * 24 * CONFIG_PRIX.DOVR_WAX) + (ecoStats.buildings.prodS * 24 * CONFIG_PRIX.DOVS_WAX); let dailyMilitaryWax = ecoStats.divisions.mint * CONFIG_PRIX.DOVX_WAX; let totalRevWax = dailyIndustryWax + dailyMilitaryWax; let costWax = ecoStats.buildings.totalCost * CONFIG_PRIX.DOVX_WAX; let entry = { timestamp: new Date().toISOString(), type: isManual ? "MANUAL" : "AUTO", revenue_usd: totalRevWax * CONFIG_PRIX.WAX_USD, cost_usd: costWax * CONFIG_PRIX.WAX_USD, profit_usd: (totalRevWax - costWax) * CONFIG_PRIX.WAX_USD, assets_count: ecoStats.buildings.active + ecoStats.divisions.active }; logs.push(entry); if(logs.length > 1000) logs.shift(); localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(logs)); if(isManual) { alert("Snapshot Saved."); renderStatsUI(); } else { log("Auto-Log Saved."); } }
    function startMonitoringRoutine() { setInterval(() => { takeLogSnapshot(false); }, 3600000); }
    function switchChart(mode) { currentChartMode = mode; document.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); renderStatsUI(); }
    function showStatsView() { switchView('viewStats'); renderStatsUI(); }
    function renderStatsUI() { let logs = JSON.parse(localStorage.getItem(LOG_STORAGE_KEY) || "[]").reverse(); let html = ""; logs.forEach(l => { let date = new Date(l.timestamp).toLocaleString('fr-FR'); let color = l.type === "MANUAL" ? "var(--purple)" : "#666"; let rev = l.revenue_usd || 0; let cost = l.cost_usd || 0; let net = l.profit_usd || 0; let ast = l.assets_count || 0; html += `<div class="dt-grid dt-row" style="grid-template-columns: 140px 60px 100px 100px 100px 100px;"><div class="cell" style="color:#fff">${date}</div><div class="cell" style="color:${color}; font-weight:bold;">${l.type}</div><div class="cell c-right" style="color:var(--green)">$${rev.toFixed(2)}</div><div class="cell c-right" style="color:var(--orange)">$${cost.toFixed(2)}</div><div class="cell c-right" style="color:${net>=0?'var(--blue)':'var(--red)'}">$${net.toFixed(2)}</div><div class="cell c-right">${ast}</div></div>`; }); getId('logTable').innerHTML = html; if(logs.length > 0) { let last = logs[0]; let prev = logs.length > 1 ? logs[1] : last; let diff = last.profit_usd - prev.profit_usd; let trend = diff >= 0 ? "UP" : "DOWN"; getId('financialInsight').innerText = `LATEST: Profit $${last.profit_usd?.toFixed(2)} (${trend} $${Math.abs(diff).toFixed(2)}). Margin: ${((last.profit_usd/last.revenue_usd)*100).toFixed(1)}%.`; } if(logs.length < 2) return; let cvs = getId('analyticsChart'); let ctx = cvs.getContext('2d'); let w = cvs.width = cvs.parentElement.offsetWidth; let h = cvs.height = cvs.parentElement.offsetHeight; ctx.fillStyle = "#08080a"; ctx.fillRect(0,0,w,h); let data = logs.slice(0, 30).reverse(); if(data.length < 2) return; let maxVal = 0; data.forEach(d => { if(currentChartMode === 'pnl') maxVal = Math.max(maxVal, d.profit_usd || 0); if(currentChartMode === 'scissors') maxVal = Math.max(maxVal, d.revenue_usd || 0); if(currentChartMode === 'tvl') maxVal = Math.max(maxVal, d.assets_count || 0); }); maxVal = maxVal * 1.1; ctx.strokeStyle = "#222"; ctx.beginPath(); for(let i=0; i<5; i++) { let y = i*(h/4); ctx.moveTo(0,y); ctx.lineTo(w,y); } ctx.stroke(); let step = w / (data.length - 1); if(currentChartMode === 'pnl') { ctx.fillStyle = "rgba(41, 121, 255, 0.2)"; ctx.strokeStyle = "#2979ff"; ctx.lineWidth = 2; ctx.beginPath(); data.forEach((d, i) => { let val = d.profit_usd || 0; let x = i * step; let y = h - ((val / maxVal) * h); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.stroke(); ctx.lineTo(w, h); ctx.lineTo(0, h); ctx.fill(); } else if (currentChartMode === 'scissors') { ctx.strokeStyle = "#00f090"; ctx.lineWidth = 2; ctx.beginPath(); data.forEach((d, i) => { let y = h - (((d.revenue_usd||0) / maxVal) * h); if(i===0) ctx.moveTo(i*step,y); else ctx.lineTo(i*step,y); }); ctx.stroke(); ctx.strokeStyle = "#ff3b30"; ctx.beginPath(); data.forEach((d, i) => { let y = h - (((d.cost_usd||0) / maxVal) * h); if(i===0) ctx.moveTo(i*step,y); else ctx.lineTo(i*step,y); }); ctx.stroke(); } else if (currentChartMode === 'tvl') { ctx.fillStyle = "#ff9100"; let barW = (w / data.length) - 2; data.forEach((d, i) => { let hBar = ((d.assets_count||0) / maxVal) * h; ctx.fillRect(i*step, h - hBar, barW, hBar); }); } }
    function exportLogs() { let logs = JSON.parse(localStorage.getItem(LOG_STORAGE_KEY) || "[]"); if(logs.length === 0) { alert("No logs."); return; } let csv = "TIMESTAMP,TYPE,REV_USD,COST_USD,NET_USD,ASSETS\n"; logs.forEach(r => { csv += `${r.timestamp},${r.type},${r.revenue_usd},${r.cost_usd},${r.profit_usd},${r.assets_count}\n`; }); let blob = new Blob([csv], {type:'text/csv'}); let url = window.URL.createObjectURL(blob); let a = document.createElement('a'); a.href=url; a.download='dov_financials.csv'; a.click(); }
    function findTemplate(tid) { if(DATA.templates.FUEL[tid]) return { ...DATA.templates.FUEL[tid], type:'F' }; if(DATA.templates.HEALTH[tid]) return { ...DATA.templates.HEALTH[tid], type:'H' }; if(DATA.templates.REPAIR[tid]) return { ...DATA.templates.REPAIR[tid], type:'R' }; if(DATA.templates.SUPPLY[tid]) return { ...DATA.templates.SUPPLY[tid], type:'S' }; return null; }
    async function fetchSmartCluster(endpoint, body) { let nodes = DATA.apiConfig.rpcNodes; let shuffled = [...nodes].sort(() => 0.5 - Math.random()); for(let i=0; i<shuffled.length; i++) { try { let controller = new AbortController(); setTimeout(() => controller.abort(), 2500); let res = await fetch(shuffled[i] + endpoint, { method: 'POST', body: body, signal: controller.signal }); if(res.ok) return await res.json(); } catch(e) { } } throw new Error("CLUSTER UNREACHABLE"); }
    
    // --- XRAY MODULE ---
    async function loadXrayAbi() { let contract = getId('xrayContract').value; log(`X-RAY: Loading ABI for ${contract}...`); try { let res = await fetchSmartCluster("/v1/chain/get_abi", JSON.stringify({account_name: contract})); if(res.abi && res.abi.tables) { let html = ""; res.abi.tables.forEach(t => { html += `<option value="${t.name}">${t.name}</option>`; }); getId('xrayTable').innerHTML = html; log(`X-RAY: Found ${res.abi.tables.length} tables.`); } else { log("X-RAY: No tables found or ABI access denied."); } } catch(e) { log("X-RAY Error: " + e.message); } }
    function onXrayContractChange() { let c = getId('xrayContract').value; let s = c; if(c.includes('atomic') || c.includes('nefty') || c.includes('blend')) s = 'dawnfvictory'; getId('xrayScope').value = s; }
    async function runXrayScan() { let contract = getId('xrayContract').value; let table = getId('xrayTable').value; let scope = getId('xrayScope').value; if(!table || table === "Load ABI first...") { alert("Please load ABI first."); return; } getId('xrayResults').innerText = "Scanning..."; log(`X-RAY: Scanning ${contract} -> ${table} (Scope: ${scope})...`); try { let res = await fetchSmartCluster("/v1/chain/get_table_rows", JSON.stringify({ json: true, code: contract, scope: scope, table: table, limit: 100 })); if(res.rows && res.rows.length > 0) { let headers = Object.keys(res.rows[0]); let html = `<table class="xray-table"><thead><tr>`; headers.forEach(h => html += `<th>${h.toUpperCase()}</th>`); html += `</tr></thead><tbody>`; res.rows.forEach(r => { html += `<tr>`; headers.forEach(h => { let val = r[h]; if(typeof val === 'object') val = JSON.stringify(val); html += `<td>${val}</td>`; }); html += `</tr>`; }); html += `</tbody></table>`; getId('xrayResults').innerHTML = html; log(`X-RAY: ${res.rows.length} rows retrieved.`); } else { getId('xrayResults').innerText = "No data found (Empty table or wrong scope)."; log("X-RAY: Empty result."); } } catch(e) { getId('xrayResults').innerText = "Error: " + e.message; log("X-RAY Error: " + e.message); } }
    function showXrayView() { switchView('viewXray'); }

    // --- DISPATCHES ---
    async function dispatchGlobalScan(silent = false) { stopSignal = false; if(!silent) switchView('viewGlobal'); if(getId('cntRows')) getId('cntRows').innerText = "..."; log("Scanning Buildings..."); let next = ""; let stats = { totalCost:0, types:{ F:{p:0, a:0, t:0, max:0}, H:{p:0, a:0, t:0, max:0}, R:{p:0, a:0, t:0, max:0}, S:{p:0, a:0, t:0, max:0} } }; let groups = {F:[], H:[], R:[], S:[]}; let rowCount = 0; let assetCount = 0; inactiveAssetsLog = []; try { while(!stopSignal) { let res = await fetchSmartCluster("/v1/chain/get_table_rows", JSON.stringify({json:true, code:"dovutilstake", scope:"dovutilstake", table:"buildings", limit:1000, lower_bound:next})); if(!res.rows) break; const now = Date.now()/1000; for(let r of res.rows) { let tid = r.template_id.toString(); let tpl = findTemplate(tid); if(!tpl) continue; rowCount++; let count = r.asset_ids ? r.asset_ids.length : 1; assetCount += count; stats.types[tpl.type].t += count; runtimeWalletSet.add(r.owner); let potentialProd = count * tpl.prod; stats.types[tpl.type].max += potentialProd; if(now < (parseFloat(r.last_claim) + parseFloat(r.delay))) { stats.types[tpl.type].a += count; let h = count * tpl.prod; let d = h * 24; let c = d * 0.085; let existing = groups[tpl.type].find(x => x.name === tpl.name); if(!existing) { existing = { id:tid, name:tpl.name, act:0, tot:0, unit:tpl.prod, totH:0, totD:0, costD:0 }; groups[tpl.type].push(existing); } existing.tot += count; existing.act += count; existing.totH += h; existing.totD += d; existing.costD += c; stats.types[tpl.type].p += h; stats.totalCost += c; } else { let stopTime = parseFloat(r.last_claim) + parseFloat(r.delay); let stopDate = new Date(stopTime * 1000); let safeIds = r.asset_ids || []; inactiveAssetsLog.push({ owner: r.owner, name: tpl.name, ids: safeIds, stopDate: stopDate.toLocaleString('fr-FR'), daysInactive: ((now - stopTime) / 86400).toFixed(1) }); } } ecoStats.buildings.active = assetCount; ecoStats.buildings.prodF = stats.types.F.p; ecoStats.buildings.prodH = stats.types.H.p; ecoStats.buildings.prodR = stats.types.R.p; ecoStats.buildings.prodS = stats.types.S.p; ecoStats.buildings.totalCost = stats.totalCost; updateGlobalUI(rowCount, stats, groups); if(res.more) next = res.next_key; else break; await new Promise(r => setTimeout(r, 50)); } saveData(); log(`Buildings Scan Done. ${assetCount} Assets.`); } catch(e) { log("Error Buildings: " + e.message); } }
    function updateGlobalUI(rows, stats, groups) { if(!getId('cntRows')) return; getId('cntRows').innerText = fmt(rows); if(getId('gTotalCost')) getId('gTotalCost').innerText = fmt(stats.totalCost); for(let k in DATA.resourceDefs) { let rd = DATA.resourceDefs[k]; let currentProd = stats.types[k].p; let dailyProd = currentProd * 24; let maxProd = stats.types[k].max; let efficiency = maxProd > 0 ? (currentProd / maxProd) * 100 : 0; let missingProd = maxProd - currentProd; let colorVar = 'var(--fff)'; if(rd.class === 'fuel') colorVar = 'var(--orange)'; if(rd.class === 'health') colorVar = 'var(--red)'; if(rd.class === 'repair') colorVar = 'var(--blue)'; if(rd.class === 'supply') colorVar = 'var(--yellow)'; let cardId = `card-${k}`; let cardEl = getId(cardId); if(cardEl) { cardEl.innerHTML = `<div style="margin-bottom:5px;"><div class="kc-title">DAILY PRODUCTION</div><div class="kc-val-huge" style="color:${colorVar}">${fmtDec(dailyProd)} <span style="font-size:14px; font-weight:normal; opacity:0.8;">${rd.label}</span></div></div><div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:8px; border-top:1px solid rgba(255,255,255,0.1); padding-top:5px;"><div><div style="font-size:9px; color:#888;">HOURLY</div><div style="font-size:12px; font-weight:bold; color:#fff;">${fmtDec(currentProd)}</div></div><div style="text-align:right;"><div style="font-size:9px; color:#888;">CAPACITY (MAX)</div><div style="font-size:12px; font-weight:bold; color:#ccc;">${fmtDec(maxProd)}</div></div></div><div style="margin-bottom:5px;"><div style="display:flex; justify-content:space-between; font-size:9px; font-weight:bold; margin-bottom:2px;"><span style="color:${efficiency < 80 ? 'var(--orange)' : 'var(--green)'}">OEE: ${efficiency.toFixed(1)}%</span><span style="color:#666" title="Manque √† produire">${missingProd > 0 ? '-' + fmt(missingProd) : 'OK'}</span></div><div style="height:4px; background:#333; border-radius:2px; overflow:hidden;"><div style="height:100%; width:${efficiency}%; background:${efficiency < 50 ? 'var(--red)' : (efficiency < 90 ? 'var(--orange)' : 'var(--green)')};"></div></div></div><div class="kc-sub" id="act-${k}" style="margin-top:auto;">${fmt(stats.types[k].a)} / ${fmt(stats.types[k].t)} ACT</div>`; } let list = groups[k].sort((a,b) => b.totH - a.totH); let html = ""; list.forEach(i => { let link = `https://wax.atomichub.io/explorer/template/wax-mainnet/dovdivisions/${i.id}`; let ratio = (i.costD > 0 && i.totD > 0) ? (i.totD / i.costD) : 0; let statusColor = i.act === 0 ? "color:var(--red)" : (i.act < i.tot ? "color:var(--orange)" : "color:var(--green)"); let rarityColor = "#ccc"; if(i.name.startsWith("R_")) rarityColor = "var(--blue)"; else if(i.name.startsWith("E_")) rarityColor = "var(--purple)"; else if(i.name.startsWith("L_")) rarityColor = "var(--orange)"; else if(i.name.startsWith("S1_") || i.name.startsWith("S_")) rarityColor = "var(--red)"; html += `<div class="dt-grid dt-row"><div class="cell"><a href="${link}" target="_blank" class="atomic" style="color:${rarityColor}">${i.name}</a></div><div class="cell c-center" style="font-weight:700;"><span style="${statusColor}">${i.act}</span> / <span style="color:#666">${i.tot}</span></div><div class="cell c-right" style="color:#666">${fmtDec(i.unit)}</div><div class="cell c-right ${rd.class}" style="font-weight:700;">${fmtDec(i.totH)}</div><div class="cell c-right" style="color:#888;">${fmtDec(i.totD)}</div><div class="cell c-right" style="color:#aaa;">${ratio.toFixed(2)}</div><div class="cell c-right" style="color:var(--purple);">${fmtDec(i.costD)}</div></div>`; }); getId(`tbl-${k}`).innerHTML = html; } }
    async function startZoneScan(silent = false) { stopSignal = false; if(!silent) switchView('viewZones'); if(getId('zTotalDivsHeader')) getId('zTotalDivsHeader').innerText = "SCANNING..."; log("Scanning Divisions (Detailed)..."); let stats = { totalDivs: 0, activeDivs: 0, totalProd: 0, cityBurn:0, bf:0, bh:0, br:0, bs:0 }; let next = ""; let zonesData = {}; Object.keys(SMART_ZONES_BIBLE).forEach(id => { zonesData[id] = { count: 0, active: 0, prod: 0, cityBurn:0, bf:0, bh:0, br:0, bs:0 }; }); zoneDetailsCache = {}; Object.keys(SMART_ZONES_BIBLE).forEach(id => { zoneDetailsCache[id] = []; }); try { while(!stopSignal) { let json = await fetchSmartCluster("/v1/chain/get_table_rows", JSON.stringify({json:true, code:"dovpvecontrl", scope:"dovpvecontrl", table:"sdivisions", limit:1000, lower_bound:next})); if(!json.rows) break; for(let r of json.rows) { let zid = r.zone_id || r.zoneID; if(zonesData[zid]) { zonesData[zid].count++; stats.totalDivs++; runtimeWalletSet.add(r.owner); let end = parseFloat(r.unlock_time || r.end_time || 0); let isFighting = end > (Date.now()/1000); if(isFighting) { zonesData[zid].active++; stats.activeDivs++; let zConf = SMART_ZONES_BIBLE[zid]; let isCity = [17, 18, 19, 20].includes(parseInt(zid)); if(isCity) { zonesData[zid].cityBurn += zConf.cost; stats.cityBurn += zConf.cost; } else { zonesData[zid].bf += zConf.cost; stats.bf += zConf.cost; zonesData[zid].bh += zConf.cost; stats.bh += zConf.cost; zonesData[zid].br += zConf.cost; stats.br += zConf.cost; zonesData[zid].bs += zConf.cost; stats.bs += zConf.cost; } zonesData[zid].prod += zConf.win; stats.totalProd += zConf.win; zoneDetailsCache[zid].push({ owner: r.owner, reward: zConf.win }); } } } ecoStats.divisions.active = stats.activeDivs; ecoStats.divisions.mint = stats.totalProd; ecoStats.cityBurn = stats.cityBurn; if(ecoStats.burns) { ecoStats.burns.F = stats.bf; ecoStats.burns.H = stats.bh; ecoStats.burns.R = stats.br; ecoStats.burns.S = stats.bs; } updateZoneUI(zonesData, stats); if(!json.more) break; next = json.next_key; await new Promise(r => setTimeout(r, 50)); } saveData(); log(`Divisions Scan Done. ${stats.activeDivs} Fighting.`); } catch(e) { log("Error Divisions: " + e.message); } if(getId('zoneStatus')) getId('zoneStatus').innerText = "Complete."; }
    function updateZoneUI(zonesData, stats) { 
        if(!getId('zTotalDivsHeader')) return; 
        getId('zTotalDivsHeader').innerText = fmt(stats.totalDivs); 
        getId('zTotalDivs').innerText = fmt(stats.totalDivs); 
        getId('zActiveDivs').innerText = fmt(stats.activeDivs); 
        let activePct = stats.totalDivs > 0 ? (stats.activeDivs / stats.totalDivs) * 100 : 0; 
        getId('zPieVal').innerText = activePct.toFixed(0) + "%"; 
        getId('zPieChart').style.background = `conic-gradient(var(--green) 0% ${activePct}%, #333 ${activePct}% 100%)`; 
        getId('zTotalProd').innerText = fmt(stats.totalProd); 
        getId('gBurnF').innerText = fmt(stats.bf); 
        getId('gBurnH').innerText = fmt(stats.bh); 
        getId('gBurnR').innerText = fmt(stats.br); 
        getId('gBurnS').innerText = fmt(stats.bs); 
        getId('gCityBurn').innerText = fmt(stats.cityBurn); 
        let html = ""; 
        Object.keys(zonesData).forEach(id => { 
            let z = SMART_ZONES_BIBLE[id]; 
            let d = zonesData[id]; 
            let activeClass = d.count > 0 ? "active" : ""; 
            let isCity = [17,18,19,20].includes(parseInt(id)); 
            
            // --- NEW V342: MAPPING PAR ID - STABLE & CLEAN ---
            let theme = ZONE_BG_MAP[id] || "default";
            let bgClass = "theme-" + theme;

            let weightBadge = `<span class="badge-weight">‚öñÔ∏è ${fmtDec(z.minW)}-${fmtDec(z.maxW)}</span>`; 
            let reqBadges = ""; 
            if(z.req && z.req.length > 0) { 
                z.req.forEach(r => { 
                    let entry = REQ_DICT[r]; 
                    if(entry) { 
                        // TEXT BADGE ONLY (No images to prevent crash)
                        reqBadges += `<a href="https://wax.atomichub.io/explorer/template/wax-mainnet/dovdivisions/${r}" target="_blank" class="badge-named ${entry.r}" title="View on AtomicHub">${entry.n}</a>`; 
                    } else { 
                        reqBadges += `<a href="https://wax.atomichub.io/explorer/template/wax-mainnet/dovdivisions/${r}" target="_blank" style="text-decoration:none;"><span class="badge-req" title="Req Template: ${r}">üîó ${r}</span></a>`; 
                    } 
                }); 
            } 
            let burnHtml = isCity ? `<div class="zs-item" style="font-size:10px; color:var(--purple); font-weight:bold; margin-top:2px; text-shadow:0 1px 2px #000;">ENTRY COST: ${z.cost} DOVX</div>` : `<div class="zs-item" style="color:#eee; font-size:9px; font-weight:bold; text-shadow:0 1px 2px #000;">UTILITY COST</div><div class="zs-item" style="font-size:9px; font-weight:bold; text-shadow:0 1px 2px #000;"><span class="tc-f">${fmt(d.bf)}</span> <span class="tc-h">${fmt(d.bh)}</span> <span class="tc-r">${fmt(d.br)}</span> <span class="tc-s">${fmt(d.bs)}</span></div>`; 
            
            html += `<div class="zone-card ${activeClass} ${bgClass}" onclick="openZoneDetail('${id}')">
                <div class="zc-header">
                    <span class="zone-title">${z.name}</span>
                    <div class="zc-sub">
                        <span style="color:${d.active>0?'var(--green)':'#aaa'}">${d.active} FIGHTING</span>
                        <span style="color:#fff">${d.count} TOTAL</span>
                    </div>
                </div>
                <div class="zc-mid">
                    <div style="margin-bottom:4px; display:flex; gap:4px; flex-wrap:wrap; min-height:15px;">${weightBadge} ${reqBadges}</div>
                    <div class="zs-item" style="text-shadow:0 1px 2px #000;"><span>MINT (DOVX)</span> <span style="color:var(--purple); font-weight:bold;">${fmt(d.prod)}</span></div>
                    <div style="height:1px; background:rgba(255,255,255,0.2); margin:2px 0;"></div>
                    ${burnHtml}
                </div>
            </div>`; 
        }); 
        getId('areaZones').innerHTML = html; 
    }

    // --- STANDARD FUNCTIONS (Included implicitly) ---
    function openAuditView() { if(inactiveAssetsLog.length === 0) { alert("Aucun actif inactif d√©tect√© ou scan non effectu√©."); return; } let toolbar = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; background:#111; padding:10px; border-radius:4px; border:1px solid #333;"><div style="font-size:10px; color:#888;">FILTRE D'EXPORTATION</div><div style="display:flex; gap:10px; align-items:center;"><span style="font-size:10px; color:#ccc;">MINIMUM JOURS:</span><input type="number" id="auditThreshold" value="30" style="width:60px; padding:4px; text-align:center; background:#000; border:1px solid #444; color:#fff;"><button class="btn-blue" style="width:auto; padding:4px 15px;" onclick="exportAuditCsv()">EXPORTER LA CIBLE (.CSV)</button></div></div>`; let sorted = inactiveAssetsLog.sort((a,b) => parseFloat(b.daysInactive) - parseFloat(a.daysInactive)); let html = ""; sorted.forEach(item => { let rarityColor = "#ccc"; if(item.name.startsWith("R_")) rarityColor = "var(--blue)"; else if(item.name.startsWith("E_")) rarityColor = "var(--purple)"; else if(item.name.startsWith("L_")) rarityColor = "var(--orange)"; else if(item.name.startsWith("S1_")) rarityColor = "var(--red)"; let idsString = JSON.stringify(item.ids); html += `<div class="dt-grid dt-row" style="grid-template-columns: 1fr 1fr 1fr 100px 100px;"><div class="cell" style="color:#fff; font-weight:bold;">${item.owner}</div><div class="cell" style="color:${rarityColor}">${item.name}</div><div class="cell" style="color:#888">${item.stopDate}</div><div class="cell" style="color:var(--red); font-weight:bold;">${item.daysInactive} JOURS</div><div class="cell c-center"><button class="btn-ghost" style="padding:2px 5px; font-size:9px;" onclick='copyIds(${idsString})'>COPIER IDs</button></div></div>`; }); getId('auditList').innerHTML = toolbar + html; getId('auditModal').style.display = 'flex'; }
    function exportAuditCsv() { let days = parseFloat(document.getElementById('auditThreshold').value) || 0; let targetList = inactiveAssetsLog.filter(x => parseFloat(x.daysInactive) >= days); if(targetList.length === 0) { alert("Aucun actif ne correspond √† ce crit√®re."); return; } let csv = "OWNER,TEMPLATE,DAYS_INACTIVE,STOP_DATE,IDS_JSON\n"; targetList.forEach(r => { let idsStr = JSON.stringify(r.ids || []); let idsSafe = idsStr.replace(/"/g, '""'); csv += `${r.owner},${r.name},${r.daysInactive},${r.stopDate},"${idsSafe}"\n`; }); let blob = new Blob([csv], {type:'text/csv'}); let url = window.URL.createObjectURL(blob); let a = document.createElement('a'); a.href = url; a.download = `AUDIT_INACTIFS_PLUS_${days}J.csv`; a.click(); }
    function copyIds(idsArray) { let text = JSON.stringify(idsArray); navigator.clipboard.writeText(text).then(() => { alert("IDs copi√©s !"); }); }

    window.onload = init;
</script>
</body>
</html>
