<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DoV - COMMAND V185 (FULL SUITE)</title>
    <style>
        /* --- DESIGN SYSTEM WEB3 --- */
        :root {
            --bg-body: #0b0c15; --bg-panel: #12131f; --bg-card: #151621; --border: #2b2d42;
            --primary: #3498db; --accent: #00e676; --dovx: #e056fd; --gold: #f1c40f;
            --fuel: #e67e22; --health: #e74c3c; --repair: #3498db; --supply: #feca57;
            --text-main: #f1f2f6; --text-muted: #8d99ae;
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-mono: 'Consolas', monospace;
        }

        body { background-color: var(--bg-body); color: var(--text-gray); font-family: var(--font-main); margin: 0; display: flex; height: 100vh; overflow: hidden; font-size: 12px; }
        * { box-sizing: border-box; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: var(--bg-body); } ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        /* --- HEADER & LAYOUT --- */
        header { height: 50px; background: rgba(18, 19, 31, 0.95); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; z-index: 10; }
        .logo-dot { width:10px; height:10px; background:var(--accent); border-radius:50%; box-shadow:0 0 10px var(--accent); margin-right:10px; }
        h1 { color: #fff; margin: 0; font-size: 14px; letter-spacing: 1px; font-weight: 700; text-transform: uppercase; }

        .layout { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 280px; background: var(--bg-panel); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        .main-view { flex: 1; padding: 30px; overflow-y: auto; position: relative; background: radial-gradient(circle at 50% 0%, rgba(20,20,30,1) 0%, rgba(5,5,8,1) 100%); }

        /* --- COMPONENTS --- */
        .box-framed { border: 1px solid var(--border); padding: 15px; border-radius: 6px; background: rgba(255,255,255,0.02); }
        .group-label { font-size: 10px; font-weight: 700; color: #57606f; text-transform: uppercase; margin-bottom: 5px; }

        button { width: 100%; padding: 10px; cursor: pointer; border: none; font-weight: 700; font-size: 10px; text-transform: uppercase; border-radius: 4px; transition: 0.2s; color:#fff; margin-bottom:5px; }
        button:hover { opacity: 0.9; }
        .btn-green { background: linear-gradient(135deg, #00b894, #00cec9); color:#000; }
        .btn-orange { background: linear-gradient(135deg, #f39c12, #e67e22); color:#000; }
        .btn-blue { background: linear-gradient(135deg, #2980b9, #3498db); }
        .btn-red { background: #c0392b; }
        .btn-row { display:flex; gap:10px; }
        .btn-ghost { background:transparent; border:1px solid #444; color:#888; } .btn-ghost:hover { border-color:#fff; color:#fff; }
        
        input { width: 100%; padding: 8px; background: #050508; border: 1px solid #333; color: #fff; border-radius: 4px; font-family: var(--font-mono); margin-bottom: 8px; }

        /* --- GLOBAL DASHBOARD --- */
        .g-main-count { background: linear-gradient(90deg, #151621 0%, #1a1b26 100%); border: 1px solid var(--border); padding: 20px; border-radius: 12px; display:flex; justify-content:space-between; align-items:center; margin-bottom: 25px; border-left: 4px solid var(--accent); }
        .g-title { font-size:18px; font-weight:800; color:#fff; }
        .g-sub { font-size:11px; color:#666; font-family:var(--font-mono); }
        .g-cost-val { font-size:24px; font-weight:800; color:#fff; }
        
        .cards-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        .res-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 20px; text-align: center; position: relative; }
        .rc-label { font-size: 11px; font-weight: 700; color: #888; text-transform: uppercase; margin-bottom: 10px; }
        .rc-val { font-size: 22px; font-weight: 800; color: #fff; }
        .rc-sub { font-size: 9px; color: #444; margin-top: 5px; text-transform: uppercase; }

        .lists-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .list-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; min-height: 200px; }
        .lp-header { background: #1a1c29; padding: 12px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .lp-title { font-weight: 700; color: #ccc; font-size: 11px; text-transform: uppercase; }
        .badge { font-size: 9px; padding: 3px 8px; border-radius: 4px; background: #252838; border: 1px solid #333; color: #fff; font-family: var(--font-mono); }
        .badge-cost { border-color: rgba(224, 86, 253, 0.3); color: var(--dovx); background: rgba(224, 86, 253, 0.05); }

        .t-header { display: grid; grid-template-columns: 3fr 0.5fr 1.5fr 1.5fr; padding: 8px 15px; font-size: 9px; color: #555; font-weight: 700; text-transform: uppercase; border-bottom: 1px solid #222; background: rgba(0,0,0,0.2); }
        .t-row { display: grid; grid-template-columns: 3fr 0.5fr 1.5fr 1.5fr; padding: 10px 15px; border-bottom: 1px solid rgba(255,255,255,0.02); font-size: 11px; align-items: center; color: #eee; }
        .t-row:hover { background: rgba(255,255,255,0.03); }
        .t-act { color: var(--accent); font-weight: bold; text-align: center; }
        .t-val { text-align: right; font-family: var(--font-mono); color: #fff; }
        .t-val-dim { text-align: right; font-family: var(--font-mono); color: #777; }

        /* --- ZONES & ECO --- */
        .zones-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .zone { background: #1e202e; border: 1px solid var(--border); padding: 15px; border-radius: 8px; transition:0.2s; position:relative; overflow:hidden; }
        .zone:hover { border-color: var(--accent); } .zone.active { border-color: var(--primary); background: #151621; }
        .z-head { display:flex; justify-content:space-between; font-weight:bold; color:#fff; margin-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px; }
        .z-metric { display:flex; justify-content:space-between; font-size:10px; margin-bottom:3px; }
        .z-val { color: var(--text-main); font-family: var(--font-mono); }

        .eco-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .eco-card { background: #1e202e; border: 1px solid var(--border); padding: 20px; border-radius: 12px; }
        .eco-title { color:#666; font-size:10px; text-transform:uppercase; margin-bottom:10px; font-weight:700; }
        .eco-val { color:#fff; font-size:24px; font-weight:800; }
        
        /* --- TARGET LISTS --- */
        .build-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .b-card { background: #1e202e; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size:11px; }

        /* UTILS */
        .border-fuel::before { background: var(--fuel); } .txt-fuel { color: var(--fuel); }
        .border-health::before { background: var(--health); } .txt-health { color: var(--health); }
        .border-repair::before { background: var(--repair); } .txt-repair { color: var(--repair); }
        .border-supply::before { background: var(--supply); } .txt-supply { color: var(--supply); }
        .view-section { display: none; }
        #systemBadge { position: absolute; top: 15px; right: 20px; font-size: 10px; color: #555; }
        
        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 1000; justify-content: center; align-items: center; }
        .modal-box { background: #111; border: 1px solid var(--panel-border); width: 700px; max-height: 90vh; display: flex; flex-direction: column; border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal-head { padding: 15px 20px; background: rgba(255,255,255,0.05); border-bottom: 1px solid var(--panel-border); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-weight: 800; color: #fff; text-transform: uppercase; letter-spacing: 1px; }
        .modal-close { cursor: pointer; color: var(--text-muted); font-size: 20px; transition: 0.2s; }
        .modal-close:hover { color: #fff; }
        .modal-body { padding: 15px; overflow-y: auto; color: #ccc; font-size: 11px; }
        .set-group { margin-bottom: 15px; border: 1px solid #333; padding: 10px; }
        .set-title { color: var(--gold); font-weight: bold; margin-bottom: 5px; display:block; border-bottom:1px solid #444; padding-bottom:3px; }
        textarea { width: 100%; height: 100px; background: #0b0c15; color: #ccc; border: 1px solid #333; font-family: monospace; padding: 10px; }
    </style>
</head>
<body>

<header>
    <div class="brand">
        <div class="logo-dot"></div>
        <h1>DoV COMMAND <span class="version">V185</span></h1>
    </div>
    <div id="systemBadge">SYSTEM READY</div>
</header>

<div class="layout">
    <aside class="sidebar">
        <div class="panel-group">
            <span class="group-label">OPERATIONS</span>
            <div class="box-framed">
                <div class="btn-row">
                    <button class="btn-green" onclick="dispatchGlobalScan()">GLOBAL SCAN</button>
                    <button class="btn-red" onclick="stopSignal=true">STOP</button>
                </div>
                <div class="btn-row">
                    <button class="btn-teal" onclick="startZoneScan()">ZONES</button>
                    <button class="btn-orange" onclick="startEconomyScan()">ECONOMY</button>
                </div>
            </div>
        </div>

        <div class="panel-group">
            <span class="group-label">TARGET ACCOUNT</span>
            <div class="box-framed">
                <input type="text" id="targetIn" value="u2d2k.c.wam">
                <div class="btn-row">
                    <button class="btn-blue" onclick="startTargetDivisions()">DIVISIONS</button>
                    <button class="btn-blue" onclick="startTargetBuildings()">BUILDINGS</button>
                </div>
            </div>
        </div>

        <div class="panel-group" style="margin-top:auto">
            <span class="group-label">SYSTEM</span>
            <div class="box-framed">
                <div style="font-size:10px; margin-bottom:5px;">TEMPLATES: <b id="dictSize" style="color:#fff">0</b></div>
                <button class="btn-ghost" onclick="openSettings()">SETTINGS</button>
                <button class="btn-ghost" onclick="hardReset()" style="color:var(--alert)">FACTORY RESET</button>
            </div>
        </div>
    </aside>

    <main class="main-view">
        
        <div id="globalView" class="view-section" style="display:block;">
            <div class="g-main-count">
                <div>
                    <div class="g-title">GLOBAL SCAN LIVE</div>
                    <div class="g-sub">Rows: <b id="cntRows">0</b> &nbsp;|&nbsp; Assets: <b id="cntAssets">0</b></div>
                </div>
                <div class="g-cost-box">
                    <div class="g-cost-lbl">TOTAL MAINTENANCE</div>
                    <div><span class="g-cost-val" id="gTotalCost">0</span> <span class="g-cost-curr">DOVX</span></div>
                </div>
            </div>
            <div class="cards-container" id="dynamicCardsArea"></div>
            <div class="lists-grid" id="dynamicListsArea"></div>
        </div>

        <div id="zoneView" class="view-section">
            <div class="g-main-count" style="border-left-color: var(--accent);">
                <div class="g-title">ZONE ACTIVITY MAP</div>
                <div class="g-sub" id="zoneStatus">Waiting for scan...</div>
            </div>
            <div class="zones-grid" id="zonesArea"></div>
        </div>

        <div id="ecoView" class="view-section">
             <div class="g-main-count" style="border-left-color: var(--gold);">
                <div class="g-title">ECONOMY WATCH</div>
                <div class="g-sub" id="ecoStatus">Waiting for scan...</div>
            </div>
            <div class="eco-grid">
                <div class="eco-card"><div class="eco-title">GLOBAL DEMAND</div><div class="eco-val" id="valDemandTU">0</div></div>
                <div class="eco-card"><div class="eco-title">ACTIVE ZONES</div><div class="eco-val" id="valActiveZones">0</div></div>
                <div class="eco-card"><div class="eco-title">DOVX BURN</div><div class="eco-val" id="valEcoBurn">0</div></div>
            </div>
        </div>

        <div id="targetBuildView" class="view-section">
            <div class="g-main-count" style="border-left-color: #3498db;">
                <div class="g-title">PLAYER BUILDINGS</div>
                <div class="g-sub" id="buildStatus">Ready to scan...</div>
            </div>
            <div id="buildList" class="build-grid"></div>
        </div>

        <div id="targetDivView" class="view-section">
            <div class="g-main-count" style="border-left-color: #3498db;">
                <div class="g-title">PLAYER DIVISIONS</div>
                <div class="g-sub" id="divStatus">Ready to scan...</div>
            </div>
            <div id="divList" class="build-grid"></div>
        </div>

    </main>
</div>

<div class="modal-overlay" id="settingsModal">
    <div class="modal-box">
        <div class="modal-head">
            <div class="modal-title">CONFIGURATION</div>
            <div class="modal-close" onclick="closeModal('settingsModal')">×</div>
        </div>
        <div class="modal-body">
            <div class="set-group"><span class="set-title">INTERFACE</span><textarea id="cfgResources"></textarea></div>
            <div class="set-group"><span class="set-title">RÈGLES</span><textarea id="cfgGameRules"></textarea></div>
            <div class="set-group"><span class="set-title">ZONES</span><textarea id="cfgZones"></textarea></div>
            <div class="set-group"><span class="set-title">TEMPLATES</span><textarea id="cfgTemplates"></textarea></div>
            <button class="btn-green" onclick="saveConfig()">SAVE</button>
        </div>
    </div>
</div>

<script>
    // --- UTILS ---
    window.closeModal = function(id) { document.getElementById(id).style.display = 'none'; }
    function switchView(id) {
        document.querySelectorAll('.view-section').forEach(e => e.style.display = 'none');
        document.getElementById(id).style.display = 'block';
    }
    function setTextSafe(id, val) { let e=document.getElementById(id); if(e) e.innerText=val; }

    // --- DEFAULT DATA ---
    const DEFAULT_DATA = {
        resourceDefs: {
            "F": { label: "FUEL", color: "#e67e22", css: "border-fuel", txt: "txt-fuel" },
            "H": { label: "HEALTH", color: "#e74c3c", css: "border-health", txt: "txt-health" },
            "R": { label: "REPAIR", color: "#3498db", css: "border-repair", txt: "txt-repair" },
            "S": { label: "SUPPLY", color: "#feca57", css: "border-supply", txt: "txt-supply" }
        },
        gameConfig: {
            maintenanceCost: 0.085,
            cycleHours: 24,
            tokenMap: { "DOVF": "F", "DOVH": "H", "DOVR": "R", "DOVS": "S" }
        },
        zones: { 
            1:{name:"Beach 1",cost:1160},2:{name:"Beach 2",cost:6968},3:{name:"Beach 3",cost:8800},4:{name:"Bunker",cost:11120},
            5:{name:"Forest 1",cost:14024},6:{name:"Forest 2",cost:17704},7:{name:"Forest 3",cost:22352},8:{name:"Camp",cost:28220},
            9:{name:"Hill 1",cost:37052},10:{name:"Hill 2",cost:48652},11:{name:"Hill 3",cost:64516},12:{name:"Radar",cost:84712},
            13:{name:"Plain 1",cost:99384},14:{name:"Plain 2",cost:125708},15:{name:"Plain 3",cost:151164},16:{name:"HQ",cost:188000},
            17:{name:"City 1",cost:0},18:{name:"City 2",cost:0},19:{name:"City 3",cost:0},20:{name:"City 4",cost:0}
        },
        templates: {
            "490122": { "name": "C_F1_PRODUCER_FUEL", "prod": 5.4 }, "492383": { "name": "C_F1_PRODUCER_FUEL", "prod": 5.4 },
            "492385": { "name": "C_F2_PRODUCER_FUEL", "prod": 12.15 }, "492363": { "name": "C_F2_PRODUCER_FUEL (VAR)", "prod": 12.15 },
            "492389": { "name": "C_F3_PRODUCER_FUEL", "prod": 30.38 }, "492366": { "name": "C_F3_PRODUCER_FUEL (VAR)", "prod": 30.38 },
            "492397": { "name": "C_F4_PRODUCER_FUEL", "prod": 83.53 }, "492373": { "name": "R_F1_PRODUCER_FUEL", "prod": 16.20 },
            "492379": { "name": "R_F1_PRODUCER_FUEL", "prod": 16.20 }, "492376": { "name": "R_F2_PRODUCER_FUEL", "prod": 36.45 },
            "492386": { "name": "R_F3_PRODUCER_FUEL", "prod": 91.13 }, "492390": { "name": "R_F4_PRODUCER_FUEL", "prod": 250.59 },
            "492380": { "name": "E_F1_PRODUCER_FUEL", "prod": 48.60 }, "492381": { "name": "E_F2_PRODUCER_FUEL", "prod": 109.35 },
            "492387": { "name": "E_F3_PRODUCER_FUEL", "prod": 273.38 }, "492388": { "name": "E_F4_PRODUCER_FUEL", "prod": 751.78 },
            "492368": { "name": "L_F1_PRODUCER_FUEL", "prod": 145.80 }, "492370": { "name": "L_F2_PRODUCER_FUEL", "prod": 328.05 },
            "492372": { "name": "L_F3_PRODUCER_FUEL", "prod": 820.13 }, "544068": { "name": "S1_OWNER_FUEL", "prod": 2255.34 },
            "492392": { "name": "S1_OWNER_FUEL (VAR)", "prod": 2255.34 }, "492377": { "name": "SC_F2_PRODUCER_FUEL", "prod": 54.00 },
            "492391": { "name": "SC_F3_PRODUCER_FUEL", "prod": 121.50 },
            "492394": { "name": "C_F1_PRODUCER_HEALTH", "prod": 5.4 }, "492395": { "name": "C_F2_PRODUCER_HEALTH", "prod": 12.15 },
            "492396": { "name": "C_F3_PRODUCER_HEALTH", "prod": 30.38 }, "492399": { "name": "R_F1_PRODUCER_HEALTH", "prod": 16.20 },
            "492401": { "name": "R_F2_PRODUCER_HEALTH", "prod": 36.45 }, "492535": { "name": "R_F3_PRODUCER_HEALTH", "prod": 91.13 },
            "492537": { "name": "R_F4_PRODUCER_HEALTH", "prod": 250.59 }, "492539": { "name": "E_F1_PRODUCER_HEALTH", "prod": 48.60 },
            "492543": { "name": "E_F2_PRODUCER_HEALTH", "prod": 109.35 }, "492545": { "name": "E_F3_PRODUCER_HEALTH", "prod": 273.38 },
            "492546": { "name": "E_F4_PRODUCER_HEALTH", "prod": 751.78 }, "492550": { "name": "L_F1_PRODUCER_HEALTH", "prod": 145.80 },
            "492554": { "name": "L_F2_PRODUCER_HEALTH", "prod": 328.05 }, "492555": { "name": "L_F3_PRODUCER_HEALTH", "prod": 820.13 },
            "544070": { "name": "S1_OWNER_HEALTH", "prod": 2255.34 }, "492460": { "name": "C_F1_PRODUCER_REPAIR", "prod": 5.4 },
            "492461": { "name": "C_F2_PRODUCER_REPAIR", "prod": 12.15 }, "492462": { "name": "C_F3_PRODUCER_REPAIR", "prod": 30.38 },
            "492463": { "name": "C_F4_PRODUCER_REPAIR", "prod": 83.53 }, "492464": { "name": "R_F1_PRODUCER_REPAIR", "prod": 16.20 },
            "492465": { "name": "R_F2_PRODUCER_REPAIR", "prod": 36.45 }, "492466": { "name": "R_F3_PRODUCER_REPAIR", "prod": 91.13 },
            "492467": { "name": "R_F4_PRODUCER_REPAIR", "prod": 250.59 }, "492469": { "name": "E_F1_PRODUCER_REPAIR", "prod": 48.60 },
            "492471": { "name": "E_F2_PRODUCER_REPAIR", "prod": 109.35 }, "492472": { "name": "E_F3_PRODUCER_REPAIR", "prod": 273.38 },
            "492473": { "name": "E_F4_PRODUCER_REPAIR", "prod": 751.78 }, "492474": { "name": "L_F1_PRODUCER_REPAIR", "prod": 145.80 },
            "492475": { "name": "L_F2_PRODUCER_REPAIR", "prod": 328.05 }, "492476": { "name": "L_F3_PRODUCER_REPAIR", "prod": 820.13 },
            "544071": { "name": "S1_OWNER_REPAIR", "prod": 2255.34 }, "492507": { "name": "C_F1_PRODUCER_SUPPLY", "prod": 5.4 },
            "492509": { "name": "C_F2_PRODUCER_SUPPLY", "prod": 12.15 }, "492511": { "name": "C_F3_PRODUCER_SUPPLY", "prod": 30.38 },
            "492513": { "name": "C_F4_PRODUCER_SUPPLY", "prod": 83.53 }, "492515": { "name": "R_F1_PRODUCER_SUPPLY", "prod": 16.20 },
            "492518": { "name": "R_F2_PRODUCER_SUPPLY", "prod": 36.45 }, "492521": { "name": "R_F3_PRODUCER_SUPPLY", "prod": 91.13 },
            "492523": { "name": "R_F4_PRODUCER_SUPPLY", "prod": 250.59 }, "492526": { "name": "E_F1_PRODUCER_SUPPLY", "prod": 48.60 },
            "492528": { "name": "E_F2_PRODUCER_SUPPLY", "prod": 109.35 }, "492529": { "name": "E_F3_PRODUCER_SUPPLY", "prod": 273.38 },
            "492530": { "name": "E_F4_PRODUCER_SUPPLY", "prod": 751.78 }, "492532": { "name": "L_F1_PRODUCER_SUPPLY", "prod": 145.80 },
            "492533": { "name": "L_F2_PRODUCER_SUPPLY", "prod": 328.05 }, "492534": { "name": "L_F3_PRODUCER_SUPPLY", "prod": 820.13 },
            "544069": { "name": "S1_OWNER_SUPPLY", "prod": 2255.34 }
        }
    };

    let CORE_DATA = JSON.parse(JSON.stringify(DEFAULT_DATA));
    let stopSignal = false; 

    function initApp() {
        const stored = localStorage.getItem('DOV_DATA');
        if(stored) { try { let loaded = JSON.parse(stored); CORE_DATA = { ...DEFAULT_DATA, ...loaded, templates: { ...DEFAULT_DATA.templates, ...(loaded.templates||{}) } }; } catch(e){} }
        document.getElementById('dictSize').innerText = Object.keys(CORE_DATA.templates).length;
        initUI();
    }
    
    function initUI() {
        const c = document.getElementById('dynamicCardsArea'); 
        const l = document.getElementById('dynamicListsArea');
        c.innerHTML = ""; l.innerHTML = "";
        
        for(let k in CORE_DATA.resourceDefs) {
            let r = CORE_DATA.resourceDefs[k];
            c.innerHTML += `<div class="res-card ${r.css}"><div class="rc-label">${r.label}</div><div class="rc-val" style="color:${r.color}" id="pwr-${k}">0</div><div class="rc-sub">PROD / HOUR</div></div>`;
            l.innerHTML += `
            <div class="list-panel">
                <div class="lp-header">
                    <div class="lp-title">${r.label} BREAKDOWN</div>
                    <div class="lp-badges"><span class="badge">PROD: <span id="tot-p-${k}">0</span></span><span class="badge badge-cost">COST: <span id="tot-c-${k}">0</span></span></div>
                </div>
                <div class="t-header"><span>TEMPLATE</span><span>ACT</span><span style="text-align:right">TOT/H</span><span style="text-align:right">TOT/24H</span></div>
                <div class="t-body" id="list-${k}"></div>
            </div>`;
        }
    }

    function hardReset() { if(confirm("FACTORY RESET?")) { localStorage.removeItem('DOV_DATA'); location.reload(); } }
    
    // --- API ---
    async function fetchRows(code, table, scope, limit, lower) {
        try {
            let res = await fetch("https://wax.greymass.com/v1/chain/get_table_rows", {
                method: 'POST',
                body: JSON.stringify({ json:true, code:code, scope:scope, table:table, limit:limit, lower_bound:lower })
            });
            return await res.json();
        } catch(e) { return { rows: [] }; }
    }

    // --- CORE LOGIC (NOMINAL) ---
    function conformData(row) {
        let tid = row.template_id.toString();
        let count = row.asset_ids ? row.asset_ids.length : 1;
        let tpl = CORE_DATA.templates[tid];
        let name = tpl ? tpl.name : `UNKNOWN [${tid}]`;
        let nominal = tpl ? tpl.prod : 0;
        let totalHourly = count * nominal;
        let totalDaily = totalHourly * CORE_DATA.gameConfig.cycleHours;
        let cost = totalDaily * CORE_DATA.gameConfig.maintenanceCost;
        let rawStr = (Array.isArray(row.power)?row.power[0]:row.power) || "";
        let type = "F"; 
        for(let t in CORE_DATA.gameConfig.tokenMap) if(rawStr.includes(t)) { type = CORE_DATA.gameConfig.tokenMap[t]; break; }
        return { name, type, count, totalHourly, totalDaily, cost };
    }

    // --- 1. GLOBAL SCAN ---
    async function dispatchGlobalScan() {
        stopSignal = false; switchView('globalView');
        let next = ""; let stats = { F:{p:0, c:0}, H:{p:0, c:0}, R:{p:0, c:0}, S:{p:0, c:0}, totalCost:0 };
        let groups = { F:[], H:[], R:[], S:[] }; let rows=0, assets=0;
        
        while(!stopSignal) {
            let data = await fetchRows("dovutilstake", "buildings", "dovutilstake", 1000, next);
            if(!data.rows || data.rows.length === 0) break;
            const now = Date.now()/1000;
            
            for(let row of data.rows) {
                rows++; let info = conformData(row); assets += info.count;
                let active = now < (parseFloat(row.last_claim) + parseFloat(row.delay));
                if(active) {
                    let existing = groups[info.type].find(x => x.name === info.name);
                    if(existing) { existing.act += info.count; existing.totH += info.totalHourly; existing.totD += info.totalDaily; }
                    else { groups[info.type].push({ name:info.name, act:info.count, totH:info.totalHourly, totD:info.totalDaily }); }
                    stats[info.type].p += info.totalHourly; stats[info.type].c += info.cost; stats.totalCost += info.cost;
                }
            }
            updateGlobalUI(rows, assets, stats, groups);
            if(data.more) next = data.next_key; else break;
            await new Promise(r => setTimeout(r, 50));
        }
    }

    function updateGlobalUI(r, a, s, g) {
        document.getElementById('cntRows').innerText = r; document.getElementById('cntAssets').innerText = a;
        document.getElementById('gTotalCost').innerText = Math.floor(s.totalCost).toLocaleString();
        for(let k in CORE_DATA.resourceDefs) {
            document.getElementById(`pwr-${k}`).innerText = s[k].p.toLocaleString(undefined, {maximumFractionDigits:2});
            document.getElementById(`tot-p-${k}`).innerText = s[k].p.toLocaleString(undefined, {maximumFractionDigits:2});
            document.getElementById(`tot-c-${k}`).innerText = Math.floor(s[k].c).toLocaleString();
            let html = "";
            g[k].sort((a,b)=>b.totH-a.totH).forEach(i => {
                html += `<div class="t-row"><div class="t-name">${i.name}</div><div class="t-act">${i.act}</div><div class="t-val ${CORE_DATA.resourceDefs[k].txt}">${i.totH.toLocaleString(undefined,{maximumFractionDigits:2})}</div><div class="t-val-dim">${i.totD.toLocaleString(undefined,{maximumFractionDigits:2})}</div></div>`;
            });
            document.getElementById(`list-${k}`).innerHTML = html;
        }
    }

    // --- 2. ZONES SCAN ---
    async function startZoneScan() {
        stopSignal = false; switchView('zoneView');
        document.getElementById('zoneStatus').innerText = "Scanning...";
        const grid = document.getElementById('zonesArea'); grid.innerHTML = "";
        let counts = {}; Object.keys(CORE_DATA.zones).forEach(k => counts[k] = 0);
        let next = "";
        
        while(!stopSignal) {
            let data = await fetchRows("dovpvecontrl", "sdivisions", "dovpvecontrl", 1000, next);
            if(!data.rows) break;
            for(let row of data.rows) { let id = row.zone_id || row.zoneID; if(counts[id] !== undefined) counts[id]++; }
            
            let html = "";
            Object.keys(counts).forEach(id => {
                let z = CORE_DATA.zones[id];
                let css = counts[id] > 0 ? "active" : "";
                html += `<div class="zone ${css}"><div class="z-head"><span>${z.name}</span><span>${counts[id]}</span></div><div class="z-metric"><span>COST</span><span class="z-val">${z.cost} TU</span></div></div>`;
            });
            grid.innerHTML = html;
            if(data.more) next = data.next_key; else break;
            await new Promise(r => setTimeout(r, 50));
        }
        document.getElementById('zoneStatus').innerText = "Scan Complete";
    }

    // --- 3. ECONOMY SCAN ---
    async function startEconomyScan() {
        stopSignal = false; switchView('ecoView');
        document.getElementById('ecoStatus').innerText = "Scanning...";
        let dTU = 0, activeZones = 0, next = "";
        while(!stopSignal) {
            let data = await fetchRows("dovpvecontrl", "sdivisions", "dovpvecontrl", 1000, next);
            if(!data.rows) break;
            for(let r of data.rows) {
                let id = r.zone_id; let z = CORE_DATA.zones[id];
                if(z && z.cost > 0) { dTU += z.cost; activeZones++; }
            }
            document.getElementById('valDemandTU').innerText = dTU.toLocaleString();
            document.getElementById('valActiveZones').innerText = activeZones.toLocaleString();
            if(data.more) next = data.next_key; else break;
            await new Promise(r => setTimeout(r, 50));
        }
        document.getElementById('ecoStatus').innerText = "Scan Complete";
    }

    // --- 4. TARGET BUILDINGS ---
    async function startTargetBuildings() {
        stopSignal = false; switchView('targetBuildView');
        let user = document.getElementById('targetIn').value;
        document.getElementById('buildStatus').innerText = "Scanning " + user + "...";
        let el = document.getElementById('buildList'); el.innerHTML = "";
        let next = ""; let html = "";
        
        while(!stopSignal) {
            let data = await fetchRows("dovutilstake", "buildings", user, 1000, next);
            if(!data.rows) break;
            for(let row of data.rows) {
                let info = conformData(row);
                let color = DEFAULT_DATA.resourceDefs[info.type].color;
                html += `<div class="b-card" style="border-left:3px solid ${color}"><div class="b-head" style="color:${color}">${info.name}</div><div class="b-sub">ACTIVE: ${info.count}</div><div class="b-stat">${info.totalHourly.toLocaleString()} /h</div></div>`;
            }
            el.innerHTML = html;
            if(data.more) next = data.next_key; else break;
        }
        document.getElementById('buildStatus').innerText = "Scan Complete";
    }

    // --- 5. TARGET DIVISIONS ---
    async function startTargetDivisions() {
        stopSignal = false; switchView('targetDivView');
        let user = document.getElementById('targetIn').value;
        document.getElementById('divStatus').innerText = "Scanning " + user + "...";
        let el = document.getElementById('divList'); el.innerHTML = "";
        let next = ""; let html = "";
        
        while(!stopSignal) {
            let data = await fetchRows("dovpvecontrl", "sdivisions", user, 1000, next);
            if(!data.rows) break;
            for(let row of data.rows) {
                let id = row.zone_id; let z = CORE_DATA.zones[id];
                html += `<div class="b-card"><div class="b-head">${z ? z.name : 'Zone '+id}</div><div class="b-sub">#${row.division_id}</div><div class="b-stat" style="color:var(--accent)">READY</div></div>`;
            }
            el.innerHTML = html;
            if(data.more) next = data.next_key; else break;
        }
        document.getElementById('divStatus').innerText = "Scan Complete";
    }

    // --- SETTINGS ---
    function openSettings() {
        document.getElementById('cfgGameRules').value = JSON.stringify(CORE_DATA.gameConfig, null, 4);
        document.getElementById('cfgTemplates').value = JSON.stringify(CORE_DATA.templates, null, 4);
        document.getElementById('cfgResources').value = JSON.stringify(CORE_DATA.resourceDefs, null, 4);
        document.getElementById('cfgZones').value = JSON.stringify(CORE_DATA.zones, null, 4);
        document.getElementById('settingsModal').style.display = 'flex';
    }
    function saveConfig() {
        try {
            CORE_DATA.gameConfig = JSON.parse(document.getElementById('cfgGameRules').value);
            CORE_DATA.templates = JSON.parse(document.getElementById('cfgTemplates').value);
            CORE_DATA.resourceDefs = JSON.parse(document.getElementById('cfgResources').value);
            CORE_DATA.zones = JSON.parse(document.getElementById('cfgZones').value);
            localStorage.setItem('DOV_DATA', JSON.stringify(CORE_DATA));
            closeModal('settingsModal');
            initUI();
        } catch(e) { alert("JSON Error"); }
    }
    function resetConfig() { localStorage.removeItem('DOV_DATA'); location.reload(); }
    function updateDictionary() { alert("Simulated Update"); }

    window.onload = initApp;
</script>
</body>
</html>
