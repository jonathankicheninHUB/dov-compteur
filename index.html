<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DoV - GLOBAL WAR ROOM</title>
    <style>
        /* Design "Salle de Contrôle" */
        :root { --main: #00e676; --sec: #29b6f6; --bg: #050505; --panel: #111; }
        body { background-color: var(--bg); color: #ddd; font-family: 'Consolas', 'Courier New', monospace; padding: 0; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* HEADER */
        header { background: #000; border-bottom: 2px solid var(--main); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 0 20px rgba(0,230,118,0.2); }
        h1 { margin: 0; color: var(--main); text-transform: uppercase; letter-spacing: 3px; font-size: 24px; }
        .status-led { width: 12px; height: 12px; background: #333; border-radius: 50%; display: inline-block; margin-right: 10px; box-shadow: 0 0 5px #000; }
        .led-on { background: #f00; box-shadow: 0 0 10px #f00; animation: pulse 1s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* LAYOUT */
        .layout { display: flex; flex: 1; overflow: hidden; }
        
        /* SIDEBAR (Contrôles) */
        .sidebar { width: 300px; background: var(--panel); border-right: 1px solid #333; padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        
        .panel { background: #1a1a1a; border: 1px solid #444; padding: 15px; border-radius: 4px; }
        .panel h3 { margin-top: 0; color: var(--sec); font-size: 14px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        
        input { background: #000; color: #fff; border: 1px solid #555; padding: 8px; width: 100%; box-sizing: border-box; font-family: monospace; margin-bottom: 10px; }
        
        .btn { width: 100%; padding: 10px; border: none; font-weight: bold; cursor: pointer; margin-bottom: 5px; text-transform: uppercase; font-family: monospace; transition: 0.2s; }
        .btn-scan { background: var(--main); color: #000; }
        .btn-scan:hover { background: #00c853; }
        .btn-target { background: var(--sec); color: #000; }
        .btn-target:hover { background: #039be5; }
        .btn-stop { background: #d32f2f; color: #fff; display: none; }

        /* MAIN CONTENT (Visuel) */
        .main-view { flex: 1; padding: 20px; overflow-y: auto; position: relative; }
        
        /* DASHBOARD GLOBAL */
        .global-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: #111; border: 1px solid #333; padding: 15px; text-align: center; }
        .stat-num { font-size: 28px; color: #fff; font-weight: bold; display: block; }
        .stat-tit { font-size: 10px; color: #888; text-transform: uppercase; }

        /* ZONE GRID */
        .zone-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .zone-card { background: #0a0a0a; border: 1px solid #333; padding: 10px; position: relative; overflow: hidden; }
        .zone-card:hover { border-color: var(--sec); }
        .zone-id { font-size: 1.5em; font-weight: bold; color: var(--sec); }
        .zone-bar-bg { background: #222; height: 4px; width: 100%; margin-top: 10px; }
        .zone-bar-fill { background: var(--main); height: 100%; width: 0%; transition: width 0.5s; }
        
        /* LOG CONSOLE */
        .console { position: absolute; bottom: 0; left: 0; right: 0; height: 150px; background: #000; border-top: 2px solid #333; padding: 10px; font-size: 11px; color: #aaa; overflow-y: auto; font-family: monospace; z-index: 100; opacity: 0.9; }

        /* TARGET LIST */
        .target-list { display: none; flex-direction: column; gap: 5px; }
        .unit-row { background: #111; border-bottom: 1px solid #222; padding: 8px; display: flex; justify-content: space-between; }
        .unit-row:hover { background: #222; }
        .tag { padding: 2px 5px; font-size: 10px; border-radius: 2px; color: #000; font-weight: bold; margin-right: 5px; }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center">
        <span class="status-led" id="led"></span>
        <h1>DoV Campaign Monitor</h1>
    </div>
    <div style="font-size:12px; color:#666">Smart Contract: dovpvecontrl</div>
</header>

<div class="layout">
    <aside class="sidebar">
        <div class="panel">
            <h3>MONITEUR DE GUERRE</h3>
            <p style="font-size:11px; color:#aaa; margin-bottom:10px">Scanner l'intégralité de la carte pour voir la répartition des forces.</p>
            <button class="btn btn-scan" id="btnGlobal" onclick="startGlobalScan()">SCAN GLOBAL</button>
            <button class="btn btn-stop" id="btnStop" onclick="stopScan()">ARRÊT D'URGENCE</button>
            <div id="progressText" style="font-size:10px; text-align:center; margin-top:5px; color:#666">En attente...</div>
        </div>

        <div class="panel">
            <h3>ESPIONNAGE JOUEUR</h3>
            <input type="text" id="targetUser" placeholder="Compte (ex: u2d2k.c.wam)" value="u2d2k.c.wam">
            <button class="btn btn-target" onclick="startTargetScan()">SCANNER CIBLE</button>
        </div>
    </aside>

    <main class="main-view" id="mainView">
        
        <div id="dashboardView">
            <div class="global-stats">
                <div class="stat-box">
                    <span class="stat-num" id="gDivs">0</span>
                    <span class="stat-tit">Total Divisions</span>
                </div>
                <div class="stat-box">
                    <span class="stat-num" id="gPower">0</span>
                    <span class="stat-tit">Puissance Globale</span>
                </div>
                <div class="stat-box">
                    <span class="stat-num" id="gUnits">0</span>
                    <span class="stat-tit">Unités Engagées</span>
                </div>
                <div class="stat-box">
                    <span class="stat-num" id="gZones">0</span>
                    <span class="stat-tit">Zones Actives</span>
                </div>
            </div>

            <h3 style="color:#666; border-bottom:1px solid #333; padding-bottom:5px">RÉPARTITION PAR ZONE</h3>
            <div class="zone-grid" id="zoneContainer">
                <div style="color:#444; padding:20px">En attente du scan global...</div>
            </div>
        </div>

        <div id="targetView" class="target-list"></div>

    </main>
</div>

<div class="console" id="logs">> Système prêt. Sélectionnez un mode de scan.</div>

<script>
    // --- CONFIGURATION ---
    const RPCS = [
        "https://wax.greymass.com",
        "https://wax.eosn.io",
        "https://api.wax.alohaeos.com",
        "https://wax.pink.gg",
        "https://api.waxsweden.org"
    ];

    let isScanning = false;
    let shouldStop = false;

    // --- FONCTIONS LOG & UI ---
    function log(msg, color="#aaa") {
        const c = document.getElementById('logs');
        const time = new Date().toLocaleTimeString();
        c.innerHTML = `<div style="color:${color}">[${time}] ${msg}</div>` + c.innerHTML;
    }

    function toggleLed(state) {
        const led = document.getElementById('led');
        if(state) led.classList.add('led-on');
        else led.classList.remove('led-on');
    }

    function switchView(mode) {
        document.getElementById('dashboardView').style.display = (mode === 'global') ? 'block' : 'none';
        document.getElementById('targetView').style.display = (mode === 'target') ? 'flex' : 'none';
    }

    function stopScan() {
        shouldStop = true;
        document.getElementById('btnStop').style.display = 'none';
        document.getElementById('btnGlobal').style.display = 'block';
        log("Arrêt demandé...", "orange");
    }

    // --- MOTEUR DE CONNEXION ---
    async function getActiveRpc() {
        for(let rpc of RPCS) {
            try {
                await fetch(rpc + "/v1/chain/get_info", {method: 'POST'});
                return rpc;
            } catch(e) {}
        }
        throw new Error("Aucun serveur disponible");
    }

    // --- SCANNER GLOBAL (MONITORING) ---
    async function startGlobalScan() {
        if(isScanning) return;
        isScanning = true;
        shouldStop = false;
        
        switchView('global');
        toggleLed(true);
        document.getElementById('btnGlobal').style.display = 'none';
        document.getElementById('btnStop').style.display = 'block';
        document.getElementById('zoneContainer').innerHTML = ""; // Clear grid

        // Reset Stats
        let stats = { divs: 0, power: 0, units: 0, zones: {} };
        
        log("INITIALISATION DU MONITORING GLOBAL...", "#00e676");

        try {
            const rpc = await getActiveRpc();
            const url = rpc + "/v1/chain/get_table_rows";
            let nextKey = "";
            let hasMore = true;

            while(hasMore && !shouldStop) {
                document.getElementById('progressText').innerText = `Scan en cours... (Divisions: ${stats.divs})`;

                const res = await fetch(url, {
                    method: 'POST',
                    body: JSON.stringify({
                        json: true,
                        code: "dovpvecontrl",
                        scope: "dovpvecontrl",
                        table: "sdivisions",
                        limit: 300, // Gros paquets pour aller vite
                        lower_bound: nextKey
                    })
                });

                const data = await res.json();
                
                if(!data.rows || data.rows.length === 0) {
                    hasMore = false; break;
                }

                // TRAITEMENT DES DONNÉES EN TEMPS RÉEL
                for(let row of data.rows) {
                    // 1. Stats globales
                    stats.divs++;
                    if(row.power) stats.power += parseInt(row.power);
                    
                    // 2. Unités
                    const units = row.units || row.asset_ids || [];
                    stats.units += units.length;

                    // 3. Zones (Le cœur du monitoring)
                    const zID = row.zoneID || "Inconnue";
                    if(!stats.zones[zID]) stats.zones[zID] = { count: 0, power: 0 };
                    stats.zones[zID].count++;
                    if(row.power) stats.zones[zID].power += parseInt(row.power);
                }

                // MISE À JOUR UI (Pour que ça bouge à l'écran)
                updateDashboard(stats);

                if(data.more && data.next_key) nextKey = data.next_key;
                else hasMore = false;
            }

            log(`SCAN TERMINÉ. ${stats.divs} divisions analysées.`, "#00e676");
            renderZones(stats.zones); // Rendu final propre

        } catch(e) {
            log("ERREUR: " + e.message, "red");
        }

        isScanning = false;
        toggleLed(false);
        document.getElementById('btnStop').style.display = 'none';
        document.getElementById('btnGlobal').style.display = 'block';
        document.getElementById('progressText').innerText = "Prêt.";
    }

    // --- SCANNER CIBLE (INDIVIDUEL) ---
    async function startTargetScan() {
        const user = document.getElementById('targetUser').value.trim().toLowerCase();
        if(!user) return alert("Nom requis");
        
        switchView('target');
        document.getElementById('targetView').innerHTML = "<div style='padding:20px'>Scan de la cible...</div>";
        log(`Espionnage de : ${user}`, "#29b6f6");

        try {
            const rpc = await getActiveRpc();
            let allRows = [];
            let nextKey = user;
            let searching = true;

            while(searching) {
                const res = await fetch(rpc + "/v1/chain/get_table_rows", {
                    method: 'POST',
                    body: JSON.stringify({
                        json: true, code: "dovpvecontrl", scope: "dovpvecontrl", table: "sdivisions",
                        index_position: 2, key_type: "name", lower_bound: nextKey, limit: 100
                    })
                });
                const data = await res.json();
                
                if(!data.rows || data.rows.length === 0) break;

                for(let row of data.rows) {
                    const owner = row.owner || row.user;
                    if(owner === user) allRows.push(row);
                    else if(owner.localeCompare(user) > 0) { searching = false; break; }
                }
                if(searching && data.more) nextKey = data.next_key;
                else searching = false;
            }

            renderTargetList(allRows);
            log(`Cible analysée : ${allRows.length} divisions trouvées.`, "#29b6f6");

        } catch(e) {
            log("Erreur cible : " + e.message, "red");
        }
    }

    // --- FONCTIONS DE RENDU (VISUEL) ---

    function updateDashboard(stats) {
        document.getElementById('gDivs').innerText = stats.divs.toLocaleString();
        document.getElementById('gPower').innerText = stats.power.toLocaleString();
        document.getElementById('gUnits').innerText = stats.units.toLocaleString();
        document.getElementById('gZones').innerText = Object.keys(stats.zones).length;
        
        // On rafraichit la grille des zones tous les 500 items pour ne pas lagger
        if(stats.divs % 500 === 0) renderZones(stats.zones);
    }

    function renderZones(zonesMap) {
        const container = document.getElementById('zoneContainer');
        let html = "";
        
        // Trier les zones par ID
        const sortedKeys = Object.keys(zonesMap).sort((a,b) => parseInt(a) - parseInt(b));

        // Trouver la zone la plus peuplée pour la barre de progression relative
        let maxCount = 0;
        for(let z in zonesMap) if(zonesMap[z].count > maxCount) maxCount = zonesMap[z].count;

        sortedKeys.forEach(z => {
            const zData = zonesMap[z];
            const percent = (zData.count / maxCount) * 100;
            
            html += `
                <div class="zone-card">
                    <div style="display:flex; justify-content:space-between">
                        <span class="zone-id">ZONE ${z}</span>
                        <span style="font-size:12px; color:#666">${zData.count} Divs</span>
                    </div>
                    <div style="font-size:11px; color:#888; margin-top:5px">Puissance: ${zData.power.toLocaleString()}</div>
                    <div class="zone-bar-bg">
                        <div class="zone-bar-fill" style="width:${percent}%"></div>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function renderTargetList(rows) {
        const div = document.getElementById('targetView');
        if(rows.length === 0) { div.innerHTML = "Aucune division trouvée."; return; }
        
        let html = "";
        rows.forEach(r => {
            const units = r.units || [];
            let uHtml = "";
            units.forEach(u => {
                let role = (typeof u === 'object') ? u.key.replace(/%\d+/,'') : 'unit';
                let id = (typeof u === 'object') ? u.value : u;
                let color = "#777";
                if(role.includes('combat')) color = "#e74c3c";
                if(role.includes('officer')) color = "#f1c40f";
                
                uHtml += `<a href="https://wax.atomichub.io/explorer/asset/${id}" target="_blank" style="text-decoration:none; color:#ddd; margin-right:10px; font-size:11px;">
                    <span style="background:${color}" class="tag">${role.substring(0,3).toUpperCase()}</span>${id}
                </a>`;
            });

            html += `
                <div class="unit-row">
                    <div style="width:150px; font-weight:bold; color:#29b6f6">Div #${r.division_id}</div>
                    <div style="flex:1">${uHtml}</div>
                    <div style="width:80px; text-align:right; color:#888">Z: ${r.zoneID}</div>
                </div>
            `;
        });
        div.innerHTML = html;
    }
</script>

</body>
</html>
