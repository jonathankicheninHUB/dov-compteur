<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DoV - COMMAND V92 (UNIVERSAL MATRIX)</title>
    <style>
        :root { 
            --main: #00e676; --alert: #ff1744; --sec: #29b6f6; --warn: #ff9800; --dovx: #9c27b0; 
            --gold: #ffd700; --money: #2ecc71;
            --fuel: #e67e22; --health: #e74c3c; --repair: #bdc3c7; --supply: #f1c40f;
            --bg: #050505; --panel: #111; --card-bg: #141414;
        }
        body { background-color: var(--bg); color: #ccc; font-family: 'Segoe UI', 'Consolas', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { height: 40px; background: #000; border-bottom: 1px solid #333; display: flex; align-items: center; padding: 0 15px; justify-content: space-between; }
        h1 { color: var(--gold); margin: 0; font-size: 16px; letter-spacing: 1px; text-transform: uppercase; font-weight: 800; }
        .rpc-badge { font-size: 10px; background: #222; padding: 2px 6px; border-radius: 4px; border: 1px solid #444; color: #888; }
        .layout { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 260px; background: var(--panel); border-right: 1px solid #333; padding: 15px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .main-view { flex: 1; padding: 20px; overflow-y: auto; position: relative; background: #080808; }
        
        /* UI */
        .box { border: 1px solid #333; padding: 10px; background: #000; margin-bottom: 10px; border-radius: 4px; }
        .box-title { color: #fff; font-size: 11px; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #222; padding-bottom: 4px; text-transform: uppercase; }
        button { width: 100%; padding: 8px; cursor: pointer; border: none; font-weight: bold; font-family: monospace; text-transform: uppercase; margin-bottom: 5px; font-size: 11px; border-radius: 2px; transition: 0.2s; }
        button:hover { opacity: 0.8; }
        .btn-global { background: #fff; color: #000; } .btn-stop { background: var(--alert); color: #fff; display: none; }
        input { width: 100%; padding: 6px; background: #222; border: 1px solid #444; color: #fff; box-sizing: border-box; margin-bottom: 5px; }
        
        /* DASHBOARD */
        .g-dashboard { display: flex; flex-direction: column; gap: 10px; }
        .g-main-count { background: #fff; color: #000; padding: 15px; border-radius: 4px; display:flex; justify-content:space-between; align-items:center; border-left: 5px solid var(--sec); margin-bottom: 20px; }
        .g-mc-left { font-size: 16px; font-weight: bold; display: flex; align-items: center; }
        .live-dot { height: 8px; width: 8px; background-color: var(--sec); border-radius: 50%; display: inline-block; animation: pulse-live 1s infinite; margin-right: 5px; }
        @keyframes pulse-live { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .g-cost-val { color: var(--dovx); font-weight:bold; font-size:20px; }
        
        .g-detail-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .g-card { background: #111; border: 1px solid #333; padding: 10px; display: flex; flex-direction: column; justify-content:space-between; min-height:140px; }
        .g-card-head { display:flex; justify-content:space-between; border-bottom:1px solid #222; padding-bottom:5px; margin-bottom:5px; font-size:12px; font-weight:bold; text-transform:uppercase; }
        .g-prod-val { font-size:18px; font-weight:bold; color:#fff; display:block; text-align: center; margin: 10px 0; }
        .g-prod-lbl { font-size:9px; color:#888; text-transform:uppercase; text-align: center; }
        .g-mini-cost { font-size:14px; color: var(--dovx); font-weight:bold; text-align: center; }
        .g-split { display: flex; justify-content: space-between; font-size: 10px; border-top: 1px solid #222; padding-top: 8px; margin-top:auto; }
        .c-act { color: var(--warn); font-weight:bold; }

        /* LISTE V92 */
        .model-list-container { margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .ml-col { background: #111; border: 1px solid #333; border-radius: 4px; overflow: hidden; }
        .ml-header { padding: 8px; background: #222; font-weight: bold; font-size: 12px; text-transform: uppercase; color: #fff; display: flex; justify-content: space-between; }
        .ml-row { display: grid; grid-template-columns: 3.5fr 0.7fr 1fr 1.2fr; padding: 8px 10px; border-bottom: 1px solid #1a1a1a; font-size: 11px; align-items: center; }
        .ml-row:hover { background: #161616; }
        .ml-name a { color: #ccc; text-decoration: none; border-bottom: 1px dotted #555; transition: 0.2s; font-weight:bold; }
        .ml-name a:hover { color: var(--sec); border-bottom-color: var(--sec); }
        .ml-tid { font-size: 9px; color: #555; margin-left:5px; font-family: monospace; }
        .ml-total { color: #fff; font-weight: bold; text-align: right; }
        .c-f { border-left: 4px solid var(--fuel); } .c-h { border-left: 4px solid var(--health); }
        .c-r { border-left: 4px solid var(--repair); } .c-s { border-left: 4px solid var(--supply); }
        
        .logs { height: 100px; background: #000; border-top: 1px solid #333; padding: 10px; font-size: 11px; color: #666; overflow-y: auto; }
        .view-section { display: none; } .view-active { display: block; }
    </style>
</head>
<body>

<header>
    <h1>DoV COMMAND <span style="color:var(--sec)">V92 UNIVERSAL MATRIX</span></h1>
    <span class="rpc-badge" id="rpcStatus">PRÊT</span>
</header>

<div class="layout">
    <aside class="sidebar">
        <div class="box">
            <div class="box-title">CONFIGURATION</div>
            <input type="number" id="inpWax" value="0.00786" step="0.00001">
            <input type="text" id="inpProxy" value="https://corsproxy.io/?">
        </div>
        <div class="box">
            <button class="btn-global" onclick="startGlobalBuildings()">SCAN GLOBAL (V92)</button>
            <button class="btn-stop" id="btnStop" onclick="stopSignal=true">ARRÊT</button>
        </div>
    </aside>

    <main class="main-view">
        <div id="buildingView" class="view-section view-active">
            <div class="g-main-count">
                <div class="g-mc-left">
                    <span class="live-dot"></span>
                    <div style="margin-left:10px;"><b>SCAN UNIVERSEL (4 TYPES)</b><br><span id="globalCount">0 Bâtiments</span></div>
                </div>
                <div style="text-align:right"><small class="g-cost-label">COÛT TOTAL DOV-X (24H)</small><br><span class="g-cost-val" id="gTotalCost">0</span></div>
            </div>
            
            <div class="g-detail-grid">
                <div class="g-card" style="border-top:3px solid var(--fuel)">
                    <div class="g-card-head"><span style="color:var(--fuel)">FUEL</span> <span class="g-count-badge" id="cnt-F">0</span></div>
                    <div class="g-prod-val" style="color:var(--fuel)" id="pwr-F">0</div>
                    <div class="g-mini-cost" id="cost-F">0</div>
                    <div class="g-split"><span class="c-act">Act: <b id="act-F">0</b></span><span>Rdy: <b id="rdy-F">0</b></span></div>
                </div>
                <div class="g-card" style="border-top:3px solid var(--health)">
                    <div class="g-card-head"><span style="color:var(--health)">HEALTH</span> <span class="g-count-badge" id="cnt-H">0</span></div>
                    <div class="g-prod-val" style="color:var(--health)" id="pwr-H">0</div>
                    <div class="g-mini-cost" id="cost-H">0</div>
                    <div class="g-split"><span class="c-act">Act: <b id="act-H">0</b></span><span>Rdy: <b id="rdy-H">0</b></span></div>
                </div>
                <div class="g-card" style="border-top:3px solid var(--repair)">
                    <div class="g-card-head"><span style="color:var(--repair)">REPAIR</span> <span class="g-count-badge" id="cnt-R">0</span></div>
                    <div class="g-prod-val" style="color:var(--repair)" id="pwr-R">0</div>
                    <div class="g-mini-cost" id="cost-R">0</div>
                    <div class="g-split"><span class="c-act">Act: <b id="act-R">0</b></span><span>Rdy: <b id="rdy-R">0</b></span></div>
                </div>
                <div class="g-card" style="border-top:3px solid var(--supply)">
                    <div class="g-card-head"><span style="color:var(--supply)">SUPPLY</span> <span class="g-count-badge" id="cnt-S">0</span></div>
                    <div class="g-prod-val" style="color:var(--supply)" id="pwr-S">0</div>
                    <div class="g-mini-cost" id="cost-S">0</div>
                    <div class="g-split"><span class="c-act">Act: <b id="act-S">0</b></span><span>Rdy: <b id="rdy-S">0</b></span></div>
                </div>
            </div>

            <div class="model-list-container">
                <div class="ml-col c-f" id="list-F"><div class="ml-header">FUEL (Détails)</div></div>
                <div class="ml-col c-h" id="list-H"><div class="ml-header">HEALTH (Détails)</div></div>
                <div class="ml-col c-r" id="list-R"><div class="ml-header">REPAIR (Détails)</div></div>
                <div class="ml-col c-s" id="list-S"><div class="ml-header">SUPPLY (Détails)</div></div>
            </div>
        </div>
        <div class="logs" id="console"></div>
    </main>
</div>

<script>
    // --- 1. MATRICE DE DONNÉES NEUTRE (Applicable aux 4 tokens) ---
    // Clé: Production Horaire Unitaire
    const UNIVERSAL_MATRIX = {
        5.40:   { tier: "C",  lvl: "1", role: "PRODUCER", cost6h: 0.4590 },
        54.00:  { tier: "SC", lvl: "2", role: "PRODUCER", cost6h: 4.5900 },
        12.15:  { tier: "C",  lvl: "2", role: "PRODUCER", cost6h: 1.0328 },
        121.50: { tier: "SC", lvl: "3", role: "PRODUCER", cost6h: 10.3275 },
        30.38:  { tier: "C",  lvl: "3", role: "PRODUCER", cost6h: 2.5819 },
        83.53:  { tier: "C",  lvl: "4", role: "PRODUCER", cost6h: 7.1002 },
        1458.0: { tier: "SC", lvl: "5", role: "PRODUCER", cost6h: 123.9300 },
        16.20:  { tier: "R",  lvl: "1", role: "PRODUCER", cost6h: 1.3770 },
        36.45:  { tier: "R",  lvl: "2", role: "PRODUCER", cost6h: 3.0983 },
        91.13:  { tier: "R",  lvl: "3", role: "PRODUCER", cost6h: 7.7456 },
        250.59: { tier: "R",  lvl: "4", role: "PRODUCER", cost6h: 21.3005 },
        48.60:  { tier: "E",  lvl: "1", role: "PRODUCER", cost6h: 4.1310 },
        109.35: { tier: "E",  lvl: "2", role: "PRODUCER", cost6h: 9.2948 },
        273.38: { tier: "E",  lvl: "3", role: "PRODUCER", cost6h: 23.2369 },
        751.78: { tier: "E",  lvl: "4", role: "PRODUCER", cost6h: 63.9014 },
        145.80: { tier: "L",  lvl: "1", role: "PRODUCER", cost6h: 12.3930 },
        328.05: { tier: "L",  lvl: "2", role: "PRODUCER", cost6h: 27.8843 },
        820.13: { tier: "L",  lvl: "3", role: "PRODUCER", cost6h: 69.7106 },
        2255.34:{ tier: "S1", lvl: "",  role: "OWNER",    cost6h: 191.7042 } // S1 (ou L4)
    };

    let TEMPLATE_MAP = {}; 
    let stopSignal = false; 
    let rpcIndex = 0;
    const RPCS = ["https://wax.greymass.com", "https://api.waxsweden.org"];

    function log(msg, color="#888") { document.getElementById('console').innerHTML = `<div style="color:${color}">${msg}</div>` + document.getElementById('console').innerHTML; }

    async function robustFetch(code, table, lowerBound) {
        const proxy = document.getElementById('inpProxy').value;
        const url = proxy + encodeURIComponent(RPCS[rpcIndex % RPCS.length] + "/v1/chain/get_table_rows");
        const res = await fetch(url, { method: 'POST', body: JSON.stringify({ json: true, code, scope: code, table, limit: 500, lower_bound: lowerBound || "0" }) });
        return await res.json();
    }

    async function loadBDATA() {
        log("Chargement du catalogue blockchain...");
        let next = "0"; let more = true;
        while(more && !stopSignal) {
            const data = await robustFetch("dovutilstake", "bdata", next);
            data.rows.forEach(r => {
                let out = Array.isArray(r.output) ? r.output[0] : r.output;
                let val = parseFloat(out.replace(/[^0-9.]/g, ''));
                // Détection universelle du type
                let type = "OTHER";
                if(out.includes("DOVF")) type = "FUEL";
                else if(out.includes("DOVH")) type = "HEALTH";
                else if(out.includes("DOVR")) type = "REPAIR";
                else if(out.includes("DOVS")) type = "SUPPLY";
                
                TEMPLATE_MAP[r.template_id] = { val, type };
            });
            if(data.more) next = data.next_key; else more = false;
        }
        log("Catalogue chargé : " + Object.keys(TEMPLATE_MAP).length + " templates.");
    }

    function generateName(stats, type) {
        // Logique de construction du nom (C_F1_PRODUCER_FUEL)
        // type = FUEL, HEALTH, etc.
        let shortType = type.charAt(0); // F, H, R, S
        let tier = stats.tier; // C, SC, R, E, L, S1
        let level = stats.lvl; // 1, 2, 3...
        
        // Cas spécial S1 (pas de niveau, suffixe OWNER)
        if(tier.startsWith("S1")) {
            return `S1_OWNER_${type}`;
        }
        
        // Cas standard
        return `${tier}_${shortType}${level}_${stats.role}_${type}`;
    }

    async function startGlobalBuildings() {
        stopSignal = false; document.getElementById('btnStop').style.display = 'block';
        await loadBDATA();
        let next = "0"; let more = true;
        
        let stats = { total: 0, cost: 0, groups: { FUEL:{}, HEALTH:{}, REPAIR:{}, SUPPLY:{} } };
        let quickStats = { F:{act:0,rdy:0,pwr:0,cost:0}, H:{act:0,rdy:0,pwr:0,cost:0}, R:{act:0,rdy:0,pwr:0,cost:0}, S:{act:0,rdy:0,pwr:0,cost:0} };
        
        const now = Date.now()/1000;

        while(more && !stopSignal) {
            const data = await robustFetch("dovutilstake", "buildings", next);
            data.rows.forEach(b => {
                stats.total++;
                let t = TEMPLATE_MAP[b.template_id];
                if(!t || t.type === "OTHER") return;

                let rdy = now > (parseFloat(b.last_claim) + parseFloat(b.delay));
                let shortT = t.type.charAt(0);

                if(rdy) {
                    quickStats[shortT].rdy++;
                } else {
                    quickStats[shortT].act++;
                    
                    // CALCUL UNIVERSEL
                    let mat = UNIVERSAL_MATRIX[t.val];
                    let prod24 = t.val * 24;
                    let cost24 = 0;
                    let fullName = `CUSTOM [${b.template_id}]`;

                    if (mat) {
                        fullName = generateName(mat, t.type);
                        cost24 = mat.cost6h * 4;
                    } else {
                        // Fallback math si pas dans la table (rare)
                        cost24 = (t.val * 6) * 0.085 * 4; 
                    }

                    // Gestion des Stacks (si un batiment a une puissance multiple de la base)
                    let curP = parseFloat(Array.isArray(b.power) ? b.power[0] : b.power);
                    let stack = Math.round(curP / t.val) || 1;

                    // Ajout aux stats
                    let finalProd = prod24 * stack;
                    let finalCost = cost24 * stack;
                    
                    quickStats[shortT].pwr += finalProd;
                    quickStats[shortT].cost += finalCost;
                    stats.cost += finalCost;

                    // Grouping pour la liste
                    if(!stats.groups[t.type][b.template_id]) stats.groups[t.type][b.template_id] = { name: fullName, count: 0, prod: 0 };
                    stats.groups[t.type][b.template_id].count += stack;
                    stats.groups[t.type][b.template_id].prod += finalProd;
                }
            });
            
            // UI Updates
            document.getElementById('globalCount').innerText = stats.total + " Bâtiments";
            document.getElementById('gTotalCost').innerText = Math.round(stats.cost).toLocaleString();
            
            ['F','H','R','S'].forEach(k => {
                document.getElementById('cnt-'+k).innerText = quickStats[k].act + quickStats[k].rdy;
                document.getElementById('pwr-'+k).innerText = Math.round(quickStats[k].pwr).toLocaleString() + " TU";
                document.getElementById('cost-'+k).innerText = Math.round(quickStats[k].cost).toLocaleString();
                document.getElementById('act-'+k).innerText = quickStats[k].act;
                document.getElementById('rdy-'+k).innerText = quickStats[k].rdy;
            });

            renderLists(stats.groups);
            if(data.more) next = data.next_key; else more = false;
        }
        log("✅ Scan Terminé.");
    }

    function renderLists(groups) {
        for(let g in groups) {
            let container = document.getElementById('list-' + g.charAt(0));
            if(!container) continue;
            let html = `<div class="ml-header">${g}</div>`;
            // Sort by production
            let sortedIDs = Object.keys(groups[g]).sort((a,b) => groups[g][b].prod - groups[g][a].prod);
            
            for(let tid of sortedIDs) {
                let item = groups[g][tid];
                let link = `https://wax.atomichub.io/explorer/template/wax-mainnet/dovdivisions/${tid}`;
                html += `<div class="ml-row">
                    <div class="ml-name"><a href="${link}" target="_blank">${item.name}</a><span class="ml-tid">#${tid}</span></div>
                    <div class="ml-count">${item.count} act.</div>
                    <div class="ml-unit">${Math.round(item.prod/item.count).toLocaleString()}/u</div>
                    <div class="ml-total">${Math.round(item.prod).toLocaleString()}</div>
                </div>`;
            }
            container.innerHTML = html;
        }
    }
</script>
</body>
</html>
