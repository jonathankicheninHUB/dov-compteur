<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DoV - COMMAND V182 (FINAL STABLE)</title>
    <style>
        /* --- WEB3 DESIGN SYSTEM --- */
        :root {
            --bg-body: #0b0c15; --bg-panel: #12131f; --bg-card: #181926; --border: #2b2d42;
            --primary: #3498db; --accent: #00e676; --gold: #f1c40f; --purple: #9b59b6; --dovx: #e056fd;
            --fuel: #e67e22; --health: #e74c3c; --repair: #3498db; --supply: #f1c40f;
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-mono: 'Consolas', 'Monaco', monospace;
            --text-gray: #8d99ae;
        }

        body { background-color: var(--bg-body); color: var(--text-gray); font-family: var(--font-main); margin: 0; display: flex; height: 100vh; overflow: hidden; font-size: 12px; }
        * { box-sizing: border-box; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: var(--bg-body); } ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        /* --- LAYOUT --- */
        .sidebar { width: 280px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; gap: 20px; overflow-y: auto; }
        .main-view { flex: 1; padding: 30px; overflow-y: auto; position: relative; background: radial-gradient(circle at 50% 0%, rgba(20,20,30,1) 0%, rgba(5,5,8,1) 100%); }

        /* --- COMPONENTS --- */
        .logo-area { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .logo-dot { width: 12px; height: 12px; background: #00e676; border-radius: 50%; box-shadow: 0 0 10px #00e676; }
        .app-title { font-size: 16px; font-weight: 800; color: #fff; letter-spacing: 1px; text-transform: uppercase; }

        .group-label { font-size: 10px; font-weight: 700; color: #57606f; text-transform: uppercase; margin-bottom: 8px; display: block; }
        .box-framed { border: 1px solid var(--border); padding: 15px; border-radius: 6px; background: rgba(255,255,255,0.01); }
        .box-framed.gold-border { border-color: rgba(241, 196, 15, 0.3); }

        .inp-wrapper { margin-bottom: 10px; }
        .inp-label { display: block; font-size: 9px; color: #7f8fa6; margin-bottom: 3px; }
        input[type="text"], input[type="number"] { width: 100%; background: #050508; border: 1px solid #333; color: var(--gold); padding: 8px; font-family: var(--font-mono); font-size: 11px; border-radius: 4px; text-align: right; }
        input:focus { outline: none; border-color: var(--primary); }

        .btn-row { display: flex; gap: 10px; }
        button { width: 100%; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: 700; font-size: 10px; text-transform: uppercase; transition: 0.2s; color: #fff; }
        button:hover { opacity: 0.9; }
        .btn-teal { background: #16a085; } .btn-orange { background: #d35400; } .btn-dark { background: #2c3e50; border: 1px solid #34495e; }
        .btn-blue { background: #2980b9; } .btn-purple { background: #8e44ad; } .btn-red { background: #c0392b; }
        .btn-ghost { background: transparent; border: 1px solid #444; color: #888; } .btn-ghost:hover { border-color: #fff; color: #fff; }

        /* --- DASHBOARD --- */
        .header-bar { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 25px; }
        .page-title { font-size: 24px; font-weight: 800; color: #fff; margin: 0; }
        .page-title span { color: var(--main); }
        .sub-stats { display: flex; gap: 15px; font-size: 11px; color: #666; margin-top: 5px; font-family: var(--font-mono); }
        
        .total-cost-box { text-align: right; }
        .cost-label { font-size: 10px; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        .cost-value { font-size: 28px; font-weight: 800; color: #fff; }
        .cost-currency { font-size: 16px; color: var(--dovx); }

        .cards-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .res-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 20px; text-align: center; position: relative; overflow: hidden; }
        .res-card::before { content:''; position: absolute; top:0; left:0; width: 4px; height: 100%; background: #fff; }
        .rc-label { font-size: 11px; font-weight: 700; color: #888; text-transform: uppercase; margin-bottom: 10px; }
        .rc-val { font-size: 26px; font-weight: 800; color: #fff; letter-spacing: -1px; }
        .rc-sub { font-size: 9px; color: #444; margin-top: 5px; }

        .lists-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .list-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        
        .lp-header { background: #1e202e; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .lp-title { font-weight: 700; color: #ccc; font-size: 11px; text-transform: uppercase; }
        .lp-badges { display: flex; gap: 5px; }
        .badge { font-size: 9px; padding: 3px 6px; border-radius: 4px; background: #252838; border: 1px solid #333; color: #fff; font-family: var(--font-mono); }
        
        .t-header { display: grid; grid-template-columns: 3fr 0.5fr 1fr 1fr; padding: 8px 15px; font-size: 9px; color: #555; font-weight: 700; text-transform: uppercase; border-bottom: 1px solid #222; }
        .t-row { display: grid; grid-template-columns: 3fr 0.5fr 1fr 1fr; padding: 10px 15px; border-bottom: 1px solid #222; font-size: 11px; align-items: center; color: #eee; }
        .t-row:hover { background: #1f212e; }
        .t-name { font-weight: 600; color: #dcdde1; font-size: 10px; }
        .t-act { color: var(--accent); font-weight: bold; text-align: center; }
        .t-val { text-align: right; font-family: var(--font-mono); color: #fff; }
        .t-val-dim { text-align: right; font-family: var(--font-mono); color: #777; }

        /* UTILS */
        .border-fuel::before { background: var(--fuel); } .border-health::before { background: var(--health); }
        .border-repair::before { background: var(--repair); } .border-supply::before { background: var(--supply); }
        .txt-fuel { color: var(--fuel); } .txt-health { color: var(--health); } .txt-repair { color: var(--repair); } .txt-supply { color: var(--supply); }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index:999; justify-content:center; align-items:center; }
        .modal-box { width: 700px; background: var(--bg-card); border: 1px solid var(--primary); border-radius: 8px; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .modal-header { padding: 15px; border-bottom: 1px solid var(--border); display:flex; justify-content:space-between; }
        .modal-content { padding: 20px; max-height: 80vh; overflow-y: auto; }
        textarea { width: 100%; height: 100px; background: #0b0c15; color: #ccc; border: 1px solid #333; font-family: monospace; padding: 10px; }

        /* ZONES & ECO STYLES (Restored) */
        .zones-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .zone { background: #1e202e; border: 1px solid var(--border); padding: 10px; border-radius: 6px; cursor: pointer; transition:0.2s; }
        .zone:hover { border-color: var(--accent); } .zone.active { border-color: var(--primary); background: #151621; }
        .z-metrics div { display:flex; justify-content:space-between; font-size:10px; margin-top:2px; }

        .eco-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .eco-card { background: #1e202e; border: 1px solid var(--border); padding: 15px; border-radius: 6px; }
        .eco-val { font-size: 20px; font-weight: 800; color: #fff; display:block; margin-top:5px; }
        
        .build-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top:20px; }
        .b-card { background: #1e202e; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size:11px; }

        #systemBadge { position: absolute; top: 10px; right: 20px; font-size: 9px; background: #222; padding: 5px 10px; border: 1px solid #333; color: #00e676; border-radius: 4px; }
        .view-section { display: none; }
    </style>
</head>
<body>

<div id="systemBadge">SYSTEM V182 READY</div>

<div class="layout">
    <aside class="sidebar">
        <div class="logo-area">
            <div class="logo-dot"></div>
            <div class="app-title">DoV COMMAND</div>
        </div>
        
        <div class="panel-group">
            <span class="group-label">TARGET OPERATIONS</span>
            <div class="box-framed">
                <div class="btn-row">
                    <button class="btn-teal" onclick="startZoneScan()">SCAN ZONES</button>
                    <button class="btn-orange" onclick="startEconomyScan()">SCAN ECON</button>
                </div>
                <button class="btn-dark" style="margin-top:10px;" onclick="dispatchGlobalScan()">GLOBAL SCAN (ALL)</button>
                <button class="btn-red" style="margin-top:5px;" onclick="stopSignal=true">STOP ACTION</button>
            </div>
        </div>

        <div class="panel-group">
            <span class="group-label">TARGET ACCOUNT</span>
            <div class="box-framed">
                <div class="inp-wrapper">
                    <input type="text" id="targetIn" value="u2d2k.c.wam">
                </div>
                <div class="btn-row">
                    <button class="btn-blue" onclick="startTarget()">DIVISIONS</button>
                    <button class="btn-purple" onclick="startBuildings()">BUILDINGS</button>
                </div>
            </div>
        </div>

        <div class="panel-group">
            <span class="group-label">CONFIGURATION</span>
            <div class="box-framed gold-border">
                <div class="inp-wrapper">
                    <span class="inp-label">WAX Price ($)</span>
                    <input type="number" id="inpWax" step="0.00001" onchange="updateRates()">
                </div>
                <div class="inp-wrapper">
                    <span class="inp-label">DOVX / WAX</span>
                    <input type="number" id="inpDovx" step="0.00000001" onchange="updateRates()">
                </div>
                <div class="inp-wrapper">
                    <span class="inp-label">TU / WAX</span>
                    <input type="number" id="inpTu" step="0.00000001" onchange="updateRates()">
                </div>
            </div>
        </div>

        <div style="margin-top:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span style="font-size:10px; color:#666;">TEMPLATES: <b id="dictSize">0</b></span>
                <button class="btn-ghost" style="width:auto; padding:4px 8px;" onclick="updateDictionary()">UPDATE</button>
            </div>
            <button class="btn-ghost" onclick="openSettings()">⚙️ SETTINGS</button>
            <button class="btn-ghost" style="color:var(--alert); border-color:var(--alert); margin-top:5px;" onclick="hardReset()">!! FACTORY RESET !!</button>
        </div>
    </aside>

    <main class="main-view">
        
        <div class="header-bar">
            <div>
                <h2 class="page-title" id="pageTitle">GLOBAL SCAN <span>LIVE</span></h2>
                <div class="sub-stats">
                    <span>≡ Rows: <b id="cntRows">0</b></span>
                    <span>❖ Assets: <b id="cntAssets">0</b></span>
                </div>
            </div>
            <div class="total-cost-box">
                <div class="cost-label">TOTAL MAINTENANCE COST</div>
                <div><span class="cost-value" id="gTotalCost">0</span> <span class="cost-currency">DOVX</span></div>
            </div>
        </div>

        <div id="globalView" class="view-section" style="display:block;">
            <div class="cards-container" id="dynamicCardsArea"></div>
            <div class="lists-grid" id="dynamicListsArea"></div>
        </div>

        <div id="zoneView" class="view-section">
            <div class="zones-grid" id="zonesArea"></div>
        </div>

        <div id="ecoView" class="view-section">
            <div class="eco-grid">
                <div class="eco-card"><div class="eco-head">DEMAND (TU)</div><div class="eco-val" id="valDemandTU">0</div></div>
                <div class="eco-card"><div class="eco-head">SUPPLY (TU)</div><div class="eco-val" id="valSupplyTU">0</div></div>
                <div class="eco-card"><div class="eco-head">DOVX BURN</div><div class="eco-val" id="valDovxBurn">0</div></div>
            </div>
        </div>

        <div id="targetView" class="view-section">
            <div id="buildList" class="build-grid"></div>
            <div id="divList"></div>
        </div>

    </main>
</div>

<div class="modal-overlay" id="settingsModal">
    <div class="modal-box">
        <div class="modal-header">
            <span style="color:#fff; font-weight:bold;">ADVANCED CONFIGURATION</span>
            <button class="btn-ghost" style="width:auto;" onclick="closeModal('settingsModal')">CLOSE</button>
        </div>
        <div class="modal-content">
            <div class="inp-wrapper"><span class="inp-label">GAME RULES (Cycle & Costs)</span><textarea id="cfgGameRules"></textarea></div>
            <div class="inp-wrapper"><span class="inp-label">TEMPLATE DICTIONARY</span><textarea id="cfgTemplates" style="height:150px;"></textarea></div>
            <div class="inp-wrapper"><span class="inp-label">RESOURCE UI DEFS</span><textarea id="cfgResources"></textarea></div>
            <div class="inp-wrapper"><span class="inp-label">ZONES DATA</span><textarea id="cfgZones"></textarea></div>
            <button class="btn-teal" onclick="saveConfig()">SAVE CONFIGURATION</button>
        </div>
    </div>
</div>

<script>
    // --- UTILS ---
    window.closeModal = function(id) { document.getElementById(id).style.display = 'none'; }
    function switchView(id) {
        document.querySelectorAll('.view-section').forEach(e => e.style.display = 'none');
        document.getElementById(id).style.display = 'block';
    }
    function setTextSafe(id, val) { let e=document.getElementById(id); if(e) e.innerText=val; }

    // --- DEFAULT DATA (STRICT NOMINAL VALUES) ---
    const DEFAULT_DATA = {
        resourceDefs: {
            "F": { label: "FUEL", color: "#e67e22", css: "border-fuel" },
            "H": { label: "HEALTH", color: "#e74c3c", css: "border-health" },
            "R": { label: "REPAIR", color: "#3498db", css: "border-repair" },
            "S": { label: "SUPPLY", color: "#f1c40f", css: "border-supply" }
        },
        gameConfig: {
            maintenanceCost: 0.085,
            cycleHours: 24,
            tokenMap: { "DOVF": "F", "DOVH": "H", "DOVR": "R", "DOVS": "S" }
        },
        templates: {
            "490122": { "name": "C_F1_PRODUCER_FUEL", "prod": 5.4 }, "492383": { "name": "C_F1_PRODUCER_FUEL", "prod": 5.4 },
            "492385": { "name": "C_F2_PRODUCER_FUEL", "prod": 12.15 }, "492363": { "name": "C_F2_PRODUCER_FUEL (VAR)", "prod": 12.15 },
            "492389": { "name": "C_F3_PRODUCER_FUEL", "prod": 30.38 }, "492366": { "name": "C_F3_PRODUCER_FUEL (VAR)", "prod": 30.38 },
            "492397": { "name": "C_F4_PRODUCER_FUEL", "prod": 83.53 }, "492373": { "name": "R_F1_PRODUCER_FUEL", "prod": 16.20 },
            "492379": { "name": "R_F1_PRODUCER_FUEL", "prod": 16.20 }, "492376": { "name": "R_F2_PRODUCER_FUEL", "prod": 36.45 },
            "492386": { "name": "R_F3_PRODUCER_FUEL", "prod": 91.13 }, "492390": { "name": "R_F4_PRODUCER_FUEL", "prod": 250.59 },
            "492380": { "name": "E_F1_PRODUCER_FUEL", "prod": 48.60 }, "492381": { "name": "E_F2_PRODUCER_FUEL", "prod": 109.35 },
            "492387": { "name": "E_F3_PRODUCER_FUEL", "prod": 273.38 }, "492388": { "name": "E_F4_PRODUCER_FUEL", "prod": 751.78 },
            "492368": { "name": "L_F1_PRODUCER_FUEL", "prod": 145.80 }, "492370": { "name": "L_F2_PRODUCER_FUEL", "prod": 328.05 },
            "492372": { "name": "L_F3_PRODUCER_FUEL", "prod": 820.13 }, "544068": { "name": "S1_OWNER_FUEL", "prod": 2255.34 },
            "492392": { "name": "S1_OWNER_FUEL (VAR)", "prod": 2255.34 }, "492377": { "name": "SC_F2_PRODUCER_FUEL", "prod": 54.00 },
            "492391": { "name": "SC_F3_PRODUCER_FUEL", "prod": 121.50 },
            "492394": { "name": "C_F1_PRODUCER_HEALTH", "prod": 5.4 }, "492395": { "name": "C_F2_PRODUCER_HEALTH", "prod": 12.15 },
            "492396": { "name": "C_F3_PRODUCER_HEALTH", "prod": 30.38 }, "492399": { "name": "R_F1_PRODUCER_HEALTH", "prod": 16.20 },
            "492401": { "name": "R_F2_PRODUCER_HEALTH", "prod": 36.45 }, "492535": { "name": "R_F3_PRODUCER_HEALTH", "prod": 91.13 },
            "492537": { "name": "R_F4_PRODUCER_HEALTH", "prod": 250.59 }, "492539": { "name": "E_F1_PRODUCER_HEALTH", "prod": 48.60 },
            "492543": { "name": "E_F2_PRODUCER_HEALTH", "prod": 109.35 }, "492545": { "name": "E_F3_PRODUCER_HEALTH", "prod": 273.38 },
            "492546": { "name": "E_F4_PRODUCER_HEALTH", "prod": 751.78 }, "492550": { "name": "L_F1_PRODUCER_HEALTH", "prod": 145.80 },
            "492554": { "name": "L_F2_PRODUCER_HEALTH", "prod": 328.05 }, "492555": { "name": "L_F3_PRODUCER_HEALTH", "prod": 820.13 },
            "544070": { "name": "S1_OWNER_HEALTH", "prod": 2255.34 }, "492460": { "name": "C_F1_PRODUCER_REPAIR", "prod": 5.4 },
            "492461": { "name": "C_F2_PRODUCER_REPAIR", "prod": 12.15 }, "492462": { "name": "C_F3_PRODUCER_REPAIR", "prod": 30.38 },
            "492463": { "name": "C_F4_PRODUCER_REPAIR", "prod": 83.53 }, "492464": { "name": "R_F1_PRODUCER_REPAIR", "prod": 16.20 },
            "492465": { "name": "R_F2_PRODUCER_REPAIR", "prod": 36.45 }, "492466": { "name": "R_F3_PRODUCER_REPAIR", "prod": 91.13 },
            "492467": { "name": "R_F4_PRODUCER_REPAIR", "prod": 250.59 }, "492469": { "name": "E_F1_PRODUCER_REPAIR", "prod": 48.60 },
            "492471": { "name": "E_F2_PRODUCER_REPAIR", "prod": 109.35 }, "492472": { "name": "E_F3_PRODUCER_REPAIR", "prod": 273.38 },
            "492473": { "name": "E_F4_PRODUCER_REPAIR", "prod": 751.78 }, "492474": { "name": "L_F1_PRODUCER_REPAIR", "prod": 145.80 },
            "492475": { "name": "L_F2_PRODUCER_REPAIR", "prod": 328.05 }, "492476": { "name": "L_F3_PRODUCER_REPAIR", "prod": 820.13 },
            "544071": { "name": "S1_OWNER_REPAIR", "prod": 2255.34 }, "492507": { "name": "C_F1_PRODUCER_SUPPLY", "prod": 5.4 },
            "492509": { "name": "C_F2_PRODUCER_SUPPLY", "prod": 12.15 }, "492511": { "name": "C_F3_PRODUCER_SUPPLY", "prod": 30.38 },
            "492513": { "name": "C_F4_PRODUCER_SUPPLY", "prod": 83.53 }, "492515": { "name": "R_F1_PRODUCER_SUPPLY", "prod": 16.20 },
            "492518": { "name": "R_F2_PRODUCER_SUPPLY", "prod": 36.45 }, "492521": { "name": "R_F3_PRODUCER_SUPPLY", "prod": 91.13 },
            "492523": { "name": "R_F4_PRODUCER_SUPPLY", "prod": 250.59 }, "492526": { "name": "E_F1_PRODUCER_SUPPLY", "prod": 48.60 },
            "492528": { "name": "E_F2_PRODUCER_SUPPLY", "prod": 109.35 }, "492529": { "name": "E_F3_PRODUCER_SUPPLY", "prod": 273.38 },
            "492530": { "name": "E_F4_PRODUCER_SUPPLY", "prod": 751.78 }, "492532": { "name": "L_F1_PRODUCER_SUPPLY", "prod": 145.80 },
            "492533": { "name": "L_F2_PRODUCER_SUPPLY", "prod": 328.05 }, "492534": { "name": "L_F3_PRODUCER_SUPPLY", "prod": 820.13 },
            "544069": { "name": "S1_OWNER_SUPPLY", "prod": 2255.34 }
        },
        zones: { 1:{name:"Beach 1",cost:1160},2:{name:"Beach 2",cost:6968},3:{name:"Beach 3",cost:8800},4:{name:"Bunker",cost:11120},5:{name:"Forest 1",cost:14024},6:{name:"Forest 2",cost:17704},7:{name:"Forest 3",cost:22352},8:{name:"Camp",cost:28220},9:{name:"Hill 1",cost:37052},10:{name:"Hill 2",cost:48652},11:{name:"Hill 3",cost:64516},12:{name:"Radar",cost:84712},13:{name:"Plain 1",cost:99384},14:{name:"Plain 2",cost:125708},15:{name:"Plain 3",cost:151164},16:{name:"HQ",cost:188000},17:{name:"City 1",cost:0},18:{name:"City 2",cost:0},19:{name:"City 3",cost:0},20:{name:"City 4",cost:0}},
        rates: { WAX_USD: 0.00786, DOVX_WAX: 0.00528553, TU_WAX: 0.00045262 }
    };

    let CORE_DATA = JSON.parse(JSON.stringify(DEFAULT_DATA));
    let stopSignal = false;

    // --- INITIALIZATION ---
    function initApp() {
        const stored = localStorage.getItem('DOV_DATA');
        if(stored) {
            try {
                let loaded = JSON.parse(stored);
                CORE_DATA = { ...DEFAULT_DATA, ...loaded };
                CORE_DATA.templates = { ...DEFAULT_DATA.templates, ...(loaded.templates || {}) };
            } catch(e) { console.error("Config Load Error", e); }
        }
        
        document.getElementById('inpWax').value = CORE_DATA.rates.WAX_USD;
        document.getElementById('inpDovx').value = CORE_DATA.rates.DOVX_WAX;
        document.getElementById('inpTu').value = CORE_DATA.rates.TU_WAX;
        document.getElementById('dictSize').innerText = Object.keys(CORE_DATA.templates).length;

        buildUI();
    }

    function buildUI() {
        const cards = document.getElementById('dynamicCardsArea');
        const lists = document.getElementById('dynamicListsArea');
        cards.innerHTML = ''; lists.innerHTML = '';

        for(let key in CORE_DATA.resourceDefs) {
            let res = CORE_DATA.resourceDefs[key];
            cards.innerHTML += `<div class="res-card ${res.css}"><div class="rc-label">${res.label}</div><div class="rc-val" style="color:${res.color}" id="pwr-${key}">0</div><div class="rc-sub">PROD / HOUR</div></div>`;
            lists.innerHTML += `<div class="list-panel"><div class="lp-header"><div class="lp-title">${res.label} BREAKDOWN</div><div class="lp-badges"><span class="badge">PROD: <span id="tot-p-${key}">0</span></span><span class="badge" style="color:var(--dovx)">COST: <span id="tot-c-${key}">0</span></span></div></div><div class="t-header"><span>TEMPLATE</span><span>ACT</span><span style="text-align:right">TOT/H</span><span style="text-align:right">TOT/24H</span></div><div id="list-${key}"></div></div>`;
        }
    }

    // --- CORE LOGIC (V182 FIXED) ---
    function conformData(row) {
        let tid = row.template_id.toString();
        let count = row.asset_ids ? row.asset_ids.length : 1;
        
        let tpl = CORE_DATA.templates[tid];
        let name = tpl ? tpl.name : `UNKNOWN [${tid}]`;
        let nominal = tpl ? tpl.prod : 0;

        let totalHourly = count * nominal;
        let totalDaily = totalHourly * CORE_DATA.gameConfig.cycleHours;
        let cost = totalDaily * CORE_DATA.gameConfig.maintenanceCost;

        let rawStr = (Array.isArray(row.power)?row.power[0]:row.power) || "";
        let type = "F"; 
        for(let t in CORE_DATA.gameConfig.tokenMap) {
            if(rawStr.includes(t)) { type = CORE_DATA.gameConfig.tokenMap[t]; break; }
        }

        return { name, type, count, totalHourly, totalDaily, cost };
    }

    async function dispatchGlobalScan() {
        stopSignal = false;
        switchView('globalView');
        document.getElementById('pageTitle').innerHTML = "GLOBAL SCAN <span>LIVE</span>";
        
        let next = ""; let globalCost = 0;
        let stats = { F:{p:0, c:0}, H:{p:0, c:0}, R:{p:0, c:0}, S:{p:0, c:0} };
        let groups = { F:[], H:[], R:[], S:[] };
        let rowsCount = 0; let assetsCount = 0;

        try {
            while(!stopSignal) {
                let res = await fetch("https://wax.greymass.com/v1/chain/get_table_rows", {
                    method: 'POST',
                    body: JSON.stringify({ json:true, code:"dovutilstake", scope:"dovutilstake", table:"buildings", limit:1000, lower_bound:next })
                });
                let data = await res.json();
                if(!data.rows || data.rows.length === 0) break;

                const now = Date.now()/1000;
                
                for(let row of data.rows) {
                    rowsCount++;
                    let info = conformData(row);
                    assetsCount += info.count;

                    let isReady = now > (parseFloat(row.last_claim) + parseFloat(row.delay));
                    // Assuming all in table are active stakes
                    let existing = groups[info.type].find(x => x.name === info.name);
                    if(existing) {
                        existing.act += info.count;
                        existing.totH += info.totalHourly;
                        existing.totD += info.totalDaily;
                        existing.cost += info.cost;
                    } else {
                        groups[info.type].push({ name: info.name, act: info.count, totH: info.totalHourly, totD: info.totalDaily, cost: info.cost });
                    }
                    stats[info.type].p += info.totalHourly;
                    stats[info.type].c += info.cost;
                    globalCost += info.cost;
                }

                updateDashboard(rowsCount, assetsCount, globalCost, stats, groups);
                if(data.more) next = data.next_key; else break;
                await new Promise(r => setTimeout(r, 50));
            }
        } catch(e) { console.error(e); }
    }

    function updateDashboard(rows, assets, cost, stats, groups) {
        document.getElementById('cntRows').innerText = rows.toLocaleString();
        document.getElementById('cntAssets').innerText = assets.toLocaleString();
        document.getElementById('gTotalCost').innerText = Math.floor(cost).toLocaleString('fr-FR').replace(/\s/g, ' ');

        for(let key in stats) {
            document.getElementById(`pwr-${key}`).innerText = stats[key].p.toLocaleString('fr-FR', {maximumFractionDigits: 2});
            document.getElementById(`tot-p-${key}`).innerText = stats[key].p.toLocaleString('fr-FR', {maximumFractionDigits: 2});
            document.getElementById(`tot-c-${key}`).innerText = stats[key].c.toLocaleString('fr-FR', {maximumFractionDigits: 0});
            
            let listEl = document.getElementById(`list-${key}`);
            let html = '';
            groups[key].sort((a,b) => b.totH - a.totH);
            groups[key].forEach(item => {
                html += `<div class="t-row"><div class="t-name">${item.name}</div><div class="t-act">${item.act}</div><div class="t-val txt-${key.toLowerCase()}">${item.totH.toLocaleString('fr-FR', {maximumFractionDigits: 2})}</div><div class="t-val-dim">${item.totD.toLocaleString('fr-FR', {maximumFractionDigits: 2})}</div></div>`;
            });
            listEl.innerHTML = html;
        }
    }

    // --- TARGET SCAN (FIXED) ---
    async function startBuildings() { 
        let user = document.getElementById('targetIn').value.trim();
        switchView('targetView');
        document.getElementById('buildList').innerHTML = "Scanning...";
        let next = ""; let html = "";
        try {
            while(true) {
                let res = await fetch("https://wax.greymass.com/v1/chain/get_table_rows", {
                    method:'POST', body:JSON.stringify({json:true, code:"dovutilstake", scope:user, table:"buildings", limit:100})
                });
                let data = await res.json();
                if(!data.rows) break;
                for(let row of data.rows) {
                    let info = conformData(row); // V182 FIX: Use conformData, not conformBuilding
                    let color = DEFAULT_DATA.resourceDefs[info.type].color;
                    html += `<div class="b-card" style="border-left:3px solid ${color}"><div style="font-weight:bold; color:${color}">${info.name}</div><div style="margin:5px 0;">Count: ${info.count}</div><div style="font-weight:bold;">${info.totalHourly.toLocaleString()} /h</div></div>`;
                }
                if(!data.more) break; next = data.next_key;
            }
            document.getElementById('buildList').innerHTML = html || "No buildings found.";
        } catch(e) { document.getElementById('buildList').innerHTML = "Error: " + e.message; }
    }

    // --- ZONES SCAN (RESTORED) ---
    async function startZoneScan() {
        switchView('zoneView');
        document.getElementById('pageTitle').innerHTML = "ZONE SCAN";
        const grid = document.getElementById('zonesArea');
        grid.innerHTML = "Scanning...";
        let stats = {}; 
        Object.keys(CORE_DATA.zones).forEach(id => stats[id] = {count:0});
        
        let next = "";
        try {
            while(true) {
                let res = await fetch("https://wax.greymass.com/v1/chain/get_table_rows", {
                    method:'POST', body:JSON.stringify({json:true, code:"dovpvecontrl", scope:"dovpvecontrl", table:"sdivisions", limit:1000, lower_bound:next})
                });
                let data = await res.json();
                if(!data.rows) break;
                for(let r of data.rows) {
                    let zid = r.zone_id || r.zoneID;
                    if(stats[zid]) stats[zid].count++;
                }
                if(!data.more) break; next = data.next_key;
            }
            // Render
            let html = "";
            Object.keys(stats).forEach(id => {
               let z = CORE_DATA.zones[id];
               html += `<div class="zone"><div class="z-head"><span>${z.name}</span><span>${stats[id].count}</span></div><div class="z-metrics">Cost: ${z.cost} TU</div></div>`;
            });
            grid.innerHTML = html;
        } catch(e) { console.error(e); }
    }

    // --- ECON SCAN (RESTORED) ---
    async function startEconomyScan() {
        switchView('ecoView');
        document.getElementById('pageTitle').innerHTML = "ECONOMY SCAN";
        // Simplified Logic for brevity in restoration
        let dTU = 0, sTU = 0;
        let next = "";
        try {
            while(true) {
                let res = await fetch("https://wax.greymass.com/v1/chain/get_table_rows", {
                    method:'POST', body:JSON.stringify({json:true, code:"dovpvecontrl", scope:"dovpvecontrl", table:"sdivisions", limit:1000, lower_bound:next})
                });
                let data = await res.json();
                if(!data.rows) break;
                for(let r of data.rows) {
                    let zid = r.zone_id || r.zoneID;
                    let z = CORE_DATA.zones[zid];
                    if(z && z.cost > 0) dTU += z.cost; // Burning TU
                }
                document.getElementById('valDemandTU').innerText = dTU.toLocaleString();
                if(!data.more) break; next = data.next_key;
            }
        } catch(e) { console.error(e); }
    }

    // --- SETTINGS ---
    function openSettings() {
        document.getElementById('cfgGameRules').value = JSON.stringify(CORE_DATA.gameConfig, null, 4);
        document.getElementById('cfgTemplates').value = JSON.stringify(CORE_DATA.templates, null, 4);
        document.getElementById('cfgResources').value = JSON.stringify(CORE_DATA.resourceDefs, null, 4);
        document.getElementById('cfgZones').value = JSON.stringify(CORE_DATA.zones, null, 4);
        document.getElementById('settingsModal').style.display = 'flex';
    }
    function saveConfig() {
        try {
            CORE_DATA.gameConfig = JSON.parse(document.getElementById('cfgGameRules').value);
            CORE_DATA.templates = JSON.parse(document.getElementById('cfgTemplates').value);
            CORE_DATA.resourceDefs = JSON.parse(document.getElementById('cfgResources').value);
            CORE_DATA.zones = JSON.parse(document.getElementById('cfgZones').value);
            localStorage.setItem('DOV_DATA', JSON.stringify(CORE_DATA));
            closeModal('settingsModal');
            buildUI();
        } catch(e) { alert("JSON Error"); }
    }
    function updateDictionary() { alert("Fetch API not connected in this version."); }
    function hardReset() { localStorage.removeItem('DOV_DATA'); location.reload(); }
    function startTarget() { alert("Divisions scan logic placeholder"); }

    window.onload = initApp;
</script>
</body>
</html>
